<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>atlctrlw.h Source File</title>
<link href="mystyles.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>atlctrlw.h</h1><a href="atlctrlw_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Windows Template Library - WTL version 7.0</font>
00002 <font class="comment">// Copyright (C) 1997-2002 Microsoft Corporation</font>
00003 <font class="comment">// All rights reserved.</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// This file is a part of the Windows Template Library.</font>
00006 <font class="comment">// The code and information is provided "as-is" without</font>
00007 <font class="comment">// warranty of any kind, either expressed or implied.</font>
00008 
00009 <font class="preprocessor">#ifndef __ATLCTRLW_H__</font>
00010 <font class="preprocessor"></font><font class="preprocessor">#define __ATLCTRLW_H__</font>
00011 <font class="preprocessor"></font>
00012 <font class="preprocessor">#pragma once</font>
00013 <font class="preprocessor"></font>
00014 <font class="preprocessor">#ifndef __cplusplus</font>
00015 <font class="preprocessor"></font><font class="preprocessor">    #error ATL requires C++ compilation (use a .cpp suffix)</font>
00016 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00017 <font class="preprocessor"></font>
00018 <font class="preprocessor">#ifndef __ATLAPP_H__</font>
00019 <font class="preprocessor"></font><font class="preprocessor">    #error atlctrlw.h requires atlapp.h to be included first</font>
00020 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00021 <font class="preprocessor"></font>
00022 <font class="preprocessor">#ifndef __ATLCTRLS_H__</font>
00023 <font class="preprocessor"></font><font class="preprocessor">    #error atlctrlw.h requires atlctrls.h to be included first</font>
00024 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00025 <font class="preprocessor"></font>
00026 <font class="preprocessor">#if (_WIN32_IE &lt; 0x0400)</font>
00027 <font class="preprocessor"></font><font class="preprocessor">    #error atlctrlw.h requires _WIN32_IE &gt;= 0x0400</font>
00028 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00029 <font class="preprocessor"></font>
00030 
00032 <font class="comment">// Classes in this file</font>
00033 <font class="comment">//</font>
00034 <font class="comment">// CCommandBarCtrlImpl&lt;T, TBase, TWinTraits&gt;</font>
00035 <font class="comment">// CCommandBarCtrl</font>
00036 <font class="comment">// CMDICommandBarCtrlImpl&lt;T, TBase, TWinTraits&gt;</font>
00037 <font class="comment">// CMDICommandBarCtrl</font>
00038 
00039 
00040 <font class="keyword">namespace </font>WTL
00041 {
00042 
00044 <font class="comment">// Command Bars</font>
00045 
00046 <font class="comment">// Window Styles:</font>
<a name="l00047"></a><a class="code" href="atlctrlw_8h.html#a0">00047</a> <font class="preprocessor">#define CBRWS_TOP       CCS_TOP</font>
<a name="l00048"></a><a class="code" href="atlctrlw_8h.html#a1">00048</a> <font class="preprocessor"></font><font class="preprocessor">#define CBRWS_BOTTOM        CCS_BOTTOM</font>
<a name="l00049"></a><a class="code" href="atlctrlw_8h.html#a2">00049</a> <font class="preprocessor"></font><font class="preprocessor">#define CBRWS_NORESIZE      CCS_NORESIZE</font>
<a name="l00050"></a><a class="code" href="atlctrlw_8h.html#a3">00050</a> <font class="preprocessor"></font><font class="preprocessor">#define CBRWS_NOPARENTALIGN CCS_NOPARENTALIGN</font>
<a name="l00051"></a><a class="code" href="atlctrlw_8h.html#a4">00051</a> <font class="preprocessor"></font><font class="preprocessor">#define CBRWS_NODIVIDER     CCS_NODIVIDER</font>
00052 <font class="preprocessor"></font>
00053 <font class="comment">// Extended styles</font>
<a name="l00054"></a><a class="code" href="atlctrlw_8h.html#a5">00054</a> <font class="preprocessor">#define CBR_EX_TRANSPARENT  0x00000001L</font>
<a name="l00055"></a><a class="code" href="atlctrlw_8h.html#a6">00055</a> <font class="preprocessor"></font><font class="preprocessor">#define CBR_EX_SHAREMENU    0x00000002L</font>
<a name="l00056"></a><a class="code" href="atlctrlw_8h.html#a7">00056</a> <font class="preprocessor"></font><font class="preprocessor">#define CBR_EX_ALTFOCUSMODE 0x00000004L</font>
<a name="l00057"></a><a class="code" href="atlctrlw_8h.html#a8">00057</a> <font class="preprocessor"></font><font class="preprocessor">#define CBR_EX_TRACKALWAYS  0x00000008L</font>
00058 <font class="preprocessor"></font>
00059 <font class="comment">// standard command bar styles</font>
<a name="l00060"></a><a class="code" href="atlctrlw_8h.html#a9">00060</a> <font class="preprocessor">#define ATL_SIMPLE_CMDBAR_PANE_STYLE \</font>
00061 <font class="preprocessor">    (WS_CHILD | WS_VISIBLE | WS_CLIPCHILDREN | WS_CLIPSIBLINGS | CBRWS_NODIVIDER | CBRWS_NORESIZE | CBRWS_NOPARENTALIGN)</font>
00062 <font class="preprocessor"></font>
00063 <font class="comment">// Messages - support chevrons for frame windows</font>
<a name="l00064"></a><a class="code" href="atlctrlw_8h.html#a10">00064</a> <font class="preprocessor">#define CBRM_GETCMDBAR          (WM_USER + 301) // return command bar HWND</font>
<a name="l00065"></a><a class="code" href="atlctrlw_8h.html#a11">00065</a> <font class="preprocessor"></font><font class="preprocessor">#define CBRM_GETMENU            (WM_USER + 302) // returns loaded or attached menu</font>
<a name="l00066"></a><a class="code" href="atlctrlw_8h.html#a12">00066</a> <font class="preprocessor"></font><font class="preprocessor">#define CBRM_TRACKPOPUPMENU     (WM_USER + 303) // displays a popup menu</font>
00067 <font class="preprocessor"></font>
<a name="l00068"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html">00068</a> <font class="keyword">typedef</font> <font class="keyword">struct </font><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html">tagCBRPOPUPMENU</a>
00069 {
<a name="l00070"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m0">00070</a>     <font class="keywordtype">int</font> <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m0">cbSize</a>;
<a name="l00071"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m1">00071</a>     HMENU <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m1">hMenu</a>;        <font class="comment">// popup menu do display</font>
<a name="l00072"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m2">00072</a>     UINT <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m2">uFlags</a>;        <font class="comment">// TPM_* flags for ::TrackPopupMenuEx</font>
<a name="l00073"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m3">00073</a>     <font class="keywordtype">int</font> <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m3">x</a>;
<a name="l00074"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m4">00074</a>     <font class="keywordtype">int</font> <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m4">y</a>;
<a name="l00075"></a><a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m5">00075</a>     LPTPMPARAMS <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m5">lptpm</a>;  <font class="comment">// ptr to TPMPARAMS for ::TrackPopupMenuEx</font>
00076 } <a class="code" href="namespaceWTL.html#a31">CBRPOPUPMENU</a>, *<a class="code" href="namespaceWTL.html#a32">LPCBRPOPUPMENU</a>;
00077 
00078 <font class="comment">// helper class</font>
00079 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l00080"></a><a class="code" href="classWTL_1_1CSimpleStack.html">00080</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CSimpleStack.html">CSimpleStack</a> : <font class="keyword">public</font> <a class="code" href="classCSimpleArray.html">CSimpleArray</a>&lt; T &gt;
00081 {
00082 <font class="keyword">public</font>:
<a name="l00083"></a><a class="code" href="classWTL_1_1CSimpleStack.html#a0">00083</a>     BOOL <a class="code" href="classWTL_1_1CSimpleStack.html#a0">Push</a>(T t)
00084     {
00085 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
00086 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - STACK-PUSH (%8.8X) size = %i\n"</font>, t, GetSize());
00087 <font class="preprocessor">#endif</font>
00088 <font class="preprocessor"></font>        <font class="keywordflow">return</font> Add(t);
00089     }
<a name="l00090"></a><a class="code" href="classWTL_1_1CSimpleStack.html#a1">00090</a>     T <a class="code" href="classWTL_1_1CSimpleStack.html#a1">Pop</a>()
00091     {
00092         <font class="keywordtype">int</font> nLast = GetSize() - 1;
00093         <font class="keywordflow">if</font>(nLast &lt; 0)
00094             <font class="keywordflow">return</font> NULL;    <font class="comment">// must be able to convert to NULL</font>
00095         T t = m_aT[nLast];
00096 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
00097 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - STACK-POP (%8.8X) size = %i\n"</font>, t, GetSize());
00098 <font class="preprocessor">#endif</font>
00099 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(!RemoveAt(nLast))
00100             <font class="keywordflow">return</font> NULL;
00101         <font class="keywordflow">return</font> t;
00102     }
<a name="l00103"></a><a class="code" href="classWTL_1_1CSimpleStack.html#a2">00103</a>     T <a class="code" href="classWTL_1_1CSimpleStack.html#a2">GetCurrent</a>()
00104     {
00105         <font class="keywordtype">int</font> nLast = GetSize() - 1;
00106         <font class="keywordflow">if</font>(nLast &lt; 0)
00107             <font class="keywordflow">return</font> NULL;    <font class="comment">// must be able to convert to NULL</font>
00108         <font class="keywordflow">return</font> m_aT[nLast];
00109     }
00110 };
00111 
00112 
00114 <font class="comment">// CCommandBarCtrlBase - base class for the Command Bar implementation</font>
00115 
<a name="l00116"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html">00116</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html">CCommandBarCtrlBase</a> : <font class="keyword">public</font> <a class="code" href="namespaceWTL.html#a13">CToolBarCtrl</a>
00117 {
00118 <font class="keyword">public</font>:
<a name="l00119"></a><a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html">00119</a>     <font class="keyword">struct </font><a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html">_MsgHookData</a>
00120     {
<a name="l00121"></a><a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#m0">00121</a>         HHOOK <a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#m0">hMsgHook</a>;
<a name="l00122"></a><a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#m1">00122</a>         DWORD <a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#m1">dwUsage</a>;
00123 
<a name="l00124"></a><a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#a0">00124</a>         <a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#a0">_MsgHookData</a>() : <a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#m0">hMsgHook</a>(NULL), <a class="code" href="structWTL_1_1CCommandBarCtrlBase_1_1__MsgHookData.html#m1">dwUsage</a>(0) { }
00125     };
00126 
<a name="l00127"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#s0">00127</a>     <font class="keyword">typedef</font> CSimpleMap&lt;DWORD, _MsgHookData*&gt;    <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#s0">CMsgHookMap</a>;
<a name="l00128"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p0">00128</a>     <font class="keyword">static</font> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#s0">CMsgHookMap</a>* <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p0">s_pmapMsgHook</a>;
00129 
<a name="l00130"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p1">00130</a>     <font class="keyword">static</font> HHOOK <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p1">s_hCreateHook</a>;
<a name="l00131"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p2">00131</a>     <font class="keyword">static</font> <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p2">s_bW2K</a>;  <font class="comment">// For animation flag</font>
<a name="l00132"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p3">00132</a>     <font class="keyword">static</font> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html">CCommandBarCtrlBase</a>* <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p3">s_pCurrentBar</a>;
<a name="l00133"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p4">00133</a>     <font class="keyword">static</font> <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p4">s_bStaticInit</a>;
00134 
<a name="l00135"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m0">00135</a>     <a class="code" href="classWTL_1_1CSimpleStack.html">CSimpleStack&lt;HWND&gt;</a> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m0">m_stackMenuWnd</a>;
<a name="l00136"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m1">00136</a>     <a class="code" href="classWTL_1_1CSimpleStack.html">CSimpleStack&lt;HMENU&gt;</a> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m1">m_stackMenuHandle</a>;
00137 
<a name="l00138"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m2">00138</a>     HWND <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m2">m_hWndHook</a>;
<a name="l00139"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m3">00139</a>     DWORD <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m3">m_dwMagic</a>;
00140 
00141 
<a name="l00142"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#a0">00142</a>     <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#a0">CCommandBarCtrlBase</a>() : <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m2">m_hWndHook</a>(NULL), <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m3">m_dwMagic</a>(1314)
00143     {
00144         <font class="comment">// init static variables</font>
00145         <font class="keywordflow">if</font>(!<a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p4">s_bStaticInit</a>)
00146         {
00147             ::EnterCriticalSection(&amp;_Module.m_csStaticDataInit);
00148             <font class="keywordflow">if</font>(!<a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p4">s_bStaticInit</a>)
00149             {
00150                 <font class="comment">// Just in case...</font>
00151                 INITCOMMONCONTROLSEX iccx;
00152                 iccx.dwSize = <font class="keyword">sizeof</font>(iccx);
00153                 iccx.dwICC = ICC_COOL_CLASSES | ICC_BAR_CLASSES;
00154                 ::InitCommonControlsEx(&amp;iccx);
00155                 <font class="comment">// Animation on Win2000 only</font>
00156                 <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p2">s_bW2K</a> = !<a class="code" href="namespaceWTL.html#a59">AtlIsOldWindows</a>();
00157                 <font class="comment">// done</font>
00158                 <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#p4">s_bStaticInit</a> = <font class="keyword">true</font>;
00159             }
00160             ::LeaveCriticalSection(&amp;_Module.m_csStaticDataInit);
00161         }
00162     }
00163 
<a name="l00164"></a><a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#a1">00164</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#a1">IsCommandBarBase</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m3">m_dwMagic</a> == 1314; }
00165 };
00166 
<a name="l00167"></a><a class="code" href="namespaceWTL.html#a64">00167</a> <a class="code" href="namespaceWTL.html#a64">__declspec</a>(selectany) CCommandBarCtrlBase::CMsgHookMap* CCommandBarCtrlBase::s_pmapMsgHook = NULL;
00168 <a class="code" href="namespaceWTL.html#a64">__declspec</a>(selectany) HHOOK CCommandBarCtrlBase::s_hCreateHook = NULL;
00169 <a class="code" href="namespaceWTL.html#a64">__declspec</a>(selectany) <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html">CCommandBarCtrlBase</a>* CCommandBarCtrlBase::s_pCurrentBar = NULL;
00170 <a class="code" href="namespaceWTL.html#a64">__declspec</a>(selectany) <font class="keywordtype">bool</font> CCommandBarCtrlBase::s_bW2K = <font class="keyword">false</font>;
00171 <a class="code" href="namespaceWTL.html#a64">__declspec</a>(selectany) <font class="keywordtype">bool</font> CCommandBarCtrlBase::s_bStaticInit = <font class="keyword">false</font>;
00172 
00173 
00175 <font class="comment">// CCommandBarCtrl - ATL implementation of Command Bars</font>
00176 
00177 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keyword">class</font> TBase = CCommandBarCtrlBase, <font class="keyword">class</font> TWinTraits = CControlWinTraits&gt;
00178 <font class="keyword">class </font>ATL_NO_VTABLE <a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl</a> : <font class="keyword">public</font> <a class="code" href="classCWindowImpl.html">CWindowImpl</a>&lt; T, TBase, TWinTraits &gt;
00179 {
00180 <font class="keyword">public</font>:
00181     DECLARE_WND_SUPERCLASS(NULL, TBase::GetWndClassName())
00182 
00183 <font class="comment">// Declarations</font>
00184     <font class="keyword">struct </font>_MenuItemData    <font class="comment">// menu item data</font>
00185     {
00186         DWORD dwMagic;
00187         LPTSTR lpstrText;
00188         UINT fType;
00189         UINT fState;
00190         <font class="keywordtype">int</font> iButton;
00191 
00192         _MenuItemData() { dwMagic = 0x1313; }
00193         <font class="keywordtype">bool</font> IsCmdBarMenuItem() { <font class="keywordflow">return</font> (dwMagic == 0x1313); }
00194     };
00195 
00196     <font class="keyword">struct </font>_ToolBarData <font class="comment">// toolbar resource data</font>
00197     {
00198         WORD wVersion;
00199         WORD wWidth;
00200         WORD wHeight;
00201         WORD wItemCount;
00202         <font class="comment">//WORD aItems[wItemCount]</font>
00203 
00204         WORD* items()
00205             { <font class="keywordflow">return</font> (WORD*)(<font class="keyword">this</font>+1); }
00206     };
00207 
00208 <font class="comment">// Constants</font>
00209     <font class="keyword">enum</font> _CmdBarDrawConstants
00210     {
00211         s_kcxGap = 1,
00212         s_kcxTextMargin = 2,
00213         s_kcxButtonMargin = 3,
00214         s_kcyButtonMargin = 3
00215     };
00216 
00217     <font class="keyword">enum</font>
00218     {
00219         _nMaxMenuItemTextLength = 100,
00220         _chChevronShortcut = _T(<font class="charliteral">'/'</font>)
00221     };
00222 
00223 <font class="preprocessor">#ifndef DT_HIDEPREFIX</font>
00224 <font class="preprocessor"></font>    <font class="keyword">enum</font> { DT_HIDEPREFIX = 0x00100000 };
00225 <font class="preprocessor">#endif </font>
00226 <font class="preprocessor"></font>
00227 <font class="preprocessor"></font><font class="comment">// Data members</font>
00228     HMENU m_hMenu;
00229     HIMAGELIST m_hImageList;
00230     CSimpleValArray&lt;WORD&gt; m_arrCommand;
00231 
00232     DWORD m_dwExtendedStyle;    <font class="comment">// Command Bar specific extended styles</font>
00233 
00234     CContainedWindow m_wndParent;
00235 
00236     <font class="keywordtype">bool</font> m_bMenuActive:1;
00237     <font class="keywordtype">bool</font> m_bAttachedMenu:1;
00238     <font class="keywordtype">bool</font> m_bImagesVisible:1;
00239     <font class="keywordtype">bool</font> m_bPopupItem:1;
00240     <font class="keywordtype">bool</font> m_bContextMenu:1;
00241     <font class="keywordtype">bool</font> m_bEscapePressed:1;
00242     <font class="keywordtype">bool</font> m_bSkipMsg:1;
00243     <font class="keywordtype">bool</font> m_bParentActive:1;
00244     <font class="keywordtype">bool</font> m_bFlatMenus:1;
00245     <font class="keywordtype">bool</font> m_bUseKeyboardCues:1;
00246     <font class="keywordtype">bool</font> m_bShowKeyboardCues:1;
00247     <font class="keywordtype">bool</font> m_bAllowKeyboardCues:1;
00248     <font class="keywordtype">bool</font> m_bKeyboardInput:1;
00249     <font class="keywordtype">bool</font> m_bAlphaImages:1;
00250 
00251     <font class="keywordtype">int</font> m_nPopBtn;
00252     <font class="keywordtype">int</font> m_nNextPopBtn;
00253 
00254     SIZE m_szBitmap;
00255     SIZE m_szButton;
00256 
00257     COLORREF m_clrMask;
00258     <a class="code" href="namespaceWTL.html#a40">CFont</a> m_fontMenu;       <font class="comment">// used internally, only to measure text</font>
00259 
00260     UINT m_uSysKey;
00261 
00262     HWND m_hWndFocus;       <font class="comment">// Alternate focus mode</font>
00263 
00264     <font class="keywordtype">int</font> m_cxExtraSpacing;
00265 
00266 <font class="comment">// Constructor/destructor</font>
00267     <a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl</a>() : 
00268             m_hMenu(NULL), 
00269             m_hImageList(NULL), 
00270             m_wndParent(<font class="keyword">this</font>, 1), 
00271             m_bMenuActive(<font class="keyword">false</font>), 
00272             m_bAttachedMenu(<font class="keyword">false</font>), 
00273             m_nPopBtn(-1), 
00274             m_nNextPopBtn(-1), 
00275             m_bPopupItem(<font class="keyword">false</font>),
00276             m_bImagesVisible(<font class="keyword">true</font>),
00277             m_bSkipMsg(<font class="keyword">false</font>),
00278             m_uSysKey(0),
00279             m_hWndFocus(NULL),
00280             m_bContextMenu(<font class="keyword">false</font>),
00281             m_bEscapePressed(<font class="keyword">false</font>),
00282             m_clrMask(RGB(192, 192, 192)),
00283             m_dwExtendedStyle(<a class="code" href="atlctrlw_8h.html#a5">CBR_EX_TRANSPARENT</a> | <a class="code" href="atlctrlw_8h.html#a6">CBR_EX_SHAREMENU</a> | <a class="code" href="atlctrlw_8h.html#a8">CBR_EX_TRACKALWAYS</a>),
00284             m_bParentActive(<font class="keyword">true</font>),
00285             m_bFlatMenus(<font class="keyword">false</font>),
00286             m_bUseKeyboardCues(<font class="keyword">false</font>),
00287             m_bShowKeyboardCues(<font class="keyword">false</font>),
00288             m_bAllowKeyboardCues(<font class="keyword">true</font>),
00289             m_bKeyboardInput(<font class="keyword">false</font>),
00290             m_cxExtraSpacing(0),
00291             m_bAlphaImages(<font class="keyword">false</font>)
00292     {
00293         SetImageSize(16, 15);   <font class="comment">// default</font>
00294     }
00295 
00296     ~<a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl</a>()
00297     {
00298         <font class="keywordflow">if</font>(m_wndParent.IsWindow())
00299 <font class="comment">/*scary!*/</font>          m_wndParent.UnsubclassWindow();
00300 
00301         <font class="keywordflow">if</font>(m_hMenu != NULL &amp;&amp; (m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a6">CBR_EX_SHAREMENU</a>) == 0)
00302             ::DestroyMenu(m_hMenu);
00303 
00304         <font class="keywordflow">if</font>(m_hImageList != NULL)
00305             ::ImageList_Destroy(m_hImageList);
00306     }
00307 
00308 <font class="comment">// Attributes</font>
00309     DWORD GetCommandBarExtendedStyle()<font class="keyword"> const</font>
00310 <font class="keyword">    </font>{
00311         <font class="keywordflow">return</font> m_dwExtendedStyle;
00312     }
00313     DWORD SetCommandBarExtendedStyle(DWORD dwExtendedStyle, DWORD dwMask = 0)
00314     {
00315         DWORD dwPrevStyle = m_dwExtendedStyle;
00316         <font class="keywordflow">if</font>(dwMask == 0)
00317             m_dwExtendedStyle = dwExtendedStyle;
00318         <font class="keywordflow">else</font>
00319             m_dwExtendedStyle = (m_dwExtendedStyle &amp; ~dwMask) | (dwExtendedStyle &amp; dwMask);
00320         <font class="keywordflow">return</font> dwPrevStyle;
00321     }
00322 
00323     <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> GetMenu()<font class="keyword"> const</font>
00324 <font class="keyword">    </font>{
00325         ATLASSERT(::IsWindow(m_hWnd));
00326         <font class="keywordflow">return</font> m_hMenu;
00327     }
00328 
00329     COLORREF GetImageMaskColor()<font class="keyword"> const</font>
00330 <font class="keyword">    </font>{
00331         <font class="keywordflow">return</font> m_clrMask;
00332     }
00333     COLORREF SetImageMaskColor(COLORREF clrMask)
00334     {
00335         COLORREF clrOld = m_clrMask;
00336         m_clrMask = clrMask;
00337         <font class="keywordflow">return</font> clrOld;
00338     }
00339 
00340     <font class="keywordtype">bool</font> GetImagesVisible()<font class="keyword"> const</font>
00341 <font class="keyword">    </font>{
00342         <font class="keywordflow">return</font> m_bImagesVisible;
00343     }
00344     <font class="keywordtype">bool</font> SetImagesVisible(<font class="keywordtype">bool</font> bVisible)
00345     {
00346         <font class="keywordtype">bool</font> bOld = m_bImagesVisible;
00347         m_bImagesVisible = bVisible;
00348         <font class="keywordflow">return</font> bOld;
00349     }
00350 
00351     <font class="keywordtype">void</font> GetImageSize(SIZE&amp; size)<font class="keyword"> const</font>
00352 <font class="keyword">    </font>{
00353         size = m_szBitmap;
00354     }
00355     <font class="keywordtype">bool</font> SetImageSize(SIZE&amp; size)
00356     {
00357         <font class="keywordflow">return</font> SetImageSize(size.cx, size.cy);
00358     }
00359     <font class="keywordtype">bool</font> SetImageSize(<font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy)
00360     {
00361         <font class="keywordflow">if</font>(m_hImageList != NULL)
00362         {
00363             <font class="keywordflow">if</font>(::ImageList_GetImageCount(m_hImageList) == 0)    <font class="comment">// empty</font>
00364             {
00365                 ::ImageList_Destroy(m_hImageList);
00366                 m_hImageList = NULL;
00367             }
00368             <font class="keywordflow">else</font>
00369             {
00370                 <font class="keywordflow">return</font> <font class="keyword">false</font>;       <font class="comment">// can't set, image list exists</font>
00371             }
00372         }
00373 
00374         <font class="keywordflow">if</font>(cx == 0 || cy == 0)
00375             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00376 
00377         m_szBitmap.cx = cx;
00378         m_szBitmap.cy = cy;
00379         m_szButton.cx = m_szBitmap.cx + 2 * s_kcxButtonMargin;
00380         m_szButton.cy = m_szBitmap.cy + 2 * s_kcyButtonMargin;
00381 
00382         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00383     }
00384 
00385     <font class="keywordtype">bool</font> GetAlphaImages()<font class="keyword"> const</font>
00386 <font class="keyword">    </font>{
00387         <font class="keywordflow">return</font> m_bAlphaImages;
00388     }
00389     <font class="keywordtype">bool</font> SetAlphaImages(<font class="keywordtype">bool</font> bAlphaImages)
00390     {
00391         <font class="keywordflow">if</font>(m_hImageList != NULL)
00392         {
00393             <font class="keywordflow">if</font>(::ImageList_GetImageCount(m_hImageList) == 0)    <font class="comment">// empty</font>
00394             {
00395                 ::ImageList_Destroy(m_hImageList);
00396                 m_hImageList = NULL;
00397             }
00398             <font class="keywordflow">else</font>
00399             {
00400                 <font class="keywordflow">return</font> <font class="keyword">false</font>;       <font class="comment">// can't set, image list exists</font>
00401             }
00402         }
00403 
00404         m_bAlphaImages = bAlphaImages;
00405         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00406     }
00407 
00408     HWND GetCmdBar()<font class="keyword"> const</font>
00409 <font class="keyword">    </font>{
00410         ATLASSERT(::IsWindow(m_hWnd));
00411         <font class="keywordflow">return</font> (HWND)::SendMessage(m_hWnd, <a class="code" href="atlctrlw_8h.html#a10">CBRM_GETCMDBAR</a>, 0, 0L);
00412     }
00413 
00414 <font class="comment">// Methods</font>
00415     HWND Create(HWND hWndParent, RECT&amp; rcPos, LPCTSTR szWindowName = NULL,
00416             DWORD dwStyle = 0, DWORD dwExStyle = 0,
00417             UINT nID = 0, LPVOID lpCreateParam = NULL)
00418     {
00419         <font class="comment">// These styles are required for command bars</font>
00420         dwStyle |= TBSTYLE_LIST | TBSTYLE_FLAT;
00421         <font class="keywordflow">return</font> <a class="code" href="classCWindowImpl.html">CWindowImpl&lt; T, TBase, TWinTraits &gt;::Create</a>(hWndParent, rcPos, szWindowName, dwStyle, dwExStyle, nID, lpCreateParam);
00422     }
00423 
00424     BOOL AttachToWindow(HWND hWnd)
00425     {
00426         ATLASSERT(m_hWnd == NULL);
00427         ATLASSERT(::IsWindow(hWnd));
00428         BOOL bRet = SubclassWindow(hWnd);
00429         <font class="keywordflow">if</font>(bRet)
00430         {
00431             m_bAttachedMenu = <font class="keyword">true</font>;
00432             T* pT = static_cast&lt;T*&gt;(this);
00433             pT-&gt;GetSystemSettings();
00434         }
00435         <font class="keywordflow">return</font> bRet;
00436     }
00437 
00438     BOOL LoadMenu(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> menu)
00439     {
00440         ATLASSERT(::IsWindow(m_hWnd));
00441 
00442         <font class="keywordflow">if</font>(m_bAttachedMenu) <font class="comment">// doesn't work in this mode</font>
00443             <font class="keywordflow">return</font> FALSE;
00444         <font class="keywordflow">if</font>(menu.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a> == NULL)
00445             <font class="keywordflow">return</font> FALSE;
00446 
00447         HMENU hMenu = ::LoadMenu(_Module.GetResourceInstance(), menu.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>);
00448         <font class="keywordflow">if</font>(hMenu == NULL)
00449             <font class="keywordflow">return</font> FALSE;
00450 
00451         <font class="keywordflow">return</font> AttachMenu(hMenu);
00452     }
00453 
00454     BOOL AttachMenu(HMENU hMenu)
00455     {
00456         ATLASSERT(::IsWindow(m_hWnd));
00457         ATLASSERT(::IsMenu(hMenu));
00458         <font class="keywordflow">if</font>(hMenu != NULL &amp;&amp; !::IsMenu(hMenu))
00459             <font class="keywordflow">return</font> FALSE;
00460 
00461         <font class="comment">// destroy old menu, if needed, and set new one</font>
00462         <font class="keywordflow">if</font>(m_hMenu != NULL &amp;&amp; (m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a6">CBR_EX_SHAREMENU</a>) == 0)
00463             ::DestroyMenu(m_hMenu);
00464         m_hMenu = hMenu;
00465 
00466         <font class="keywordflow">if</font>(m_bAttachedMenu) <font class="comment">// Nothing else in this mode</font>
00467             <font class="keywordflow">return</font> TRUE;
00468 
00469         <font class="comment">// Build buttons according to menu</font>
00470         SetRedraw(FALSE);
00471 
00472         <font class="comment">// Clear all</font>
00473         BOOL bRet;
00474         <font class="keywordtype">int</font> nCount = GetButtonCount();
00475         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; nCount; i++)
00476         {
00477             bRet = DeleteButton(0);
00478             ATLASSERT(bRet);
00479         }
00480 
00481 
00482         <font class="comment">// Add buttons for each menu item</font>
00483         <font class="keywordflow">if</font>(m_hMenu != NULL)
00484         {
00485             <font class="keywordtype">int</font> nItems = ::GetMenuItemCount(m_hMenu);
00486 
00487             T* pT = static_cast&lt;T*&gt;(this);
00488             pT; <font class="comment">// avoid level 4 warning</font>
00489             TCHAR szString[pT-&gt;_nMaxMenuItemTextLength];
00490             <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; nItems; i++)
00491             {
00492                 <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> mii;
00493                 mii.fMask = MIIM_TYPE | MIIM_STATE | MIIM_SUBMENU;
00494                 mii.fType = MFT_STRING;
00495                 mii.dwTypeData = szString;
00496                 mii.cch = pT-&gt;_nMaxMenuItemTextLength;
00497                 bRet = ::GetMenuItemInfo(m_hMenu, i, TRUE, &amp;mii);
00498                 ATLASSERT(bRet);
00499                 <font class="comment">// If we have more than the buffer, we assume we have bitmaps bits</font>
00500                 <font class="keywordflow">if</font>(lstrlen(szString) &gt; pT-&gt;_nMaxMenuItemTextLength - 1)
00501                 {
00502                     mii.fType = MFT_BITMAP;
00503                     ::SetMenuItemInfo(m_hMenu, i, TRUE, &amp;mii);
00504                     szString[0] = 0;
00505                 }
00506 
00507                 <font class="comment">// NOTE: Command Bar currently supports only drop-down menu items</font>
00508                 ATLASSERT(mii.hSubMenu != NULL);
00509 
00510                 TBBUTTON btn;
00511                 btn.iBitmap = 0;
00512                 btn.idCommand = i;
00513                 btn.fsState = (BYTE)(((mii.fState &amp; MFS_DISABLED) == 0) ? TBSTATE_ENABLED : 0);
00514                 btn.fsStyle = TBSTYLE_BUTTON | TBSTYLE_AUTOSIZE | TBSTYLE_DROPDOWN;
00515                 btn.dwData = 0;
00516                 btn.iString = 0;
00517 
00518                 bRet = InsertButton(-1, &amp;btn);
00519                 ATLASSERT(bRet);
00520 
00521                 TBBUTTONINFO bi;
00522                 memset(&amp;bi, 0, <font class="keyword">sizeof</font>(bi));
00523                 bi.cbSize = <font class="keyword">sizeof</font>(TBBUTTONINFO);
00524                 bi.dwMask = TBIF_TEXT;
00525                 bi.pszText = szString;
00526 
00527                 bRet = SetButtonInfo(i, &amp;bi);
00528                 ATLASSERT(bRet);
00529             }
00530         }
00531 
00532         SetRedraw(TRUE);
00533         Invalidate();
00534         UpdateWindow();
00535 
00536         <font class="keywordflow">return</font> TRUE;
00537     }
00538 
00539     BOOL LoadImages(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> image)
00540     {
00541         <font class="keywordflow">return</font> _LoadImagesHelper(image, <font class="keyword">false</font>);
00542     }
00543 
00544     BOOL LoadMappedImages(UINT nIDImage, UINT nFlags = 0, LPCOLORMAP lpColorMap = NULL, <font class="keywordtype">int</font> nMapSize = 0)
00545     {
00546         <font class="keywordflow">return</font> _LoadImagesHelper(nIDImage, <font class="keyword">true</font>, nFlags , lpColorMap, nMapSize);
00547     }
00548 
00549     BOOL _LoadImagesHelper(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> image, <font class="keywordtype">bool</font> bMapped, UINT nFlags = 0, LPCOLORMAP lpColorMap = NULL, <font class="keywordtype">int</font> nMapSize = 0)
00550     {
00551         ATLASSERT(::IsWindow(m_hWnd));
00552         HINSTANCE hInstance = _Module.GetResourceInstance();
00553 
00554         HRSRC hRsrc = ::FindResource(hInstance, image.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>, (LPTSTR)<a class="code" href="atlres_8h.html#a1">RT_TOOLBAR</a>);
00555         <font class="keywordflow">if</font>(hRsrc == NULL)
00556             <font class="keywordflow">return</font> FALSE;
00557 
00558         HGLOBAL hGlobal = ::LoadResource(hInstance, hRsrc);
00559         <font class="keywordflow">if</font>(hGlobal == NULL)
00560             <font class="keywordflow">return</font> FALSE;
00561 
00562         _ToolBarData* pData = (_ToolBarData*)::LockResource(hGlobal);
00563         <font class="keywordflow">if</font>(pData == NULL)
00564             <font class="keywordflow">return</font> FALSE;
00565         ATLASSERT(pData-&gt;wVersion == 1);
00566 
00567         WORD* pItems = pData-&gt;items();
00568         <font class="keywordtype">int</font> nItems = pData-&gt;wItemCount;
00569 
00570         <font class="comment">// Set internal data</font>
00571         SetImageSize(pData-&gt;wWidth, pData-&gt;wHeight);
00572 
00573         <font class="comment">// Create image list if needed</font>
00574         <font class="keywordflow">if</font>(m_hImageList == NULL)
00575         {
00576             <font class="comment">// Check if the bitmap is 32-bit (alpha channel) bitmap (valid for Windows XP only)</font>
00577             T* pT = static_cast&lt;T*&gt;(this);
00578             m_bAlphaImages = <a class="code" href="namespaceWTL.html#a63">AtlIsAlphaBitmapResource</a>(image);
00579 
00580             <font class="keywordflow">if</font>(!pT-&gt;CreateInternalImageList(pData-&gt;wItemCount))
00581                 <font class="keywordflow">return</font> FALSE;
00582         }
00583 
00584         <font class="comment">// Add bitmap to our image list</font>
00585         <a class="code" href="namespaceWTL.html#a42">CBitmap</a> bmp;
00586         <font class="keywordflow">if</font>(bMapped)
00587         {
00588             ATLASSERT(HIWORD(<a class="code" href="atlapp_8h.html#a16">PtrToUlong</a>(image.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>)) == 0);  <font class="comment">// if mapped, must be a numeric ID</font>
00589             <font class="keywordtype">int</font> nIDImage = (int)(short)LOWORD(<a class="code" href="atlapp_8h.html#a16">PtrToUlong</a>(image.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>));
00590             bmp.LoadMappedBitmap(nIDImage, (WORD)nFlags, lpColorMap, nMapSize);
00591         }
00592         <font class="keywordflow">else</font>
00593         {
00594             <font class="keywordflow">if</font>(m_bAlphaImages)
00595                 bmp = (HBITMAP)::LoadImage(_Module.GetResourceInstance(), image.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>, IMAGE_BITMAP, 0, 0, LR_CREATEDIBSECTION | LR_DEFAULTSIZE);
00596             <font class="keywordflow">else</font>
00597                 bmp.LoadBitmap(image.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>);
00598         }
00599         ATLASSERT(bmp.m_hBitmap != NULL);
00600         <font class="keywordflow">if</font>(bmp.m_hBitmap == NULL)
00601             <font class="keywordflow">return</font> FALSE;
00602         <font class="keywordflow">if</font>(::ImageList_AddMasked(m_hImageList, bmp, m_clrMask) == -1)
00603             <font class="keywordflow">return</font> FALSE;
00604 
00605         <font class="comment">// Fill the array with command IDs</font>
00606         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; nItems; i++)
00607         {
00608             <font class="keywordflow">if</font>(pItems[i] != 0)
00609                 m_arrCommand.Add(pItems[i]);
00610         }
00611 
00612         ATLASSERT(::ImageList_GetImageCount(m_hImageList) == m_arrCommand.GetSize());
00613         <font class="keywordflow">if</font>(::ImageList_GetImageCount(m_hImageList) != m_arrCommand.GetSize())
00614             <font class="keywordflow">return</font> FALSE;
00615 
00616         <font class="keywordflow">return</font> TRUE;
00617     }
00618 
00619     BOOL AddBitmap(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> bitmap, <font class="keywordtype">int</font> nCommandID)
00620     {
00621         ATLASSERT(::IsWindow(m_hWnd));
00622         <a class="code" href="namespaceWTL.html#a42">CBitmap</a> bmp;
00623         bmp.LoadBitmap(bitmap.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>);
00624         <font class="keywordflow">if</font>(bmp.m_hBitmap == NULL)
00625             <font class="keywordflow">return</font> FALSE;
00626         <font class="keywordflow">return</font> AddBitmap(bmp, nCommandID);
00627     }
00628 
00629     BOOL AddBitmap(HBITMAP hBitmap, UINT nCommandID)
00630     {
00631         ATLASSERT(::IsWindow(m_hWnd));
00632         <font class="comment">// Create image list if it doesn't exist</font>
00633         <font class="keywordflow">if</font>(m_hImageList == NULL)
00634         {
00635             T* pT = static_cast&lt;T*&gt;(this);
00636             <font class="keywordflow">if</font>(!pT-&gt;CreateInternalImageList(1))
00637                 <font class="keywordflow">return</font> FALSE;
00638         }
00639         <font class="comment">// check bitmap size</font>
00640         <a class="code" href="namespaceWTL.html#a41">CBitmapHandle</a> bmp = hBitmap;
00641         SIZE size = { 0, 0 };
00642         bmp.GetSize(size);
00643         <font class="keywordflow">if</font>(size.cx != m_szBitmap.cx || size.cy != m_szBitmap.cy)
00644         {
00645             ATLASSERT(FALSE);   <font class="comment">// must match size!</font>
00646             <font class="keywordflow">return</font> FALSE;
00647         }
00648         <font class="comment">// add bitmap</font>
00649         <font class="keywordtype">int</font> nRet = ::ImageList_AddMasked(m_hImageList, hBitmap, m_clrMask);
00650         <font class="keywordflow">if</font>(nRet == -1)
00651             <font class="keywordflow">return</font> FALSE;
00652         BOOL bRet = m_arrCommand.Add((WORD)nCommandID);
00653         ATLASSERT(::ImageList_GetImageCount(m_hImageList) == m_arrCommand.GetSize());
00654         <font class="keywordflow">return</font> bRet;
00655     }
00656 
00657     BOOL AddIcon(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> icon, UINT nCommandID)
00658     {
00659         ATLASSERT(::IsWindow(m_hWnd));
00660         HICON hIcon = ::LoadIcon(_Module.GetResourceInstance(), icon.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>);
00661         <font class="keywordflow">if</font>(hIcon == NULL)
00662             <font class="keywordflow">return</font> FALSE;
00663         <font class="keywordflow">return</font> AddIcon(hIcon, nCommandID);
00664     }
00665 
00666     BOOL AddIcon(HICON hIcon, UINT nCommandID)
00667     {
00668         ATLASSERT(::IsWindow(m_hWnd));
00669         <font class="comment">// create image list if it doesn't exist</font>
00670         <font class="keywordflow">if</font>(m_hImageList == NULL)
00671         {
00672             T* pT = static_cast&lt;T*&gt;(this);
00673             <font class="keywordflow">if</font>(!pT-&gt;CreateInternalImageList(1))
00674                 <font class="keywordflow">return</font> FALSE;
00675         }
00676 
00677         <font class="keywordtype">int</font> nRet = ::ImageList_AddIcon(m_hImageList, hIcon);
00678         <font class="keywordflow">if</font>(nRet == -1)
00679             <font class="keywordflow">return</font> FALSE;
00680         BOOL bRet = m_arrCommand.Add((WORD)nCommandID);
00681         ATLASSERT(::ImageList_GetImageCount(m_hImageList) == m_arrCommand.GetSize());
00682         <font class="keywordflow">return</font> bRet;
00683     }
00684 
00685     BOOL ReplaceBitmap(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> bitmap, <font class="keywordtype">int</font> nCommandID)
00686     {
00687         ATLASSERT(::IsWindow(m_hWnd));
00688         <a class="code" href="namespaceWTL.html#a42">CBitmap</a> bmp;
00689         bmp.LoadBitmap(bitmap.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>);
00690         <font class="keywordflow">if</font>(bmp.m_hBitmap == NULL)
00691             <font class="keywordflow">return</font> FALSE;
00692         <font class="keywordflow">return</font> ReplaceBitmap(bmp, nCommandID);
00693     }
00694 
00695     BOOL ReplaceBitmap(HBITMAP hBitmap, UINT nCommandID)
00696     {
00697         ATLASSERT(::IsWindow(m_hWnd));
00698         BOOL bRet = FALSE;
00699         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; m_arrCommand.GetSize(); i++)
00700         {
00701             <font class="keywordflow">if</font>(m_arrCommand[i] == nCommandID)
00702             {
00703                 bRet = ::ImageList_Remove(m_hImageList, i);
00704                 <font class="keywordflow">if</font>(bRet)
00705                     m_arrCommand.RemoveAt(i);
00706                 <font class="keywordflow">break</font>;
00707             }
00708         }
00709         <font class="keywordflow">if</font>(bRet)
00710             bRet = AddBitmap(hBitmap, nCommandID);
00711         <font class="keywordflow">return</font> bRet;
00712     }
00713 
00714     BOOL ReplaceIcon(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> icon, UINT nCommandID)
00715     {
00716         ATLASSERT(::IsWindow(m_hWnd));
00717         HICON hIcon = ::LoadIcon(_Module.GetResourceInstance(), icon.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>);
00718         <font class="keywordflow">if</font>(hIcon == NULL)
00719             <font class="keywordflow">return</font> FALSE;
00720         <font class="keywordflow">return</font> ReplaceIcon(hIcon, nCommandID);
00721     }
00722 
00723     BOOL ReplaceIcon(HICON hIcon, UINT nCommandID)
00724     {
00725         ATLASSERT(::IsWindow(m_hWnd));
00726         BOOL bRet = FALSE;
00727         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; m_arrCommand.GetSize(); i++)
00728         {
00729             <font class="keywordflow">if</font>(m_arrCommand[i] == nCommandID)
00730             {
00731                 bRet = (::ImageList_ReplaceIcon(m_hImageList, i, hIcon) != -1);
00732                 <font class="keywordflow">break</font>;
00733             }
00734         }
00735         <font class="keywordflow">return</font> bRet;
00736     }
00737 
00738     BOOL RemoveImage(<font class="keywordtype">int</font> nCommandID)
00739     {
00740         ATLASSERT(::IsWindow(m_hWnd));
00741 
00742         BOOL bRet = FALSE;
00743         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; m_arrCommand.GetSize(); i++)
00744         {
00745             <font class="keywordflow">if</font>(m_arrCommand[i] == nCommandID)
00746             {
00747                 bRet = ::ImageList_Remove(m_hImageList, i);
00748                 <font class="keywordflow">if</font>(bRet)
00749                     m_arrCommand.RemoveAt(i);
00750                 <font class="keywordflow">break</font>;
00751             }
00752         }
00753         <font class="keywordflow">return</font> bRet;
00754     }
00755 
00756     BOOL RemoveAllImages()
00757     {
00758         ATLASSERT(::IsWindow(m_hWnd));
00759 
00760         ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Removing all images\n"</font>);
00761         BOOL bRet = ::ImageList_RemoveAll(m_hImageList);
00762         <font class="keywordflow">if</font>(bRet)
00763             m_arrCommand.RemoveAll();
00764         <font class="keywordflow">return</font> bRet;
00765     }
00766 
00767     BOOL TrackPopupMenu(HMENU hMenu, UINT uFlags, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, LPTPMPARAMS lpParams = NULL)
00768     {
00769         ATLASSERT(::IsWindow(m_hWnd));
00770         ATLASSERT(::IsMenu(hMenu));
00771         <font class="keywordflow">if</font>(!::IsMenu(hMenu))
00772             <font class="keywordflow">return</font> FALSE;
00773         m_bContextMenu = <font class="keyword">true</font>;
00774         <font class="keywordflow">if</font>(m_bUseKeyboardCues)
00775             m_bShowKeyboardCues = m_bKeyboardInput;
00776         T* pT = static_cast&lt;T*&gt;(this);
00777         <font class="keywordflow">return</font> pT-&gt;DoTrackPopupMenu(hMenu, uFlags, x, y, lpParams);
00778     }
00779 
00780     BOOL SetMDIClient(HWND <font class="comment">/*hWndMDIClient*/</font>)
00781     {
00782         <font class="comment">// Use CMDICommandBarCtrl for MDI support</font>
00783         ATLASSERT(FALSE);
00784         <font class="keywordflow">return</font> FALSE;
00785     }
00786 
00787 <font class="comment">// Message map and handlers</font>
00788     BEGIN_MSG_MAP(<a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl</a>)
00789         MESSAGE_HANDLER(WM_CREATE, OnCreate)
00790         MESSAGE_HANDLER(WM_DESTROY, OnDestroy)
00791         MESSAGE_HANDLER(WM_ERASEBKGND, OnEraseBackground)
00792         MESSAGE_HANDLER(WM_INITMENU, OnInitMenu)
00793         MESSAGE_HANDLER(WM_INITMENUPOPUP, OnInitMenuPopup)
00794         MESSAGE_HANDLER(WM_MENUSELECT, OnMenuSelect)
00795         MESSAGE_HANDLER(GetAutoPopupMessage(), OnInternalAutoPopup)
00796         MESSAGE_HANDLER(GetGetBarMessage(), OnInternalGetBar)
00797         MESSAGE_HANDLER(WM_SETTINGCHANGE, OnSettingChange)
00798         MESSAGE_HANDLER(WM_MENUCHAR, OnMenuChar)
00799 
00800         MESSAGE_HANDLER(WM_KEYDOWN, OnKeyDown)
00801         MESSAGE_HANDLER(WM_KEYUP, OnKeyUp)
00802         MESSAGE_HANDLER(WM_CHAR, OnChar)
00803         MESSAGE_HANDLER(WM_SYSKEYDOWN, OnSysKeyDown)
00804         MESSAGE_HANDLER(WM_SYSKEYUP, OnSysKeyUp)
00805         MESSAGE_HANDLER(WM_SYSCHAR, OnSysChar)
00806 <font class="comment">// public API handlers - these stay to support chevrons in atlframe.h</font>
00807         MESSAGE_HANDLER(<a class="code" href="atlctrlw_8h.html#a11">CBRM_GETMENU</a>, OnAPIGetMenu)
00808         MESSAGE_HANDLER(<a class="code" href="atlctrlw_8h.html#a12">CBRM_TRACKPOPUPMENU</a>, OnAPITrackPopupMenu)
00809         MESSAGE_HANDLER(<a class="code" href="atlctrlw_8h.html#a10">CBRM_GETCMDBAR</a>, OnAPIGetCmdBar)
00810 
00811         MESSAGE_HANDLER(WM_DRAWITEM, OnDrawItem)
00812         MESSAGE_HANDLER(WM_MEASUREITEM, OnMeasureItem)
00813 
00814         MESSAGE_HANDLER(WM_FORWARDMSG, OnForwardMsg)
00815     ALT_MSG_MAP(1)      <font class="comment">// Parent window messages</font>
00816         NOTIFY_CODE_HANDLER(TBN_HOTITEMCHANGE, OnParentHotItemChange)
00817         NOTIFY_CODE_HANDLER(TBN_DROPDOWN, OnParentDropDown)
00818         MESSAGE_HANDLER(WM_INITMENUPOPUP, OnParentInitMenuPopup)
00819         MESSAGE_HANDLER(GetGetBarMessage(), OnParentInternalGetBar)
00820         MESSAGE_HANDLER(WM_SYSCOMMAND, OnParentSysCommand)
00821         MESSAGE_HANDLER(<a class="code" href="atlctrlw_8h.html#a11">CBRM_GETMENU</a>, OnParentAPIGetMenu)
00822         MESSAGE_HANDLER(WM_MENUCHAR, OnParentMenuChar)
00823         MESSAGE_HANDLER(<a class="code" href="atlctrlw_8h.html#a12">CBRM_TRACKPOPUPMENU</a>, OnParentAPITrackPopupMenu)
00824         MESSAGE_HANDLER(<a class="code" href="atlctrlw_8h.html#a10">CBRM_GETCMDBAR</a>, OnParentAPIGetCmdBar)
00825 
00826         MESSAGE_HANDLER(WM_DRAWITEM, OnParentDrawItem)
00827         MESSAGE_HANDLER(WM_MEASUREITEM, OnParentMeasureItem)
00828 
00829         MESSAGE_HANDLER(WM_ACTIVATE, OnParentActivate)
00830         NOTIFY_CODE_HANDLER(NM_CUSTOMDRAW, OnParentCustomDraw)
00831     ALT_MSG_MAP(2)      <font class="comment">// MDI client window messages</font>
00832         <font class="comment">// Use CMDICommandBarCtrl for MDI support</font>
00833     ALT_MSG_MAP(3)      <font class="comment">// Message hook messages</font>
00834         MESSAGE_HANDLER(WM_MOUSEMOVE, OnHookMouseMove)
00835         MESSAGE_HANDLER(WM_SYSKEYDOWN, OnHookSysKeyDown)
00836         MESSAGE_HANDLER(WM_SYSKEYUP, OnHookSysKeyUp)
00837         MESSAGE_HANDLER(WM_SYSCHAR, OnHookSysChar)
00838         MESSAGE_HANDLER(WM_KEYDOWN, OnHookKeyDown)
00839         MESSAGE_HANDLER(WM_NEXTMENU, OnHookNextMenu)
00840         MESSAGE_HANDLER(WM_CHAR, OnHookChar)
00841     END_MSG_MAP()
00842 
00843     LRESULT OnForwardMsg(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00844     {
00845         LPMSG pMsg = (LPMSG)lParam;
00846         <font class="keywordflow">if</font>(pMsg-&gt;message &gt;= WM_MOUSEFIRST &amp;&amp; pMsg-&gt;message &lt;= WM_MOUSELAST)
00847             m_bKeyboardInput = <font class="keyword">false</font>;
00848         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(pMsg-&gt;message &gt;= WM_KEYFIRST &amp;&amp; pMsg-&gt;message &lt;= WM_KEYLAST)
00849             m_bKeyboardInput = <font class="keyword">true</font>;
00850         LRESULT lRet = 0;
00851         ProcessWindowMessage(pMsg-&gt;hwnd, pMsg-&gt;message, pMsg-&gt;wParam, pMsg-&gt;lParam, lRet, 3);
00852         <font class="keywordflow">return</font> lRet;
00853     }
00854 
00855     LRESULT OnCreate(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00856     {
00857         <font class="comment">// Let the toolbar initialize itself</font>
00858         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
00859         <font class="comment">// get and use system settings</font>
00860         T* pT = static_cast&lt;T*&gt;(this);
00861         pT-&gt;GetSystemSettings();
00862         <font class="comment">// Parent init</font>
00863         <a class="code" href="classCWindow.html">CWindow</a> wndParent = GetParent();
00864         <a class="code" href="classCWindow.html">CWindow</a> wndTopLevelParent = wndParent.GetTopLevelParent();
00865         m_wndParent.SubclassWindow(wndTopLevelParent);
00866         <font class="comment">// Toolbar Init</font>
00867         SetButtonStructSize();
00868         SetImageList(NULL);
00869 
00870         <font class="comment">// Create message hook if needed</font>
00871         ::EnterCriticalSection(&amp;_Module.m_csWindowCreate);
00872         <font class="keywordflow">if</font>(s_pmapMsgHook == NULL)
00873         {
00874             ATLTRY(s_pmapMsgHook = <font class="keyword">new</font> CMsgHookMap);
00875             ATLASSERT(s_pmapMsgHook != NULL);
00876         }
00877 
00878         <font class="keywordflow">if</font>(s_pmapMsgHook != NULL)
00879         {
00880             DWORD dwThreadID = ::GetCurrentThreadId();
00881             _MsgHookData* pData = s_pmapMsgHook-&gt;Lookup(dwThreadID);
00882             <font class="keywordflow">if</font>(pData == NULL)
00883             {
00884                 ATLTRY(pData = <font class="keyword">new</font> _MsgHookData);
00885                 ATLASSERT(pData != NULL);
00886                 HHOOK hMsgHook = ::SetWindowsHookEx(WH_GETMESSAGE, MessageHookProc, _Module.GetModuleInstance(), dwThreadID);
00887                 ATLASSERT(hMsgHook != NULL);
00888                 <font class="keywordflow">if</font>(pData != NULL &amp;&amp; hMsgHook != NULL)
00889                 {
00890                     pData-&gt;hMsgHook = hMsgHook;
00891                     pData-&gt;dwUsage = 1;
00892                     BOOL bRet = s_pmapMsgHook-&gt;Add(dwThreadID, pData);
00893                     bRet;
00894                     ATLASSERT(bRet);
00895                 }
00896             }
00897             <font class="keywordflow">else</font>
00898             {
00899                 (pData-&gt;dwUsage)++;
00900             }
00901         }
00902         ::LeaveCriticalSection(&amp;_Module.m_csWindowCreate);
00903 
00904         <font class="keywordflow">return</font> lRet;
00905     }
00906 
00907     LRESULT OnDestroy(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00908     {
00909         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
00910         ::EnterCriticalSection(&amp;_Module.m_csWindowCreate);
00911         <font class="keywordflow">if</font>(s_pmapMsgHook != NULL)
00912         {
00913             DWORD dwThreadID = ::GetCurrentThreadId();
00914             _MsgHookData* pData = s_pmapMsgHook-&gt;Lookup(dwThreadID);
00915             <font class="keywordflow">if</font>(pData != NULL)
00916             {
00917                 (pData-&gt;dwUsage)--;
00918                 <font class="keywordflow">if</font>(pData-&gt;dwUsage == 0)
00919                 {
00920                     BOOL bRet = ::UnhookWindowsHookEx(pData-&gt;hMsgHook);
00921                     ATLASSERT(bRet);
00922                     bRet = s_pmapMsgHook-&gt;Remove(dwThreadID);
00923                     ATLASSERT(bRet);
00924                     <font class="keywordflow">if</font>(bRet)
00925                         <font class="keyword">delete</font> pData;
00926                 }
00927 
00928                 <font class="keywordflow">if</font>(s_pmapMsgHook-&gt;GetSize() == 0)
00929                 {
00930                     <font class="keyword">delete</font> s_pmapMsgHook;
00931                     s_pmapMsgHook = NULL;
00932                 }
00933             }
00934         }
00935         ::LeaveCriticalSection(&amp;_Module.m_csWindowCreate);
00936         <font class="keywordflow">return</font> lRet;
00937     }
00938 
00939     LRESULT OnKeyDown(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
00940     {
00941 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
00942 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnKeyDown\n"</font>);
00943 <font class="preprocessor">#endif</font>
00944 <font class="preprocessor"></font>        bHandled = FALSE;
00945         <font class="comment">// Simulate Alt+Space for the parent</font>
00946         <font class="keywordflow">if</font>(wParam == VK_SPACE)
00947         {
00948             m_wndParent.PostMessage(WM_SYSKEYDOWN, wParam, lParam | (1 &lt;&lt; 29));
00949             bHandled = TRUE;
00950         }
00951 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
00952 <font class="preprocessor"></font>        <font class="keywordflow">else</font> <font class="keywordflow">if</font>(wParam == VK_LEFT || wParam == VK_RIGHT)
00953         {
00954 <font class="preprocessor">#if (WINVER &gt;= 0x0500)</font>
00955 <font class="preprocessor"></font>            <font class="keywordtype">bool</font> bRTL = ((GetExStyle() &amp; WS_EX_LAYOUTRTL) != 0);
00956             WPARAM wpNext = bRTL ? VK_LEFT : VK_RIGHT;
00957 <font class="preprocessor">#else // !(WINVER &gt;= 0x0500)</font>
00958 <font class="preprocessor"></font>            WPARAM wpNext = VK_RIGHT;
00959 <font class="preprocessor">#endif // !(WINVER &gt;= 0x0500)</font>
00960 <font class="preprocessor"></font>            <font class="keywordflow">if</font>(!m_bMenuActive)
00961             {
00962                 T* pT = static_cast&lt;T*&gt;(this);
00963                 <font class="keywordtype">int</font> nBtn = GetHotItem();
00964                 <font class="keywordtype">int</font> nNextBtn = (wParam == wpNext) ? pT-&gt;GetNextMenuItem(nBtn) : pT-&gt;GetPreviousMenuItem(nBtn);
00965                 <font class="keywordflow">if</font>(nNextBtn == -2)
00966                 {
00967                     SetHotItem(-1);
00968                     <font class="keywordflow">if</font>(pT-&gt;DisplayChevronMenu())
00969                         bHandled = TRUE;
00970                 }
00971             }
00972         }
00973 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
00974 <font class="preprocessor"></font>        <font class="keywordflow">return</font> 0;
00975     }
00976 
00977     LRESULT OnKeyUp(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
00978     {
00979 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
00980 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnKeyUp\n"</font>);
00981 <font class="preprocessor">#endif</font>
00982 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(wParam != VK_SPACE)
00983             bHandled = FALSE;
00984         <font class="keywordflow">return</font> 0;
00985     }
00986 
00987     LRESULT OnChar(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
00988     {
00989 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
00990 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnChar\n"</font>);
00991 <font class="preprocessor">#endif</font>
00992 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(wParam != VK_SPACE)
00993             bHandled = FALSE;
00994         <font class="keywordflow">else</font>
00995             <font class="keywordflow">return</font> 0;
00996         <font class="comment">// Security</font>
00997         <font class="keywordflow">if</font>(!m_wndParent.IsWindowEnabled() || ::GetFocus() != m_hWnd)
00998             <font class="keywordflow">return</font> 0;
00999 
01000         <font class="comment">// Handle mnemonic press when we have focus</font>
01001         <font class="keywordtype">int</font> nBtn = 0;
01002         <font class="keywordflow">if</font>(wParam != VK_RETURN &amp;&amp; !MapAccelerator((TCHAR)LOWORD(wParam), nBtn))
01003         {
01004 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01005 <font class="preprocessor"></font>            <font class="keywordflow">if</font>((TCHAR)LOWORD(wParam) != _chChevronShortcut)
01006 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01007 <font class="preprocessor"></font>                ::MessageBeep(0);
01008         }
01009         <font class="keywordflow">else</font>
01010         {
01011 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01012 <font class="preprocessor"></font>            RECT rcClient;
01013             GetClientRect(&amp;rcClient);
01014             RECT rcBtn;
01015             GetItemRect(nBtn, &amp;rcBtn);
01016             TBBUTTON tbb = { 0 };
01017             GetButton(nBtn, &amp;tbb);
01018             <font class="keywordflow">if</font>((tbb.fsState &amp; TBSTATE_ENABLED) != 0 &amp;&amp; (tbb.fsState &amp; TBSTATE_HIDDEN) == 0 &amp;&amp; rcBtn.right &lt;= rcClient.right)
01019             {
01020 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01021 <font class="preprocessor"></font>                PostMessage(WM_KEYDOWN, VK_DOWN, 0L);
01022                 <font class="keywordflow">if</font>(wParam != VK_RETURN)
01023                     SetHotItem(nBtn);
01024 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01025 <font class="preprocessor"></font>            }
01026             <font class="keywordflow">else</font>
01027             {
01028                 ::MessageBeep(0);
01029                 bHandled = TRUE;
01030             }
01031 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01032 <font class="preprocessor"></font>        }
01033         <font class="keywordflow">return</font> 0;
01034     }
01035 
01036     LRESULT OnSysKeyDown(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01037     {
01038 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01039 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnSysKeyDown\n"</font>);
01040 <font class="preprocessor">#endif</font>
01041 <font class="preprocessor"></font>        bHandled = FALSE;
01042         <font class="keywordflow">return</font> 0;
01043     }
01044 
01045     LRESULT OnSysKeyUp(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01046     {
01047 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01048 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnSysKeyUp\n"</font>);
01049 <font class="preprocessor">#endif</font>
01050 <font class="preprocessor"></font>        bHandled = FALSE;
01051         <font class="keywordflow">return</font> 0;
01052     }
01053 
01054     LRESULT OnSysChar(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01055     {
01056 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01057 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnSysChar\n"</font>);
01058 <font class="preprocessor">#endif</font>
01059 <font class="preprocessor"></font>        bHandled = FALSE;
01060         <font class="keywordflow">return</font> 0;
01061     }
01062 
01063     LRESULT OnEraseBackground(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01064     {
01065         <font class="keywordflow">if</font>(m_bAttachedMenu || (m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a5">CBR_EX_TRANSPARENT</a>))
01066         {
01067             bHandled = FALSE;
01068             <font class="keywordflow">return</font> 0;
01069         }
01070 
01071         <a class="code" href="namespaceWTL.html#a47">CDCHandle</a> dc = (HDC)wParam;
01072         RECT rect;
01073         GetClientRect(&amp;rect);
01074         dc.FillRect(&amp;rect, COLOR_MENU);
01075 
01076         <font class="keywordflow">return</font> 1;   <font class="comment">// don't do the default erase</font>
01077     }
01078 
01079     LRESULT OnInitMenu(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01080     {
01081         <font class="keywordtype">int</font> nIndex = GetHotItem();
01082         SendMessage(WM_MENUSELECT, MAKEWPARAM(nIndex, MF_POPUP|MF_HILITE), (LPARAM)m_hMenu);
01083         bHandled = FALSE;
01084         <font class="keywordflow">return</font> 1;
01085     }
01086 
01087     LRESULT OnInitMenuPopup(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01088     {
01089         <font class="keywordflow">if</font>((BOOL)HIWORD(lParam))    <font class="comment">// System menu, do nothing</font>
01090         {
01091             bHandled = FALSE;
01092             <font class="keywordflow">return</font> 1;
01093         }
01094 
01095         <font class="keywordflow">if</font>(!(m_bAttachedMenu || m_bMenuActive))     <font class="comment">// Not attached or ours, do nothing</font>
01096         {
01097             bHandled = FALSE;
01098             <font class="keywordflow">return</font> 1;
01099         }
01100 
01101 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01102 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnInitMenuPopup\n"</font>);
01103 <font class="preprocessor">#endif</font>
01104 <font class="preprocessor"></font>        <font class="comment">// forward to the parent or subclassed window, so it can handle update UI</font>
01105         LRESULT lRet = 0;
01106         <font class="keywordflow">if</font>(m_bAttachedMenu)
01107             lRet = DefWindowProc(uMsg, wParam, (lParam || m_bContextMenu) ? lParam : GetHotItem());
01108         <font class="keywordflow">else</font>
01109             lRet = m_wndParent.DefWindowProc(uMsg, wParam, (lParam || m_bContextMenu) ? lParam : GetHotItem());
01110 
01111         <font class="comment">// Convert menu items to ownerdraw, add our data</font>
01112         <font class="keywordflow">if</font>(m_bImagesVisible)
01113         {
01114             <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> menuPopup = (HMENU)wParam;
01115             ATLASSERT(menuPopup.m_hMenu != NULL);
01116 
01117             T* pT = static_cast&lt;T*&gt;(this);
01118             pT; <font class="comment">// avoid level 4 warning</font>
01119             TCHAR szString[pT-&gt;_nMaxMenuItemTextLength];
01120             BOOL bRet;
01121             <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; menuPopup.GetMenuItemCount(); i++)
01122             {
01123                 <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> mii;
01124                 mii.cch = pT-&gt;_nMaxMenuItemTextLength;
01125                 mii.fMask = MIIM_CHECKMARKS | MIIM_DATA | MIIM_ID | MIIM_STATE | MIIM_SUBMENU | MIIM_TYPE;
01126                 mii.dwTypeData = szString;
01127                 bRet = menuPopup.GetMenuItemInfo(i, TRUE, &amp;mii);
01128                 ATLASSERT(bRet);
01129 
01130                 <font class="keywordflow">if</font>(!(mii.fType &amp; MFT_OWNERDRAW))    <font class="comment">// Not already an ownerdraw item</font>
01131                 {
01132                     mii.fMask = MIIM_DATA | MIIM_TYPE | MIIM_STATE;
01133                     _MenuItemData* pMI = NULL;
01134                     ATLTRY(pMI = <font class="keyword">new</font> _MenuItemData);
01135                     ATLASSERT(pMI != NULL);
01136                     <font class="keywordflow">if</font>(pMI != NULL)
01137                     {
01138                         pMI-&gt;fType = mii.fType;
01139                         pMI-&gt;fState = mii.fState;
01140                         mii.fType |= MFT_OWNERDRAW;
01141                         pMI-&gt;iButton = -1;
01142                         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> j = 0; j &lt; m_arrCommand.GetSize(); j++)
01143                         {
01144                             <font class="keywordflow">if</font>(m_arrCommand[j] == mii.wID)
01145                             {
01146                                 pMI-&gt;iButton = j;
01147                                 <font class="keywordflow">break</font>;
01148                             }
01149                         }
01150                         pMI-&gt;lpstrText = NULL;
01151                         ATLTRY(pMI-&gt;lpstrText = <font class="keyword">new</font> TCHAR[lstrlen(szString) + 1]);
01152                         ATLASSERT(pMI-&gt;lpstrText != NULL);
01153                         <font class="keywordflow">if</font>(pMI-&gt;lpstrText != NULL)
01154                             lstrcpy(pMI-&gt;lpstrText, szString);
01155                         mii.dwItemData = (ULONG_PTR)pMI;
01156                         bRet = menuPopup.SetMenuItemInfo(i, TRUE, &amp;mii);
01157                         ATLASSERT(bRet);
01158                     }
01159                 }
01160             }
01161 
01162             <font class="comment">// Add it to the list</font>
01163             m_stackMenuHandle.Push(menuPopup.m_hMenu);
01164         }
01165 
01166         <font class="keywordflow">return</font> lRet;
01167     }
01168 
01169     LRESULT OnMenuSelect(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01170     {
01171         <font class="keywordflow">if</font>(!m_bAttachedMenu)    <font class="comment">// Not attached, do nothing, forward to parent</font>
01172         {
01173             m_bPopupItem = (lParam != NULL) &amp;&amp; ((HMENU)lParam != m_hMenu) &amp;&amp; (HIWORD(wParam) &amp; MF_POPUP);
01174             <font class="keywordflow">if</font>(m_wndParent.IsWindow())
01175                 m_wndParent.SendMessage(uMsg, wParam, lParam);
01176             bHandled = FALSE;
01177             <font class="keywordflow">return</font> 1;
01178         }
01179 
01180         <font class="comment">// Check if a menu is closing, do a cleanup</font>
01181         <font class="keywordflow">if</font>(HIWORD(wParam) == 0xFFFF &amp;&amp; lParam == NULL)  <font class="comment">// Menu closing</font>
01182         {
01183 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01184 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnMenuSelect - CLOSING!!!!\n"</font>);
01185 <font class="preprocessor">#endif</font>
01186 <font class="preprocessor"></font>            ATLASSERT(m_stackMenuWnd.GetSize() == 0);
01187             <font class="comment">// Restore the menu items to the previous state for all menus that were converted</font>
01188             <font class="keywordflow">if</font>(m_bImagesVisible)
01189             {
01190                 HMENU hMenu;
01191                 <font class="keywordflow">while</font>((hMenu = m_stackMenuHandle.Pop()) != NULL)
01192                 {
01193                     <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> menuPopup = hMenu;
01194                     ATLASSERT(menuPopup.m_hMenu != NULL);
01195                     <font class="comment">// Restore state and delete menu item data</font>
01196                     BOOL bRet;
01197                     <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; menuPopup.GetMenuItemCount(); i++)
01198                     {
01199                         <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> mii;
01200                         mii.fMask = MIIM_DATA | MIIM_TYPE;
01201                         bRet = menuPopup.GetMenuItemInfo(i, TRUE, &amp;mii);
01202                         ATLASSERT(bRet);
01203 
01204                         _MenuItemData* pMI = (_MenuItemData*)mii.dwItemData;
01205                         <font class="keywordflow">if</font>(pMI != NULL &amp;&amp; pMI-&gt;IsCmdBarMenuItem())
01206                         {
01207                             mii.fMask = MIIM_DATA | MIIM_TYPE | MIIM_STATE;
01208                             mii.fType = pMI-&gt;fType;
01209                             mii.dwTypeData = pMI-&gt;lpstrText;
01210                             mii.cch = lstrlen(pMI-&gt;lpstrText);
01211                             mii.dwItemData = NULL;
01212 
01213                             bRet = menuPopup.SetMenuItemInfo(i, TRUE, &amp;mii);
01214                             ATLASSERT(bRet);
01215 
01216                             <font class="keyword">delete</font> [] pMI-&gt;lpstrText;
01217                             pMI-&gt;dwMagic = 0x6666;
01218                             <font class="keyword">delete</font> pMI;
01219                         }
01220                     }
01221                 }
01222             }
01223         }
01224 
01225         bHandled = FALSE;
01226         <font class="keywordflow">return</font> 1;
01227     }
01228 
01229     LRESULT OnInternalAutoPopup(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01230     {
01231         <font class="keywordtype">int</font> nIndex = (int)wParam;
01232         T* pT = static_cast&lt;T*&gt;(this);
01233         pT-&gt;DoPopupMenu(nIndex, <font class="keyword">false</font>);
01234         <font class="keywordflow">return</font> 0;
01235     }
01236 
01237     LRESULT OnInternalGetBar(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01238     {
01239         <font class="comment">// Let's make sure we're not embedded in another process</font>
01240         <font class="keywordflow">if</font>((LPVOID)wParam != NULL)
01241             *((DWORD*)wParam) = GetCurrentProcessId();
01242         <font class="keywordflow">if</font>(IsWindowVisible())
01243             <font class="keywordflow">return</font> (LRESULT)static_cast&lt;CCommandBarCtrlBase*&gt;(this);
01244         <font class="keywordflow">else</font>
01245             <font class="keywordflow">return</font> NULL;
01246     }
01247 
01248     LRESULT OnSettingChange(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01249     {
01250         T* pT = static_cast&lt;T*&gt;(this);
01251         pT-&gt;GetSystemSettings();
01252         <font class="keywordflow">return</font> 0;
01253     }
01254 
01255     LRESULT OnWindowPosChanging(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01256     {
01257         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
01258 
01259         LPWINDOWPOS lpWP = (LPWINDOWPOS)lParam;
01260         <font class="keywordtype">int</font> cyMin = ::GetSystemMetrics(SM_CYMENU);
01261         <font class="keywordflow">if</font>(lpWP-&gt;cy &lt; cyMin)
01262         lpWP-&gt;cy = cyMin;
01263 
01264         <font class="keywordflow">return</font> lRet;
01265     }
01266 
01267     LRESULT OnMenuChar(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01268     {
01269 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01270 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - OnMenuChar\n"</font>);
01271 <font class="preprocessor">#endif</font>
01272 <font class="preprocessor"></font>        bHandled = TRUE;
01273         T* pT = static_cast&lt;T*&gt;(this);
01274 
01275         LRESULT lRet;
01276         <font class="keywordflow">if</font>(m_bMenuActive &amp;&amp; LOWORD(wParam) != 0x0D)
01277             lRet = 0;
01278         <font class="keywordflow">else</font>
01279             lRet = MAKELRESULT(1, 1);
01280 
01281         <font class="keywordflow">if</font>(m_bMenuActive &amp;&amp; HIWORD(wParam) == MF_POPUP)
01282         {
01283             <font class="comment">// Convert character to lower/uppercase and possibly Unicode, using current keyboard layout</font>
01284             TCHAR ch = (TCHAR)LOWORD(wParam);
01285             <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> menu = (HMENU)lParam;
01286             <font class="keywordtype">int</font> nCount = ::GetMenuItemCount(menu);
01287             <font class="keywordtype">int</font> nRetCode = MNC_EXECUTE;
01288             BOOL bRet;
01289             TCHAR szString[pT-&gt;_nMaxMenuItemTextLength];
01290             WORD wMnem = 0;
01291             <font class="keywordtype">bool</font> bFound = <font class="keyword">false</font>;
01292             <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; nCount; i++)
01293             {
01294                 <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> mii;
01295                 mii.cch = pT-&gt;_nMaxMenuItemTextLength;
01296                 mii.fMask = MIIM_CHECKMARKS | MIIM_DATA | MIIM_ID | MIIM_STATE | MIIM_SUBMENU | MIIM_TYPE;
01297                 mii.dwTypeData = szString;
01298                 bRet = menu.GetMenuItemInfo(i, TRUE, &amp;mii);
01299                 <font class="keywordflow">if</font>(!bRet || (mii.fType &amp; MFT_SEPARATOR))
01300                     <font class="keywordflow">continue</font>;
01301                 _MenuItemData* pmd = (_MenuItemData*)mii.dwItemData;
01302                 <font class="keywordflow">if</font>(pmd != NULL &amp;&amp; pmd-&gt;IsCmdBarMenuItem())
01303                 {
01304                     LPTSTR p = pmd-&gt;lpstrText;
01305 
01306                     <font class="keywordflow">if</font>(p != NULL)
01307                     {
01308                         <font class="keywordflow">while</font>(*p &amp;&amp; *p != _T(<font class="charliteral">'&amp;'</font>))
01309                             p = ::CharNext(p);
01310                         <font class="keywordflow">if</font>(p != NULL &amp;&amp; *p)
01311                         {
01312                             DWORD dwP = MAKELONG(*(++p), 0);
01313                             DWORD dwC = MAKELONG(ch, 0);
01314                             <font class="keywordflow">if</font>(::CharLower((LPTSTR)<a class="code" href="atlapp_8h.html#a25">ULongToPtr</a>(dwP)) == ::CharLower((LPTSTR)<a class="code" href="atlapp_8h.html#a25">ULongToPtr</a>(dwC)))
01315                             {
01316                                 <font class="keywordflow">if</font>(!bFound)
01317                                 {
01318                                     wMnem = (WORD)i;
01319                                     bFound = <font class="keyword">true</font>;
01320                                 }
01321                                 <font class="keywordflow">else</font>
01322                                 {
01323                                     nRetCode = MNC_SELECT;
01324                                     <font class="keywordflow">break</font>;
01325                                 }
01326                             }
01327                         }
01328                     }
01329                 }
01330             }
01331             <font class="keywordflow">if</font>(bFound)
01332             {
01333                 <font class="keywordflow">if</font>(nRetCode == MNC_EXECUTE)
01334                 {
01335                     PostMessage(TB_SETHOTITEM, (WPARAM)-1, 0L);
01336                     pT-&gt;GiveFocusBack();
01337                 }
01338                 bHandled = TRUE;
01339                 lRet = MAKELRESULT(wMnem, nRetCode);
01340             }
01341         } 
01342         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(!m_bMenuActive)
01343         {
01344             <font class="keywordtype">int</font> nBtn = 0;
01345             <font class="keywordflow">if</font>(!MapAccelerator((TCHAR)LOWORD(wParam), nBtn))
01346             {
01347                 bHandled = FALSE;
01348                 PostMessage(TB_SETHOTITEM, (WPARAM)-1, 0L);
01349                 pT-&gt;GiveFocusBack();
01350 
01351 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01352 <font class="preprocessor"></font>                <font class="comment">// check if we should display chevron menu</font>
01353                 <font class="keywordflow">if</font>((TCHAR)LOWORD(wParam) == pT-&gt;_chChevronShortcut)
01354                 {
01355                     <font class="keywordflow">if</font>(pT-&gt;DisplayChevronMenu())
01356                         bHandled = TRUE;
01357                 }
01358 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01359 <font class="preprocessor"></font>            }
01360             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(m_wndParent.IsWindowEnabled())
01361             {
01362 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01363 <font class="preprocessor"></font>                RECT rcClient;
01364                 GetClientRect(&amp;rcClient);
01365                 RECT rcBtn;
01366                 GetItemRect(nBtn, &amp;rcBtn);
01367                 TBBUTTON tbb = { 0 };
01368                 GetButton(nBtn, &amp;tbb);
01369                 <font class="keywordflow">if</font>((tbb.fsState &amp; TBSTATE_ENABLED) != 0 &amp;&amp; (tbb.fsState &amp; TBSTATE_HIDDEN) == 0 &amp;&amp; rcBtn.right &lt;= rcClient.right)
01370                 {
01371 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01372 <font class="preprocessor"></font>                    <font class="keywordflow">if</font>(m_bUseKeyboardCues &amp;&amp; !m_bShowKeyboardCues)
01373                     {
01374                         m_bAllowKeyboardCues = <font class="keyword">true</font>;
01375                         ShowKeyboardCues(<font class="keyword">true</font>);
01376                     }
01377                     pT-&gt;TakeFocus();
01378                     PostMessage(WM_KEYDOWN, VK_DOWN, 0L);
01379                     SetHotItem(nBtn);
01380 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01381 <font class="preprocessor"></font>                }
01382                 <font class="keywordflow">else</font>
01383                 {
01384                     ::MessageBeep(0);
01385                 }
01386 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01387 <font class="preprocessor"></font>            }
01388         }
01389 
01390         <font class="keywordflow">return</font> lRet;
01391     }
01392 
01393     LRESULT OnDrawItem(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
01394     {
01395         LPDRAWITEMSTRUCT lpDrawItemStruct = (LPDRAWITEMSTRUCT)lParam;
01396         _MenuItemData* pmd = (_MenuItemData*)lpDrawItemStruct-&gt;itemData;
01397         <font class="keywordflow">if</font>(lpDrawItemStruct-&gt;CtlType == ODT_MENU &amp;&amp; pmd-&gt;IsCmdBarMenuItem())
01398         {
01399             T* pT = static_cast&lt;T*&gt;(this);
01400             pT-&gt;DrawItem(lpDrawItemStruct);
01401         }
01402         <font class="keywordflow">else</font>
01403         {
01404             bHandled = FALSE;
01405         }
01406         <font class="keywordflow">return</font> (LRESULT)TRUE;
01407     }
01408 
01409     LRESULT OnMeasureItem(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
01410     {
01411         LPMEASUREITEMSTRUCT lpMeasureItemStruct = (LPMEASUREITEMSTRUCT)lParam;
01412         _MenuItemData* pmd = (_MenuItemData*)lpMeasureItemStruct-&gt;itemData;
01413         <font class="keywordflow">if</font>(lpMeasureItemStruct-&gt;CtlType == ODT_MENU &amp;&amp; pmd-&gt;IsCmdBarMenuItem())
01414         {
01415             T* pT = static_cast&lt;T*&gt;(this);
01416             pT-&gt;MeasureItem(lpMeasureItemStruct);
01417         }
01418         <font class="keywordflow">else</font>
01419         {
01420             bHandled = FALSE;
01421         }
01422         <font class="keywordflow">return</font> (LRESULT)TRUE;
01423     }
01424 
01425 <font class="comment">// API message handlers</font>
01426     LRESULT OnAPIGetMenu(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01427     {
01428         <font class="keywordflow">return</font> (LRESULT)m_hMenu;
01429     }
01430 
01431     LRESULT OnAPITrackPopupMenu(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01432     {
01433         <font class="keywordflow">if</font>(lParam == NULL)
01434             <font class="keywordflow">return</font> FALSE;
01435         <a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html">LPCBRPOPUPMENU</a> lpCBRPopupMenu = (LPCBRPOPUPMENU)lParam;
01436         <font class="keywordflow">if</font>(lpCBRPopupMenu-&gt;<a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m0">cbSize</a> != <font class="keyword">sizeof</font>(CBRPOPUPMENU))
01437             <font class="keywordflow">return</font> FALSE;
01438 
01439         T* pT = static_cast&lt;T*&gt;(this);
01440         <font class="keywordflow">return</font> pT-&gt;TrackPopupMenu(lpCBRPopupMenu-&gt;<a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m1">hMenu</a>, lpCBRPopupMenu-&gt;<a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m2">uFlags</a>, lpCBRPopupMenu-&gt;<a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m3">x</a>, lpCBRPopupMenu-&gt;<a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m4">y</a>, lpCBRPopupMenu-&gt;<a class="code" href="structWTL_1_1tagCBRPOPUPMENU.html#m5">lptpm</a>);
01441     }
01442 
01443     LRESULT OnAPIGetCmdBar(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01444     {
01445         <font class="keywordflow">return</font> (LRESULT)m_hWnd;
01446     }
01447 
01448 <font class="comment">// Parent window message handlers</font>
01449     LRESULT OnParentHotItemChange(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; bHandled)
01450     {
01451         LPNMTBHOTITEM lpNMHT = (LPNMTBHOTITEM)pnmh;
01452 
01453         <font class="comment">// Check if this comes from us</font>
01454         <font class="keywordflow">if</font>(pnmh-&gt;hwndFrom != m_hWnd)
01455         {
01456             bHandled = FALSE;
01457             <font class="keywordflow">return</font> 0;
01458         }
01459 
01460         <font class="keywordtype">bool</font> bBlockTracking = <font class="keyword">false</font>;
01461         <font class="keywordflow">if</font>((m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a8">CBR_EX_TRACKALWAYS</a>) == 0)
01462         {
01463             DWORD dwProcessID;
01464             ::GetWindowThreadProcessId(::GetActiveWindow(), &amp;dwProcessID);
01465             bBlockTracking = (::GetCurrentProcessId() != dwProcessID);
01466         }
01467 
01468         <font class="keywordflow">if</font>((!m_wndParent.IsWindowEnabled() || bBlockTracking) &amp;&amp; (lpNMHT-&gt;dwFlags &amp; HICF_MOUSE))
01469         {
01470             <font class="keywordflow">return</font> 1;
01471         }
01472         <font class="keywordflow">else</font>
01473         {
01474 <font class="preprocessor">#ifndef HICF_LMOUSE</font>
01475 <font class="preprocessor"></font>            <font class="keyword">const</font> DWORD HICF_LMOUSE = 0x00000080;   <font class="comment">// left mouse button selected</font>
01476 <font class="preprocessor">#endif</font>
01477 <font class="preprocessor"></font>            bHandled = FALSE;
01478 
01479             <font class="comment">// Send WM_MENUSELECT to the app if it needs to display a status text</font>
01480             <font class="keywordflow">if</font>(!(lpNMHT-&gt;dwFlags &amp; HICF_MOUSE)  
01481                 &amp;&amp; !(lpNMHT-&gt;dwFlags &amp; HICF_ACCELERATOR)
01482                 &amp;&amp; !(lpNMHT-&gt;dwFlags &amp; HICF_LMOUSE))
01483             {
01484                 <font class="keywordflow">if</font>(lpNMHT-&gt;dwFlags &amp; HICF_ENTERING)
01485                     m_wndParent.SendMessage(WM_MENUSELECT, 0, (LPARAM)m_hMenu);
01486                 <font class="keywordflow">if</font>(lpNMHT-&gt;dwFlags &amp; HICF_LEAVING)
01487                     m_wndParent.SendMessage(WM_MENUSELECT, MAKEWPARAM(0, 0xFFFF), NULL);
01488             }
01489 
01490             <font class="keywordflow">return</font> 0;
01491         }
01492     }
01493 
01494     LRESULT OnParentDropDown(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; bHandled)
01495     {
01496         <font class="comment">// Check if this comes from us</font>
01497         <font class="keywordflow">if</font>(pnmh-&gt;hwndFrom != m_hWnd)
01498         {
01499             bHandled = FALSE;
01500             <font class="keywordflow">return</font> 1;
01501         }
01502 
01503         T* pT = static_cast&lt;T*&gt;(this);
01504         <font class="keywordflow">if</font>(::GetFocus() != m_hWnd)
01505             pT-&gt;TakeFocus();
01506         LPNMTOOLBAR pNMToolBar = (LPNMTOOLBAR)pnmh;
01507         <font class="keywordtype">int</font> nIndex = CommandToIndex(pNMToolBar-&gt;iItem);
01508         m_bContextMenu = <font class="keyword">false</font>;
01509         m_bEscapePressed = <font class="keyword">false</font>;
01510         pT-&gt;DoPopupMenu(nIndex, <font class="keyword">true</font>);
01511 
01512         <font class="keywordflow">return</font> TBDDRET_DEFAULT;
01513     }
01514 
01515     LRESULT OnParentInitMenuPopup(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01516     {
01517         <font class="keywordflow">return</font> OnInitMenuPopup(uMsg, wParam, lParam, bHandled);
01518     }
01519 
01520     LRESULT OnParentInternalGetBar(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01521     {
01522         <font class="keywordflow">return</font> OnInternalGetBar(uMsg, wParam, lParam, bHandled);
01523     }
01524 
01525     LRESULT OnParentSysCommand(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01526     {
01527         bHandled = FALSE;
01528         <font class="keywordflow">if</font>((m_uSysKey == VK_MENU 
01529             || (m_uSysKey == VK_F10 &amp;&amp; !(::GetKeyState(VK_SHIFT) &amp; 0x80))
01530             || m_uSysKey == VK_SPACE) 
01531             &amp;&amp; wParam == SC_KEYMENU)
01532         {
01533             T* pT = static_cast&lt;T*&gt;(this);
01534             <font class="keywordflow">if</font>(::GetFocus() == m_hWnd)
01535             {
01536                 pT-&gt;GiveFocusBack();        <font class="comment">// exit menu "loop"</font>
01537                 PostMessage(TB_SETHOTITEM, (WPARAM)-1, 0L);
01538             }
01539             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(m_uSysKey != VK_SPACE &amp;&amp; !m_bSkipMsg)
01540             {
01541                 <font class="keywordflow">if</font>(m_bUseKeyboardCues &amp;&amp; !m_bShowKeyboardCues &amp;&amp; m_bAllowKeyboardCues)
01542                     ShowKeyboardCues(<font class="keyword">true</font>);
01543 
01544                 pT-&gt;TakeFocus();            <font class="comment">// enter menu "loop"</font>
01545                 bHandled = TRUE;
01546             }
01547             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(m_uSysKey != VK_SPACE)
01548             {
01549                 bHandled = TRUE;
01550             }
01551         }
01552         m_bSkipMsg = <font class="keyword">false</font>;
01553         <font class="keywordflow">return</font> 0;
01554     }
01555 
01556     LRESULT OnParentAPIGetMenu(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01557     {
01558         <font class="keywordflow">return</font> OnAPIGetMenu(uMsg, wParam, lParam, bHandled);
01559     }
01560 
01561     LRESULT OnParentMenuChar(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01562     {
01563         <font class="keywordflow">return</font> OnMenuChar(uMsg, wParam, lParam, bHandled);
01564     }
01565 
01566     LRESULT OnParentAPITrackPopupMenu(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01567     {
01568         <font class="keywordflow">return</font> OnAPITrackPopupMenu(uMsg, wParam, lParam, bHandled);
01569     }
01570 
01571     LRESULT OnParentAPIGetCmdBar(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01572     {
01573         <font class="keywordflow">return</font> OnAPIGetCmdBar(uMsg, wParam, lParam, bHandled);
01574     }
01575 
01576     LRESULT OnParentDrawItem(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01577     {
01578         <font class="keywordflow">return</font> OnDrawItem(uMsg, wParam, lParam, bHandled);
01579     }
01580 
01581     LRESULT OnParentMeasureItem(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
01582     {
01583         <font class="keywordflow">return</font> OnMeasureItem(uMsg, wParam, lParam, bHandled);
01584     }
01585 
01586     LRESULT OnParentActivate(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01587     {
01588         m_bParentActive = (LOWORD(wParam) != WA_INACTIVE);
01589         <font class="keywordflow">if</font>(!m_bParentActive &amp;&amp; m_bUseKeyboardCues &amp;&amp; m_bShowKeyboardCues)
01590         {
01591             ShowKeyboardCues(<font class="keyword">false</font>);    <font class="comment">// this will repaint our window</font>
01592         }
01593         <font class="keywordflow">else</font>
01594         {
01595             Invalidate();
01596             UpdateWindow();
01597         }
01598         bHandled = FALSE;
01599         <font class="keywordflow">return</font> 1;
01600     }
01601 
01602     LRESULT OnParentCustomDraw(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; bHandled)
01603     {
01604         LRESULT lRet = CDRF_DODEFAULT;
01605         bHandled = FALSE;
01606         <font class="keywordflow">if</font>(pnmh-&gt;hwndFrom == m_hWnd)
01607         {
01608             LPNMTBCUSTOMDRAW lpTBCustomDraw = (LPNMTBCUSTOMDRAW)pnmh;
01609             <font class="keywordflow">if</font>(lpTBCustomDraw-&gt;nmcd.dwDrawStage == CDDS_PREPAINT)
01610             {
01611                 lRet = CDRF_NOTIFYITEMDRAW;
01612                 bHandled = TRUE;
01613             }
01614             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(lpTBCustomDraw-&gt;nmcd.dwDrawStage == CDDS_ITEMPREPAINT)
01615             {
01616                 <font class="keywordflow">if</font>(m_bFlatMenus)
01617                 {
01618 <font class="preprocessor">#ifndef COLOR_MENUHILIGHT</font>
01619 <font class="preprocessor"></font>                    <font class="keyword">const</font> <font class="keywordtype">int</font> COLOR_MENUHILIGHT = 29;
01620 <font class="preprocessor">#endif </font>
01621 <font class="preprocessor">                    bool bDisabled = ((lpTBCustomDraw-&gt;nmcd.uItemState &amp; CDIS_DISABLED) == CDIS_DISABLED);</font>
01622 <font class="preprocessor"></font>                    <font class="keywordflow">if</font>(!bDisabled &amp;&amp; ((lpTBCustomDraw-&gt;nmcd.uItemState &amp; CDIS_HOT) == CDIS_HOT || 
01623                         (lpTBCustomDraw-&gt;nmcd.uItemState &amp; CDIS_SELECTED) == CDIS_SELECTED))
01624                     {
01625                         ::FillRect(lpTBCustomDraw-&gt;nmcd.hdc, &amp;lpTBCustomDraw-&gt;nmcd.rc, ::GetSysColorBrush(COLOR_MENUHILIGHT));
01626                         ::FrameRect(lpTBCustomDraw-&gt;nmcd.hdc, &amp;lpTBCustomDraw-&gt;nmcd.rc, ::GetSysColorBrush(COLOR_HIGHLIGHT));
01627                         lpTBCustomDraw-&gt;clrText = ::GetSysColor(m_bParentActive ? COLOR_HIGHLIGHTTEXT : COLOR_GRAYTEXT);
01628                     }
01629                     <font class="keywordflow">else</font> <font class="keywordflow">if</font>(bDisabled || !m_bParentActive)
01630                     {
01631                         lpTBCustomDraw-&gt;clrText = ::GetSysColor(COLOR_GRAYTEXT);
01632                     }
01633                     <a class="code" href="namespaceWTL.html#a47">CDCHandle</a> dc = lpTBCustomDraw-&gt;nmcd.hdc;
01634                     dc.SetTextColor(lpTBCustomDraw-&gt;clrText);
01635                     dc.SetBkMode(lpTBCustomDraw-&gt;nStringBkMode);
01636                     HFONT hFont = GetFont();
01637                     HFONT hFontOld = NULL;
01638                     <font class="keywordflow">if</font>(hFont != NULL)
01639                         hFontOld = dc.SelectFont(hFont);
01640                     TCHAR szText[200];
01641                     TBBUTTONINFO tbbi;
01642                     tbbi.cbSize = <font class="keyword">sizeof</font>(TBBUTTONINFO);
01643                     tbbi.dwMask = TBIF_TEXT;
01644                     tbbi.pszText = szText;
01645                     tbbi.cchText = <font class="keyword">sizeof</font>(szText) / <font class="keyword">sizeof</font>(TCHAR);
01646                     GetButtonInfo((<font class="keywordtype">int</font>)lpTBCustomDraw-&gt;nmcd.dwItemSpec, &amp;tbbi);
01647                     dc.DrawText(szText, -1, &amp;lpTBCustomDraw-&gt;nmcd.rc, DT_SINGLELINE | DT_CENTER | DT_VCENTER | (m_bShowKeyboardCues ? 0 : DT_HIDEPREFIX));
01648                     <font class="keywordflow">if</font>(hFont != NULL)
01649                         dc.SelectFont(hFontOld);
01650                     lRet = CDRF_SKIPDEFAULT;
01651                     bHandled = TRUE;
01652                 }
01653                 <font class="keywordflow">else</font> <font class="keywordflow">if</font>(!m_bParentActive)
01654                 {
01655                     lpTBCustomDraw-&gt;clrText = ::GetSysColor(COLOR_GRAYTEXT);
01656                     bHandled = TRUE;
01657                 }
01658             }
01659         }
01660         <font class="keywordflow">return</font> lRet;
01661     }
01662 
01663 <font class="comment">// Message hook handlers</font>
01664     LRESULT OnHookMouseMove(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01665     {
01666         <font class="keyword">static</font> POINT s_point = { -1, -1 };
01667         DWORD dwPoint = ::GetMessagePos();
01668         POINT point = { <a class="code" href="atlapp_8h.html#a28">GET_X_LPARAM</a>(dwPoint), <a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(dwPoint) };
01669 
01670         bHandled = FALSE;
01671         <font class="keywordflow">if</font>(m_bMenuActive)
01672         {
01673             <font class="keywordflow">if</font>(::WindowFromPoint(point) == m_hWnd)
01674             {
01675                 ScreenToClient(&amp;point);
01676                 <font class="keywordtype">int</font> nHit = HitTest(&amp;point);
01677 
01678                 <font class="keywordflow">if</font>((point.x != s_point.x || point.y != s_point.y) &amp;&amp; nHit &gt;= 0 &amp;&amp; nHit &lt; ::GetMenuItemCount(m_hMenu) &amp;&amp; nHit != m_nPopBtn &amp;&amp; m_nPopBtn != -1)
01679                 {
01680                     TBBUTTON tbb;
01681                     GetButton(nHit, &amp;tbb);
01682                     <font class="keywordflow">if</font>((tbb.fsState &amp; TBSTATE_ENABLED) != 0)
01683                     {
01684                         m_nNextPopBtn = nHit | 0xFFFF0000;
01685                         HWND hWndMenu = m_stackMenuWnd.GetCurrent();
01686                         ATLASSERT(hWndMenu != NULL);
01687 
01688                         <font class="comment">// this one is needed to close a menu if mouse button was down</font>
01689                         ::PostMessage(hWndMenu, WM_LBUTTONUP, 0, MAKELPARAM(point.x, point.y));
01690                         <font class="comment">// this one closes a popup menu</font>
01691                         ::PostMessage(hWndMenu, WM_KEYDOWN, VK_ESCAPE, 0L);
01692 
01693                         bHandled = TRUE;
01694                     }
01695                 }
01696             }
01697         }
01698         <font class="keywordflow">else</font>
01699         {
01700             ScreenToClient(&amp;point);
01701         }
01702 
01703         s_point = point;
01704         <font class="keywordflow">return</font> 0;
01705     }
01706 
01707     LRESULT OnHookSysKeyDown(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01708     {
01709         bHandled = FALSE;
01710 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01711 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook WM_SYSKEYDOWN (0x%2.2X)\n"</font>, wParam);
01712 <font class="preprocessor">#endif</font>
01713 <font class="preprocessor"></font>
01714         <font class="keywordflow">if</font>(wParam == VK_MENU &amp;&amp; m_bUseKeyboardCues &amp;&amp; !m_bShowKeyboardCues &amp;&amp; m_bAllowKeyboardCues)
01715             ShowKeyboardCues(<font class="keyword">true</font>);
01716 
01717         <font class="keywordflow">if</font>(wParam != VK_SPACE &amp;&amp; !m_bMenuActive &amp;&amp; ::GetFocus() == m_hWnd)
01718         {
01719             m_bAllowKeyboardCues = <font class="keyword">false</font>;
01720             PostMessage(TB_SETHOTITEM, (WPARAM)-1, 0L);
01721             T* pT = static_cast&lt;T*&gt;(this);
01722             pT-&gt;GiveFocusBack();
01723             m_bSkipMsg = <font class="keyword">true</font>;
01724         }
01725         <font class="keywordflow">else</font>
01726         {
01727             <font class="keywordflow">if</font>(wParam == VK_SPACE &amp;&amp; m_bUseKeyboardCues &amp;&amp; m_bShowKeyboardCues)
01728             {
01729                 m_bAllowKeyboardCues = <font class="keyword">true</font>;
01730                 ShowKeyboardCues(<font class="keyword">false</font>);
01731             }
01732             m_uSysKey = (UINT)wParam;
01733         }
01734         <font class="keywordflow">return</font> 0;
01735     }
01736 
01737     LRESULT OnHookSysKeyUp(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01738     {
01739         <font class="keywordflow">if</font>(!m_bAllowKeyboardCues)
01740             m_bAllowKeyboardCues = <font class="keyword">true</font>;
01741         bHandled = FALSE;
01742         wParam;
01743 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01744 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook WM_SYSKEYUP (0x%2.2X)\n"</font>, wParam);
01745 <font class="preprocessor">#endif</font>
01746 <font class="preprocessor"></font>        <font class="keywordflow">return</font> 0;
01747     }
01748 
01749     LRESULT OnHookSysChar(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01750     {
01751         bHandled = FALSE;
01752 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01753 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook WM_SYSCHAR (0x%2.2X)\n"</font>, wParam);
01754 <font class="preprocessor">#endif</font>
01755 <font class="preprocessor"></font>
01756         <font class="keywordflow">if</font>(!m_bMenuActive &amp;&amp; m_hWndHook != m_hWnd &amp;&amp; wParam != VK_SPACE)
01757             bHandled = TRUE;
01758         <font class="keywordflow">return</font> 0;
01759     }
01760 
01761     LRESULT OnHookKeyDown(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01762     {
01763 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01764 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook WM_KEYDOWN (0x%2.2X)\n"</font>, wParam);
01765 <font class="preprocessor">#endif</font>
01766 <font class="preprocessor"></font>        bHandled = FALSE;
01767         T* pT = static_cast&lt;T*&gt;(this);
01768 
01769         <font class="keywordflow">if</font>(wParam == VK_ESCAPE)
01770         {
01771             <font class="keywordflow">if</font>(m_bMenuActive &amp;&amp; !m_bContextMenu)
01772             {
01773                 <font class="keywordtype">int</font> nHot = GetHotItem();
01774                 <font class="keywordflow">if</font>(nHot == -1)
01775                     nHot = m_nPopBtn;
01776                 <font class="keywordflow">if</font>(nHot == -1)
01777                     nHot = 0;
01778                 SetHotItem(nHot);
01779                 bHandled = TRUE;
01780                 pT-&gt;TakeFocus();
01781                 m_bEscapePressed = <font class="keyword">true</font>; <font class="comment">// To keep focus</font>
01782             }
01783             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(::GetFocus() == m_hWnd &amp;&amp; m_wndParent.IsWindow())
01784             {
01785                 SetHotItem(-1);
01786                 pT-&gt;GiveFocusBack();
01787                 bHandled = TRUE;
01788             }
01789         }
01790         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(wParam == VK_RETURN || wParam == VK_UP || wParam == VK_DOWN)
01791         {
01792             <font class="keywordflow">if</font>(!m_bMenuActive &amp;&amp; ::GetFocus() == m_hWnd &amp;&amp; m_wndParent.IsWindow())
01793             {
01794                 <font class="keywordtype">int</font> nHot = GetHotItem();
01795                 <font class="keywordflow">if</font>(nHot != -1)
01796                 {
01797                     <font class="keywordflow">if</font>(wParam != VK_RETURN)
01798                     {
01799 <font class="comment">// IE4 only: WM_KEYDOWN doesn't generate TBN_DROPDOWN, we need to simulate a mouse click</font>
01800 <font class="preprocessor">#if (_WIN32_IE &lt; 0x0500)</font>
01801 <font class="preprocessor"></font>                        DWORD dwMajor = 0, dwMinor = 0;
01802                         AtlGetCommCtrlVersion(&amp;dwMajor, &amp;dwMinor);
01803                         <font class="keywordflow">if</font>(dwMajor &lt;= 4 || (dwMajor == 5 &amp;&amp; dwMinor &lt; 80))
01804                         {
01805                             RECT rect;
01806                             GetItemRect(nHot, &amp;rect);
01807                             PostMessage(WM_LBUTTONDOWN, MK_LBUTTON, MAKELPARAM(rect.left, rect.top));
01808                         }
01809 <font class="preprocessor">#endif //(_WIN32_IE &lt; 0x0500)</font>
01810 <font class="preprocessor"></font>                        PostMessage(WM_KEYDOWN, VK_DOWN, 0L);
01811                     }
01812                 }
01813                 <font class="keywordflow">else</font>
01814                 {
01815                     ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Can't find hot button\n"</font>);
01816                 }
01817             }
01818             <font class="keywordflow">if</font>(wParam == VK_RETURN &amp;&amp; m_bMenuActive)
01819             {
01820                 PostMessage(TB_SETHOTITEM, (WPARAM)-1, 0L);
01821                 m_nNextPopBtn = -1;
01822                 pT-&gt;GiveFocusBack();
01823             }
01824         }
01825         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(wParam == VK_LEFT || wParam == VK_RIGHT)
01826         {
01827 <font class="preprocessor">#if (WINVER &gt;= 0x0500)</font>
01828 <font class="preprocessor"></font>            <font class="keywordtype">bool</font> bRTL = ((GetExStyle() &amp; WS_EX_LAYOUTRTL) != 0);
01829             WPARAM wpNext = bRTL ? VK_LEFT : VK_RIGHT;
01830             WPARAM wpPrev = bRTL ? VK_RIGHT : VK_LEFT;
01831 <font class="preprocessor">#else // !(WINVER &gt;= 0x0500)</font>
01832 <font class="preprocessor"></font>            WPARAM wpNext = VK_RIGHT;
01833             WPARAM wpPrev = VK_LEFT;
01834 <font class="preprocessor">#endif // !(WINVER &gt;= 0x0500)</font>
01835 <font class="preprocessor"></font>
01836             <font class="keywordflow">if</font>(m_bMenuActive &amp;&amp; !m_bContextMenu &amp;&amp; !(wParam == wpNext &amp;&amp; m_bPopupItem))
01837             {
01838                 <font class="keywordtype">bool</font> bAction = <font class="keyword">false</font>;
01839                 <font class="keywordflow">if</font>(wParam == wpPrev &amp;&amp; s_pCurrentBar-&gt;m_stackMenuWnd.GetSize() == 1)
01840                 {
01841                     m_nNextPopBtn = pT-&gt;GetPreviousMenuItem(m_nPopBtn);
01842                     <font class="keywordflow">if</font>(m_nNextPopBtn != -1)
01843                         bAction = <font class="keyword">true</font>;
01844                 }
01845                 <font class="keywordflow">else</font> <font class="keywordflow">if</font>(wParam == wpNext)
01846                 {
01847                     m_nNextPopBtn = pT-&gt;GetNextMenuItem(m_nPopBtn);
01848                     <font class="keywordflow">if</font>(m_nNextPopBtn != -1)
01849                         bAction = <font class="keyword">true</font>;
01850                 }
01851                 HWND hWndMenu = m_stackMenuWnd.GetCurrent();
01852                 ATLASSERT(hWndMenu != NULL);
01853 
01854                 <font class="comment">// Close the popup menu</font>
01855                 <font class="keywordflow">if</font>(bAction)
01856                 {
01857                     ::PostMessage(hWndMenu, WM_KEYDOWN, VK_ESCAPE, 0L);
01858                     <font class="keywordflow">if</font>(wParam == wpNext)
01859                     {
01860                         <font class="keywordtype">int</font> cItem = m_stackMenuWnd.GetSize() - 1;
01861                         <font class="keywordflow">while</font>(cItem &gt;= 0)
01862                         {
01863                             hWndMenu = m_stackMenuWnd[cItem];
01864                             <font class="keywordflow">if</font>(hWndMenu != NULL)
01865                                 ::PostMessage(hWndMenu, WM_KEYDOWN, VK_ESCAPE, 0L);
01866                             cItem--;
01867                         }
01868                     }
01869 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
01870 <font class="preprocessor"></font>                    <font class="keywordflow">if</font>(m_nNextPopBtn == -2)
01871                     {
01872                         m_nNextPopBtn = -1;
01873                         pT-&gt;DisplayChevronMenu();
01874                     }
01875 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01876 <font class="preprocessor"></font>                    bHandled = TRUE;
01877                 }
01878             }
01879         }
01880         <font class="keywordflow">return</font> 0;
01881     }
01882 
01883     LRESULT OnHookNextMenu(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01884     {
01885 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01886 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook WM_NEXTMENU\n"</font>);
01887 <font class="preprocessor">#endif</font>
01888 <font class="preprocessor"></font>        bHandled = FALSE;
01889         <font class="keywordflow">return</font> 1;
01890     }
01891 
01892     LRESULT OnHookChar(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
01893     {
01894 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
01895 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook WM_CHAR (0x%2.2X)\n"</font>, wParam);
01896 <font class="preprocessor">#endif</font>
01897 <font class="preprocessor"></font>        bHandled = (wParam == VK_ESCAPE);
01898         <font class="keywordflow">return</font> 0;
01899     }
01900 
01901 <font class="comment">// Implementation - ownerdraw overrideables and helpers</font>
01902     <font class="keywordtype">void</font> DrawItem(LPDRAWITEMSTRUCT lpDrawItemStruct)
01903     {
01904         T* pT = static_cast&lt;T*&gt;(this);
01905         <font class="keywordflow">if</font>(m_bFlatMenus)
01906             pT-&gt;DrawItemFlat(lpDrawItemStruct);
01907         <font class="keywordflow">else</font>
01908             pT-&gt;DrawItem3D(lpDrawItemStruct);
01909 
01910     }
01911 
01912     <font class="keywordtype">void</font> DrawItem3D(LPDRAWITEMSTRUCT lpDrawItemStruct)
01913     {
01914         _MenuItemData* pmd = (_MenuItemData*)lpDrawItemStruct-&gt;itemData;
01915         <a class="code" href="namespaceWTL.html#a47">CDCHandle</a> dc = lpDrawItemStruct-&gt;hDC;
01916         <font class="keyword">const</font> RECT&amp; rcItem = lpDrawItemStruct-&gt;rcItem;
01917         T* pT = static_cast&lt;T*&gt;(this);
01918 
01919         <font class="keywordflow">if</font>(pmd-&gt;fType &amp; MFT_SEPARATOR)
01920         {
01921             <font class="comment">// draw separator</font>
01922             RECT rc = rcItem;
01923             rc.top += (rc.bottom - rc.top) / 2; <font class="comment">// vertical center</font>
01924             dc.DrawEdge(&amp;rc, EDGE_ETCHED, BF_TOP);  <font class="comment">// draw separator line</font>
01925         }
01926         <font class="keywordflow">else</font>        <font class="comment">// not a separator</font>
01927         {
01928             BOOL bDisabled = lpDrawItemStruct-&gt;itemState &amp; ODS_GRAYED;
01929             BOOL bSelected = lpDrawItemStruct-&gt;itemState &amp; ODS_SELECTED;
01930             BOOL bChecked = lpDrawItemStruct-&gt;itemState &amp; ODS_CHECKED;
01931             BOOL bHasImage = FALSE;
01932 
01933             <font class="keywordflow">if</font>(LOWORD(lpDrawItemStruct-&gt;itemID) == (WORD)-1)
01934                 bSelected = FALSE;
01935             RECT rcButn = { rcItem.left, rcItem.top, rcItem.left + m_szButton.cx, rcItem.top + m_szButton.cy };         <font class="comment">// button rect</font>
01936             ::OffsetRect(&amp;rcButn, 0, ((rcItem.bottom - rcItem.top) - (rcButn.bottom - rcButn.top)) / 2);    <font class="comment">// center vertically</font>
01937 
01938             <font class="keywordtype">int</font> iButton = pmd-&gt;iButton;
01939             <font class="keywordflow">if</font>(iButton &gt;= 0)
01940             {
01941                 bHasImage = TRUE;
01942 
01943                 <font class="comment">// calc drawing point</font>
01944                 SIZE sz = { rcButn.right - rcButn.left - m_szBitmap.cx, rcButn.bottom - rcButn.top - m_szBitmap.cy };
01945                 sz.cx /= 2;
01946                 sz.cy /= 2;
01947                 POINT point = { rcButn.left + sz.cx, rcButn.top + sz.cy };
01948 
01949                 <font class="comment">// draw disabled or normal</font>
01950                 <font class="keywordflow">if</font>(!bDisabled)
01951                 {
01952                     <font class="comment">// normal - fill background depending on state</font>
01953                     <font class="keywordflow">if</font>(!bChecked || bSelected)
01954                     {
01955                         dc.FillRect(&amp;rcButn, (bChecked &amp;&amp; !bSelected) ? COLOR_3DLIGHT : COLOR_MENU);
01956                     }
01957                     <font class="keywordflow">else</font>
01958                     {
01959                         COLORREF crTxt = dc.SetTextColor(::GetSysColor(COLOR_BTNFACE));
01960                         COLORREF crBk = dc.SetBkColor(::GetSysColor(COLOR_BTNHILIGHT));
01961                         <a class="code" href="namespaceWTL.html#a38">CBrush</a> hbr(CDCHandle::GetHalftoneBrush());
01962                         dc.SetBrushOrg(rcButn.left, rcButn.top);
01963                         dc.FillRect(&amp;rcButn, hbr);
01964                         dc.SetTextColor(crTxt);
01965                         dc.SetBkColor(crBk);
01966                     }
01967 
01968                     <font class="comment">// draw pushed-in or popped-out edge</font>
01969                     <font class="keywordflow">if</font>(bSelected || bChecked)
01970                     {
01971                         RECT rc2 = rcButn;
01972                         dc.DrawEdge(&amp;rc2, bChecked ? BDR_SUNKENOUTER : BDR_RAISEDINNER, BF_RECT);
01973                     }
01974                     <font class="comment">// draw the image</font>
01975                     ::ImageList_Draw(m_hImageList, iButton, dc, point.x, point.y, ILD_TRANSPARENT);
01976                 }
01977                 <font class="keywordflow">else</font>
01978                 {
01979                     HBRUSH hBrushBackground = ::GetSysColorBrush(COLOR_MENU);
01980                     pT-&gt;DrawBitmapDisabled(dc, iButton, point, hBrushBackground);
01981                 }
01982             }
01983             <font class="keywordflow">else</font>
01984             {
01985                 <font class="comment">// no image - look for custom checked/unchecked bitmaps</font>
01986                 <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> info;
01987                 info.fMask = MIIM_CHECKMARKS | MIIM_TYPE;
01988                 ::GetMenuItemInfo((HMENU)lpDrawItemStruct-&gt;hwndItem, lpDrawItemStruct-&gt;itemID, MF_BYCOMMAND, &amp;info);
01989                 <font class="keywordflow">if</font>(bChecked || info.hbmpUnchecked != NULL)
01990                 {
01991                     BOOL bRadio = ((info.fType &amp; MFT_RADIOCHECK) != 0);
01992                     bHasImage = pT-&gt;DrawCheckmark(dc, rcButn, bSelected, bDisabled, bRadio, bChecked ? info.hbmpChecked : info.hbmpUnchecked);
01993                 }
01994             }
01995 
01996             <font class="comment">// draw item text</font>
01997             <font class="keywordtype">int</font> cxButn = m_szButton.cx;
01998             COLORREF colorBG = ::GetSysColor(bSelected ? COLOR_HIGHLIGHT : COLOR_MENU);
01999             <font class="keywordflow">if</font>(bSelected || lpDrawItemStruct-&gt;itemAction == ODA_SELECT)
02000             {
02001                 RECT rcBG = rcItem;
02002                 <font class="keywordflow">if</font>(bHasImage)
02003                     rcBG.left += cxButn + s_kcxGap;
02004                 dc.FillRect(&amp;rcBG, bSelected ? COLOR_HIGHLIGHT : COLOR_MENU);
02005             }
02006 
02007             <font class="comment">// calc text rectangle and colors</font>
02008             RECT rcText = rcItem;
02009             rcText.left += cxButn + s_kcxGap + s_kcxTextMargin;
02010             rcText.right -= cxButn;
02011             dc.SetBkMode(TRANSPARENT);
02012             COLORREF colorText = ::GetSysColor(bDisabled ?  (bSelected ? COLOR_GRAYTEXT : COLOR_3DSHADOW) : (bSelected ? COLOR_HIGHLIGHTTEXT : COLOR_MENUTEXT));
02013 
02014             <font class="comment">// font already selected by Windows</font>
02015             <font class="keywordflow">if</font>(bDisabled &amp;&amp; (!bSelected || colorText == colorBG))
02016             {
02017                 <font class="comment">// disabled - draw shadow text shifted down and right 1 pixel (unles selected)</font>
02018                 RECT rcDisabled = rcText;
02019                 ::OffsetRect(&amp;rcDisabled, 1, 1);
02020                 pT-&gt;DrawMenuText(dc, rcDisabled, pmd-&gt;lpstrText, ::GetSysColor(COLOR_3DHILIGHT));
02021             }
02022             pT-&gt;DrawMenuText(dc, rcText, pmd-&gt;lpstrText, colorText); <font class="comment">// finally!</font>
02023         }
02024     }
02025 
02026     <font class="keywordtype">void</font> DrawItemFlat(LPDRAWITEMSTRUCT lpDrawItemStruct)
02027     {
02028         _MenuItemData* pmd = (_MenuItemData*)lpDrawItemStruct-&gt;itemData;
02029         <a class="code" href="namespaceWTL.html#a47">CDCHandle</a> dc = lpDrawItemStruct-&gt;hDC;
02030         <font class="keyword">const</font> RECT&amp; rcItem = lpDrawItemStruct-&gt;rcItem;
02031         T* pT = static_cast&lt;T*&gt;(this);
02032 
02033 <font class="preprocessor">#ifndef COLOR_MENUHILIGHT</font>
02034 <font class="preprocessor"></font>        <font class="keyword">const</font> <font class="keywordtype">int</font> COLOR_MENUHILIGHT = 29;
02035 <font class="preprocessor">#endif </font>
02036 <font class="preprocessor"></font>
02037 <font class="preprocessor"></font>        BOOL bDisabled = lpDrawItemStruct-&gt;itemState &amp; ODS_GRAYED;
02038         BOOL bSelected = lpDrawItemStruct-&gt;itemState &amp; ODS_SELECTED;
02039         BOOL bChecked = lpDrawItemStruct-&gt;itemState &amp; ODS_CHECKED;
02040 
02041         <font class="comment">// paint background</font>
02042         <font class="keywordflow">if</font>(bSelected || lpDrawItemStruct-&gt;itemAction == ODA_SELECT)
02043         {
02044             <font class="keywordflow">if</font>(bSelected)
02045             {
02046                 dc.FillRect(&amp;rcItem, ::GetSysColorBrush(COLOR_MENUHILIGHT));
02047                 dc.FrameRect(&amp;rcItem, ::GetSysColorBrush(COLOR_HIGHLIGHT));
02048             }
02049             <font class="keywordflow">else</font>
02050             {
02051                 dc.FillRect(&amp;rcItem, ::GetSysColorBrush(COLOR_MENU));
02052             }
02053         }
02054 
02055         <font class="keywordflow">if</font>(pmd-&gt;fType &amp; MFT_SEPARATOR)
02056         {
02057             <font class="comment">// draw separator</font>
02058             RECT rc = rcItem;
02059             rc.top += (rc.bottom - rc.top) / 2; <font class="comment">// vertical center</font>
02060             dc.DrawEdge(&amp;rc, EDGE_ETCHED, BF_TOP);  <font class="comment">// draw separator line</font>
02061         }
02062         <font class="keywordflow">else</font>        <font class="comment">// not a separator</font>
02063         {
02064             <font class="keywordflow">if</font>(LOWORD(lpDrawItemStruct-&gt;itemID) == (WORD)-1)
02065                 bSelected = FALSE;
02066             RECT rcButn = { rcItem.left, rcItem.top, rcItem.left + m_szButton.cx, rcItem.top + m_szButton.cy };         <font class="comment">// button rect</font>
02067             ::OffsetRect(&amp;rcButn, 0, ((rcItem.bottom - rcItem.top) - (rcButn.bottom - rcButn.top)) / 2);    <font class="comment">// center vertically</font>
02068 
02069             <font class="comment">// draw background and border for checked items</font>
02070             <font class="keywordflow">if</font>(m_bFlatMenus &amp;&amp; bChecked)
02071             {
02072                 RECT rcCheck = rcButn;
02073                 ::InflateRect(&amp;rcCheck, -1, -1);
02074                 <font class="keywordflow">if</font>(bSelected)
02075                     dc.FillRect(&amp;rcCheck, ::GetSysColorBrush(COLOR_MENU));
02076                 dc.FrameRect(&amp;rcCheck, ::GetSysColorBrush(COLOR_HIGHLIGHT));
02077             }
02078 
02079             <font class="keywordtype">int</font> iButton = pmd-&gt;iButton;
02080             <font class="keywordflow">if</font>(iButton &gt;= 0)
02081             {
02082                 <font class="comment">// calc drawing point</font>
02083                 SIZE sz = { rcButn.right - rcButn.left - m_szBitmap.cx, rcButn.bottom - rcButn.top - m_szBitmap.cy };
02084                 sz.cx /= 2;
02085                 sz.cy /= 2;
02086                 POINT point = { rcButn.left + sz.cx, rcButn.top + sz.cy };
02087 
02088                 <font class="comment">// draw disabled or normal</font>
02089                 <font class="keywordflow">if</font>(!bDisabled)
02090                 {
02091                     ::ImageList_Draw(m_hImageList, iButton, dc, point.x, point.y, ILD_TRANSPARENT);
02092                 }
02093                 <font class="keywordflow">else</font>
02094                 {
02095                     HBRUSH hBrushBackground = ::GetSysColorBrush(bSelected ? COLOR_MENUHILIGHT : COLOR_MENU);
02096                     HBRUSH hBrushDisabledImage = ::GetSysColorBrush(COLOR_3DSHADOW);
02097                     pT-&gt;DrawBitmapDisabled(dc, iButton, point, hBrushBackground, hBrushBackground, hBrushDisabledImage);
02098                 }
02099             }
02100             <font class="keywordflow">else</font>
02101             {
02102                 <font class="comment">// no image - look for custom checked/unchecked bitmaps</font>
02103                 <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> info;
02104                 info.fMask = MIIM_CHECKMARKS | MIIM_TYPE;
02105                 ::GetMenuItemInfo((HMENU)lpDrawItemStruct-&gt;hwndItem, lpDrawItemStruct-&gt;itemID, MF_BYCOMMAND, &amp;info);
02106                 <font class="keywordflow">if</font>(bChecked || info.hbmpUnchecked != NULL)
02107                 {
02108                     BOOL bRadio = ((info.fType &amp; MFT_RADIOCHECK) != 0);
02109                     pT-&gt;DrawCheckmark(dc, rcButn, bSelected, bDisabled, bRadio, bChecked ? info.hbmpChecked : info.hbmpUnchecked);
02110                 }
02111             }
02112 
02113             <font class="comment">// draw item text</font>
02114             <font class="keywordtype">int</font> cxButn = m_szButton.cx;
02115             <font class="comment">// calc text rectangle and colors</font>
02116             RECT rcText = rcItem;
02117             rcText.left += cxButn + s_kcxGap + s_kcxTextMargin;
02118             rcText.right -= cxButn;
02119             dc.SetBkMode(TRANSPARENT);
02120             COLORREF colorText = ::GetSysColor(bDisabled ?  (bSelected ? COLOR_GRAYTEXT : COLOR_3DSHADOW) : (bSelected ? COLOR_HIGHLIGHTTEXT : COLOR_MENUTEXT));
02121 
02122             pT-&gt;DrawMenuText(dc, rcText, pmd-&gt;lpstrText, colorText); <font class="comment">// finally!</font>
02123         }
02124     }
02125 
02126     <font class="keywordtype">void</font> DrawMenuText(<a class="code" href="namespaceWTL.html#a47">CDCHandle</a>&amp; dc, RECT&amp; rc, LPCTSTR lpstrText, COLORREF color)
02127     {
02128         <font class="keywordtype">int</font> nTab = -1;
02129         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; lstrlen(lpstrText); i++)
02130         {
02131             <font class="keywordflow">if</font>(lpstrText[i] == <font class="charliteral">'\t'</font>)
02132             {
02133                 nTab = i;
02134                 <font class="keywordflow">break</font>;
02135             }
02136         }
02137         dc.SetTextColor(color);
02138         dc.DrawText(lpstrText, nTab, &amp;rc, DT_SINGLELINE | DT_LEFT | DT_VCENTER | (m_bShowKeyboardCues ? 0 : DT_HIDEPREFIX));
02139         <font class="keywordflow">if</font>(nTab != -1)
02140             dc.DrawText(&amp;lpstrText[nTab + 1], -1, &amp;rc, DT_SINGLELINE | DT_RIGHT | DT_VCENTER | (m_bShowKeyboardCues ? 0 : DT_HIDEPREFIX));
02141     }
02142 
02143     <font class="keywordtype">void</font> DrawBitmapDisabled(<a class="code" href="namespaceWTL.html#a47">CDCHandle</a>&amp; dc, <font class="keywordtype">int</font> nImage, POINT point,
02144             HBRUSH hBrushBackground = ::GetSysColorBrush(COLOR_3DFACE),
02145             HBRUSH hBrush3DEffect = ::GetSysColorBrush(COLOR_3DHILIGHT),
02146             HBRUSH hBrushDisabledImage = ::GetSysColorBrush(COLOR_3DSHADOW))
02147     {
02148 <font class="preprocessor">#if (_WIN32_WINNT &gt;= 0x0501)</font>
02149 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_bAlphaImages)
02150         {
02151             IMAGELISTDRAWPARAMS ildp;
02152             memset(&amp;ildp, 0, <font class="keyword">sizeof</font>(ildp));
02153             ildp.cbSize = <font class="keyword">sizeof</font>(IMAGELISTDRAWPARAMS);
02154             ildp.himl = m_hImageList;
02155             ildp.i = nImage;
02156             ildp.hdcDst = dc;
02157             ildp.x = point.x;
02158             ildp.y = point.y;
02159             ildp.cx = 0;
02160             ildp.cy = 0;
02161             ildp.xBitmap = 0;
02162             ildp.yBitmap = 0;
02163             ildp.fStyle = ILD_TRANSPARENT;
02164             ildp.fState = ILS_SATURATE;
02165             ildp.Frame = (DWORD)-100;
02166             ::ImageList_DrawIndirect(&amp;ildp);
02167         }
02168         <font class="keywordflow">else</font>
02169 <font class="preprocessor">#endif //(_WIN32_WINNT &gt;= 0x0501)</font>
02170 <font class="preprocessor"></font>        {
02171             <font class="comment">// create memory DC</font>
02172             <a class="code" href="namespaceWTL.html#a48">CDC</a> dcMem;
02173             dcMem.<a class="code" href="classWTL_1_1CDCT.html#a14">CreateCompatibleDC</a>(dc);
02174             <font class="comment">// create mono or color bitmap</font>
02175             <a class="code" href="namespaceWTL.html#a42">CBitmap</a> bmp;
02176             bmp.CreateCompatibleBitmap(dc, m_szBitmap.cx, m_szBitmap.cy);
02177             ATLASSERT(bmp.m_hBitmap != NULL);
02178             <font class="comment">// draw image into memory DC--fill BG white first</font>
02179             HBITMAP hBmpOld = dcMem.SelectBitmap(bmp);
02180             dcMem.PatBlt(0, 0, m_szBitmap.cx, m_szBitmap.cy, WHITENESS);
02181             <font class="comment">// If white is the text color, we can't use the normal painting since</font>
02182             <font class="comment">// it would blend with the WHITENESS, but the mask is OK</font>
02183             UINT uDrawStyle = (::GetSysColor(COLOR_BTNTEXT) == RGB(255, 255, 255)) ? ILD_MASK : ILD_NORMAL;
02184             ::ImageList_Draw(m_hImageList, nImage, dcMem, 0, 0, uDrawStyle);
02185             dc.DitherBlt(point.x, point.y, m_szBitmap.cx, m_szBitmap.cy, dcMem, NULL, 0, 0, hBrushBackground, hBrush3DEffect, hBrushDisabledImage);
02186             dcMem.SelectBitmap(hBmpOld);        <font class="comment">// restore</font>
02187         }
02188     }
02189 
02190     <font class="comment">// old name</font>
02191     BOOL Draw3DCheckmark(<a class="code" href="namespaceWTL.html#a47">CDCHandle</a>&amp; dc, <font class="keyword">const</font> RECT&amp; rc, BOOL bSelected, BOOL bDisabled, BOOL bRadio, HBITMAP hBmpCheck)
02192     {
02193         <font class="keywordflow">return</font> DrawCheckmark(dc, rc, bSelected, bDisabled, bRadio, hBmpCheck);
02194     }
02195 
02196     BOOL DrawCheckmark(<a class="code" href="namespaceWTL.html#a47">CDCHandle</a>&amp; dc, <font class="keyword">const</font> RECT&amp; rc, BOOL bSelected, BOOL bDisabled, BOOL bRadio, HBITMAP hBmpCheck)
02197     {
02198         <font class="comment">// get checkmark bitmap, if none, use Windows standard</font>
02199         SIZE size = { 0, 0 };
02200         <a class="code" href="namespaceWTL.html#a41">CBitmapHandle</a> bmp = hBmpCheck;
02201         <font class="keywordflow">if</font>(hBmpCheck != NULL)
02202         {
02203             bmp.GetSize(size);
02204         }
02205         <font class="keywordflow">else</font>
02206         {
02207             size.cx = ::GetSystemMetrics(SM_CXMENUCHECK); 
02208             size.cy = ::GetSystemMetrics(SM_CYMENUCHECK); 
02209             bmp.CreateCompatibleBitmap(dc, size.cx, size.cy);
02210             ATLASSERT(bmp.m_hBitmap != NULL);
02211         }
02212         <font class="comment">// center bitmap in caller's rectangle</font>
02213         RECT rcDest = rc;
02214         <font class="keywordflow">if</font>((rc.right - rc.left) &gt; size.cx)
02215         {
02216             rcDest.left = rc.left + (rc.right - rc.left - size.cx) / 2;
02217             rcDest.right = rcDest.left + size.cx;
02218         }
02219         <font class="keywordflow">if</font>((rc.bottom - rc.top) &gt; size.cy)
02220         {
02221             rcDest.top = rc.top + (rc.bottom - rc.top - size.cy) / 2;
02222             rcDest.bottom = rcDest.top + size.cy;
02223         }
02224         <font class="comment">// paint background</font>
02225         <font class="keywordflow">if</font>(!m_bFlatMenus &amp;&amp; !bDisabled)
02226         {
02227             <font class="keywordflow">if</font>(bSelected)
02228             {
02229                 dc.FillRect(&amp;rcDest, COLOR_MENU);
02230             }
02231             <font class="keywordflow">else</font>
02232             {
02233                 COLORREF clrTextOld = dc.SetTextColor(::GetSysColor(COLOR_BTNFACE));
02234                 COLORREF clrBkOld = dc.SetBkColor(::GetSysColor(COLOR_BTNHILIGHT));
02235                 <a class="code" href="namespaceWTL.html#a38">CBrush</a> hbr(CDCHandle::GetHalftoneBrush());
02236                 dc.SetBrushOrg(rcDest.left, rcDest.top);
02237                 dc.FillRect(&amp;rcDest, hbr);
02238                 dc.SetTextColor(clrTextOld);
02239                 dc.SetBkColor(clrBkOld);
02240             }
02241         }
02242 
02243         <font class="comment">// create source image</font>
02244         <a class="code" href="namespaceWTL.html#a48">CDC</a> dcSource;
02245         dcSource.<a class="code" href="classWTL_1_1CDCT.html#a14">CreateCompatibleDC</a>(dc);
02246         HBITMAP hBmpOld = dcSource.SelectBitmap(bmp);
02247         <font class="comment">// set colors</font>
02248         <font class="keyword">const</font> COLORREF clrBlack = RGB(0, 0, 0);
02249         <font class="keyword">const</font> COLORREF clrWhite = RGB(255, 255, 255);
02250         COLORREF clrTextOld = dc.SetTextColor(clrBlack);
02251         COLORREF clrBkOld = dc.SetBkColor(clrWhite);
02252         <font class="comment">// create mask</font>
02253         <a class="code" href="namespaceWTL.html#a48">CDC</a> dcMask;
02254         dcMask.<a class="code" href="classWTL_1_1CDCT.html#a14">CreateCompatibleDC</a>(dc);
02255         <a class="code" href="namespaceWTL.html#a42">CBitmap</a> bmpMask;
02256         bmpMask.CreateBitmap(size.cx, size.cy, 1, 1, NULL);
02257         HBITMAP hBmpOld1 = dcMask.SelectBitmap(bmpMask);
02258 
02259         <font class="comment">// draw the checkmark transparently</font>
02260         <font class="keywordtype">int</font> cx = rcDest.right - rcDest.left;
02261         <font class="keywordtype">int</font> cy = rcDest.bottom - rcDest.top;    
02262         <font class="keywordflow">if</font>(hBmpCheck != NULL)
02263         {
02264             <font class="comment">// build mask based on transparent color    </font>
02265             dcSource.SetBkColor(m_clrMask);
02266             dcMask.SetBkColor(clrBlack);
02267             dcMask.SetTextColor(clrWhite);
02268             dcMask.BitBlt(0, 0, size.cx, size.cy, dcSource, 0, 0, SRCCOPY);
02269             <font class="comment">// draw bitmap using the mask</font>
02270             dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcSource, 0, 0, SRCINVERT);
02271             dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcMask, 0, 0, SRCAND);
02272             dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcSource, 0, 0, SRCINVERT);
02273         }
02274         <font class="keywordflow">else</font>
02275         {
02276             <font class="keyword">const</font> DWORD ROP_DSno = 0x00BB0226L;
02277             <font class="keyword">const</font> DWORD ROP_DSa = 0x008800C6L;
02278             <font class="keyword">const</font> DWORD ROP_DSo = 0x00EE0086L;
02279             <font class="keyword">const</font> DWORD ROP_DSna = 0x00220326L;
02280 
02281             <font class="comment">// draw mask</font>
02282             RECT rcSource = { 0, 0, min(size.cx, rc.right - rc.left), min(size.cy, rc.bottom - rc.top) };
02283             dcMask.DrawFrameControl(&amp;rcSource, DFC_MENU, bRadio ? DFCS_MENUBULLET : DFCS_MENUCHECK);
02284 
02285             <font class="comment">// draw shadow if disabled</font>
02286             <font class="keywordflow">if</font>(!m_bFlatMenus &amp;&amp; bDisabled)
02287             {
02288                 <font class="comment">// offset by one pixel</font>
02289                 <font class="keywordtype">int</font> x = rcDest.left + 1;
02290                 <font class="keywordtype">int</font> y = rcDest.top + 1;
02291                 <font class="comment">// paint source bitmap</font>
02292                 <font class="keyword">const</font> <font class="keywordtype">int</font> nColor = COLOR_3DHILIGHT;
02293                 dcSource.FillRect(&amp;rcSource, nColor);
02294                 <font class="comment">// draw checkmark - special case black and white colors</font>
02295                 COLORREF clrCheck = ::GetSysColor(nColor);
02296                 <font class="keywordflow">if</font>(clrCheck == clrWhite)
02297                 {
02298                     dc.BitBlt(x, y, cx, cy, dcMask,  0, 0,   ROP_DSno);
02299                     dc.BitBlt(x, y, cx, cy, dcSource, 0, 0, ROP_DSa);
02300                 }
02301                 <font class="keywordflow">else</font>
02302                 {
02303                     <font class="keywordflow">if</font>(clrCheck != clrBlack)
02304                     {
02305                         ATLASSERT(dcSource.GetTextColor() == clrBlack);
02306                         ATLASSERT(dcSource.GetBkColor() == clrWhite);
02307                         dcSource.BitBlt(0, 0, size.cx, size.cy, dcMask, 0, 0, ROP_DSna);
02308                     }
02309                     dc.BitBlt(x, y, cx, cy, dcMask,  0,  0,  ROP_DSa);
02310                     dc.BitBlt(x, y, cx, cy, dcSource, 0, 0, ROP_DSo);
02311                 }
02312             }
02313 
02314             <font class="comment">// paint source bitmap</font>
02315             <font class="keyword">const</font> <font class="keywordtype">int</font> nColor = bDisabled ? COLOR_BTNSHADOW : COLOR_MENUTEXT;
02316             dcSource.FillRect(&amp;rcSource, nColor);
02317             <font class="comment">// draw checkmark - special case black and white colors</font>
02318             COLORREF clrCheck = ::GetSysColor(nColor);
02319             <font class="keywordflow">if</font>(clrCheck == clrWhite)
02320             {
02321                 dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcMask,  0, 0,   ROP_DSno);
02322                 dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcSource, 0, 0, ROP_DSa);
02323             }
02324             <font class="keywordflow">else</font>
02325             {
02326                 <font class="keywordflow">if</font>(clrCheck != clrBlack)
02327                 {
02328                     ATLASSERT(dcSource.GetTextColor() == clrBlack);
02329                     ATLASSERT(dcSource.GetBkColor() == clrWhite);
02330                     dcSource.BitBlt(0, 0, size.cx, size.cy, dcMask, 0, 0, ROP_DSna);
02331                 }
02332                 dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcMask,  0,  0,  ROP_DSa);
02333                 dc.BitBlt(rcDest.left, rcDest.top, cx, cy, dcSource, 0, 0, ROP_DSo);
02334             }
02335         }
02336         <font class="comment">// restore all</font>
02337         dc.SetTextColor(clrTextOld);            
02338         dc.SetBkColor(clrBkOld);
02339         dcSource.SelectBitmap(hBmpOld);
02340         dcMask.SelectBitmap(hBmpOld1);
02341         <font class="keywordflow">if</font>(hBmpCheck == NULL)
02342             bmp.DeleteObject();
02343         <font class="comment">// draw pushed-in hilight</font>
02344         <font class="keywordflow">if</font>(!m_bFlatMenus &amp;&amp; !bDisabled)
02345         {
02346             <font class="keywordflow">if</font>(rc.right - rc.left &gt; size.cx)
02347                 ::InflateRect(&amp;rcDest, 1,1);    <font class="comment">// inflate checkmark by one pixel all around</font>
02348             dc.DrawEdge(&amp;rcDest, BDR_SUNKENOUTER, BF_RECT);
02349         }
02350 
02351         <font class="keywordflow">return</font> TRUE;
02352     }
02353 
02354     <font class="keywordtype">void</font> MeasureItem(LPMEASUREITEMSTRUCT lpMeasureItemStruct)
02355     {
02356         _MenuItemData* pmd = (_MenuItemData*)lpMeasureItemStruct-&gt;itemData;
02357 
02358         <font class="keywordflow">if</font>(pmd-&gt;fType &amp; MFT_SEPARATOR)  <font class="comment">// separator - use half system height and zero width</font>
02359         {
02360             lpMeasureItemStruct-&gt;itemHeight = ::GetSystemMetrics(SM_CYMENU) / 2;
02361             lpMeasureItemStruct-&gt;itemWidth  = 0;
02362         }
02363         <font class="keywordflow">else</font>
02364         {
02365             <font class="comment">// compute size of text - use DrawText with DT_CALCRECT</font>
02366             <a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a> dc(NULL);
02367             <a class="code" href="namespaceWTL.html#a40">CFont</a> fontBold;
02368             HFONT hOldFont;
02369             <font class="keywordflow">if</font>(pmd-&gt;fState &amp; MFS_DEFAULT)
02370             {
02371                 <font class="comment">// need bold version of font</font>
02372                 LOGFONT lf;
02373                 m_fontMenu.GetLogFont(lf);
02374                 lf.lfWeight += 200;
02375                 fontBold.CreateFontIndirect(&amp;lf);
02376                 ATLASSERT(fontBold.m_hFont != NULL);
02377                 hOldFont = dc.<a class="code" href="classWTL_1_1CDCT.html#a28">SelectFont</a>(fontBold);
02378             }
02379             <font class="keywordflow">else</font>
02380             {
02381                 hOldFont = dc.<a class="code" href="classWTL_1_1CDCT.html#a28">SelectFont</a>(m_fontMenu);
02382             }
02383 
02384             RECT rcText = { 0, 0, 0, 0 };
02385             dc.<a class="code" href="classWTL_1_1CDCT.html#a161">DrawText</a>(pmd-&gt;lpstrText, -1, &amp;rcText, DT_SINGLELINE | DT_LEFT | DT_VCENTER | DT_CALCRECT);
02386             <font class="keywordtype">int</font> cx = rcText.right - rcText.left;
02387             dc.<a class="code" href="classWTL_1_1CDCT.html#a28">SelectFont</a>(hOldFont);
02388 
02389             LOGFONT lf;
02390             m_fontMenu.GetLogFont(lf);
02391             <font class="keywordtype">int</font> cy = lf.lfHeight;
02392             <font class="keywordflow">if</font>(cy &lt; 0)
02393                 cy = -cy;
02394             cy += 8;
02395 
02396             <font class="comment">// height of item is the bigger of these two</font>
02397             lpMeasureItemStruct-&gt;itemHeight = max(cy, (<font class="keywordtype">int</font>)m_szButton.cy);
02398 
02399             <font class="comment">// width is width of text plus a bunch of stuff</font>
02400             cx += 2 * s_kcxTextMargin;  <font class="comment">// L/R margin for readability</font>
02401             cx += s_kcxGap;         <font class="comment">// space between button and menu text</font>
02402             cx += 2 * m_szButton.cx;    <font class="comment">// button width (L=button; R=empty margin)</font>
02403             cx += m_cxExtraSpacing;     <font class="comment">// extra between item text and accelerator keys</font>
02404 
02405             <font class="comment">// Windows adds 1 to returned value</font>
02406             cx -= ::GetSystemMetrics(SM_CXMENUCHECK) - 1;
02407             lpMeasureItemStruct-&gt;itemWidth = cx;        <font class="comment">// done deal</font>
02408         }
02409     }
02410 
02411 <font class="comment">// Implementation - Hook procs</font>
02412     <font class="keyword">static</font> LRESULT CALLBACK CreateHookProc(<font class="keywordtype">int</font> nCode, WPARAM wParam, LPARAM lParam)
02413     {
02414         LRESULT lRet = 0;
02415         TCHAR szClassName[7];
02416 
02417         <font class="keywordflow">if</font>(nCode == HCBT_CREATEWND)
02418         {
02419             HWND hWndMenu = (HWND)wParam;
02420 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
02421 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - HCBT_CREATEWND (HWND = %8.8X)\n"</font>, hWndMenu);
02422 <font class="preprocessor">#endif</font>
02423 <font class="preprocessor"></font>
02424             ::GetClassName(hWndMenu, szClassName, 7);
02425             <font class="keywordflow">if</font>(!lstrcmp(_T(<font class="stringliteral">"#32768"</font>), szClassName))
02426                 s_pCurrentBar-&gt;m_stackMenuWnd.Push(hWndMenu);
02427         }
02428         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(nCode == HCBT_DESTROYWND)
02429         {
02430             HWND hWndMenu = (HWND)wParam;
02431 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
02432 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - HCBT_DESTROYWND (HWND = %8.8X)\n"</font>, hWndMenu);
02433 <font class="preprocessor">#endif</font>
02434 <font class="preprocessor"></font>
02435             ::GetClassName(hWndMenu, szClassName, 7);
02436             <font class="keywordflow">if</font>(!lstrcmp(_T(<font class="stringliteral">"#32768"</font>), szClassName))
02437             {
02438                 ATLASSERT(hWndMenu == s_pCurrentBar-&gt;m_stackMenuWnd.GetCurrent());
02439                 s_pCurrentBar-&gt;m_stackMenuWnd.Pop();
02440             }
02441         }
02442         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(nCode &lt; 0)
02443         {
02444             lRet = ::CallNextHookEx(s_hCreateHook, nCode, wParam, lParam);
02445         }
02446         <font class="keywordflow">return</font> lRet;
02447     }
02448 
02449     <font class="keyword">static</font> LRESULT CALLBACK MessageHookProc(<font class="keywordtype">int</font> nCode, WPARAM wParam, LPARAM lParam)
02450     {
02451         LPMSG pMsg = (LPMSG)lParam;
02452 
02453         <font class="keywordflow">if</font>(nCode == HC_ACTION &amp;&amp; wParam == PM_REMOVE &amp;&amp; pMsg-&gt;message != GetGetBarMessage() &amp;&amp; pMsg-&gt;message != WM_FORWARDMSG)
02454         {
02455             <a class="code" href="classWTL_1_1CCommandBarCtrlBase.html">CCommandBarCtrlBase</a>* pCmdBar = NULL;
02456             HWND hWnd = pMsg-&gt;hwnd;
02457             DWORD dwPID = 0;
02458             <font class="keywordflow">while</font>(pCmdBar == NULL &amp;&amp; hWnd != NULL)
02459             {
02460                 pCmdBar = (<a class="code" href="classWTL_1_1CCommandBarCtrlBase.html">CCommandBarCtrlBase</a>*)::SendMessage(hWnd, GetGetBarMessage(), (WPARAM)&amp;dwPID, 0L);
02461                 hWnd = ::GetParent(hWnd);
02462             }
02463 
02464             <font class="keywordflow">if</font>(pCmdBar != NULL &amp;&amp; dwPID == GetCurrentProcessId())
02465             {
02466                 pCmdBar-&gt;<a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#m2">m_hWndHook</a> = pMsg-&gt;hwnd;
02467                 ATLASSERT(pCmdBar-&gt;<a class="code" href="classWTL_1_1CCommandBarCtrlBase.html#a1">IsCommandBarBase</a>());
02468 
02469                 <font class="keywordflow">if</font>(::IsWindow(pCmdBar-&gt;m_hWnd))
02470                     pCmdBar-&gt;SendMessage(WM_FORWARDMSG, 0, (LPARAM)pMsg);
02471                 <font class="keywordflow">else</font>
02472                     ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - Hook skipping message, can't find command bar!\n"</font>);
02473             }
02474         }
02475 
02476         LRESULT lRet = 0;
02477         ATLASSERT(s_pmapMsgHook != NULL);
02478         <font class="keywordflow">if</font>(s_pmapMsgHook != NULL)
02479         {
02480             DWORD dwThreadID = ::GetCurrentThreadId();
02481             _MsgHookData* pData = s_pmapMsgHook-&gt;Lookup(dwThreadID);
02482             <font class="keywordflow">if</font>(pData != NULL)
02483             {
02484                 lRet = ::CallNextHookEx(pData-&gt;hMsgHook, nCode, wParam, lParam);
02485             }
02486         }
02487         <font class="keywordflow">return</font> lRet;
02488     }
02489 
02490 <font class="comment">// Implementation</font>
02491     <font class="keywordtype">void</font> DoPopupMenu(<font class="keywordtype">int</font> nIndex, <font class="keywordtype">bool</font> bAnimate)
02492     {
02493 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
02494 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - DoPopupMenu, bAnimate = %s\n"</font>, bAnimate ? <font class="stringliteral">"true"</font> : <font class="stringliteral">"false"</font>);
02495 <font class="preprocessor">#endif</font>
02496 <font class="preprocessor"></font>
02497         <font class="comment">// Menu animation flags</font>
02498 <font class="preprocessor">#ifndef TPM_VERPOSANIMATION</font>
02499 <font class="preprocessor"></font>        <font class="keyword">const</font> UINT TPM_VERPOSANIMATION = 0x1000L;
02500 <font class="preprocessor">#endif</font>
02501 <font class="preprocessor"></font><font class="preprocessor">#ifndef TPM_NOANIMATION</font>
02502 <font class="preprocessor"></font>        <font class="keyword">const</font> UINT TPM_NOANIMATION = 0x4000L;
02503 <font class="preprocessor">#endif</font>
02504 <font class="preprocessor"></font>        T* pT = static_cast&lt;T*&gt;(this);
02505 
02506         <font class="comment">// get popup menu and it's position</font>
02507         RECT rect;
02508         GetItemRect(nIndex, &amp;rect);
02509         MapWindowPoints(NULL, &amp;rect);
02510         TPMPARAMS TPMParams;
02511         TPMParams.cbSize = <font class="keyword">sizeof</font>(TPMPARAMS);
02512         TPMParams.rcExclude = rect;
02513         HMENU hMenuPopup = ::GetSubMenu(m_hMenu, nIndex);
02514         ATLASSERT(hMenuPopup != NULL);
02515 
02516         <font class="comment">// get button ID</font>
02517         TBBUTTON tbb;
02518         GetButton(nIndex, &amp;tbb);
02519         <font class="keywordtype">int</font> nCmdID = tbb.idCommand;
02520 
02521         m_nPopBtn = nIndex; <font class="comment">// remember current button's index</font>
02522 
02523         <font class="comment">// press button and display popup menu</font>
02524         PressButton(nCmdID, TRUE);
02525         SetHotItem(nCmdID);
02526         pT-&gt;DoTrackPopupMenu(hMenuPopup, TPM_LEFTBUTTON | TPM_VERTICAL | TPM_LEFTALIGN | TPM_TOPALIGN |
02527             (s_bW2K ? (bAnimate ? TPM_VERPOSANIMATION : TPM_NOANIMATION) : 0), rect.left, rect.bottom, &amp;TPMParams);
02528         PressButton(nCmdID, FALSE);
02529         <font class="keywordflow">if</font>(::GetFocus() != m_hWnd)
02530             SetHotItem(-1);
02531 
02532         m_nPopBtn = -1;     <font class="comment">// restore</font>
02533 
02534         <font class="comment">// eat next message if click is on the same button</font>
02535         MSG msg;
02536         <font class="keywordflow">if</font>(::PeekMessage(&amp;msg, m_hWnd, WM_LBUTTONDOWN, WM_LBUTTONDOWN, PM_NOREMOVE) &amp;&amp; ::PtInRect(&amp;rect, msg.pt))
02537             ::PeekMessage(&amp;msg, m_hWnd, WM_LBUTTONDOWN, WM_LBUTTONDOWN, PM_REMOVE);
02538 
02539         <font class="comment">// check if another popup menu should be displayed</font>
02540         <font class="keywordflow">if</font>(m_nNextPopBtn != -1)
02541         {
02542             PostMessage(GetAutoPopupMessage(), m_nNextPopBtn &amp; 0xFFFF);
02543             <font class="keywordflow">if</font>(!(m_nNextPopBtn &amp; 0xFFFF0000) &amp;&amp; !m_bPopupItem)
02544                 PostMessage(WM_KEYDOWN, VK_DOWN, 0);
02545             m_nNextPopBtn = -1;
02546         }
02547         <font class="keywordflow">else</font>
02548         {
02549             m_bContextMenu = <font class="keyword">false</font>;
02550             <font class="comment">// If user didn't hit escape, give focus back</font>
02551             <font class="keywordflow">if</font>(!m_bEscapePressed)
02552             {
02553                 <font class="keywordflow">if</font>(m_bUseKeyboardCues &amp;&amp; m_bShowKeyboardCues)
02554                     m_bAllowKeyboardCues = <font class="keyword">false</font>;
02555                 pT-&gt;GiveFocusBack();
02556             }
02557             <font class="keywordflow">else</font>
02558             {
02559                 SetHotItem(nCmdID);
02560                 SetAnchorHighlight(TRUE);
02561             }
02562         }
02563     }
02564 
02565     BOOL DoTrackPopupMenu(HMENU hMenu, UINT uFlags, <font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y, LPTPMPARAMS lpParams = NULL)
02566     {
02567         <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> menuPopup = hMenu;
02568 
02569         ::EnterCriticalSection(&amp;_Module.m_csWindowCreate);
02570 
02571         ATLASSERT(s_hCreateHook == NULL);
02572 
02573         s_pCurrentBar = static_cast&lt;CCommandBarCtrlBase*&gt;(this);
02574 
02575         s_hCreateHook = ::SetWindowsHookEx(WH_CBT, CreateHookProc, _Module.GetModuleInstance(), GetCurrentThreadId());
02576         ATLASSERT(s_hCreateHook != NULL);
02577 
02578         m_bPopupItem = <font class="keyword">false</font>;
02579         m_bMenuActive = <font class="keyword">true</font>;
02580 
02581         BOOL bTrackRet = menuPopup.TrackPopupMenuEx(uFlags, x, y, m_hWnd, lpParams);
02582         m_bMenuActive = <font class="keyword">false</font>;
02583 
02584         ::UnhookWindowsHookEx(s_hCreateHook);
02585 
02586         s_hCreateHook = NULL;
02587         s_pCurrentBar = NULL;
02588 
02589         ::LeaveCriticalSection(&amp;_Module.m_csWindowCreate);
02590 
02591         <font class="comment">// cleanup - convert menus back to original state</font>
02592 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
02593 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - TrackPopupMenu - cleanup\n"</font>);
02594 <font class="preprocessor">#endif</font>
02595 <font class="preprocessor"></font>
02596         ATLASSERT(m_stackMenuWnd.GetSize() == 0);
02597 
02598         UpdateWindow();
02599         <a class="code" href="classCWindow.html">CWindow</a> wndTL = GetTopLevelParent();
02600         wndTL.UpdateWindow();
02601 
02602         <font class="comment">// restore the menu items to the previous state for all menus that were converted</font>
02603         <font class="keywordflow">if</font>(m_bImagesVisible)
02604         {
02605             HMENU hMenuSav;
02606             <font class="keywordflow">while</font>((hMenuSav = m_stackMenuHandle.Pop()) != NULL)
02607             {
02608                 menuPopup = hMenuSav;
02609                 BOOL bRet;
02610                 <font class="comment">// restore state and delete menu item data</font>
02611                 <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; menuPopup.GetMenuItemCount(); i++)
02612                 {
02613                     <a class="code" href="classWTL_1_1CMenuItemInfo.html">CMenuItemInfo</a> mii;
02614                     mii.fMask = MIIM_DATA | MIIM_TYPE | MIIM_ID;
02615                     bRet = menuPopup.GetMenuItemInfo(i, TRUE, &amp;mii);
02616                     ATLASSERT(bRet);
02617 
02618                     _MenuItemData* pMI = (_MenuItemData*)mii.dwItemData;
02619                     <font class="keywordflow">if</font>(pMI != NULL &amp;&amp; pMI-&gt;IsCmdBarMenuItem())
02620                     {
02621                         mii.fMask = MIIM_DATA | MIIM_TYPE | MIIM_STATE;
02622                         mii.fType = pMI-&gt;fType;
02623                         mii.fState = pMI-&gt;fState;
02624                         mii.dwTypeData = pMI-&gt;lpstrText;
02625                         mii.cch = lstrlen(pMI-&gt;lpstrText);
02626                         mii.dwItemData = NULL;
02627 
02628                         bRet = menuPopup.SetMenuItemInfo(i, TRUE, &amp;mii);
02629                         <font class="comment">// this one triggers WM_MEASUREITEM</font>
02630                         menuPopup.ModifyMenu(i, MF_BYPOSITION | mii.fType | mii.fState, mii.wID, pMI-&gt;lpstrText);
02631                         ATLASSERT(bRet);
02632 
02633                         <font class="keyword">delete</font> [] pMI-&gt;lpstrText;
02634                         <font class="keyword">delete</font> pMI;
02635                     }
02636                 }
02637             }
02638         }
02639         <font class="keywordflow">return</font> bTrackRet;
02640     }
02641 
02642     <font class="keywordtype">int</font> GetPreviousMenuItem(<font class="keywordtype">int</font> nBtn)<font class="keyword"> const</font>
02643 <font class="keyword">    </font>{
02644         <font class="keywordflow">if</font>(nBtn == -1)
02645             <font class="keywordflow">return</font> -1;
02646 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02647 <font class="preprocessor"></font>        RECT rcClient;
02648         GetClientRect(&amp;rcClient);
02649 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02650 <font class="preprocessor"></font>        <font class="keywordtype">int</font> nNextBtn;
02651         <font class="keywordflow">for</font>(nNextBtn = nBtn - 1; nNextBtn != nBtn; nNextBtn--)
02652         {
02653             <font class="keywordflow">if</font>(nNextBtn &lt; 0)
02654                 nNextBtn = ::GetMenuItemCount(m_hMenu) - 1;
02655             TBBUTTON tbb = { 0 };
02656             GetButton(nNextBtn, &amp;tbb);
02657 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02658 <font class="preprocessor"></font>            RECT rcBtn;
02659             GetItemRect(nNextBtn, &amp;rcBtn);
02660             <font class="keywordflow">if</font>(rcBtn.right &gt; rcClient.right)
02661             {
02662                 nNextBtn = -2;  <font class="comment">// chevron</font>
02663                 <font class="keywordflow">break</font>;
02664             }
02665 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02666 <font class="preprocessor"></font>            <font class="keywordflow">if</font>((tbb.fsState &amp; TBSTATE_ENABLED) != 0 &amp;&amp; (tbb.fsState &amp; TBSTATE_HIDDEN) == 0)
02667                 <font class="keywordflow">break</font>;
02668         }
02669         <font class="keywordflow">return</font> (nNextBtn != nBtn) ? nNextBtn : -1;
02670     }
02671 
02672     <font class="keywordtype">int</font> GetNextMenuItem(<font class="keywordtype">int</font> nBtn)<font class="keyword"> const</font>
02673 <font class="keyword">    </font>{
02674         <font class="keywordflow">if</font>(nBtn == -1)
02675             <font class="keywordflow">return</font> -1;
02676 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02677 <font class="preprocessor"></font>        RECT rcClient;
02678         GetClientRect(&amp;rcClient);
02679 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02680 <font class="preprocessor"></font>        <font class="keywordtype">int</font> nNextBtn;
02681         <font class="keywordtype">int</font> nCount = ::GetMenuItemCount(m_hMenu);
02682         <font class="keywordflow">for</font>(nNextBtn = nBtn + 1; nNextBtn != nBtn; nNextBtn++)
02683         {
02684             <font class="keywordflow">if</font>(nNextBtn &gt;= nCount)
02685                 nNextBtn = 0;
02686             TBBUTTON tbb = { 0 };
02687             GetButton(nNextBtn, &amp;tbb);
02688 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02689 <font class="preprocessor"></font>            RECT rcBtn;
02690             GetItemRect(nNextBtn, &amp;rcBtn);
02691             <font class="keywordflow">if</font>(rcBtn.right &gt; rcClient.right)
02692             {
02693                 nNextBtn = -2;  <font class="comment">// chevron</font>
02694                 <font class="keywordflow">break</font>;
02695             }
02696 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02697 <font class="preprocessor"></font>            <font class="keywordflow">if</font>((tbb.fsState &amp; TBSTATE_ENABLED) != 0 &amp;&amp; (tbb.fsState &amp; TBSTATE_HIDDEN) == 0)
02698                 <font class="keywordflow">break</font>;
02699         }
02700         <font class="keywordflow">return</font> (nNextBtn != nBtn) ? nNextBtn : -1;
02701     }
02702 
02703 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02704 <font class="preprocessor"></font>    <font class="keywordtype">bool</font> DisplayChevronMenu()
02705     {
02706         <font class="comment">// assume we are in a rebar</font>
02707         HWND hWndReBar = GetParent();
02708         <font class="keywordtype">int</font> nCount = (int)::SendMessage(hWndReBar, RB_GETBANDCOUNT, 0, 0L);
02709         <font class="keywordtype">bool</font> bRet = <font class="keyword">false</font>;
02710         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; nCount; i++)
02711         {
02712             REBARBANDINFO rbbi = { <font class="keyword">sizeof</font>(REBARBANDINFO), RBBIM_CHILD | RBBIM_STYLE };
02713             BOOL bRetBandInfo = (BOOL)::SendMessage(hWndReBar, RB_GETBANDINFO, i, (LPARAM)&amp;rbbi);
02714             <font class="keywordflow">if</font>(bRetBandInfo &amp;&amp; rbbi.hwndChild == m_hWnd)
02715             {
02716                 <font class="keywordflow">if</font>((rbbi.fStyle &amp; RBBS_USECHEVRON) != 0)
02717                 {
02718                     ::PostMessage(hWndReBar, RB_PUSHCHEVRON, i, 0L);
02719                     PostMessage(WM_KEYDOWN, VK_DOWN, 0L);
02720                     bRet = <font class="keyword">true</font>;
02721                 }
02722                 <font class="keywordflow">break</font>;
02723             }
02724         }
02725         <font class="keywordflow">return</font> bRet;
02726     }
02727 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02728 <font class="preprocessor"></font>
02729     <font class="keywordtype">void</font> GetSystemSettings()
02730     {
02731         <font class="comment">// refresh our font</font>
02732         NONCLIENTMETRICS info;
02733         info.cbSize = <font class="keyword">sizeof</font>(info);
02734         BOOL bRet = ::SystemParametersInfo(SPI_GETNONCLIENTMETRICS, <font class="keyword">sizeof</font>(info), &amp;info, 0);
02735         ATLASSERT(bRet);
02736         <font class="keywordflow">if</font>(bRet)
02737         {
02738             LOGFONT logfont;
02739             memset(&amp;logfont, 0, <font class="keyword">sizeof</font>(LOGFONT));
02740             <font class="keywordflow">if</font>(m_fontMenu.m_hFont != NULL)
02741                 m_fontMenu.GetLogFont(logfont);
02742             <font class="keywordflow">if</font>(logfont.lfHeight != info.lfMenuFont.lfHeight ||
02743                logfont.lfWidth != info.lfMenuFont.lfWidth ||
02744                logfont.lfEscapement != info.lfMenuFont.lfEscapement ||
02745                logfont.lfOrientation != info.lfMenuFont.lfOrientation ||
02746                logfont.lfWeight != info.lfMenuFont.lfWeight ||
02747                logfont.lfItalic != info.lfMenuFont.lfItalic ||
02748                logfont.lfUnderline != info.lfMenuFont.lfUnderline ||
02749                logfont.lfStrikeOut != info.lfMenuFont.lfStrikeOut ||
02750                logfont.lfCharSet != info.lfMenuFont.lfCharSet ||
02751                logfont.lfOutPrecision != info.lfMenuFont.lfOutPrecision ||
02752                logfont.lfClipPrecision != info.lfMenuFont.lfClipPrecision ||
02753                logfont.lfQuality != info.lfMenuFont.lfQuality ||
02754                logfont.lfPitchAndFamily != info.lfMenuFont.lfPitchAndFamily ||
02755                lstrcmp(logfont.lfFaceName, info.lfMenuFont.lfFaceName) != 0)
02756             {
02757                 HFONT hFontMenu = ::CreateFontIndirect(&amp;info.lfMenuFont);
02758                 ATLASSERT(hFontMenu != NULL);
02759                 <font class="keywordflow">if</font>(hFontMenu != NULL)
02760                 {
02761                     <font class="keywordflow">if</font>(m_fontMenu.m_hFont != NULL)
02762                         m_fontMenu.DeleteObject();
02763                     m_fontMenu.Attach(hFontMenu);
02764                     SetFont(m_fontMenu);
02765                     AddStrings(_T(<font class="stringliteral">"NS\0"</font>)); <font class="comment">// for proper item height</font>
02766                     AutoSize();
02767                 }
02768             }
02769         }
02770 
02771         <font class="comment">// check if we need extra spacing for menu item text</font>
02772         <a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a> dc(m_hWnd);
02773         HFONT hFontOld = dc.<a class="code" href="classWTL_1_1CDCT.html#a28">SelectFont</a>(m_fontMenu);
02774         RECT rcText = { 0, 0, 0, 0 };
02775         dc.<a class="code" href="classWTL_1_1CDCT.html#a161">DrawText</a>(_T(<font class="stringliteral">"\t"</font>), -1, &amp;rcText, DT_SINGLELINE | DT_LEFT | DT_VCENTER | DT_CALCRECT);
02776         <font class="keywordflow">if</font>((rcText.right - rcText.left) &lt; 4)
02777         {
02778             ::SetRectEmpty(&amp;rcText);
02779             dc.<a class="code" href="classWTL_1_1CDCT.html#a161">DrawText</a>(_T(<font class="stringliteral">"x"</font>), -1, &amp;rcText, DT_SINGLELINE | DT_LEFT | DT_VCENTER | DT_CALCRECT);
02780             m_cxExtraSpacing = rcText.right - rcText.left;
02781         }
02782         <font class="keywordflow">else</font>
02783         {
02784             m_cxExtraSpacing = 0;
02785         }
02786         dc.<a class="code" href="classWTL_1_1CDCT.html#a28">SelectFont</a>(hFontOld);
02787 
02788         <font class="comment">// get Windows version</font>
02789         OSVERSIONINFO ovi = { <font class="keyword">sizeof</font>(OSVERSIONINFO) };
02790         ::GetVersionEx(&amp;ovi);
02791 
02792         <font class="comment">// query keyboard cues mode (Windows 2000 or later)</font>
02793         <font class="keywordflow">if</font>(ovi.dwMajorVersion &gt;= 5)
02794         {
02795 <font class="preprocessor">#ifndef SPI_GETKEYBOARDCUES</font>
02796 <font class="preprocessor"></font>            <font class="keyword">const</font> UINT SPI_GETKEYBOARDCUES = 0x100A;
02797 <font class="preprocessor">#endif </font>
02798 <font class="preprocessor">            BOOL bRetVal = TRUE;</font>
02799 <font class="preprocessor"></font>            bRet = ::SystemParametersInfo(SPI_GETKEYBOARDCUES, 0, &amp;bRetVal, 0);
02800             m_bUseKeyboardCues = (bRet &amp;&amp; !bRetVal);
02801             m_bAllowKeyboardCues = <font class="keyword">true</font>;
02802             ShowKeyboardCues(!m_bUseKeyboardCues);
02803         }
02804 
02805         <font class="comment">// query flat menu mode (Windows XP or later)</font>
02806         <font class="keywordflow">if</font>((ovi.dwMajorVersion == 5 &amp;&amp; ovi.dwMinorVersion &gt;= 1) || (ovi.dwMajorVersion &gt; 5))
02807         {
02808 <font class="preprocessor">#ifndef SPI_GETFLATMENU</font>
02809 <font class="preprocessor"></font>            <font class="keyword">const</font> UINT SPI_GETFLATMENU = 0x1022;
02810 <font class="preprocessor">#endif </font>
02811 <font class="preprocessor">            BOOL bRetVal = FALSE;</font>
02812 <font class="preprocessor"></font>            bRet = ::SystemParametersInfo(SPI_GETFLATMENU, 0, &amp;bRetVal, 0);
02813             m_bFlatMenus = (bRet &amp;&amp; bRetVal);
02814         }
02815 
02816 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
02817 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CmdBar - GetSystemSettings:\n     m_bFlatMenus = %s\n     m_bUseKeyboardCues = %s\n"</font>,
02818             m_bFlatMenus ? <font class="stringliteral">"true"</font> : <font class="stringliteral">"false"</font>, m_bUseKeyboardCues ? <font class="stringliteral">"true"</font> : <font class="stringliteral">"false"</font>);
02819 <font class="preprocessor">#endif</font>
02820 <font class="preprocessor"></font>    }
02821 
02822 <font class="comment">// Implementation - alternate focus mode support</font>
02823     <font class="keywordtype">void</font> TakeFocus()
02824     {
02825         <font class="keywordflow">if</font>((m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a7">CBR_EX_ALTFOCUSMODE</a>) &amp;&amp; m_hWndFocus == NULL)
02826             m_hWndFocus = ::GetFocus();
02827         SetFocus();
02828     }
02829 
02830     <font class="keywordtype">void</font> GiveFocusBack()
02831     {
02832         <font class="keywordflow">if</font>(m_bParentActive)
02833         {
02834             <font class="keywordflow">if</font>((m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a7">CBR_EX_ALTFOCUSMODE</a>) &amp;&amp; ::IsWindow(m_hWndFocus))
02835                 ::SetFocus(m_hWndFocus);
02836             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(!(m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a7">CBR_EX_ALTFOCUSMODE</a>) &amp;&amp; m_wndParent.IsWindow())
02837                 m_wndParent.SetFocus();
02838         }
02839         m_hWndFocus = NULL;
02840         SetAnchorHighlight(FALSE);
02841         <font class="keywordflow">if</font>(m_bUseKeyboardCues &amp;&amp; m_bShowKeyboardCues)
02842             ShowKeyboardCues(<font class="keyword">false</font>);
02843     }
02844 
02845     <font class="keywordtype">void</font> ShowKeyboardCues(<font class="keywordtype">bool</font> bShow)
02846     {
02847         m_bShowKeyboardCues = bShow;
02848         SetDrawTextFlags(DT_HIDEPREFIX, m_bShowKeyboardCues ? 0 : DT_HIDEPREFIX);
02849         Invalidate();
02850         UpdateWindow();
02851     }
02852 
02853 <font class="comment">// Implementation - internal message helpers</font>
02854     <font class="keyword">static</font> UINT GetAutoPopupMessage()
02855     {
02856         <font class="keyword">static</font> UINT uAutoPopupMessage = 0;
02857         <font class="keywordflow">if</font>(uAutoPopupMessage == 0)
02858         {
02859             ::EnterCriticalSection(&amp;_Module.m_csStaticDataInit);
02860             <font class="keywordflow">if</font>(uAutoPopupMessage == 0)
02861                 uAutoPopupMessage = ::RegisterWindowMessage(_T(<font class="stringliteral">"WTL_CmdBar_InternalAutoPopupMsg"</font>));
02862             ::LeaveCriticalSection(&amp;_Module.m_csStaticDataInit);
02863         }
02864         ATLASSERT(uAutoPopupMessage != 0);
02865         <font class="keywordflow">return</font> uAutoPopupMessage;
02866     }
02867 
02868     <font class="keyword">static</font> UINT GetGetBarMessage()
02869     {
02870         <font class="keyword">static</font> UINT uGetBarMessage = 0;
02871         <font class="keywordflow">if</font>(uGetBarMessage == 0)
02872         {
02873             ::EnterCriticalSection(&amp;_Module.m_csStaticDataInit);
02874             <font class="keywordflow">if</font>(uGetBarMessage == 0)
02875                 uGetBarMessage = ::RegisterWindowMessage(_T(<font class="stringliteral">"WTL_CmdBar_InternalGetBarMsg"</font>));
02876             ::LeaveCriticalSection(&amp;_Module.m_csStaticDataInit);
02877         }
02878         ATLASSERT(uGetBarMessage != 0);
02879         <font class="keywordflow">return</font> uGetBarMessage;
02880     }
02881 
02882 <font class="comment">// Implementation</font>
02883     <font class="keywordtype">bool</font> CreateInternalImageList(<font class="keywordtype">int</font> cImages)
02884     {
02885         UINT uFlags = (m_bAlphaImages ? ILC_COLOR32 : ILC_COLOR) | ILC_MASK;
02886         m_hImageList = ::ImageList_Create(m_szBitmap.cx, m_szBitmap.cy, uFlags, cImages, 1);
02887         ATLASSERT(m_hImageList != NULL);
02888         <font class="keywordflow">return</font> (m_hImageList != NULL);
02889     }
02890 };
02891 
02892 
<a name="l02893"></a><a class="code" href="classWTL_1_1CCommandBarCtrl.html">02893</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CCommandBarCtrl.html">CCommandBarCtrl</a> : <font class="keyword">public</font> <a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl</a>&lt;CCommandBarCtrl&gt;
02894 {
02895 <font class="keyword">public</font>:
02896     DECLARE_WND_SUPERCLASS(_T(<font class="stringliteral">"WTL_CommandBar"</font>), GetWndClassName())
02897 };
02898 
02899 
02901 <font class="comment">// CMDICommandBarCtrl - ATL implementation of Command Bars for MDI apps</font>
02902 
02903 <font class="comment">// Note: If this is used in a rebar, all menus should have the same top level items.</font>
02904 <font class="comment">// If you have different menus, you'll have to set the rebar band info when they switch.</font>
02905 
02906 
02907 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keyword">class</font> TBase = CCommandBarCtrlBase, <font class="keyword">class</font> TWinTraits = CControlWinTraits&gt;
<a name="l02908"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html">02908</a> <font class="keyword">class </font>ATL_NO_VTABLE CMDICommandBarCtrlImpl : <font class="keyword">public</font> <a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl</a>&lt; T, TBase, TWinTraits&gt;
02909 {
02910 <font class="keyword">public</font>:
02911 <font class="comment">// Data members</font>
<a name="l02912"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m0">02912</a>     CContainedWindow m_wndMDIClient;
<a name="l02913"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m1">02913</a>     <font class="keywordtype">bool</font> m_bChildMaximized;
<a name="l02914"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m2">02914</a>     HWND m_hWndChildMaximized;
<a name="l02915"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m3">02915</a>     HICON m_hIconChildMaximized;
<a name="l02916"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m4">02916</a>     <font class="keywordtype">int</font> m_nBtnPressed;
<a name="l02917"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m5">02917</a>     <font class="keywordtype">int</font> m_nBtnWasPressed;
02918 
<a name="l02919"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m6">02919</a>     <font class="keywordtype">int</font> m_cxyOffset;    <font class="comment">// offset between nonclient elements</font>
<a name="l02920"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m7">02920</a>     <font class="keywordtype">int</font> m_cxIconWidth;  <font class="comment">// small icon width</font>
<a name="l02921"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m8">02921</a>     <font class="keywordtype">int</font> m_cyIconHeight; <font class="comment">// small icon height</font>
<a name="l02922"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m9">02922</a>     <font class="keywordtype">int</font> m_cxBtnWidth;   <font class="comment">// nonclient button width</font>
<a name="l02923"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m10">02923</a>     <font class="keywordtype">int</font> m_cyBtnHeight;  <font class="comment">// nonclient button height</font>
<a name="l02924"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m11">02924</a>     <font class="keywordtype">int</font> m_cxLeft;       <font class="comment">// left nonclient area width</font>
<a name="l02925"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m12">02925</a>     <font class="keywordtype">int</font> m_cxRight;      <font class="comment">// right nonclient area width</font>
02926 
02927 <font class="comment">// Theme declarations and data members</font>
02928 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
02929 <font class="preprocessor"></font><font class="preprocessor">#ifndef _UXTHEME_H_</font>
<a name="l02930"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#s0">02930</a> <font class="preprocessor"></font>    <font class="keyword">typedef</font> HANDLE HTHEME;
02931 <font class="preprocessor">#endif </font>
<a name="l02932"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#s1">02932</a> <font class="preprocessor">    typedef HTHEME (STDAPICALLTYPE *PFN_OpenThemeData)(HWND hwnd, LPCWSTR pszClassList);</font>
<a name="l02933"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#s2">02933</a> <font class="preprocessor"></font>    <font class="keyword">typedef</font> HRESULT (STDAPICALLTYPE *PFN_CloseThemeData)(HTHEME hTheme);
<a name="l02934"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#s3">02934</a>     <font class="keyword">typedef</font> HRESULT (STDAPICALLTYPE *PFN_DrawThemeBackground)(HTHEME hTheme, HDC hdc, <font class="keywordtype">int</font> iPartId, <font class="keywordtype">int</font> iStateId, <font class="keyword">const</font> RECT *pRect, OPTIONAL <font class="keyword">const</font> RECT *pClipRect);
02935 
<a name="l02936"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m13">02936</a>     HMODULE m_hThemeDLL;
<a name="l02937"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m14">02937</a>     HTHEME m_hTheme;
<a name="l02938"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#m15">02938</a>     PFN_DrawThemeBackground m_pfnDrawThemeBackground;
02939 <font class="preprocessor">#endif </font>
02940 <font class="preprocessor"></font>
02941 <font class="preprocessor"></font><font class="comment">// Constructor/destructor</font>
<a name="l02942"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a0">02942</a>     CMDICommandBarCtrlImpl() : m_wndMDIClient(this, 2), m_bChildMaximized(false), 
02943                     m_hWndChildMaximized(NULL), m_hIconChildMaximized(NULL), 
02944                     m_nBtnPressed(-1), m_nBtnWasPressed(-1),
02945 #ifndef _WTL_NO_AUTO_THEME
02946                     m_hThemeDLL(NULL), m_hTheme(NULL), m_pfnDrawThemeBackground(NULL),
02947 #endif 
02948                     m_cxyOffset(2),
02949                     m_cxIconWidth(16), m_cyIconHeight(16),
02950                     m_cxBtnWidth(16), m_cyBtnHeight(14),
02951                     m_cxLeft(20), m_cxRight(55)
02952     { }
02953 
<a name="l02954"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a1">02954</a>     ~CMDICommandBarCtrlImpl()
02955     {
02956         <font class="keywordflow">if</font>(m_wndMDIClient.IsWindow())
02957 <font class="comment">/*scary!*/</font>          m_wndMDIClient.UnsubclassWindow();
02958     }
02959 
02960 <font class="comment">// Operations</font>
<a name="l02961"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a2">02961</a>     BOOL SetMDIClient(HWND hWndMDIClient)
02962     {
02963         ATLASSERT(::IsWindow(m_hWnd));
02964         ATLASSERT(::IsWindow(hWndMDIClient));
02965         <font class="keywordflow">if</font>(!::IsWindow(hWndMDIClient))
02966             <font class="keywordflow">return</font> FALSE;
02967 <font class="preprocessor">#ifdef _DEBUG</font>
02968 <font class="preprocessor"></font>        LPCTSTR lpszMDIClientClass = _T(<font class="stringliteral">"MDICLIENT"</font>);
02969         <font class="keywordtype">int</font> nNameLen = lstrlen(lpszMDIClientClass) + 1;
02970         LPTSTR lpstrClassName = (LPTSTR)_alloca(nNameLen * <font class="keyword">sizeof</font>(TCHAR));
02971         ::GetClassName(hWndMDIClient, lpstrClassName, nNameLen);
02972         ATLASSERT(lstrcmpi(lpstrClassName, lpszMDIClientClass) == 0);
02973         <font class="keywordflow">if</font>(lstrcmpi(lpstrClassName, lpszMDIClientClass) != 0)
02974             <font class="keywordflow">return</font> FALSE;   <font class="comment">// not an "MDIClient" window</font>
02975 <font class="preprocessor">#endif //_DEBUG</font>
02976 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_wndMDIClient.IsWindow())
02977 <font class="comment">/*scary!*/</font>      m_wndMDIClient.UnsubclassWindow();
02978 
02979         <font class="keywordflow">return</font> m_wndMDIClient.SubclassWindow(hWndMDIClient);
02980     }
02981 
02982 <font class="comment">// Message maps</font>
<a name="l02983"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#s4">02983</a>     <font class="keyword">typedef</font> <a class="code" href="classCCommandBarCtrlImpl.html">CCommandBarCtrlImpl&lt; T, TBase, TWinTraits &gt;</a> <a class="code" href="classCCommandBarCtrlImpl.html">_baseClass</a>;
02984     BEGIN_MSG_MAP(CMDICommandBarCtrlImpl)
02985         MESSAGE_HANDLER(WM_CREATE, OnCreate)
02986         MESSAGE_HANDLER(WM_DESTROY, OnDestroy)
02987 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
02988 <font class="preprocessor"></font>        MESSAGE_HANDLER(_GetThemeChangedMsg(), OnThemeChanged)
02989 <font class="preprocessor">#endif </font>
02990 <font class="preprocessor">        MESSAGE_HANDLER(WM_SIZE, OnSize)</font>
02991 <font class="preprocessor"></font>        MESSAGE_HANDLER(WM_NCCALCSIZE, OnNcCalcSize)
02992         MESSAGE_HANDLER(WM_NCPAINT, OnNcPaint)
02993         MESSAGE_HANDLER(WM_NCHITTEST, OnNcHitTest)
02994         MESSAGE_HANDLER(WM_NCLBUTTONDOWN, OnNcLButtonDown)
02995         MESSAGE_HANDLER(WM_MOUSEMOVE, OnMouseMove)
02996         MESSAGE_HANDLER(WM_LBUTTONUP, OnLButtonUp)
02997         MESSAGE_HANDLER(WM_NCLBUTTONDBLCLK, OnNcLButtonDblClk)
02998         MESSAGE_HANDLER(WM_CAPTURECHANGED, OnCaptureChanged)
02999         CHAIN_MSG_MAP(_baseClass)
03000     ALT_MSG_MAP(1)      <font class="comment">// Parent window messages</font>
03001         CHAIN_MSG_MAP_ALT(_baseClass, 1)
03002     ALT_MSG_MAP(2)      <font class="comment">// MDI client window messages</font>
03003         MESSAGE_HANDLER(WM_MDISETMENU, OnMDISetMenu)
03004         <font class="comment">// no chaining needed since this was moved from the base class here</font>
03005     ALT_MSG_MAP(3)      <font class="comment">// Message hook messages</font>
03006         MESSAGE_RANGE_HANDLER(0, 0xFFFF, OnAllHookMessages)
03007         CHAIN_MSG_MAP_ALT(_baseClass, 3)
03008     END_MSG_MAP()
03009 
03010 <font class="comment">// Additional MDI message handlers</font>
<a name="l03011"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a3">03011</a>     LRESULT OnCreate(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
03012     {
03013         LRESULT lRet = _baseClass::OnCreate(uMsg, wParam, lParam, bHandled);
03014         <font class="keywordflow">if</font>(lRet == (LRESULT)-1)
03015             <font class="keywordflow">return</font> lRet;
03016 
03017 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03018 <font class="preprocessor"></font>        <font class="comment">// this will fail if theming is not supported</font>
03019         m_hThemeDLL = ::LoadLibrary(_T(<font class="stringliteral">"uxtheme.dll"</font>));
03020         <font class="keywordflow">if</font>(m_hThemeDLL != NULL)
03021         {
03022             m_pfnDrawThemeBackground = (PFN_DrawThemeBackground)::GetProcAddress(m_hThemeDLL, <font class="stringliteral">"DrawThemeBackground"</font>);
03023             ATLASSERT(m_pfnDrawThemeBackground != NULL);
03024             <font class="keywordflow">if</font>(m_pfnDrawThemeBackground != NULL)
03025             {
03026                 T* pT = static_cast&lt;T*&gt;(this);
03027                 pT-&gt;_OpenThemeData();
03028             }
03029             <font class="keywordflow">else</font>
03030             {
03031                 ::FreeLibrary(m_hThemeDLL);
03032                 m_hThemeDLL = NULL;
03033             }
03034         }
03035 <font class="preprocessor">#endif </font>
03036 <font class="preprocessor"></font>
03037 <font class="preprocessor"></font>        <font class="keywordflow">return</font> lRet;
03038     }
03039 
<a name="l03040"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a4">03040</a>     LRESULT OnDestroy(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
03041     {
03042         LRESULT lRet = _baseClass::OnDestroy(uMsg, wParam, lParam, bHandled);
03043 
03044 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03045 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_hThemeDLL != NULL)
03046         {
03047             T* pT = static_cast&lt;T*&gt;(this);
03048             pT-&gt;_CloseThemeData();
03049             ::FreeLibrary(m_hThemeDLL);
03050             m_hThemeDLL = NULL;
03051         }
03052 <font class="preprocessor">#endif </font>
03053 <font class="preprocessor"></font>
03054 <font class="preprocessor"></font>        <font class="keywordflow">return</font> lRet;
03055     }
03056 
03057 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
<a name="l03058"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a5">03058</a> <font class="preprocessor"></font>    LRESULT OnThemeChanged(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
03059     {
03060         <font class="keywordflow">if</font>(m_hThemeDLL != NULL)
03061         {
03062             T* pT = static_cast&lt;T*&gt;(this);
03063             pT-&gt;_CloseThemeData();
03064             pT-&gt;_OpenThemeData();
03065         }
03066         <font class="keywordflow">return</font> 0;
03067     }
03068 <font class="preprocessor">#endif </font>
03069 <font class="preprocessor"></font>
<a name="l03070"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a6">03070</a> <font class="preprocessor"></font>    LRESULT OnSize(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
03071     {
03072         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
03073         T* pT = static_cast&lt;T*&gt;(this);
03074         pT-&gt;_AdjustBtnSize(<a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(lParam));
03075         <font class="keywordflow">return</font> lRet;
03076     }
03077 
<a name="l03078"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a7">03078</a>     LRESULT OnNcCalcSize(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
03079     {
03080         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
03081 
03082         <font class="keywordflow">if</font>(m_bChildMaximized &amp;&amp; (BOOL)wParam)
03083         {
03084             LPNCCALCSIZE_PARAMS lpParams = (LPNCCALCSIZE_PARAMS)lParam;
03085             lpParams-&gt;rgrc[0].left += m_cxLeft;
03086             lpParams-&gt;rgrc[0].right -= m_cxRight;
03087         }
03088 
03089         <font class="keywordflow">return</font> lRet;
03090     }
03091 
<a name="l03092"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a8">03092</a>     LRESULT OnNcPaint(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
03093     {
03094         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
03095 
03096         <font class="keywordflow">if</font>(!m_bChildMaximized)
03097             <font class="keywordflow">return</font> lRet;
03098 
03099         ATLASSERT(m_hWndChildMaximized != NULL &amp;&amp; m_hIconChildMaximized != NULL);
03100 
03101         <font class="comment">// get DC and window rectangle</font>
03102         <a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a> dc(m_hWnd);
03103         RECT rect;
03104         GetWindowRect(&amp;rect);
03105         <font class="keywordtype">int</font> cxWidth = rect.right - rect.left;
03106         <font class="keywordtype">int</font> cyHeight = rect.bottom - rect.top;
03107 
03108         <font class="comment">// paint left side nonclient background and draw icon</font>
03109         ::SetRect(&amp;rect, 0, 0, m_cxLeft, cyHeight);
03110 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03111 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_hTheme != NULL)
03112         {
03113             dc.<a class="code" href="classWTL_1_1CDCT.html#a116">FillRect</a>(&amp;rect, COLOR_WINDOW);
03114         }
03115         <font class="keywordflow">else</font>
03116 <font class="preprocessor">#endif </font>
03117 <font class="preprocessor">        {</font>
03118 <font class="preprocessor"></font>            <font class="keywordflow">if</font>((m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a5">CBR_EX_TRANSPARENT</a>) != 0)
03119                 dc.<a class="code" href="classWTL_1_1CDCT.html#a116">FillRect</a>(&amp;rect, COLOR_3DFACE);
03120             <font class="keywordflow">else</font>
03121                 dc.<a class="code" href="classWTL_1_1CDCT.html#a116">FillRect</a>(&amp;rect, COLOR_MENU);
03122         }
03123 
03124         RECT rcIcon;
03125         T* pT = static_cast&lt;T*&gt;(this);
03126         pT-&gt;_CalcIconRect(cyHeight, rcIcon);
03127         dc.DrawIconEx(rcIcon.left, rcIcon.top, m_hIconChildMaximized, m_cxIconWidth, m_cyIconHeight);
03128 
03129         <font class="comment">// paint right side nonclient background</font>
03130         ::SetRect(&amp;rect, cxWidth - m_cxRight, 0, cxWidth, cyHeight);
03131 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03132 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_hTheme != NULL)
03133         {
03134             dc.FillRect(&amp;rect, COLOR_WINDOW);
03135         }
03136         <font class="keywordflow">else</font>
03137 <font class="preprocessor">#endif </font>
03138 <font class="preprocessor">        {</font>
03139 <font class="preprocessor"></font>            <font class="keywordflow">if</font>((m_dwExtendedStyle &amp; <a class="code" href="atlctrlw_8h.html#a5">CBR_EX_TRANSPARENT</a>) != 0)
03140                 dc.FillRect(&amp;rect, COLOR_3DFACE);
03141             <font class="keywordflow">else</font>
03142                 dc.FillRect(&amp;rect, COLOR_MENU);
03143         }
03144 
03145         <font class="comment">// draw buttons</font>
03146         RECT arrRect[3];
03147         pT-&gt;_CalcBtnRects(cxWidth, cyHeight, arrRect);
03148         pT-&gt;_DrawMDIButton(dc, arrRect, -1);    <font class="comment">// draw all buttons</font>
03149 
03150         <font class="keywordflow">return</font> lRet;
03151     }
03152 
<a name="l03153"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a9">03153</a>     LRESULT OnNcHitTest(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
03154     {
03155         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
03156         <font class="keywordflow">if</font>(m_bChildMaximized)
03157         {
03158             RECT rect;
03159             GetWindowRect(&amp;rect);
03160             POINT pt = { <a class="code" href="atlapp_8h.html#a28">GET_X_LPARAM</a>(lParam) - rect.left, <a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(lParam) - rect.top };
03161             <font class="keywordflow">if</font>((pt.x &lt; m_cxLeft) || (pt.x &gt; ((rect.right - rect.left) - m_cxRight)))
03162                 lRet = HTBORDER;
03163         }
03164         <font class="keywordflow">return</font> lRet;
03165     }
03166 
<a name="l03167"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a10">03167</a>     LRESULT OnNcLButtonDown(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
03168     {
03169         <font class="keywordflow">if</font>(!m_bChildMaximized)
03170         {
03171             bHandled = FALSE;
03172             <font class="keywordflow">return</font> 1;
03173         }
03174 
03175         ATLASSERT(_DebugCheckChild());
03176 
03177         POINT pt = { <a class="code" href="atlapp_8h.html#a28">GET_X_LPARAM</a>(lParam), <a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(lParam) };
03178         RECT rect;
03179         GetWindowRect(&amp;rect);
03180         pt.x -= rect.left;
03181         pt.y -= rect.top;
03182 
03183         RECT rcIcon;
03184         T* pT = static_cast&lt;T*&gt;(this);
03185         pT-&gt;_CalcIconRect(rect.bottom - rect.top, rcIcon);
03186         RECT arrRect[3];
03187         pT-&gt;_CalcBtnRects(rect.right - rect.left, rect.bottom - rect.top, arrRect);
03188 
03189         <font class="keywordflow">if</font>(::PtInRect(&amp;rcIcon, pt))
03190         {
03191 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03192 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonDown: icon\n"</font>);
03193 <font class="preprocessor">#endif</font>
03194 <font class="preprocessor"></font><font class="preprocessor">#ifndef TPM_VERPOSANIMATION</font>
03195 <font class="preprocessor"></font>            <font class="keyword">const</font> UINT TPM_VERPOSANIMATION = 0x1000L;   <font class="comment">// Menu animation flag</font>
03196 <font class="preprocessor">#endif</font>
03197 <font class="preprocessor"></font>            <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> menu = ::GetSystemMenu(m_hWndChildMaximized, FALSE);
03198             UINT uRet = (UINT)menu.TrackPopupMenu(TPM_LEFTBUTTON | TPM_VERTICAL | TPM_LEFTALIGN | TPM_TOPALIGN | TPM_VERPOSANIMATION | TPM_RETURNCMD, 
03199                 rect.left, rect.bottom, m_hWndChildMaximized);
03200 
03201             <font class="comment">// eat next message if click is on the same button</font>
03202             ::OffsetRect(&amp;rcIcon, rect.left, rect.top);
03203             MSG msg;
03204             <font class="keywordflow">if</font>(::PeekMessage(&amp;msg, m_hWnd, WM_NCLBUTTONDOWN, WM_NCLBUTTONDOWN, PM_NOREMOVE) &amp;&amp; ::PtInRect(&amp;rcIcon, msg.pt))
03205                 ::PeekMessage(&amp;msg, m_hWnd, WM_NCLBUTTONDOWN, WM_NCLBUTTONDOWN, PM_REMOVE);
03206 
03207             <font class="keywordflow">if</font>(uRet != 0)
03208                 ::SendMessage(m_hWndChildMaximized, WM_SYSCOMMAND, uRet, 0L);
03209         }
03210         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(::PtInRect(&amp;arrRect[0], pt))
03211         {
03212 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03213 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonDown: close button\n"</font>);
03214 <font class="preprocessor">#endif</font>
03215 <font class="preprocessor"></font>            m_nBtnWasPressed = m_nBtnPressed = 0;
03216         }
03217         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(::PtInRect(&amp;arrRect[1], pt))
03218         {
03219 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03220 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonDown: restore button\n"</font>);
03221 <font class="preprocessor">#endif</font>
03222 <font class="preprocessor"></font>            m_nBtnWasPressed = m_nBtnPressed = 1;
03223         }
03224         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(::PtInRect(&amp;arrRect[2], pt))
03225         {
03226 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03227 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonDown: minimize button\n"</font>);
03228 <font class="preprocessor">#endif</font>
03229 <font class="preprocessor"></font>            m_nBtnWasPressed = m_nBtnPressed = 2;
03230         }
03231         <font class="keywordflow">else</font>
03232         {
03233             bHandled = FALSE;
03234         }
03235 
03236         <font class="comment">// draw the button state if it was pressed</font>
03237         <font class="keywordflow">if</font>(m_nBtnPressed != -1)
03238         {
03239             SetCapture();
03240             <a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a> dc(m_hWnd);
03241             pT-&gt;_DrawMDIButton(dc, arrRect, m_nBtnPressed);
03242         }
03243 
03244         <font class="keywordflow">return</font> 0;
03245     }
03246 
<a name="l03247"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a11">03247</a>     LRESULT OnMouseMove(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
03248     {
03249         <font class="keywordflow">if</font>(!m_bChildMaximized || ::GetCapture() != m_hWnd || m_nBtnWasPressed == -1)
03250         {
03251             bHandled = FALSE;
03252             <font class="keywordflow">return</font> 1;
03253         }
03254 
03255         POINT pt = { <a class="code" href="atlapp_8h.html#a28">GET_X_LPARAM</a>(lParam), <a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(lParam) };
03256         ClientToScreen(&amp;pt);
03257         RECT rect;
03258         GetWindowRect(&amp;rect);
03259         pt.x -= rect.left;
03260         pt.y -= rect.top;
03261         RECT arrRect[3];
03262         T* pT = static_cast&lt;T*&gt;(this);
03263         pT-&gt;_CalcBtnRects(rect.right - rect.left, rect.bottom - rect.top, arrRect);
03264         <font class="keywordtype">int</font> nOldBtnPressed = m_nBtnPressed;
03265         m_nBtnPressed = ::PtInRect(&amp;arrRect[m_nBtnWasPressed], pt) ? m_nBtnWasPressed : -1;
03266         <font class="keywordflow">if</font>(nOldBtnPressed != m_nBtnPressed)
03267         {
03268             <a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a> dc(m_hWnd);
03269             pT-&gt;_DrawMDIButton(dc, arrRect, (m_nBtnPressed != -1) ? m_nBtnPressed : nOldBtnPressed);
03270         }
03271 
03272         <font class="keywordflow">return</font> 0;
03273     }
03274 
<a name="l03275"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a12">03275</a>     LRESULT OnLButtonUp(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
03276     {
03277         <font class="keywordflow">if</font>(!m_bChildMaximized || ::GetCapture() != m_hWnd || m_nBtnWasPressed == -1)
03278         {
03279             bHandled = FALSE;
03280             <font class="keywordflow">return</font> 1;
03281         }
03282 
03283         ATLASSERT(_DebugCheckChild());
03284 
03285         POINT pt = { <a class="code" href="atlapp_8h.html#a28">GET_X_LPARAM</a>(lParam), <a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(lParam) };
03286         ClientToScreen(&amp;pt);
03287         RECT rect;
03288         GetWindowRect(&amp;rect);
03289         pt.x -= rect.left;
03290         pt.y -= rect.top;
03291 
03292         <font class="keywordtype">int</font> nBtn = m_nBtnWasPressed;
03293         ReleaseCapture();
03294 
03295         RECT arrRect[3];
03296         T* pT = static_cast&lt;T*&gt;(this);
03297         pT-&gt;_CalcBtnRects(rect.right - rect.left, rect.bottom - rect.top, arrRect);
03298         <font class="keywordflow">if</font>(::PtInRect(&amp;arrRect[nBtn], pt))
03299         {
03300             <font class="keywordflow">switch</font>(nBtn)
03301             {
03302             <font class="keywordflow">case</font> 0:     <font class="comment">// close</font>
03303 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03304 <font class="preprocessor"></font>                ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonUp: close button\n"</font>);
03305 <font class="preprocessor">#endif</font>
03306 <font class="preprocessor"></font>                ::SendMessage(m_hWndChildMaximized, WM_SYSCOMMAND, SC_CLOSE, 0L);
03307                 <font class="keywordflow">break</font>;
03308             <font class="keywordflow">case</font> 1:     <font class="comment">// restore</font>
03309 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03310 <font class="preprocessor"></font>                ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonUp: restore button\n"</font>);
03311 <font class="preprocessor">#endif</font>
03312 <font class="preprocessor"></font>                ::SendMessage(m_hWndChildMaximized, WM_SYSCOMMAND, SC_RESTORE, 0L);
03313                 <font class="keywordflow">break</font>;
03314             <font class="keywordflow">case</font> 2:     <font class="comment">// minimize</font>
03315 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03316 <font class="preprocessor"></font>                ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - LButtonUp: minimize button\n"</font>);
03317 <font class="preprocessor">#endif</font>
03318 <font class="preprocessor"></font>                ::SendMessage(m_hWndChildMaximized, WM_SYSCOMMAND, SC_MINIMIZE, 0L);
03319                 <font class="keywordflow">break</font>;
03320             <font class="keywordflow">default</font>:
03321                 <font class="keywordflow">break</font>;
03322             }
03323         }
03324 
03325         <font class="keywordflow">return</font> 0;
03326     }
03327 
<a name="l03328"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a13">03328</a>     LRESULT OnNcLButtonDblClk(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
03329     {
03330         <font class="keywordflow">if</font>(!m_bChildMaximized || m_nBtnWasPressed != -1)
03331         {
03332             bHandled = FALSE;
03333             <font class="keywordflow">return</font> 1;
03334         }
03335 
03336         ATLASSERT(_DebugCheckChild());
03337 
03338         POINT pt = { <a class="code" href="atlapp_8h.html#a28">GET_X_LPARAM</a>(lParam), <a class="code" href="atlapp_8h.html#a29">GET_Y_LPARAM</a>(lParam) };
03339         RECT rect;
03340         GetWindowRect(&amp;rect);
03341         pt.x -= rect.left;
03342         pt.y -= rect.top;
03343 
03344         RECT rcIcon;
03345         T* pT = static_cast&lt;T*&gt;(this);
03346         pT-&gt;_CalcIconRect(rect.bottom - rect.top, rcIcon);
03347         RECT arrRect[3];
03348         pT-&gt;_CalcBtnRects(rect.right - rect.left, rect.bottom - rect.top, arrRect);
03349 
03350         <font class="keywordflow">if</font>(::PtInRect(&amp;rcIcon, pt))
03351         {
03352             <a class="code" href="namespaceWTL.html#a57">CMenuHandle</a> menu = ::GetSystemMenu(m_hWndChildMaximized, FALSE);
03353             UINT uDefID = menu.GetMenuDefaultItem();
03354             <font class="keywordflow">if</font>(uDefID == (UINT)-1)
03355                 uDefID = SC_CLOSE;
03356             ::SendMessage(m_hWndChildMaximized, WM_SYSCOMMAND, uDefID, 0L);
03357         }
03358 
03359         <font class="keywordflow">return</font> 0;
03360     }
03361 
<a name="l03362"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a14">03362</a>     LRESULT OnCaptureChanged(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
03363     {
03364         <font class="keywordflow">if</font>(m_bChildMaximized &amp;&amp; m_nBtnPressed != -1)
03365         {
03366             ATLASSERT(m_nBtnPressed == m_nBtnWasPressed);   <font class="comment">// must be</font>
03367             m_nBtnPressed = -1;
03368             RECT rect;
03369             GetWindowRect(&amp;rect);
03370             RECT arrRect[3];
03371             T* pT = static_cast&lt;T*&gt;(this);
03372             pT-&gt;_CalcBtnRects(rect.right - rect.left, rect.bottom - rect.top, arrRect);
03373             <a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a> dc(m_hWnd);
03374             pT-&gt;_DrawMDIButton(dc, arrRect, m_nBtnWasPressed);
03375             m_nBtnWasPressed = -1;
03376         }
03377         <font class="keywordflow">else</font>
03378         {
03379             bHandled = FALSE;
03380         }
03381         <font class="keywordflow">return</font> 0;
03382     }
03383 
03384 <font class="comment">// MDI client window message handlers</font>
<a name="l03385"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a15">03385</a>     LRESULT OnMDISetMenu(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
03386     {
03387         m_wndMDIClient.DefWindowProc(uMsg, NULL, lParam);
03388         HMENU hOldMenu = GetMenu();
03389         BOOL bRet = AttachMenu((HMENU)wParam);
03390         bRet;
03391         ATLASSERT(bRet);
03392         <font class="keywordflow">return</font> (LRESULT)hOldMenu;
03393     }
03394 
03395 <font class="comment">// All messages from the message hook - check for the maximized MDI child window change</font>
<a name="l03396"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a16">03396</a>     LRESULT OnAllHookMessages(UINT uMsg, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
03397     {
03398         bHandled = FALSE;
03399         <font class="keywordflow">if</font>(uMsg == WM_MDIGETACTIVE || uMsg == WM_MDISETMENU)
03400             <font class="keywordflow">return</font> 1;
03401 
03402         BOOL bMaximized = FALSE;
03403         HWND hWndChild = (HWND)::SendMessage(m_wndMDIClient, WM_MDIGETACTIVE, 0, (LPARAM)&amp;bMaximized);
03404         <font class="keywordtype">bool</font> bMaxOld = m_bChildMaximized;
03405         m_bChildMaximized = (hWndChild != NULL &amp;&amp; bMaximized);
03406 
03407         <font class="keywordflow">if</font>(m_bChildMaximized)
03408         {
03409             <font class="keywordflow">if</font>(m_hWndChildMaximized != hWndChild)
03410             {
03411                 <a class="code" href="classCWindow.html">CWindow</a> wnd = m_hWndChildMaximized = hWndChild;
03412                 m_hIconChildMaximized = wnd.GetIcon(FALSE);
03413                 <font class="keywordflow">if</font>(m_hIconChildMaximized == NULL)   <font class="comment">// no icon set with WM_SETICON, get the class one</font>
03414                 {
03415                     TCHAR szClass[200];
03416                     ::GetClassName(wnd, szClass, <font class="keyword">sizeof</font>(szClass) / <font class="keyword">sizeof</font>(TCHAR));
03417                     WNDCLASSEX wc;
03418                     wc.cbSize = <font class="keyword">sizeof</font>(WNDCLASSEX);
03419                     <font class="comment">// try process local class first</font>
03420                     BOOL bRet = ::GetClassInfoEx(_Module.GetModuleInstance(), szClass, &amp;wc);
03421                     <font class="keywordflow">if</font>(!bRet)   <font class="comment">// try global class</font>
03422                         bRet = ::GetClassInfoEx(NULL, szClass, &amp;wc);
03423                     m_hIconChildMaximized = bRet ? wc.hIcon : NULL;
03424                 }
03425             }
03426         }
03427         <font class="keywordflow">else</font>
03428         {
03429             m_hWndChildMaximized = NULL;
03430             m_hIconChildMaximized = NULL;
03431         }
03432 
03433         <font class="keywordflow">if</font>(bMaxOld != m_bChildMaximized)
03434         {
03435 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03436 <font class="preprocessor"></font>            ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - All messages hook change: m_bChildMaximized = %s\n"</font>, m_bChildMaximized ? <font class="stringliteral">"true"</font> : <font class="stringliteral">"false"</font>);
03437 <font class="preprocessor">#endif</font>
03438 <font class="preprocessor"></font>            <font class="comment">// assuming we are in a rebar, change our size to accomodate new state</font>
03439             <font class="comment">// we hope that if we are not in a rebar, nCount will be 0</font>
03440             <font class="keywordtype">int</font> nCount = (int)::SendMessage(GetParent(), RB_GETBANDCOUNT, 0, 0L);
03441             <font class="keywordtype">int</font> cxDiff = (m_bChildMaximized ? 1 : -1) * (m_cxLeft + m_cxRight);
03442             <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; nCount; i++)
03443             { 
03444 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
03445 <font class="preprocessor"></font>                REBARBANDINFO rbi = { <font class="keyword">sizeof</font>(REBARBANDINFO), RBBIM_CHILD | RBBIM_CHILDSIZE | RBBIM_IDEALSIZE | RBBIM_STYLE };
03446                 ::SendMessage(GetParent(), RB_GETBANDINFO, i, (LPARAM)&amp;rbi);
03447                 <font class="keywordflow">if</font>(rbi.hwndChild == m_hWnd)
03448                 {
03449                     <font class="keywordflow">if</font>((rbi.fStyle &amp; RBBS_USECHEVRON) != 0)
03450                     {
03451                         rbi.fMask = RBBIM_CHILDSIZE | RBBIM_IDEALSIZE;
03452                         rbi.cxMinChild += cxDiff;
03453                         rbi.cxIdeal += cxDiff;
03454                         ::SendMessage(GetParent(), RB_SETBANDINFO, i, (LPARAM)&amp;rbi);
03455                     }
03456                     <font class="keywordflow">break</font>;
03457                 }
03458 <font class="preprocessor">#else </font>
03459 <font class="preprocessor">                REBARBANDINFO rbi = { sizeof(REBARBANDINFO), RBBIM_CHILD | RBBIM_CHILDSIZE };</font>
03460 <font class="preprocessor"></font>                ::SendMessage(GetParent(), RB_GETBANDINFO, i, (LPARAM)&amp;rbi);
03461                 <font class="keywordflow">if</font>(rbi.hwndChild == m_hWnd)
03462                 {
03463                     rbi.fMask = RBBIM_CHILDSIZE;
03464                     rbi.cxMinChild += cxDiff;
03465                     ::SendMessage(GetParent(), RB_SETBANDINFO, i, (LPARAM)&amp;rbi);
03466                     <font class="keywordflow">break</font>;
03467                 }
03468 <font class="preprocessor">#endif </font>
03469 <font class="preprocessor">            }</font>
03470 <font class="preprocessor"></font>
03471             <font class="comment">// force size change and redraw everything</font>
03472             RECT rect;
03473             GetWindowRect(&amp;rect);
03474             ::MapWindowPoints(NULL, GetParent(), (LPPOINT)&amp;rect, 2);
03475             SetRedraw(FALSE);
03476             SetWindowPos(NULL, 0, 0, 1, 1, SWP_NOZORDER | SWP_NOMOVE);
03477             SetWindowPos(NULL, &amp;rect, SWP_NOZORDER | SWP_NOMOVE);
03478             SetRedraw(TRUE);
03479             RedrawWindow(NULL, NULL, RDW_FRAME | RDW_INVALIDATE | RDW_UPDATENOW);
03480         }
03481 
03482         <font class="keywordflow">return</font> 1;
03483     }
03484 
03485 <font class="comment">// Implementation</font>
<a name="l03486"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a17">03486</a>     <font class="keywordtype">void</font> GetSystemSettings()
03487     {
03488 <font class="preprocessor">#ifdef _CMDBAR_EXTRA_TRACE</font>
03489 <font class="preprocessor"></font>        ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"MDI CmdBar - GetSystemSettings\n"</font>);
03490 <font class="preprocessor">#endif</font>
03491 <font class="preprocessor"></font>        _baseClass::GetSystemSettings();
03492 
03493         NONCLIENTMETRICS info = { <font class="keyword">sizeof</font>(NONCLIENTMETRICS) };
03494         BOOL bRet = ::SystemParametersInfo(SPI_GETNONCLIENTMETRICS, <font class="keyword">sizeof</font>(info), &amp;info, 0);
03495         ATLASSERT(bRet);
03496         <font class="keywordflow">if</font>(bRet)
03497         {
03498             m_cxIconWidth = ::GetSystemMetrics(SM_CXSMICON);
03499             m_cyIconHeight = ::GetSystemMetrics(SM_CYSMICON);
03500             m_cxLeft = m_cxIconWidth;
03501 
03502 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03503 <font class="preprocessor"></font>            <font class="keywordflow">if</font>(m_hTheme != NULL)
03504             {
03505                 m_cxBtnWidth = info.iCaptionWidth - 2 * m_cxyOffset;
03506                 m_cyBtnHeight = info.iCaptionHeight - 2 * m_cxyOffset;
03507                 m_cxRight = 3 * m_cxBtnWidth;
03508             }
03509             <font class="keywordflow">else</font>
03510 <font class="preprocessor">#endif </font>
03511 <font class="preprocessor">            {</font>
03512 <font class="preprocessor"></font>                m_cxBtnWidth = info.iCaptionWidth - m_cxyOffset;
03513                 m_cyBtnHeight = info.iCaptionHeight - 2 * m_cxyOffset;
03514                 m_cxRight = 3 * m_cxBtnWidth + m_cxyOffset;
03515             }
03516         }
03517 
03518         RECT rect;
03519         GetClientRect(&amp;rect);
03520         T* pT = static_cast&lt;T*&gt;(this);
03521         pT-&gt;_AdjustBtnSize(rect.bottom);
03522     }
03523 
<a name="l03524"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a18">03524</a>     <font class="keywordtype">void</font> _AdjustBtnSize(<font class="keywordtype">int</font> cyHeight)
03525     {
03526         <font class="keywordflow">if</font>(cyHeight &gt; 1 &amp;&amp; m_cyBtnHeight &gt; cyHeight)
03527         {
03528 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03529 <font class="preprocessor"></font>            <font class="keywordflow">if</font>(m_hTheme != NULL)
03530             {
03531                 m_cyBtnHeight = cyHeight;
03532                 m_cxBtnWidth = cyHeight;
03533                 m_cxRight = 3 * m_cxBtnWidth;
03534             }
03535             <font class="keywordflow">else</font>
03536 <font class="preprocessor">#endif </font>
03537 <font class="preprocessor">            {</font>
03538 <font class="preprocessor"></font>                m_cyBtnHeight = cyHeight;
03539                 m_cxBtnWidth = cyHeight + m_cxyOffset;
03540                 m_cxRight = 3 * m_cxBtnWidth + m_cxyOffset;
03541             }
03542         }
03543     }
03544 
<a name="l03545"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a19">03545</a>     <font class="keywordtype">void</font> _CalcIconRect(<font class="keywordtype">int</font> cyHeight, RECT&amp; rect)
03546     {
03547         <font class="keywordtype">int</font> xStart = (m_cxLeft - m_cxIconWidth) / 2;
03548         <font class="keywordflow">if</font>(xStart &lt; 0)
03549             xStart = 0;
03550         <font class="keywordtype">int</font> yStart = (cyHeight - m_cyIconHeight) / 2;
03551         <font class="keywordflow">if</font>(yStart &lt; 0)
03552             yStart = 0;
03553 
03554         ::SetRect(&amp;rect, xStart, yStart, xStart + m_cxBtnWidth, yStart + m_cyBtnHeight);
03555     }
03556 
<a name="l03557"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a20">03557</a>     <font class="keywordtype">void</font> _CalcBtnRects(<font class="keywordtype">int</font> cxWidth, <font class="keywordtype">int</font> cyHeight, RECT arrRect[3])<font class="keyword"> const</font>
03558 <font class="keyword">    </font>{
03559         <font class="keywordtype">int</font> yStart = (cyHeight - m_cyBtnHeight) / 2;
03560         <font class="keywordflow">if</font>(yStart &lt; 0)
03561             yStart = 0;
03562 
03563         RECT rcBtn = { cxWidth - m_cxBtnWidth, yStart, cxWidth, yStart + m_cyBtnHeight };
03564         arrRect[0] = rcBtn;
03565 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03566 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_hTheme != NULL)
03567             ::OffsetRect(&amp;rcBtn, -m_cxBtnWidth, 0);
03568         <font class="keywordflow">else</font>
03569 <font class="preprocessor">#endif </font>
03570 <font class="preprocessor">            ::OffsetRect(&amp;rcBtn, -(m_cxBtnWidth + m_cxyOffset), 0);</font>
03571 <font class="preprocessor"></font>        arrRect[1] = rcBtn;
03572         ::OffsetRect(&amp;rcBtn, -m_cxBtnWidth, 0);
03573         arrRect[2] = rcBtn;
03574     }
03575 
<a name="l03576"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a21">03576</a>     <font class="keywordtype">void</font> _DrawMDIButton(<a class="code" href="classWTL_1_1CWindowDC.html">CWindowDC</a>&amp; dc, LPRECT pRects, <font class="keywordtype">int</font> nBtn)
03577     {
03578 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
03579 <font class="preprocessor"></font>        <font class="keywordflow">if</font>(m_hTheme != NULL)
03580         {
03581 <font class="preprocessor">#ifndef TMSCHEMA_H</font>
03582 <font class="preprocessor"></font>            <font class="keyword">const</font> <font class="keywordtype">int</font> WP_MDICLOSEBUTTON = 20;
03583             <font class="keyword">const</font> <font class="keywordtype">int</font> CBS_NORMAL = 1;
03584             <font class="keyword">const</font> <font class="keywordtype">int</font> CBS_PUSHED = 3;
03585             <font class="keyword">const</font> <font class="keywordtype">int</font> WP_MDIRESTOREBUTTON = 22;
03586             <font class="keyword">const</font> <font class="keywordtype">int</font> RBS_NORMAL = 1;
03587             <font class="keyword">const</font> <font class="keywordtype">int</font> RBS_PUSHED = 3;
03588             <font class="keyword">const</font> <font class="keywordtype">int</font> WP_MDIMINBUTTON = 16;
03589             <font class="keyword">const</font> <font class="keywordtype">int</font> MINBS_NORMAL = 1;
03590             <font class="keyword">const</font> <font class="keywordtype">int</font> MINBS_PUSHED = 3;
03591 <font class="preprocessor">#endif //TMSCHEMA_H</font>
03592 <font class="preprocessor"></font>            <font class="keywordflow">if</font>(nBtn == -1 || nBtn == 0)
03593                 m_pfnDrawThemeBackground(m_hTheme, dc, WP_MDICLOSEBUTTON, (m_nBtnPressed == 0) ? CBS_PUSHED : CBS_NORMAL, &amp;pRects[0], NULL);
03594             <font class="keywordflow">if</font>(nBtn == -1 || nBtn == 1)
03595                 m_pfnDrawThemeBackground(m_hTheme, dc, WP_MDIRESTOREBUTTON, (m_nBtnPressed == 1) ? RBS_PUSHED : RBS_NORMAL, &amp;pRects[1], NULL);
03596             <font class="keywordflow">if</font>(nBtn == -1 || nBtn == 2)
03597                 m_pfnDrawThemeBackground(m_hTheme, dc, WP_MDIMINBUTTON, (m_nBtnPressed == 2) ? MINBS_PUSHED : MINBS_NORMAL, &amp;pRects[2], NULL);
03598         }
03599         <font class="keywordflow">else</font>
03600 <font class="preprocessor">#endif </font>
03601 <font class="preprocessor">        {</font>
03602 <font class="preprocessor"></font>            <font class="keywordflow">if</font>(nBtn == -1 || nBtn == 0)
03603                 dc.<a class="code" href="classWTL_1_1CDCT.html#a176">DrawFrameControl</a>(&amp;pRects[0], DFC_CAPTION, DFCS_CAPTIONCLOSE | ((m_nBtnPressed == 0) ? DFCS_PUSHED : 0));
03604             <font class="keywordflow">if</font>(nBtn == -1 || nBtn == 1)
03605                 dc.<a class="code" href="classWTL_1_1CDCT.html#a176">DrawFrameControl</a>(&amp;pRects[1], DFC_CAPTION, DFCS_CAPTIONRESTORE | ((m_nBtnPressed == 1) ? DFCS_PUSHED : 0));
03606             <font class="keywordflow">if</font>(nBtn == -1 || nBtn == 2)
03607                 dc.<a class="code" href="classWTL_1_1CDCT.html#a176">DrawFrameControl</a>(&amp;pRects[2], DFC_CAPTION, DFCS_CAPTIONMIN | ((m_nBtnPressed == 2) ? DFCS_PUSHED : 0));
03608         }
03609     }
03610 
03611 <font class="preprocessor">#ifndef _WTL_NO_AUTO_THEME</font>
<a name="l03612"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#d0">03612</a> <font class="preprocessor"></font>    <font class="keyword">static</font> UINT _GetThemeChangedMsg()
03613     {
03614 <font class="preprocessor">#ifndef WM_THEMECHANGED</font>
03615 <font class="preprocessor"></font>        <font class="keyword">static</font> <font class="keyword">const</font> UINT WM_THEMECHANGED = 0x031A;
03616 <font class="preprocessor">#endif </font>
03617 <font class="preprocessor">        return WM_THEMECHANGED;</font>
03618 <font class="preprocessor"></font>    }
03619 
<a name="l03620"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a22">03620</a>     <font class="keywordtype">void</font> _OpenThemeData()
03621     {
03622         ATLASSERT(m_hThemeDLL != NULL);
03623 
03624         PFN_OpenThemeData pfnOpenThemeData = (PFN_OpenThemeData)::GetProcAddress(m_hThemeDLL, <font class="stringliteral">"OpenThemeData"</font>);
03625         ATLASSERT(pfnOpenThemeData != NULL);
03626         <font class="keywordflow">if</font>(pfnOpenThemeData != NULL)
03627             m_hTheme = pfnOpenThemeData(m_hWnd, L<font class="stringliteral">"Window"</font>);
03628     }
03629 
<a name="l03630"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a23">03630</a>     <font class="keywordtype">void</font> _CloseThemeData()
03631     {
03632         ATLASSERT(m_hThemeDLL != NULL);
03633 
03634         <font class="keywordflow">if</font>(m_hTheme == NULL)
03635             <font class="keywordflow">return</font>; <font class="comment">// nothing to do</font>
03636 
03637         PFN_CloseThemeData pfnCloseThemeData = (PFN_CloseThemeData)::GetProcAddress(m_hThemeDLL, <font class="stringliteral">"CloseThemeData"</font>);
03638         ATLASSERT(pfnCloseThemeData != NULL);
03639         <font class="keywordflow">if</font>(pfnCloseThemeData != NULL)
03640         {
03641             pfnCloseThemeData(m_hTheme);
03642             m_hTheme = NULL;
03643         }
03644     }
03645 <font class="preprocessor">#endif </font>
03646 <font class="preprocessor"></font>
<a name="l03647"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html#a24">03647</a> <font class="preprocessor"></font>    <font class="keywordtype">bool</font> _DebugCheckChild()
03648     {
03649 <font class="preprocessor">#ifdef _DEBUG</font>
03650 <font class="preprocessor"></font>        BOOL bMaximized = FALSE;
03651         HWND hWndChild = (HWND)::SendMessage(m_wndMDIClient, WM_MDIGETACTIVE, 0, (LPARAM)&amp;bMaximized);
03652         <font class="keywordflow">return</font> (bMaximized &amp;&amp; hWndChild == m_hWndChildMaximized);
03653 <font class="preprocessor">#else </font>
03654 <font class="preprocessor">        return true;</font>
03655 <font class="preprocessor"></font><font class="preprocessor">#endif </font>
03656 <font class="preprocessor">    }</font>
03657 <font class="preprocessor"></font>};
03658 
<a name="l03659"></a><a class="code" href="classWTL_1_1CMDICommandBarCtrl.html">03659</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CMDICommandBarCtrl.html">CMDICommandBarCtrl</a> : <font class="keyword">public</font> <a class="code" href="classWTL_1_1CMDICommandBarCtrlImpl.html">CMDICommandBarCtrlImpl</a>&lt;CMDICommandBarCtrl&gt;
03660 {
03661 <font class="keyword">public</font>:
03662     DECLARE_WND_SUPERCLASS(_T(<font class="stringliteral">"WTL_MDICommandBar"</font>), GetWndClassName())
03663 };
03664 
03665 }; <font class="comment">//namespace WTL</font>
03666 
03667 <font class="preprocessor">#endif // __ATLCTRLW_H__</font>
</pre></div><hr><address align="right"><small>Generated on Thu Apr 11 21:09:30 2002 for wtl-doc by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
