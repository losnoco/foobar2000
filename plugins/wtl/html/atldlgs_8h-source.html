<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>atldlgs.h Source File</title>
<link href="mystyles.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>atldlgs.h</h1><a href="atldlgs_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Windows Template Library - WTL version 7.0</font>
00002 <font class="comment">// Copyright (C) 1997-2002 Microsoft Corporation</font>
00003 <font class="comment">// All rights reserved.</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// This file is a part of the Windows Template Library.</font>
00006 <font class="comment">// The code and information is provided "as-is" without</font>
00007 <font class="comment">// warranty of any kind, either expressed or implied.</font>
00008 
00009 <font class="preprocessor">#ifndef __ATLDLGS_H__</font>
00010 <font class="preprocessor"></font><font class="preprocessor">#define __ATLDLGS_H__</font>
00011 <font class="preprocessor"></font>
00012 <font class="preprocessor">#pragma once</font>
00013 <font class="preprocessor"></font>
00014 <font class="preprocessor">#ifndef __cplusplus</font>
00015 <font class="preprocessor"></font><font class="preprocessor">    #error ATL requires C++ compilation (use a .cpp suffix)</font>
00016 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00017 <font class="preprocessor"></font>
00018 <font class="preprocessor">#ifndef __ATLAPP_H__</font>
00019 <font class="preprocessor"></font><font class="preprocessor">    #error atldlgs.h requires atlapp.h to be included first</font>
00020 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00021 <font class="preprocessor"></font>
00022 <font class="preprocessor">#ifndef __ATLWIN_H__</font>
00023 <font class="preprocessor"></font><font class="preprocessor">    #error atldlgs.h requires atlwin.h to be included first</font>
00024 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00025 <font class="preprocessor"></font>
00026 <font class="preprocessor">#include &lt;commdlg.h&gt;</font>
00027 <font class="preprocessor">#include &lt;shlobj.h&gt;</font>
00028 
00029 
00031 <font class="comment">// Classes in this file</font>
00032 <font class="comment">//</font>
00033 <font class="comment">// CFileDialogImpl&lt;T&gt;</font>
00034 <font class="comment">// CFileDialog</font>
00035 <font class="comment">// CFolderDialogImpl&lt;T&gt;</font>
00036 <font class="comment">// CFolderDialog</font>
00037 <font class="comment">// CFontDialogImpl&lt;T&gt;</font>
00038 <font class="comment">// CFontDialog</font>
00039 <font class="comment">// CRichEditFontDialogImpl&lt;T&gt;</font>
00040 <font class="comment">// CRichEditFontDialog</font>
00041 <font class="comment">// CColorDialogImpl&lt;T&gt;</font>
00042 <font class="comment">// CColorDialog</font>
00043 <font class="comment">// CPrintDialogImpl&lt;T&gt;</font>
00044 <font class="comment">// CPrintDialog</font>
00045 <font class="comment">// CPageSetupDialogImpl&lt;T&gt;</font>
00046 <font class="comment">// CPrintDialogExImpl&lt;T&gt;</font>
00047 <font class="comment">// CPrintDialogEx</font>
00048 <font class="comment">// CPageSetupDialog</font>
00049 <font class="comment">// CFindReplaceDialogImpl&lt;T&gt;</font>
00050 <font class="comment">// CFindReplaceDialog</font>
00051 <font class="comment">//</font>
00052 <font class="comment">// CPropertySheetWindow</font>
00053 <font class="comment">// CPropertySheetImpl&lt;T, TBase&gt;</font>
00054 <font class="comment">// CPropertySheet</font>
00055 <font class="comment">// CPropertyPageWindow</font>
00056 <font class="comment">// CPropertyPageImpl&lt;T, TBase&gt;</font>
00057 <font class="comment">// CPropertyPage&lt;t_wDlgTemplateID&gt;</font>
00058 
00059 
00060 <font class="keyword">namespace </font>WTL
00061 {
00062 
00064 <font class="comment">// CFileDialogImpl - used for File Open or File Save As</font>
00065 
00066 <font class="comment">// compatibility with the old (vc6.0) headers</font>
00067 <font class="preprocessor">#if (_WIN32_WINNT &gt;= 0x0500) &amp;&amp; !defined(OPENFILENAME_SIZE_VERSION_400)</font>
00068 <font class="preprocessor"></font><font class="preprocessor">#ifndef CDSIZEOF_STRUCT</font>
<a name="l00069"></a><a class="code" href="atldlgs_8h.html#a0">00069</a> <font class="preprocessor"></font><font class="preprocessor">#define CDSIZEOF_STRUCT(structname, member)  (((int)((LPBYTE)(&amp;((structname*)0)-&gt;member) - ((LPBYTE)((structname*)0)))) + sizeof(((structname*)0)-&gt;member))</font>
00070 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
<a name="l00071"></a><a class="code" href="atldlgs_8h.html#a1">00071</a> <font class="preprocessor"></font><font class="preprocessor">#define OPENFILENAME_SIZE_VERSION_400A  CDSIZEOF_STRUCT(OPENFILENAMEA,lpTemplateName)</font>
<a name="l00072"></a><a class="code" href="atldlgs_8h.html#a2">00072</a> <font class="preprocessor"></font><font class="preprocessor">#define OPENFILENAME_SIZE_VERSION_400W  CDSIZEOF_STRUCT(OPENFILENAMEW,lpTemplateName)</font>
00073 <font class="preprocessor"></font><font class="preprocessor">#ifdef UNICODE</font>
00074 <font class="preprocessor"></font><font class="preprocessor">#define OPENFILENAME_SIZE_VERSION_400  OPENFILENAME_SIZE_VERSION_400W</font>
00075 <font class="preprocessor"></font><font class="preprocessor">#else</font>
<a name="l00076"></a><a class="code" href="atldlgs_8h.html#a3">00076</a> <font class="preprocessor"></font><font class="preprocessor">#define OPENFILENAME_SIZE_VERSION_400  OPENFILENAME_SIZE_VERSION_400A</font>
00077 <font class="preprocessor"></font><font class="preprocessor">#endif // !UNICODE</font>
00078 <font class="preprocessor"></font><font class="preprocessor">#endif // (_WIN32_WINNT &gt;= 0x0500) &amp;&amp; !defined(OPENFILENAME_SIZE_VERSION_400)</font>
00079 <font class="preprocessor"></font>
00080 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l00081"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html">00081</a> <font class="keyword">class </font>ATL_NO_VTABLE <a class="code" href="classWTL_1_1CFileDialogImpl.html">CFileDialogImpl</a> : <font class="keyword">public</font> <a class="code" href="classCDialogImplBase.html">CDialogImplBase</a>
00082 {
00083 <font class="keyword">public</font>:
<a name="l00084"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#m0">00084</a>     OPENFILENAME m_ofn;
<a name="l00085"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#m1">00085</a>     BOOL m_bOpenFileDialog;         <font class="comment">// TRUE for file open, FALSE for file save</font>
<a name="l00086"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#m2">00086</a>     TCHAR m_szFileTitle[_MAX_FNAME];    <font class="comment">// contains file title after return</font>
<a name="l00087"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#m3">00087</a>     TCHAR m_szFileName[_MAX_PATH];      <font class="comment">// contains full path name after return</font>
00088 
<a name="l00089"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a0">00089</a>     <a class="code" href="classWTL_1_1CFileDialogImpl.html">CFileDialogImpl</a>(BOOL bOpenFileDialog, <font class="comment">// TRUE for FileOpen, FALSE for FileSaveAs</font>
00090             LPCTSTR lpszDefExt = NULL,
00091             LPCTSTR lpszFileName = NULL,
00092             DWORD dwFlags = OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT,
00093             LPCTSTR lpszFilter = NULL,
00094             HWND hWndParent = NULL)
00095     {
00096         memset(&amp;m_ofn, 0, <font class="keyword">sizeof</font>(m_ofn)); <font class="comment">// initialize structure to 0/NULL</font>
00097         m_szFileName[0] = <font class="charliteral">'\0'</font>;
00098         m_szFileTitle[0] = <font class="charliteral">'\0'</font>;
00099 
00100         m_bOpenFileDialog = bOpenFileDialog;
00101 
00102         m_ofn.lStructSize = <font class="keyword">sizeof</font>(m_ofn);
00103 <font class="preprocessor">#if (_WIN32_WINNT &gt;= 0x0500)</font>
00104 <font class="preprocessor"></font>        <font class="comment">// adjust struct size if running on older version of Windows</font>
00105         <font class="keywordflow">if</font>(<a class="code" href="namespaceWTL.html#a59">AtlIsOldWindows</a>())
00106         {
00107             ATLASSERT(<font class="keyword">sizeof</font>(m_ofn) &gt; <a class="code" href="atldlgs_8h.html#a3">OPENFILENAME_SIZE_VERSION_400</a>);   <font class="comment">// must be</font>
00108             m_ofn.lStructSize = <a class="code" href="atldlgs_8h.html#a3">OPENFILENAME_SIZE_VERSION_400</a>;
00109         }
00110 <font class="preprocessor">#endif //(_WIN32_WINNT &gt;= 0x0500)</font>
00111 <font class="preprocessor"></font>        m_ofn.lpstrFile = m_szFileName;
00112         m_ofn.nMaxFile = _MAX_PATH;
00113         m_ofn.lpstrDefExt = lpszDefExt;
00114         m_ofn.lpstrFileTitle = (LPTSTR)m_szFileTitle;
00115         m_ofn.nMaxFileTitle = _MAX_FNAME;
00116         m_ofn.Flags |= dwFlags | OFN_EXPLORER | OFN_ENABLEHOOK | OFN_ENABLESIZING;
00117         m_ofn.lpstrFilter = lpszFilter;
00118         m_ofn.hInstance = _Module.GetResourceInstance();
00119         m_ofn.lpfnHook = (LPOFNHOOKPROC)T::StartDialogProc;
00120         m_ofn.hwndOwner = hWndParent;
00121 
00122         <font class="comment">// setup initial file name</font>
00123         <font class="keywordflow">if</font>(lpszFileName != NULL)
00124             lstrcpyn(m_szFileName, lpszFileName, _MAX_PATH);
00125     }
00126 
<a name="l00127"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a1">00127</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
00128     {
00129         ATLASSERT(m_ofn.Flags &amp; OFN_ENABLEHOOK);
00130         ATLASSERT(m_ofn.lpfnHook != NULL);  <font class="comment">// can still be a user hook</font>
00131 
00132         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00133 
00134         <font class="keywordflow">if</font>(m_ofn.hwndOwner == NULL)     <font class="comment">// set only if not specified before</font>
00135             m_ofn.hwndOwner = hWndParent;
00136 
00137         ATLASSERT(m_hWnd == NULL);
00138         _Module.AddCreateWndData(&amp;m_thunk.cd, (<a class="code" href="classCDialogImplBase.html">CDialogImplBase</a>*)<font class="keyword">this</font>);
00139 
00140         BOOL bRet;
00141         <font class="keywordflow">if</font>(m_bOpenFileDialog)
00142             bRet = ::GetOpenFileName(&amp;m_ofn);
00143         <font class="keywordflow">else</font>
00144             bRet = ::GetSaveFileName(&amp;m_ofn);
00145 
00146         m_hWnd = NULL;
00147 
00148         <font class="keywordflow">return</font> bRet ? IDOK : IDCANCEL;
00149     }
00150 
00151 <font class="comment">// Attributes</font>
<a name="l00152"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a2">00152</a>     <a class="code" href="classCWindow.html">CWindow</a> GetFileDialogWindow()<font class="keyword"> const</font>
00153 <font class="keyword">    </font>{
00154         ATLASSERT(::IsWindow(m_hWnd));
00155         <font class="keywordflow">return</font> <a class="code" href="classCWindow.html">CWindow</a>(GetParent());
00156     }
00157 
<a name="l00158"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a3">00158</a>     <font class="keywordtype">int</font> GetFilePath(LPTSTR lpstrFilePath, <font class="keywordtype">int</font> nLength)<font class="keyword"> const</font>
00159 <font class="keyword">    </font>{
00160         ATLASSERT(::IsWindow(m_hWnd));
00161         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00162 
00163         <font class="keywordflow">return</font> (int)GetFileDialogWindow().SendMessage(CDM_GETFILEPATH, nLength, (LPARAM)lpstrFilePath);
00164     }
00165 
<a name="l00166"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a4">00166</a>     <font class="keywordtype">int</font> GetFolderIDList(LPVOID lpBuff, <font class="keywordtype">int</font> nLength)<font class="keyword"> const</font>
00167 <font class="keyword">    </font>{
00168         ATLASSERT(::IsWindow(m_hWnd));
00169         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00170 
00171         <font class="keywordflow">return</font> (int)GetFileDialogWindow().SendMessage(CDM_GETFOLDERIDLIST, nLength, (LPARAM)lpBuff);
00172     }
00173 
<a name="l00174"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a5">00174</a>     <font class="keywordtype">int</font> GetFolderPath(LPTSTR lpstrFolderPath, <font class="keywordtype">int</font> nLength)<font class="keyword"> const</font>
00175 <font class="keyword">    </font>{
00176         ATLASSERT(::IsWindow(m_hWnd));
00177         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00178 
00179         <font class="keywordflow">return</font> (int)GetFileDialogWindow().SendMessage(CDM_GETFOLDERPATH, nLength, (LPARAM)lpstrFolderPath);
00180     }
00181 
<a name="l00182"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a6">00182</a>     <font class="keywordtype">int</font> GetSpec(LPTSTR lpstrSpec, <font class="keywordtype">int</font> nLength)<font class="keyword"> const</font>
00183 <font class="keyword">    </font>{
00184         ATLASSERT(::IsWindow(m_hWnd));
00185         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00186 
00187         <font class="keywordflow">return</font> (int)GetFileDialogWindow().SendMessage(CDM_GETSPEC, nLength, (LPARAM)lpstrSpec);
00188     }
00189 
<a name="l00190"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a7">00190</a>     <font class="keywordtype">void</font> SetControlText(<font class="keywordtype">int</font> nCtrlID, LPCTSTR lpstrText)
00191     {
00192         ATLASSERT(::IsWindow(m_hWnd));
00193         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00194 
00195         GetFileDialogWindow().SendMessage(CDM_SETCONTROLTEXT, nCtrlID, (LPARAM)lpstrText);
00196     }
00197 
<a name="l00198"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a8">00198</a>     <font class="keywordtype">void</font> SetDefExt(LPCTSTR lpstrExt)
00199     {
00200         ATLASSERT(::IsWindow(m_hWnd));
00201         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00202 
00203         GetFileDialogWindow().SendMessage(CDM_SETDEFEXT, 0, (LPARAM)lpstrExt);
00204     }
00205 
<a name="l00206"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a9">00206</a>     BOOL GetReadOnlyPref() <font class="keyword">const</font>    <font class="comment">// return TRUE if readonly checked</font>
00207     {
00208         <font class="keywordflow">return</font> (m_ofn.Flags &amp; OFN_READONLY) ? TRUE : FALSE;
00209     }
00210 
00211 <font class="comment">// Operations</font>
<a name="l00212"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a10">00212</a>     <font class="keywordtype">void</font> HideControl(<font class="keywordtype">int</font> nCtrlID)
00213     {
00214         ATLASSERT(::IsWindow(m_hWnd));
00215         ATLASSERT(m_ofn.Flags &amp; OFN_EXPLORER);
00216 
00217         GetFileDialogWindow().SendMessage(CDM_HIDECONTROL, nCtrlID);
00218     }
00219 
00220 <font class="comment">// Special override for common dialogs</font>
<a name="l00221"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a11">00221</a>     BOOL EndDialog(INT_PTR <font class="comment">/*nRetCode*/</font> = 0)
00222     {
00223         ATLASSERT(::IsWindow(m_hWnd));
00224         GetFileDialogWindow().SendMessage(WM_COMMAND, MAKEWPARAM(IDCANCEL, 0));
00225         <font class="keywordflow">return</font> TRUE;
00226     }
00227 
00228 <font class="comment">// Message map and handlers</font>
00229     BEGIN_MSG_MAP(CFileDialogImpl)
00230         NOTIFY_CODE_HANDLER(CDN_FILEOK, _OnFileOK)
00231         NOTIFY_CODE_HANDLER(CDN_FOLDERCHANGE, _OnFolderChange)
00232         NOTIFY_CODE_HANDLER(CDN_HELP, _OnHelp)
00233         NOTIFY_CODE_HANDLER(CDN_INITDONE, _OnInitDone)
00234         NOTIFY_CODE_HANDLER(CDN_SELCHANGE, _OnSelChange)
00235         NOTIFY_CODE_HANDLER(CDN_SHAREVIOLATION, _OnShareViolation)
00236         NOTIFY_CODE_HANDLER(CDN_TYPECHANGE, _OnTypeChange)
00237     END_MSG_MAP()
00238 
<a name="l00239"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a12">00239</a>     LRESULT _OnFileOK(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00240     {
00241         ATLASSERT(::IsWindow(m_hWnd));
00242         T* pT = static_cast&lt;T*&gt;(this);
00243         <font class="keywordflow">return</font> !pT-&gt;OnFileOK((LPOFNOTIFY)pnmh);
00244     }
<a name="l00245"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a13">00245</a>     LRESULT _OnFolderChange(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00246     {
00247         ATLASSERT(::IsWindow(m_hWnd));
00248         T* pT = static_cast&lt;T*&gt;(this);
00249         pT-&gt;OnFolderChange((LPOFNOTIFY)pnmh);
00250         <font class="keywordflow">return</font> 0;
00251     }
<a name="l00252"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a14">00252</a>     LRESULT _OnHelp(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00253     {
00254         ATLASSERT(::IsWindow(m_hWnd));
00255         T* pT = static_cast&lt;T*&gt;(this);
00256         pT-&gt;OnHelp((LPOFNOTIFY)pnmh);
00257         <font class="keywordflow">return</font> 0;
00258     }
<a name="l00259"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a15">00259</a>     LRESULT _OnInitDone(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00260     {
00261         ATLASSERT(::IsWindow(m_hWnd));
00262         T* pT = static_cast&lt;T*&gt;(this);
00263         pT-&gt;OnInitDone((LPOFNOTIFY)pnmh);
00264         <font class="keywordflow">return</font> 0;
00265     }
<a name="l00266"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a16">00266</a>     LRESULT _OnSelChange(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00267     {
00268         ATLASSERT(::IsWindow(m_hWnd));
00269         T* pT = static_cast&lt;T*&gt;(this);
00270         pT-&gt;OnSelChange((LPOFNOTIFY)pnmh);
00271         <font class="keywordflow">return</font> 0;
00272     }
<a name="l00273"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a17">00273</a>     LRESULT _OnShareViolation(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00274     {
00275         ATLASSERT(::IsWindow(m_hWnd));
00276         T* pT = static_cast&lt;T*&gt;(this);
00277         <font class="keywordflow">return</font> pT-&gt;OnShareViolation((LPOFNOTIFY)pnmh);
00278     }
<a name="l00279"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a18">00279</a>     LRESULT _OnTypeChange(<font class="keywordtype">int</font> <font class="comment">/*idCtrl*/</font>, LPNMHDR pnmh, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00280     {
00281         ATLASSERT(::IsWindow(m_hWnd));
00282         T* pT = static_cast&lt;T*&gt;(this);
00283         pT-&gt;OnTypeChange((LPOFNOTIFY)pnmh);
00284         <font class="keywordflow">return</font> 0;
00285     }
00286 
00287 <font class="comment">// Overrideables</font>
<a name="l00288"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a19">00288</a>     BOOL OnFileOK(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00289     {
00290         <font class="keywordflow">return</font> TRUE;
00291     }
<a name="l00292"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a20">00292</a>     <font class="keywordtype">void</font> OnFolderChange(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00293     {
00294     }
<a name="l00295"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a21">00295</a>     <font class="keywordtype">void</font> OnHelp(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00296     {
00297     }
<a name="l00298"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a22">00298</a>     <font class="keywordtype">void</font> OnInitDone(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00299     {
00300     }
<a name="l00301"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a23">00301</a>     <font class="keywordtype">void</font> OnSelChange(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00302     {
00303     }
<a name="l00304"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a24">00304</a>     <font class="keywordtype">int</font> OnShareViolation(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00305     {
00306         <font class="keywordflow">return</font> 0;
00307     }
<a name="l00308"></a><a class="code" href="classWTL_1_1CFileDialogImpl.html#a25">00308</a>     <font class="keywordtype">void</font> OnTypeChange(LPOFNOTIFY <font class="comment">/*lpon*/</font>)
00309     {
00310     }
00311 };
00312 
00313 
<a name="l00314"></a><a class="code" href="classWTL_1_1CFileDialog.html">00314</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CFileDialog.html">CFileDialog</a> : <font class="keyword">public</font> <a class="code" href="classWTL_1_1CFileDialogImpl.html">CFileDialogImpl</a>&lt;CFileDialog&gt;
00315 {
00316 <font class="keyword">public</font>:
<a name="l00317"></a><a class="code" href="classWTL_1_1CFileDialog.html#a0">00317</a>     <a class="code" href="classWTL_1_1CFileDialog.html#a0">CFileDialog</a>(BOOL bOpenFileDialog, <font class="comment">// TRUE for FileOpen, FALSE for FileSaveAs</font>
00318         LPCTSTR lpszDefExt = NULL,
00319         LPCTSTR lpszFileName = NULL,
00320         DWORD dwFlags = OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT,
00321         LPCTSTR lpszFilter = NULL,
00322         HWND hWndParent = NULL)
00323         : <a class="code" href="classWTL_1_1CFileDialogImpl.html">CFileDialogImpl</a>&lt;<a class="code" href="classWTL_1_1CFileDialog.html">CFileDialog</a>&gt;(bOpenFileDialog, lpszDefExt, lpszFileName, dwFlags, lpszFilter, hWndParent)
00324     { }
00325 
00326     <font class="comment">// override base class map and references to handlers</font>
00327     DECLARE_EMPTY_MSG_MAP()
00328 };
00329 
00330 
00332 <font class="comment">// CFolderDialogImpl - used for browsing for a folder</font>
00333 
00334 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l00335"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html">00335</a> <font class="keyword">class </font>ATL_NO_VTABLE CFolderDialogImpl
00336 {
00337 <font class="keyword">public</font>:
<a name="l00338"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#m0">00338</a>     BROWSEINFO m_bi;
<a name="l00339"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#m1">00339</a>     TCHAR m_szFolderDisplayName[MAX_PATH];
<a name="l00340"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#m2">00340</a>     TCHAR m_szFolderPath[MAX_PATH];
<a name="l00341"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#m3">00341</a>     HWND m_hWnd;    <font class="comment">// used only in the callback function</font>
00342 
00343 <font class="comment">// Constructor</font>
<a name="l00344"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a0">00344</a>     CFolderDialogImpl(HWND hWndParent = NULL, LPCTSTR lpstrTitle = NULL, UINT uFlags = BIF_RETURNONLYFSDIRS)
00345     {
00346         memset(&amp;m_bi, 0, <font class="keyword">sizeof</font>(m_bi)); <font class="comment">// initialize structure to 0/NULL</font>
00347 
00348         m_bi.hwndOwner = hWndParent;
00349         m_bi.pidlRoot = NULL;
00350         m_bi.pszDisplayName = m_szFolderDisplayName;
00351         m_bi.lpszTitle = lpstrTitle;
00352         m_bi.ulFlags = uFlags;
00353         m_bi.lpfn = BrowseCallbackProc;
00354         m_bi.lParam = (LPARAM)static_cast&lt;T*&gt;(this);
00355 
00356         m_szFolderPath[0] = 0;
00357         m_szFolderDisplayName[0] = 0;
00358 
00359         m_hWnd = NULL;
00360     }
00361 
00362 <font class="comment">// Operations</font>
<a name="l00363"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a1">00363</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
00364     {
00365         <font class="keywordflow">if</font>(m_bi.hwndOwner == NULL)  <font class="comment">// set only if not specified before</font>
00366             m_bi.hwndOwner = hWndParent;
00367 
00368         INT_PTR nRet = -1;
00369         LPITEMIDLIST pItemIDList = ::SHBrowseForFolder(&amp;m_bi);
00370         <font class="keywordflow">if</font>(pItemIDList != NULL)
00371         {
00372             <font class="keywordflow">if</font>(::SHGetPathFromIDList(pItemIDList, m_szFolderPath))
00373             {
00374                 IMalloc* pMalloc = NULL;
00375                 <font class="keywordflow">if</font>(SUCCEEDED(::SHGetMalloc(&amp;pMalloc)))
00376                 {
00377                     pMalloc-&gt;Free(pItemIDList);
00378                     pMalloc-&gt;Release();
00379                 }
00380                 nRet = IDOK;
00381             }
00382             <font class="keywordflow">else</font>
00383             {
00384                 nRet = IDCANCEL;
00385             }
00386         }
00387 
00388         <font class="keywordflow">return</font> nRet;
00389     }
00390 
00391     <font class="comment">// filled after a call to DoModal</font>
<a name="l00392"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a2">00392</a>     LPCTSTR GetFolderPath()<font class="keyword"> const</font>
00393 <font class="keyword">    </font>{
00394         <font class="keywordflow">return</font> m_szFolderPath;
00395     }
<a name="l00396"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a3">00396</a>     LPCTSTR GetFolderDisplayName()<font class="keyword"> const</font>
00397 <font class="keyword">    </font>{
00398         <font class="keywordflow">return</font> m_szFolderDisplayName;
00399     }
<a name="l00400"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a4">00400</a>     <font class="keywordtype">int</font> GetFolderImageIndex()<font class="keyword"> const</font>
00401 <font class="keyword">    </font>{
00402         <font class="keywordflow">return</font> m_bi.iImage;
00403     }
00404 
00405 <font class="comment">// Callback function and overrideables</font>
<a name="l00406"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#d0">00406</a>     <font class="keyword">static</font> <font class="keywordtype">int</font> CALLBACK BrowseCallbackProc(HWND hWnd, UINT uMsg, LPARAM lParam, LPARAM lpData)
00407     {
00408 <font class="preprocessor">#ifndef BFFM_VALIDATEFAILED</font>
00409 <font class="preprocessor"></font><font class="preprocessor">#ifdef UNICODE</font>
00410 <font class="preprocessor"></font>        <font class="keyword">const</font> <font class="keywordtype">int</font> BFFM_VALIDATEFAILED = 4;
00411 <font class="preprocessor">#else</font>
00412 <font class="preprocessor"></font>        <font class="keyword">const</font> <font class="keywordtype">int</font> BFFM_VALIDATEFAILED = 3;
00413 <font class="preprocessor">#endif</font>
00414 <font class="preprocessor"></font><font class="preprocessor">#endif </font>
00415 <font class="preprocessor">        int nRet = 0;</font>
00416 <font class="preprocessor"></font>        T* pT = (T*)lpData;
00417         pT-&gt;m_hWnd = hWnd;
00418         <font class="keywordflow">switch</font>(uMsg)
00419         {
00420         <font class="keywordflow">case</font> BFFM_INITIALIZED:
00421             pT-&gt;OnInitialized();
00422             <font class="keywordflow">break</font>;
00423         <font class="keywordflow">case</font> BFFM_SELCHANGED:
00424             pT-&gt;OnSelChanged((LPITEMIDLIST)lParam);
00425             <font class="keywordflow">break</font>;
00426         <font class="keywordflow">case</font> BFFM_VALIDATEFAILED:
00427             nRet = pT-&gt;OnValidateFailed((LPCTSTR)lParam);
00428             <font class="keywordflow">break</font>;
00429         <font class="keywordflow">default</font>:
00430             ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, _T(<font class="stringliteral">"Unknown message received in CFolderDialogImpl::BrowseCallbackProc\n"</font>));
00431             <font class="keywordflow">break</font>;
00432         }
00433         pT-&gt;m_hWnd = NULL;
00434         <font class="keywordflow">return</font> nRet;
00435     }
<a name="l00436"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a5">00436</a>     <font class="keywordtype">void</font> OnInitialized()
00437     {
00438     }
<a name="l00439"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a6">00439</a>     <font class="keywordtype">void</font> OnSelChanged(LPITEMIDLIST <font class="comment">/*pItemIDList*/</font>)
00440     {
00441     }
<a name="l00442"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a7">00442</a>     <font class="keywordtype">int</font> OnValidateFailed(LPCTSTR <font class="comment">/*lpstrFolderPath*/</font>)
00443     {
00444         <font class="keywordflow">return</font> 1;   <font class="comment">// 1=continue, 0=EndDialog</font>
00445     }
00446 
00447     <font class="comment">// Commands - valid to call only from handlers</font>
<a name="l00448"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a8">00448</a>     <font class="keywordtype">void</font> EnableOK(BOOL bEnable)
00449     {
00450         ATLASSERT(m_hWnd != NULL);
00451         ::SendMessage(m_hWnd, BFFM_ENABLEOK, bEnable, 0L);
00452     }
<a name="l00453"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a9">00453</a>     <font class="keywordtype">void</font> SetSelection(LPITEMIDLIST pItemIDList)
00454     {
00455         ATLASSERT(m_hWnd != NULL);
00456         ::SendMessage(m_hWnd, BFFM_SETSELECTION, FALSE, (LPARAM)pItemIDList);
00457     }
<a name="l00458"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a10">00458</a>     <font class="keywordtype">void</font> SetSelection(LPCTSTR lpstrFolderPath)
00459     {
00460         ATLASSERT(m_hWnd != NULL);
00461         ::SendMessage(m_hWnd, BFFM_SETSELECTION, TRUE, (LPARAM)lpstrFolderPath);
00462     }
<a name="l00463"></a><a class="code" href="classWTL_1_1CFolderDialogImpl.html#a11">00463</a>     <font class="keywordtype">void</font> SetStatusText(LPCTSTR lpstrText)
00464     {
00465         ATLASSERT(m_hWnd != NULL);
00466         ::SendMessage(m_hWnd, BFFM_SETSTATUSTEXT, 0, (LPARAM)lpstrText);
00467     }
00468 };
00469 
<a name="l00470"></a><a class="code" href="classWTL_1_1CFolderDialog.html">00470</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CFolderDialog.html">CFolderDialog</a> : <font class="keyword">public</font> CFolderDialogImpl&lt;CFolderDialog&gt;
00471 {
00472 <font class="keyword">public</font>:
<a name="l00473"></a><a class="code" href="classWTL_1_1CFolderDialog.html#a0">00473</a>     <a class="code" href="classWTL_1_1CFolderDialog.html#a0">CFolderDialog</a>(HWND hWndParent = NULL, LPCTSTR lpstrTitle = NULL, UINT uFlags = BIF_RETURNONLYFSDIRS)
00474         : CFolderDialogImpl&lt;<a class="code" href="classWTL_1_1CFolderDialog.html">CFolderDialog</a>&gt;(hWndParent, lpstrTitle, uFlags)
00475     {
00476         <a class="code" href="classWTL_1_1CFolderDialogImpl.html#m0">m_bi</a>.lpfn = NULL;
00477     }
00478 };
00479 
00480 
00482 <font class="comment">// CCommonDialogImplBase - base class for common dialog classes</font>
00483 
<a name="l00484"></a><a class="code" href="classWTL_1_1CCommonDialogImplBase.html">00484</a> <font class="keyword">class </font>ATL_NO_VTABLE CCommonDialogImplBase : <font class="keyword">public</font> CWindowImplBase
00485 {
00486 <font class="keyword">public</font>:
<a name="l00487"></a><a class="code" href="classWTL_1_1CCommonDialogImplBase.html#d0">00487</a>     <font class="keyword">static</font> UINT_PTR APIENTRY HookProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
00488     {
00489         <font class="keywordflow">if</font>(uMsg != WM_INITDIALOG)
00490             <font class="keywordflow">return</font> 0;
00491         CCommonDialogImplBase* pT = (CCommonDialogImplBase*)_Module.ExtractCreateWndData();
00492         ATLASSERT(pT != NULL);
00493         ATLASSERT(pT-&gt;m_hWnd == NULL);
00494         ATLASSERT(::IsWindow(hWnd));
00495         <font class="comment">// subclass dialog's window</font>
00496         <font class="keywordflow">if</font>(!pT-&gt;SubclassWindow(hWnd))
00497         {
00498             ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, _T(<font class="stringliteral">"Subclassing a common dialog failed\n"</font>));
00499             <font class="keywordflow">return</font> 0;
00500         }
00501         <font class="comment">// check message map for WM_INITDIALOG handler</font>
00502         LRESULT lRes;
00503         <font class="keywordflow">if</font>(pT-&gt;ProcessWindowMessage(pT-&gt;m_hWnd, uMsg, wParam, lParam, lRes, 0) == FALSE)
00504             <font class="keywordflow">return</font> 0;
00505         <font class="keywordflow">return</font> lRes;
00506     }
00507 
00508 <font class="comment">// Special override for common dialogs</font>
<a name="l00509"></a><a class="code" href="classWTL_1_1CCommonDialogImplBase.html#a0">00509</a>     BOOL EndDialog(INT_PTR <font class="comment">/*nRetCode*/</font> = 0)
00510     {
00511         ATLASSERT(::IsWindow(m_hWnd));
00512         SendMessage(WM_COMMAND, MAKEWPARAM(IDABORT, 0));
00513         <font class="keywordflow">return</font> TRUE;
00514     }
00515 
00516 <font class="comment">// Implementation - try to override these, to prevent errors</font>
<a name="l00517"></a><a class="code" href="classWTL_1_1CCommonDialogImplBase.html#a1">00517</a>     HWND Create(HWND, <a class="code" href="classWTL_1_1__U__RECT.html">_U_RECT</a>, LPCTSTR, DWORD, DWORD, <a class="code" href="classWTL_1_1__U__MENUorID.html">_U_MENUorID</a>, ATOM, LPVOID)
00518     {
00519         ATLASSERT(FALSE);   <font class="comment">// should not be called</font>
00520         <font class="keywordflow">return</font> NULL;
00521     }
<a name="l00522"></a><a class="code" href="classWTL_1_1CCommonDialogImplBase.html#d1">00522</a>     <font class="keyword">static</font> LRESULT CALLBACK StartWindowProc(HWND <font class="comment">/*hWnd*/</font>, UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>)
00523     {
00524         ATLASSERT(FALSE);   <font class="comment">// should not be called</font>
00525         <font class="keywordflow">return</font> 0;
00526     }
00527 };
00528 
00529 
00531 <font class="comment">// CFontDialogImpl - font selection dialog</font>
00532 
00533 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l00534"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html">00534</a> <font class="keyword">class </font>ATL_NO_VTABLE CFontDialogImpl : <font class="keyword">public</font> CCommonDialogImplBase
00535 {
00536 <font class="keyword">public</font>:
<a name="l00537"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#m0">00537</a>     CHOOSEFONT m_cf;
<a name="l00538"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#m1">00538</a>     TCHAR m_szStyleName[64];    <font class="comment">// contains style name after return</font>
<a name="l00539"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#m2">00539</a>     LOGFONT m_lf;           <font class="comment">// default LOGFONT to store the info</font>
00540 
00541 <font class="comment">// Constructors</font>
<a name="l00542"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a0">00542</a>     CFontDialogImpl(LPLOGFONT lplfInitial = NULL,
00543             DWORD dwFlags = CF_EFFECTS | CF_SCREENFONTS,
00544             HDC hDCPrinter = NULL,
00545             HWND hWndParent = NULL)
00546     {
00547         memset(&amp;m_cf, 0, <font class="keyword">sizeof</font>(m_cf));
00548         memset(&amp;m_lf, 0, <font class="keyword">sizeof</font>(m_lf));
00549         memset(&amp;m_szStyleName, 0, <font class="keyword">sizeof</font>(m_szStyleName));
00550 
00551         m_cf.lStructSize = <font class="keyword">sizeof</font>(m_cf);
00552         m_cf.hwndOwner = hWndParent;
00553         m_cf.rgbColors = RGB(0, 0, 0);
00554         m_cf.lpszStyle = (LPTSTR)&amp;m_szStyleName;
00555         m_cf.Flags = dwFlags | CF_ENABLEHOOK;
00556         m_cf.lpfnHook = (LPCFHOOKPROC)T::HookProc;
00557 
00558         <font class="keywordflow">if</font>(lplfInitial != NULL)
00559         {
00560             m_cf.lpLogFont = lplfInitial;
00561             m_cf.Flags |= CF_INITTOLOGFONTSTRUCT;
00562             memcpy(&amp;m_lf, m_cf.lpLogFont, <font class="keyword">sizeof</font>(m_lf));
00563         }
00564         <font class="keywordflow">else</font>
00565         {
00566             m_cf.lpLogFont = &amp;m_lf;
00567         }
00568 
00569         <font class="keywordflow">if</font>(hDCPrinter != NULL)
00570         {
00571             m_cf.hDC = hDCPrinter;
00572             m_cf.Flags |= CF_PRINTERFONTS;
00573         }
00574     }
00575 
00576 <font class="comment">// Operations</font>
<a name="l00577"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a1">00577</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
00578     {
00579         ATLASSERT(m_cf.Flags &amp; CF_ENABLEHOOK);
00580         ATLASSERT(m_cf.lpfnHook != NULL);   <font class="comment">// can still be a user hook</font>
00581 
00582         <font class="keywordflow">if</font>(m_cf.hwndOwner == NULL)      <font class="comment">// set only if not specified before</font>
00583             m_cf.hwndOwner = hWndParent;
00584 
00585         ATLASSERT(m_hWnd == NULL);
00586         _Module.AddCreateWndData(&amp;m_thunk.cd, (CCommonDialogImplBase*)<font class="keyword">this</font>);
00587 
00588         BOOL bRet = ::ChooseFont(&amp;m_cf);
00589 
00590         m_hWnd = NULL;
00591 
00592         <font class="keywordflow">if</font>(bRet)    <font class="comment">// copy logical font from user's initialization buffer (if needed)</font>
00593             memcpy(&amp;m_lf, m_cf.lpLogFont, <font class="keyword">sizeof</font>(m_lf));
00594 
00595         <font class="keywordflow">return</font> bRet ? IDOK : IDCANCEL;
00596     }
00597 
00598     <font class="comment">// Get the selected font (works during DoModal displayed or after)</font>
<a name="l00599"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a2">00599</a>     <font class="keywordtype">void</font> GetCurrentFont(LPLOGFONT lplf)<font class="keyword"> const</font>
00600 <font class="keyword">    </font>{
00601         ATLASSERT(lplf != NULL);
00602 
00603         <font class="keywordflow">if</font>(m_hWnd != NULL)
00604             ::SendMessage(m_hWnd, WM_CHOOSEFONT_GETLOGFONT, 0, (LPARAM)lplf);
00605         <font class="keywordflow">else</font>
00606             *lplf = m_lf;
00607     }
00608 
00609     <font class="comment">// Helpers for parsing information after successful return</font>
<a name="l00610"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a3">00610</a>     LPCTSTR GetFaceName() <font class="keyword">const</font>   <font class="comment">// return the face name of the font</font>
00611     {
00612         <font class="keywordflow">return</font> (LPCTSTR)m_cf.lpLogFont-&gt;lfFaceName;
00613     }
<a name="l00614"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a4">00614</a>     LPCTSTR GetStyleName() <font class="keyword">const</font>  <font class="comment">// return the style name of the font</font>
00615     {
00616         <font class="keywordflow">return</font> m_cf.lpszStyle;
00617     }
<a name="l00618"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a5">00618</a>     <font class="keywordtype">int</font> GetSize() <font class="keyword">const</font>           <font class="comment">// return the pt size of the font</font>
00619     {
00620         <font class="keywordflow">return</font> m_cf.iPointSize;
00621     }
<a name="l00622"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a6">00622</a>     COLORREF GetColor() <font class="keyword">const</font>     <font class="comment">// return the color of the font</font>
00623     {
00624         <font class="keywordflow">return</font> m_cf.rgbColors;
00625     }
<a name="l00626"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a7">00626</a>     <font class="keywordtype">int</font> GetWeight() <font class="keyword">const</font>         <font class="comment">// return the chosen font weight</font>
00627     {
00628         <font class="keywordflow">return</font> (int)m_cf.lpLogFont-&gt;lfWeight;
00629     }
<a name="l00630"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a8">00630</a>     BOOL IsStrikeOut() <font class="keyword">const</font>      <font class="comment">// return TRUE if strikeout</font>
00631     {
00632         <font class="keywordflow">return</font> (m_cf.lpLogFont-&gt;lfStrikeOut) ? TRUE : FALSE;
00633     }
<a name="l00634"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a9">00634</a>     BOOL IsUnderline() <font class="keyword">const</font>      <font class="comment">// return TRUE if underline</font>
00635     {
00636         <font class="keywordflow">return</font> (m_cf.lpLogFont-&gt;lfUnderline) ? TRUE : FALSE;
00637     }
<a name="l00638"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a10">00638</a>     BOOL IsBold() <font class="keyword">const</font>           <font class="comment">// return TRUE if bold font</font>
00639     {
00640         <font class="keywordflow">return</font> (m_cf.lpLogFont-&gt;lfWeight == FW_BOLD) ? TRUE : FALSE;
00641     }
<a name="l00642"></a><a class="code" href="classWTL_1_1CFontDialogImpl.html#a11">00642</a>     BOOL IsItalic() <font class="keyword">const</font>         <font class="comment">// return TRUE if italic font</font>
00643     {
00644         <font class="keywordflow">return</font> m_cf.lpLogFont-&gt;lfItalic ? TRUE : FALSE;
00645     }
00646 };
00647 
<a name="l00648"></a><a class="code" href="classWTL_1_1CFontDialog.html">00648</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CFontDialog.html">CFontDialog</a> : <font class="keyword">public</font> CFontDialogImpl&lt;CFontDialog&gt;
00649 {
00650 <font class="keyword">public</font>:
<a name="l00651"></a><a class="code" href="classWTL_1_1CFontDialog.html#a0">00651</a>     <a class="code" href="classWTL_1_1CFontDialog.html#a0">CFontDialog</a>(LPLOGFONT lplfInitial = NULL,
00652         DWORD dwFlags = CF_EFFECTS | CF_SCREENFONTS,
00653         HDC hDCPrinter = NULL,
00654         HWND hWndParent = NULL)
00655         : CFontDialogImpl&lt;<a class="code" href="classWTL_1_1CFontDialog.html">CFontDialog</a>&gt;(lplfInitial, dwFlags, hDCPrinter, hWndParent)
00656     { }
00657 
00658     DECLARE_EMPTY_MSG_MAP()
00659 };
00660 
00661 
00663 <font class="comment">// CRichEditFontDialogImpl - font selection for the Rich Edit ctrl</font>
00664 
00665 <font class="preprocessor">#ifdef _RICHEDIT_</font>
00666 <font class="preprocessor"></font>
00667 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
00668 <font class="keyword">class </font>ATL_NO_VTABLE CRichEditFontDialogImpl : <font class="keyword">public</font> CFontDialogImpl&lt; T &gt;
00669 {
00670 <font class="keyword">public</font>:
00671     CRichEditFontDialogImpl(<font class="keyword">const</font> CHARFORMAT&amp; charformat,
00672             DWORD dwFlags = CF_SCREENFONTS,
00673             HDC hDCPrinter = NULL,
00674             HWND hWndParent = NULL)
00675             : CFontDialogImpl&lt; T &gt;(NULL, dwFlags, hDCPrinter, hWndParent)
00676     {
00677         m_cf.Flags |= CF_INITTOLOGFONTSTRUCT;
00678         m_cf.Flags |= FillInLogFont(charformat);
00679         m_cf.lpLogFont = &amp;m_lf;
00680 
00681         <font class="keywordflow">if</font>(charformat.dwMask &amp; CFM_COLOR)
00682             m_cf.rgbColors = charformat.crTextColor;
00683     }
00684 
00685     <font class="keywordtype">void</font> GetCharFormat(CHARFORMAT&amp; cf)<font class="keyword"> const</font>
00686 <font class="keyword">    </font>{
00687         USES_CONVERSION;
00688         cf.dwEffects = 0;
00689         cf.dwMask = 0;
00690         <font class="keywordflow">if</font>((m_cf.Flags &amp; CF_NOSTYLESEL) == 0)
00691         {
00692             cf.dwMask |= CFM_BOLD | CFM_ITALIC;
00693             cf.dwEffects |= IsBold() ? CFE_BOLD : 0;
00694             cf.dwEffects |= IsItalic() ? CFE_ITALIC : 0;
00695         }
00696         <font class="keywordflow">if</font>((m_cf.Flags &amp; CF_NOSIZESEL) == 0)
00697         {
00698             cf.dwMask |= CFM_SIZE;
00699             <font class="comment">//GetSize() returns in tenths of points so mulitply by 2 to get twips</font>
00700             cf.yHeight = GetSize() * 2;
00701         }
00702 
00703         <font class="keywordflow">if</font>((m_cf.Flags &amp; CF_NOFACESEL) == 0)
00704         {
00705             cf.dwMask |= CFM_FACE;
00706             cf.bPitchAndFamily = m_cf.lpLogFont-&gt;lfPitchAndFamily;
00707 <font class="preprocessor">#if (_RICHEDIT_VER &gt;= 0x0200)</font>
00708 <font class="preprocessor"></font>            lstrcpy(cf.szFaceName, GetFaceName());
00709 <font class="preprocessor">#else</font>
00710 <font class="preprocessor"></font>            lstrcpyA(cf.szFaceName, T2A((LPTSTR)(LPCTSTR)GetFaceName()));
00711 <font class="preprocessor">#endif //(_RICHEDIT_VER &gt;= 0x0200)</font>
00712 <font class="preprocessor"></font>        }
00713 
00714         <font class="keywordflow">if</font>(m_cf.Flags &amp; CF_EFFECTS)
00715         {
00716             cf.dwMask |= CFM_UNDERLINE | CFM_STRIKEOUT | CFM_COLOR;
00717             cf.dwEffects |= IsUnderline() ? CFE_UNDERLINE : 0;
00718             cf.dwEffects |= IsStrikeOut() ? CFE_STRIKEOUT : 0;
00719             cf.crTextColor = GetColor();
00720         }
00721         <font class="keywordflow">if</font>((m_cf.Flags &amp; CF_NOSCRIPTSEL) == 0)
00722         {
00723             cf.bCharSet = m_cf.lpLogFont-&gt;lfCharSet;
00724             cf.dwMask |= CFM_CHARSET;
00725         }
00726         cf.yOffset = 0;
00727     }
00728 
00729     DWORD FillInLogFont(<font class="keyword">const</font> CHARFORMAT&amp; cf)
00730     {
00731         USES_CONVERSION;
00732         DWORD dwFlags = 0;
00733         <font class="keywordflow">if</font>(cf.dwMask &amp; CFM_SIZE)
00734         {
00735             HDC hDC = ::CreateDC(_T(<font class="stringliteral">"DISPLAY"</font>), NULL, NULL, NULL);
00736             LONG yPerInch = ::GetDeviceCaps(hDC, LOGPIXELSY);
00737             m_lf.lfHeight = -(int)((cf.yHeight * yPerInch) / 1440);
00738         }
00739         <font class="keywordflow">else</font>
00740             m_lf.lfHeight = 0;
00741 
00742         m_lf.lfWidth = 0;
00743         m_lf.lfEscapement = 0;
00744         m_lf.lfOrientation = 0;
00745 
00746         <font class="keywordflow">if</font>((cf.dwMask &amp; (CFM_ITALIC|CFM_BOLD)) == (CFM_ITALIC|CFM_BOLD))
00747         {
00748             m_lf.lfWeight = (cf.dwEffects &amp; CFE_BOLD) ? FW_BOLD : FW_NORMAL;
00749             m_lf.lfItalic = (BYTE)((cf.dwEffects &amp; CFE_ITALIC) ? TRUE : FALSE);
00750         }
00751         <font class="keywordflow">else</font>
00752         {
00753             dwFlags |= CF_NOSTYLESEL;
00754             m_lf.lfWeight = FW_DONTCARE;
00755             m_lf.lfItalic = FALSE;
00756         }
00757 
00758         <font class="keywordflow">if</font>((cf.dwMask &amp; (CFM_UNDERLINE|CFM_STRIKEOUT|CFM_COLOR)) ==
00759             (CFM_UNDERLINE|CFM_STRIKEOUT|CFM_COLOR))
00760         {
00761             dwFlags |= CF_EFFECTS;
00762             m_lf.lfUnderline = (BYTE)((cf.dwEffects &amp; CFE_UNDERLINE) ? TRUE : FALSE);
00763             m_lf.lfStrikeOut = (BYTE)((cf.dwEffects &amp; CFE_STRIKEOUT) ? TRUE : FALSE);
00764         }
00765         <font class="keywordflow">else</font>
00766         {
00767             m_lf.lfUnderline = (BYTE)FALSE;
00768             m_lf.lfStrikeOut = (BYTE)FALSE;
00769         }
00770 
00771         <font class="keywordflow">if</font>(cf.dwMask &amp; CFM_CHARSET)
00772             m_lf.lfCharSet = cf.bCharSet;
00773         <font class="keywordflow">else</font>
00774             dwFlags |= CF_NOSCRIPTSEL;
00775         m_lf.lfOutPrecision = OUT_DEFAULT_PRECIS;
00776         m_lf.lfClipPrecision = CLIP_DEFAULT_PRECIS;
00777         m_lf.lfQuality = DEFAULT_QUALITY;
00778         <font class="keywordflow">if</font>(cf.dwMask &amp; CFM_FACE)
00779         {
00780             m_lf.lfPitchAndFamily = cf.bPitchAndFamily;
00781 <font class="preprocessor">#if (_RICHEDIT_VER &gt;= 0x0200)</font>
00782 <font class="preprocessor"></font>            lstrcpy(m_lf.lfFaceName, cf.szFaceName);
00783 <font class="preprocessor">#else</font>
00784 <font class="preprocessor"></font>            lstrcpy(m_lf.lfFaceName, A2T((LPSTR)cf.szFaceName));
00785 <font class="preprocessor">#endif //(_RICHEDIT_VER &gt;= 0x0200)</font>
00786 <font class="preprocessor"></font>        }
00787         <font class="keywordflow">else</font>
00788         {
00789             m_lf.lfPitchAndFamily = DEFAULT_PITCH|FF_DONTCARE;
00790             m_lf.lfFaceName[0] = (TCHAR)0;
00791         }
00792         <font class="keywordflow">return</font> dwFlags;
00793     }
00794 };
00795 
00796 <font class="keyword">class </font>CRichEditFontDialog : <font class="keyword">public</font> CRichEditFontDialogImpl&lt;CRichEditFontDialog&gt;
00797 {
00798 <font class="keyword">public</font>:
00799     CRichEditFontDialog(<font class="keyword">const</font> CHARFORMAT&amp; charformat,
00800         DWORD dwFlags = CF_SCREENFONTS,
00801         HDC hDCPrinter = NULL,
00802         HWND hWndParent = NULL)
00803         : CRichEditFontDialogImpl&lt;CRichEditFontDialog&gt;(charformat, dwFlags, hDCPrinter, hWndParent)
00804     { }
00805 
00806     DECLARE_EMPTY_MSG_MAP()
00807 };
00808 
00809 <font class="preprocessor">#endif // _RICHEDIT_</font>
00810 <font class="preprocessor"></font>
00812 <font class="comment">// CColorDialogImpl - color selection</font>
00813 
00814 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l00815"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html">00815</a> <font class="keyword">class </font>ATL_NO_VTABLE CColorDialogImpl : <font class="keyword">public</font> CCommonDialogImplBase
00816 {
00817 <font class="keyword">public</font>:
<a name="l00818"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#m0">00818</a>     CHOOSECOLOR m_cc;
00819 
00820 <font class="comment">// Constructor</font>
<a name="l00821"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#a0">00821</a>     CColorDialogImpl(COLORREF clrInit = 0, DWORD dwFlags = 0, HWND hWndParent = NULL)
00822     {
00823         memset(&amp;m_cc, 0, <font class="keyword">sizeof</font>(m_cc));
00824 
00825         m_cc.lStructSize = <font class="keyword">sizeof</font>(m_cc);
00826         m_cc.lpCustColors = GetCustomColors();
00827         m_cc.hwndOwner = hWndParent;
00828         m_cc.Flags = dwFlags | CC_ENABLEHOOK;
00829         m_cc.lpfnHook = (LPCCHOOKPROC)T::HookProc;
00830 
00831         <font class="keywordflow">if</font>(clrInit != 0)
00832         {
00833             m_cc.rgbResult = clrInit;
00834             m_cc.Flags |= CC_RGBINIT;
00835         }
00836     }
00837 
00838 <font class="comment">// Operations</font>
<a name="l00839"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#a1">00839</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
00840     {
00841         ATLASSERT(m_cc.Flags &amp; CC_ENABLEHOOK);
00842         ATLASSERT(m_cc.lpfnHook != NULL);   <font class="comment">// can still be a user hook</font>
00843 
00844         <font class="keywordflow">if</font>(m_cc.hwndOwner == NULL)      <font class="comment">// set only if not specified before</font>
00845             m_cc.hwndOwner = hWndParent;
00846 
00847         ATLASSERT(m_hWnd == NULL);
00848         _Module.AddCreateWndData(&amp;m_thunk.cd, (CCommonDialogImplBase*)<font class="keyword">this</font>);
00849 
00850         BOOL bRet = ::ChooseColor(&amp;m_cc);
00851 
00852         m_hWnd = NULL;
00853 
00854         <font class="keywordflow">return</font> bRet ? IDOK : IDCANCEL;
00855     }
00856 
00857     <font class="comment">// Set the current color while dialog is displayed</font>
<a name="l00858"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#a2">00858</a>     <font class="keywordtype">void</font> SetCurrentColor(COLORREF clr)
00859     {
00860         ATLASSERT(::IsWindow(m_hWnd));
00861         SendMessage(_GetSetRGBMessage(), 0, (LPARAM)clr);
00862     }
00863 
00864     <font class="comment">// Get the selected color after DoModal returns, or in OnColorOK</font>
<a name="l00865"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#a3">00865</a>     COLORREF GetColor()<font class="keyword"> const</font>
00866 <font class="keyword">    </font>{
00867         <font class="keywordflow">return</font> m_cc.rgbResult;
00868     }
00869 
00870 <font class="comment">// Special override for the color dialog</font>
<a name="l00871"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#d0">00871</a>     <font class="keyword">static</font> UINT_PTR APIENTRY HookProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
00872     {
00873         <font class="keywordflow">if</font>(uMsg != WM_INITDIALOG &amp;&amp; uMsg != _GetColorOKMessage())
00874             <font class="keywordflow">return</font> 0;
00875 
00876         LPCHOOSECOLOR lpCC = (LPCHOOSECOLOR)lParam;
00877         CCommonDialogImplBase* pT = NULL;
00878 
00879         <font class="keywordflow">if</font>(uMsg == WM_INITDIALOG)
00880         {
00881             pT = (CCommonDialogImplBase*)_Module.ExtractCreateWndData();
00882             lpCC-&gt;lCustData = (LPARAM)pT;
00883             ATLASSERT(pT != NULL);
00884             ATLASSERT(pT-&gt;m_hWnd == NULL);
00885             ATLASSERT(::IsWindow(hWnd));
00886             <font class="comment">// subclass dialog's window</font>
00887             <font class="keywordflow">if</font>(!pT-&gt;SubclassWindow(hWnd))
00888             {
00889                 ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, _T(<font class="stringliteral">"Subclassing a Color common dialog failed\n"</font>));
00890                 <font class="keywordflow">return</font> 0;
00891             }
00892         }
00893         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(uMsg == _GetColorOKMessage())
00894         {
00895             pT = (CCommonDialogImplBase*)lpCC-&gt;lCustData;
00896             ATLASSERT(pT != NULL);
00897             ATLASSERT(::IsWindow(pT-&gt;m_hWnd));
00898         }
00899 
00900         <font class="comment">// pass to the message map</font>
00901         LRESULT lRes;
00902         <font class="keywordflow">if</font>(pT-&gt;ProcessWindowMessage(pT-&gt;m_hWnd, uMsg, wParam, lParam, lRes, 0) == FALSE)
00903             <font class="keywordflow">return</font> 0;
00904         <font class="keywordflow">return</font> lRes;
00905     }
00906 
00907 <font class="comment">// Helpers</font>
<a name="l00908"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#d1">00908</a>     <font class="keyword">static</font> COLORREF* GetCustomColors()
00909     {
00910         <font class="keyword">static</font> COLORREF rgbCustomColors[16] =
00911         {
00912             RGB(255, 255, 255), RGB(255, 255, 255), 
00913             RGB(255, 255, 255), RGB(255, 255, 255), 
00914             RGB(255, 255, 255), RGB(255, 255, 255), 
00915             RGB(255, 255, 255), RGB(255, 255, 255), 
00916             RGB(255, 255, 255), RGB(255, 255, 255), 
00917             RGB(255, 255, 255), RGB(255, 255, 255), 
00918             RGB(255, 255, 255), RGB(255, 255, 255), 
00919             RGB(255, 255, 255), RGB(255, 255, 255), 
00920         };
00921 
00922         <font class="keywordflow">return</font> rgbCustomColors;
00923     }
00924 
<a name="l00925"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#d2">00925</a>     <font class="keyword">static</font> UINT _GetSetRGBMessage()
00926     {
00927         <font class="keyword">static</font> UINT uSetRGBMessage = 0;
00928         <font class="keywordflow">if</font>(uSetRGBMessage == 0)
00929         {
00930             ::EnterCriticalSection(&amp;_Module.m_csStaticDataInit);
00931             <font class="keywordflow">if</font>(uSetRGBMessage == 0)
00932                 uSetRGBMessage = ::RegisterWindowMessage(SETRGBSTRING);
00933             ::LeaveCriticalSection(&amp;_Module.m_csStaticDataInit);
00934         }
00935         ATLASSERT(uSetRGBMessage != 0);
00936         <font class="keywordflow">return</font> uSetRGBMessage;
00937     }
00938 
<a name="l00939"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#d3">00939</a>     <font class="keyword">static</font> UINT _GetColorOKMessage()
00940     {
00941         <font class="keyword">static</font> UINT uColorOKMessage = 0;
00942         <font class="keywordflow">if</font>(uColorOKMessage == 0)
00943         {
00944             ::EnterCriticalSection(&amp;_Module.m_csStaticDataInit);
00945             <font class="keywordflow">if</font>(uColorOKMessage == 0)
00946                 uColorOKMessage = ::RegisterWindowMessage(COLOROKSTRING);
00947             ::LeaveCriticalSection(&amp;_Module.m_csStaticDataInit);
00948         }
00949         ATLASSERT(uColorOKMessage != 0);
00950         <font class="keywordflow">return</font> uColorOKMessage;
00951     }
00952 
00953 <font class="comment">// Message map and handlers</font>
00954     BEGIN_MSG_MAP(CColorDialogImpl)
00955         MESSAGE_HANDLER(_GetColorOKMessage(), _OnColorOK)
00956     END_MSG_MAP()
00957 
<a name="l00958"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#a4">00958</a>     LRESULT _OnColorOK(UINT, WPARAM, LPARAM, BOOL&amp;)
00959     {
00960         T* pT = static_cast&lt;T*&gt;(this);
00961         <font class="keywordflow">return</font> pT-&gt;OnColorOK();
00962     }
00963 
00964 <font class="comment">// Overrideable</font>
<a name="l00965"></a><a class="code" href="classWTL_1_1CColorDialogImpl.html#a5">00965</a>     BOOL OnColorOK()        <font class="comment">// validate color</font>
00966     {
00967         <font class="keywordflow">return</font> FALSE;
00968     }
00969 };
00970 
<a name="l00971"></a><a class="code" href="classWTL_1_1CColorDialog.html">00971</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CColorDialog.html">CColorDialog</a> : <font class="keyword">public</font> CColorDialogImpl&lt;CColorDialog&gt;
00972 {
00973 <font class="keyword">public</font>:
<a name="l00974"></a><a class="code" href="classWTL_1_1CColorDialog.html#a0">00974</a>     <a class="code" href="classWTL_1_1CColorDialog.html#a0">CColorDialog</a>(COLORREF clrInit = 0, DWORD dwFlags = 0, HWND hWndParent = NULL)
00975         : CColorDialogImpl&lt;<a class="code" href="classWTL_1_1CColorDialog.html">CColorDialog</a>&gt;(clrInit, dwFlags, hWndParent)
00976     { }
00977 
00978     <font class="comment">// override base class map and references to handlers</font>
00979     DECLARE_EMPTY_MSG_MAP()
00980 };
00981 
00982 
00984 <font class="comment">// CPrintDialogImpl - used for Print... and PrintSetup...</font>
00985 
00986 <font class="comment">// global helper</font>
<a name="l00987"></a><a class="code" href="namespaceWTL.html#a65">00987</a> <font class="keyword">static</font> HDC <a class="code" href="namespaceWTL.html#a65">_AtlCreateDC</a>(HGLOBAL hDevNames, HGLOBAL hDevMode)
00988 {
00989     <font class="keywordflow">if</font>(hDevNames == NULL)
00990         <font class="keywordflow">return</font> NULL;
00991 
00992     LPDEVNAMES lpDevNames = (LPDEVNAMES)::GlobalLock(hDevNames);
00993     LPDEVMODE  lpDevMode = (hDevMode != NULL) ? (LPDEVMODE)::GlobalLock(hDevMode) : NULL;
00994 
00995     <font class="keywordflow">if</font>(lpDevNames == NULL)
00996         <font class="keywordflow">return</font> NULL;
00997 
00998     HDC hDC = ::CreateDC((LPCTSTR)lpDevNames + lpDevNames-&gt;wDriverOffset,
00999                       (LPCTSTR)lpDevNames + lpDevNames-&gt;wDeviceOffset,
01000                       (LPCTSTR)lpDevNames + lpDevNames-&gt;wOutputOffset,
01001                       lpDevMode);
01002 
01003     ::GlobalUnlock(hDevNames);
01004     <font class="keywordflow">if</font>(hDevMode != NULL)
01005         ::GlobalUnlock(hDevMode);
01006     <font class="keywordflow">return</font> hDC;
01007 }
01008 
01009 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l01010"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html">01010</a> <font class="keyword">class </font>ATL_NO_VTABLE CPrintDialogImpl : <font class="keyword">public</font> CCommonDialogImplBase
01011 {
01012 <font class="keyword">public</font>:
01013     <font class="comment">// print dialog parameter block (note this is a reference)</font>
<a name="l01014"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#m0">01014</a>     PRINTDLG&amp; m_pd;
01015 
01016 <font class="comment">// Constructors</font>
<a name="l01017"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a0">01017</a>     CPrintDialogImpl(BOOL bPrintSetupOnly = FALSE,  <font class="comment">// TRUE for Print Setup, FALSE for Print Dialog</font>
01018             DWORD dwFlags = PD_ALLPAGES | PD_USEDEVMODECOPIES | PD_NOPAGENUMS | PD_NOSELECTION,
01019             HWND hWndParent = NULL)
01020             : m_pd(m_pdActual)
01021     {
01022         memset(&amp;m_pdActual, 0, <font class="keyword">sizeof</font>(m_pdActual));
01023 
01024         m_pd.lStructSize = <font class="keyword">sizeof</font>(m_pdActual);
01025         m_pd.hwndOwner = hWndParent;
01026         m_pd.Flags = (dwFlags | PD_ENABLEPRINTHOOK | PD_ENABLESETUPHOOK);
01027         m_pd.lpfnPrintHook = (LPPRINTHOOKPROC)T::HookProc;
01028         m_pd.lpfnSetupHook = (LPSETUPHOOKPROC)T::HookProc;
01029 
01030         <font class="keywordflow">if</font>(bPrintSetupOnly)
01031             m_pd.Flags |= PD_PRINTSETUP;
01032         <font class="keywordflow">else</font>
01033             m_pd.Flags |= PD_RETURNDC;
01034 
01035         m_pd.Flags &amp;= ~PD_RETURNIC; <font class="comment">// do not support information context</font>
01036     }
01037 
01038 <font class="comment">// Operations</font>
<a name="l01039"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a1">01039</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
01040     {
01041         ATLASSERT(m_pd.Flags &amp; PD_ENABLEPRINTHOOK);
01042         ATLASSERT(m_pd.Flags &amp; PD_ENABLESETUPHOOK);
01043         ATLASSERT(m_pd.lpfnPrintHook != NULL);  <font class="comment">// can still be a user hook</font>
01044         ATLASSERT(m_pd.lpfnSetupHook != NULL);  <font class="comment">// can still be a user hook</font>
01045         ATLASSERT((m_pd.Flags &amp; PD_RETURNDEFAULT) == 0);    <font class="comment">// use GetDefaults for this</font>
01046 
01047         <font class="keywordflow">if</font>(m_pd.hwndOwner == NULL)      <font class="comment">// set only if not specified before</font>
01048             m_pd.hwndOwner = hWndParent;
01049 
01050         ATLASSERT(m_hWnd == NULL);
01051         _Module.AddCreateWndData(&amp;m_thunk.cd, (CCommonDialogImplBase*)<font class="keyword">this</font>);
01052 
01053         BOOL bRet = ::PrintDlg(&amp;m_pd);
01054 
01055         m_hWnd = NULL;
01056 
01057         <font class="keywordflow">return</font> bRet ? IDOK : IDCANCEL;
01058     }
01059 
01060     <font class="comment">// GetDefaults will not display a dialog but will get device defaults</font>
<a name="l01061"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a2">01061</a>     BOOL GetDefaults()
01062     {
01063         m_pd.Flags |= PD_RETURNDEFAULT;
01064         ATLASSERT(m_pd.hDevMode == NULL);   <font class="comment">// must be NULL</font>
01065         ATLASSERT(m_pd.hDevNames == NULL);  <font class="comment">// must be NULL</font>
01066 
01067         return ::PrintDlg(&amp;m_pd);
01068     }
01069 
01070     <font class="comment">// Helpers for parsing information after successful return num. copies requested</font>
<a name="l01071"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a3">01071</a>     <font class="keywordtype">int</font> GetCopies()<font class="keyword"> const</font>
01072 <font class="keyword">    </font>{
01073         <font class="keywordflow">if</font>(m_pd.Flags &amp; PD_USEDEVMODECOPIES)
01074         {
01075             LPDEVMODE lpDevMode = GetDevMode();
01076             <font class="keywordflow">return</font> (lpDevMode != NULL) ? lpDevMode-&gt;dmCopies : -1;
01077         }
01078 
01079         <font class="keywordflow">return</font> m_pd.nCopies;
01080     }
<a name="l01081"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a4">01081</a>     BOOL PrintCollate() <font class="keyword">const</font>       <font class="comment">// TRUE if collate checked</font>
01082     {
01083         <font class="keywordflow">return</font> (m_pd.Flags &amp; PD_COLLATE) ? TRUE : FALSE;
01084     }
<a name="l01085"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a5">01085</a>     BOOL PrintSelection() <font class="keyword">const</font>     <font class="comment">// TRUE if printing selection</font>
01086     {
01087         <font class="keywordflow">return</font> (m_pd.Flags &amp; PD_SELECTION) ? TRUE : FALSE;
01088     }
<a name="l01089"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a6">01089</a>     BOOL PrintAll() <font class="keyword">const</font>           <font class="comment">// TRUE if printing all pages</font>
01090     {
01091         <font class="keywordflow">return</font> (!PrintRange() &amp;&amp; !PrintSelection()) ? TRUE : FALSE;
01092     }
<a name="l01093"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a7">01093</a>     BOOL PrintRange() <font class="keyword">const</font>         <font class="comment">// TRUE if printing page range</font>
01094     {
01095         <font class="keywordflow">return</font> (m_pd.Flags &amp; PD_PAGENUMS) ? TRUE : FALSE;
01096     }
<a name="l01097"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a8">01097</a>     <font class="keywordtype">int</font> GetFromPage() <font class="keyword">const</font>         <font class="comment">// starting page if valid</font>
01098     {
01099         <font class="keywordflow">return</font> PrintRange() ? m_pd.nFromPage : -1;
01100     }
<a name="l01101"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a9">01101</a>     <font class="keywordtype">int</font> GetToPage() <font class="keyword">const</font>           <font class="comment">// ending page if valid</font>
01102     {
01103         <font class="keywordflow">return</font> PrintRange() ? m_pd.nToPage : -1;
01104     }
<a name="l01105"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a10">01105</a>     LPDEVMODE GetDevMode() <font class="keyword">const</font>    <font class="comment">// return DEVMODE</font>
01106     {
01107         <font class="keywordflow">if</font>(m_pd.hDevMode == NULL)
01108             <font class="keywordflow">return</font> NULL;
01109 
01110         <font class="keywordflow">return</font> (LPDEVMODE)::GlobalLock(m_pd.hDevMode);
01111     }
<a name="l01112"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a11">01112</a>     LPCTSTR GetDriverName() <font class="keyword">const</font>   <font class="comment">// return driver name</font>
01113     {
01114         <font class="keywordflow">if</font>(m_pd.hDevNames == NULL)
01115             <font class="keywordflow">return</font> NULL;
01116 
01117         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_pd.hDevNames);
01118         <font class="keywordflow">if</font>(lpDev == NULL)
01119             <font class="keywordflow">return</font> NULL;
01120 
01121         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wDriverOffset;
01122     }
<a name="l01123"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a12">01123</a>     LPCTSTR GetDeviceName() <font class="keyword">const</font>   <font class="comment">// return device name</font>
01124     {
01125         <font class="keywordflow">if</font>(m_pd.hDevNames == NULL)
01126             <font class="keywordflow">return</font> NULL;
01127 
01128         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_pd.hDevNames);
01129         <font class="keywordflow">if</font>(lpDev == NULL)
01130             <font class="keywordflow">return</font> NULL;
01131 
01132         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wDeviceOffset;
01133     }
<a name="l01134"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a13">01134</a>     LPCTSTR GetPortName() <font class="keyword">const</font>     <font class="comment">// return output port name</font>
01135     {
01136         <font class="keywordflow">if</font>(m_pd.hDevNames == NULL)
01137             <font class="keywordflow">return</font> NULL;
01138 
01139         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_pd.hDevNames);
01140         <font class="keywordflow">if</font>(lpDev == NULL)
01141             <font class="keywordflow">return</font> NULL;
01142 
01143         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wOutputOffset;
01144     }
<a name="l01145"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a14">01145</a>     HDC GetPrinterDC() <font class="keyword">const</font>        <font class="comment">// return HDC (caller must delete)</font>
01146     {
01147         ATLASSERT(m_pd.Flags &amp; PD_RETURNDC);
01148         <font class="keywordflow">return</font> m_pd.hDC;
01149     }
01150 
01151     <font class="comment">// This helper creates a DC based on the DEVNAMES and DEVMODE structures.</font>
01152     <font class="comment">// This DC is returned, but also stored in m_pd.hDC as though it had been</font>
01153     <font class="comment">// returned by CommDlg.  It is assumed that any previously obtained DC</font>
01154     <font class="comment">// has been/will be deleted by the user.  This may be</font>
01155     <font class="comment">// used without ever invoking the print/print setup dialogs.</font>
<a name="l01156"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a15">01156</a>     HDC CreatePrinterDC()
01157     {
01158         m_pd.hDC = <a class="code" href="namespaceWTL.html#a65">_AtlCreateDC</a>(m_pd.hDevNames, m_pd.hDevMode);
01159         <font class="keywordflow">return</font> m_pd.hDC;
01160     }
01161 
01162 <font class="comment">// Implementation</font>
<a name="l01163"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#m1">01163</a>     PRINTDLG m_pdActual; <font class="comment">// the Print/Print Setup need to share this</font>
01164 
01165     <font class="comment">// The following handle the case of print setup... from the print dialog</font>
<a name="l01166"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a16">01166</a>     CPrintDialogImpl(PRINTDLG&amp; pdInit) : m_pd(pdInit)
01167     { }
01168 
01169     BEGIN_MSG_MAP(CPrintDialogImpl)
01170 <font class="preprocessor">#ifdef psh1</font>
01171 <font class="preprocessor"></font>        COMMAND_ID_HANDLER(psh1, OnPrintSetup) <font class="comment">// print setup button when print is displayed</font>
01172 <font class="preprocessor">#else </font>
01173 <font class="preprocessor">        COMMAND_ID_HANDLER(0x0400, OnPrintSetup) // value from dlgs.h</font>
01174 <font class="preprocessor"></font><font class="preprocessor">#endif </font>
01175 <font class="preprocessor">    END_MSG_MAP()</font>
01176 <font class="preprocessor"></font>
<a name="l01177"></a><a class="code" href="classWTL_1_1CPrintDialogImpl.html#a17">01177</a>     LRESULT OnPrintSetup(WORD wNotifyCode, WORD wID, HWND hWndCtl, BOOL&amp; <font class="comment">/*bHandled*/</font>)
01178     {
01179         <a class="code" href="classWTL_1_1CPrintDialogImpl.html">CPrintDialogImpl&lt; T &gt;</a>* pDlgSetup = NULL;
01180         ATLTRY(pDlgSetup = <font class="keyword">new</font> <a class="code" href="classWTL_1_1CPrintDialogImpl.html">CPrintDialogImpl&lt; T &gt;</a>(m_pd));
01181         ATLASSERT(pDlgSetup != NULL);
01182 
01183         _Module.AddCreateWndData(&amp;m_thunk.cd, (CCommonDialogImplBase*)pDlgSetup);
01184         LRESULT lRet = DefWindowProc(WM_COMMAND, MAKEWPARAM(wID, wNotifyCode), (LPARAM)hWndCtl);
01185 
01186         <font class="keyword">delete</font> pDlgSetup;
01187         <font class="keywordflow">return</font> lRet;
01188     }
01189 };
01190 
<a name="l01191"></a><a class="code" href="classWTL_1_1CPrintDialog.html">01191</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrintDialog.html">CPrintDialog</a> : <font class="keyword">public</font> CPrintDialogImpl&lt;CPrintDialog&gt;
01192 {
01193 <font class="keyword">public</font>:
<a name="l01194"></a><a class="code" href="classWTL_1_1CPrintDialog.html#a0">01194</a>     <a class="code" href="classWTL_1_1CPrintDialog.html#a0">CPrintDialog</a>(BOOL bPrintSetupOnly = FALSE,
01195         DWORD dwFlags = PD_ALLPAGES | PD_USEDEVMODECOPIES | PD_NOPAGENUMS | PD_NOSELECTION,
01196         HWND hWndParent = NULL)
01197         : CPrintDialogImpl&lt;<a class="code" href="classWTL_1_1CPrintDialog.html">CPrintDialog</a>&gt;(bPrintSetupOnly, dwFlags, hWndParent)
01198     { }
01199 
<a name="l01200"></a><a class="code" href="classWTL_1_1CPrintDialog.html#a1">01200</a>     <a class="code" href="classWTL_1_1CPrintDialog.html#a0">CPrintDialog</a>(PRINTDLG&amp; pdInit) : CPrintDialogImpl&lt;<a class="code" href="classWTL_1_1CPrintDialog.html">CPrintDialog</a>&gt;(pdInit)
01201     { }
01202 };
01203 
01204 
01206 <font class="comment">// CPrintDialogExImpl - new print dialog for Windows 2000</font>
01207 
01208 <font class="preprocessor">#if (WINVER &gt;= 0x0500)</font>
01209 <font class="preprocessor"></font>
01210 }; <font class="comment">//namespace WTL</font>
01211 
01212 <font class="preprocessor">#include &lt;atlcom.h&gt;</font>
01213 
<a name="l01214"></a><a class="code" href="atldlgs_8h.html#a4">01214</a> <font class="keyword">extern</font> <font class="stringliteral">"C"</font> <font class="keyword">const</font> <a class="code" href="atldlgs_8h.html#a4">__declspec</a>(selectany) IID IID_IPrintDialogCallback = {0x5852a2c3, 0x6530, 0x11d1, {0xb6, 0xa3, 0x0, 0x0, 0xf8, 0x75, 0x7b, 0xf9}};
01215 <font class="keyword">extern</font> <font class="stringliteral">"C"</font> <font class="keyword">const</font> <a class="code" href="atldlgs_8h.html#a4">__declspec</a>(selectany) IID IID_IPrintDialogServices = {0x509aaeda, 0x5639, 0x11d1, {0xb6, 0xa1, 0x0, 0x0, 0xf8, 0x75, 0x7b, 0xf9}};
01216 
01217 <font class="keyword">namespace </font>WTL
01218 {
01219 
01220 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l01221"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html">01221</a> <font class="keyword">class </font>ATL_NO_VTABLE CPrintDialogExImpl : 
01222                 <font class="keyword">public</font> <a class="code" href="classCWindow.html">CWindow</a>,
01223                 <font class="keyword">public</font> <a class="code" href="classCMessageMap.html">CMessageMap</a>,
01224                 <font class="keyword">public</font> <a class="code" href="classIPrintDialogCallback.html">IPrintDialogCallback</a>,
01225                 <font class="keyword">public</font> <a class="code" href="classIObjectWithSiteImpl.html">IObjectWithSiteImpl</a>&lt; T &gt;
01226 {
01227 <font class="keyword">public</font>:
<a name="l01228"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#m0">01228</a>     PRINTDLGEX m_pdex;
01229 
01230 <font class="comment">// Constructor</font>
<a name="l01231"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a0">01231</a>     CPrintDialogExImpl(DWORD dwFlags = PD_ALLPAGES | PD_USEDEVMODECOPIES | PD_NOPAGENUMS | PD_NOSELECTION | PD_NOCURRENTPAGE,
01232                 HWND hWndParent = NULL)
01233     {
01234         memset(&amp;m_pdex, 0, <font class="keyword">sizeof</font>(m_pdex));
01235 
01236         m_pdex.lStructSize = <font class="keyword">sizeof</font>(PRINTDLGEX);
01237         m_pdex.hwndOwner = hWndParent;
01238         m_pdex.Flags = dwFlags;
01239         m_pdex.nStartPage = START_PAGE_GENERAL;
01240         <font class="comment">// callback object will be set in DoModal</font>
01241 
01242         m_pdex.Flags &amp;= ~PD_RETURNIC; <font class="comment">// do not support information context</font>
01243     }
01244 
01245 <font class="comment">// Operations</font>
<a name="l01246"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a1">01246</a>     HRESULT DoModal(HWND hWndParent = ::GetActiveWindow())
01247     {
01248         ATLASSERT(m_hWnd == NULL);
01249         ATLASSERT((m_pdex.Flags &amp; PD_RETURNDEFAULT) == 0);  <font class="comment">// use GetDefaults for this</font>
01250 
01251         <font class="keywordflow">if</font>(m_pdex.hwndOwner == NULL)        <font class="comment">// set only if not specified before</font>
01252             m_pdex.hwndOwner = hWndParent;
01253 
01254         T* pT = static_cast&lt;T*&gt;(this);
01255         m_pdex.lpCallback = (IUnknown*)(<a class="code" href="classIPrintDialogCallback.html">IPrintDialogCallback</a>*)pT;
01256 
01257         HRESULT hResult = ::PrintDlgEx(&amp;m_pdex);
01258 
01259         m_hWnd = NULL;
01260 
01261         <font class="keywordflow">return</font> hResult;
01262     }
01263 
<a name="l01264"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a2">01264</a>     BOOL EndDialog(INT_PTR <font class="comment">/*nRetCode*/</font> = 0)
01265     {
01266         ATLASSERT(::IsWindow(m_hWnd));
01267         SendMessage(WM_COMMAND, MAKEWPARAM(IDABORT, 0));
01268         <font class="keywordflow">return</font> TRUE;
01269     }
01270 
01271     <font class="comment">// GetDefaults will not display a dialog but will get device defaults</font>
<a name="l01272"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a3">01272</a>     HRESULT GetDefaults()
01273     {
01274         m_pdex.Flags |= PD_RETURNDEFAULT;
01275         ATLASSERT(m_pdex.hDevMode == NULL); <font class="comment">// must be NULL</font>
01276         ATLASSERT(m_pdex.hDevNames == NULL);    <font class="comment">// must be NULL</font>
01277 
01278         return ::PrintDlgEx(&amp;m_pdex);
01279     }
01280 
01281     <font class="comment">// Helpers for parsing information after successful return num. copies requested</font>
<a name="l01282"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a4">01282</a>     <font class="keywordtype">int</font> GetCopies()<font class="keyword"> const</font>
01283 <font class="keyword">    </font>{
01284         <font class="keywordflow">if</font>(m_pdex.Flags &amp; PD_USEDEVMODECOPIES)
01285         {
01286             LPDEVMODE lpDevMode = GetDevMode();
01287             <font class="keywordflow">return</font> (lpDevMode != NULL) ? lpDevMode-&gt;dmCopies : -1;
01288         }
01289 
01290         <font class="keywordflow">return</font> m_pdex.nCopies;
01291     }
<a name="l01292"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a5">01292</a>     BOOL PrintCollate() <font class="keyword">const</font>       <font class="comment">// TRUE if collate checked</font>
01293     {
01294         <font class="keywordflow">return</font> (m_pdex.Flags &amp; PD_COLLATE) ? TRUE : FALSE;
01295     }
<a name="l01296"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a6">01296</a>     BOOL PrintSelection() <font class="keyword">const</font>     <font class="comment">// TRUE if printing selection</font>
01297     {
01298         <font class="keywordflow">return</font> (m_pdex.Flags &amp; PD_SELECTION) ? TRUE : FALSE;
01299     }
<a name="l01300"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a7">01300</a>     BOOL PrintAll() <font class="keyword">const</font>           <font class="comment">// TRUE if printing all pages</font>
01301     {
01302         <font class="keywordflow">return</font> (!PrintRange() &amp;&amp; !PrintSelection()) ? TRUE : FALSE;
01303     }
<a name="l01304"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a8">01304</a>     BOOL PrintRange() <font class="keyword">const</font>         <font class="comment">// TRUE if printing page range</font>
01305     {
01306         <font class="keywordflow">return</font> (m_pdex.Flags &amp; PD_PAGENUMS) ? TRUE : FALSE;
01307     }
<a name="l01308"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a9">01308</a>     LPDEVMODE GetDevMode() <font class="keyword">const</font>    <font class="comment">// return DEVMODE</font>
01309     {
01310         <font class="keywordflow">if</font>(m_pdex.hDevMode == NULL)
01311             <font class="keywordflow">return</font> NULL;
01312 
01313         <font class="keywordflow">return</font> (LPDEVMODE)::GlobalLock(m_pdex.hDevMode);
01314     }
<a name="l01315"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a10">01315</a>     LPCTSTR GetDriverName() <font class="keyword">const</font>   <font class="comment">// return driver name</font>
01316     {
01317         <font class="keywordflow">if</font>(m_pdex.hDevNames == NULL)
01318             <font class="keywordflow">return</font> NULL;
01319 
01320         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_pdex.hDevNames);
01321         <font class="keywordflow">if</font>(lpDev == NULL)
01322             <font class="keywordflow">return</font> NULL;
01323 
01324         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wDriverOffset;
01325     }
<a name="l01326"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a11">01326</a>     LPCTSTR GetDeviceName() <font class="keyword">const</font>   <font class="comment">// return device name</font>
01327     {
01328         <font class="keywordflow">if</font>(m_pdex.hDevNames == NULL)
01329             <font class="keywordflow">return</font> NULL;
01330 
01331         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_pdex.hDevNames);
01332         <font class="keywordflow">if</font>(lpDev == NULL)
01333             <font class="keywordflow">return</font> NULL;
01334 
01335         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wDeviceOffset;
01336     }
<a name="l01337"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a12">01337</a>     LPCTSTR GetPortName() <font class="keyword">const</font>     <font class="comment">// return output port name</font>
01338     {
01339         <font class="keywordflow">if</font>(m_pdex.hDevNames == NULL)
01340             <font class="keywordflow">return</font> NULL;
01341 
01342         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_pdex.hDevNames);
01343         <font class="keywordflow">if</font>(lpDev == NULL)
01344             <font class="keywordflow">return</font> NULL;
01345 
01346         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wOutputOffset;
01347     }
<a name="l01348"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a13">01348</a>     HDC GetPrinterDC() <font class="keyword">const</font>        <font class="comment">// return HDC (caller must delete)</font>
01349     {
01350         ATLASSERT(m_pdex.Flags &amp; PD_RETURNDC);
01351         <font class="keywordflow">return</font> m_pdex.hDC;
01352     }
01353 
01354     <font class="comment">// This helper creates a DC based on the DEVNAMES and DEVMODE structures.</font>
01355     <font class="comment">// This DC is returned, but also stored in m_pdex.hDC as though it had been</font>
01356     <font class="comment">// returned by CommDlg.  It is assumed that any previously obtained DC</font>
01357     <font class="comment">// has been/will be deleted by the user.  This may be</font>
01358     <font class="comment">// used without ever invoking the print/print setup dialogs.</font>
<a name="l01359"></a><a class="code" href="classWTL_1_1CPrintDialogExImpl.html#a14">01359</a>     HDC CreatePrinterDC()
01360     {
01361         m_pdex.hDC = <a class="code" href="namespaceWTL.html#a65">_AtlCreateDC</a>(m_pdex.hDevNames, m_pdex.hDevMode);
01362         <font class="keywordflow">return</font> m_pdex.hDC;
01363     }
01364 
01365 <font class="comment">// Implementation - interfaces</font>
01366 
01367 <font class="comment">// IUnknown</font>
01368     STDMETHOD(QueryInterface)(REFIID riid, <font class="keywordtype">void</font>** ppvObject)
01369     {
01370         <font class="keywordflow">if</font>(ppvObject == NULL)
01371             <font class="keywordflow">return</font> E_POINTER;
01372 
01373         T* pT = static_cast&lt;T*&gt;(this);
01374         <font class="keywordflow">if</font>(IsEqualGUID(riid, IID_IUnknown) || IsEqualGUID(riid, IID_IPrintDialogCallback))
01375         {
01376             *ppvObject = (<a class="code" href="classIPrintDialogCallback.html">IPrintDialogCallback</a>*)pT;
01377             <font class="comment">// AddRef() not needed</font>
01378             <font class="keywordflow">return</font> S_OK;
01379         }
01380         <font class="keywordflow">else</font> <font class="keywordflow">if</font>(IsEqualGUID(riid, IID_IObjectWithSite))
01381         {
01382             *ppvObject = (IObjectWithSite*)pT;
01383             <font class="comment">// AddRef() not needed</font>
01384             <font class="keywordflow">return</font> S_OK;
01385         }
01386 
01387         <font class="keywordflow">return</font> E_NOINTERFACE;
01388     }
01389     <font class="keyword">virtual</font> ULONG STDMETHODCALLTYPE AddRef()
01390     {
01391         <font class="keywordflow">return</font> 1;
01392     }
01393     <font class="keyword">virtual</font> ULONG STDMETHODCALLTYPE Release()
01394     {
01395         <font class="keywordflow">return</font> 1;
01396     }
01397 
01398 <font class="comment">// IPrintDialogCallback</font>
01399     STDMETHOD(InitDone)()
01400     {
01401         <font class="keywordflow">return</font> S_FALSE;
01402     }
01403     STDMETHOD(SelectionChange)()
01404     {
01405         <font class="keywordflow">return</font> S_FALSE;
01406     }
01407     STDMETHOD(HandleMessage)(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam, LRESULT* plResult)
01408     {
01409         <font class="comment">// set up m_hWnd the first time</font>
01410         <font class="keywordflow">if</font>(m_hWnd == NULL)
01411             Attach(hWnd);
01412 
01413         <font class="comment">// call message map</font>
01414         HRESULT hRet = ProcessWindowMessage(hWnd, uMsg, wParam, lParam, *plResult, 0) ? S_OK : S_FALSE;
01415         <font class="keywordflow">if</font>(hRet == S_OK &amp;&amp; uMsg == WM_NOTIFY)   <font class="comment">// return in DWLP_MSGRESULT</font>
01416             ::SetWindowLongPtr(GetParent(), <a class="code" href="atlapp_8h.html#a12">DWLP_MSGRESULT</a>, (LONG_PTR)*plResult);
01417 
01418         <font class="keywordflow">if</font>(uMsg == WM_INITDIALOG &amp;&amp; hRet == S_OK &amp;&amp; (BOOL)*plResult != FALSE)
01419             hRet = S_FALSE;
01420 
01421         <font class="keywordflow">return</font> hRet;
01422     }
01423 };
01424 
<a name="l01425"></a><a class="code" href="classWTL_1_1CPrintDialogEx.html">01425</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrintDialogEx.html">CPrintDialogEx</a> : <font class="keyword">public</font> CPrintDialogExImpl&lt;CPrintDialogEx&gt;
01426 {
01427 <font class="keyword">public</font>:
<a name="l01428"></a><a class="code" href="classWTL_1_1CPrintDialogEx.html#a0">01428</a>     <a class="code" href="classWTL_1_1CPrintDialogEx.html#a0">CPrintDialogEx</a>(
01429         DWORD dwFlags = PD_ALLPAGES | PD_USEDEVMODECOPIES | PD_NOPAGENUMS | PD_NOSELECTION | PD_NOCURRENTPAGE,
01430         HWND hWndParent = NULL)
01431         : CPrintDialogExImpl&lt;<a class="code" href="classWTL_1_1CPrintDialogEx.html">CPrintDialogEx</a>&gt;(dwFlags, hWndParent)
01432     { }
01433 
01434     DECLARE_EMPTY_MSG_MAP()
01435 };
01436 
01437 <font class="preprocessor">#endif //(WINVER &gt;= 0x0500)</font>
01438 <font class="preprocessor"></font>
01440 <font class="comment">// CPageSetupDialogImpl - Page Setup dialog</font>
01441 
01442 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l01443"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html">01443</a> <font class="keyword">class </font>ATL_NO_VTABLE CPageSetupDialogImpl : <font class="keyword">public</font> CCommonDialogImplBase
01444 {
01445 <font class="keyword">public</font>:
<a name="l01446"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#m0">01446</a>     PAGESETUPDLG m_psd;
<a name="l01447"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#m1">01447</a>     CWndProcThunk m_thunkPaint;
01448 
01449 
01450 <font class="comment">// Constructors</font>
<a name="l01451"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a0">01451</a>     CPageSetupDialogImpl(DWORD dwFlags = PSD_MARGINS | PSD_INWININIINTLMEASURE, HWND hWndParent = NULL)
01452     {
01453         memset(&amp;m_psd, 0, <font class="keyword">sizeof</font>(m_psd));
01454 
01455         m_psd.lStructSize = <font class="keyword">sizeof</font>(m_psd);
01456         m_psd.hwndOwner = hWndParent;
01457         m_psd.Flags = (dwFlags | PSD_ENABLEPAGESETUPHOOK | PSD_ENABLEPAGEPAINTHOOK);
01458         m_psd.lpfnPageSetupHook = (LPPAGESETUPHOOK)T::HookProc;
01459         m_thunkPaint.Init((WNDPROC)T::PaintHookProc, <font class="keyword">this</font>);
01460 <font class="preprocessor">#if (_ATL_VER &gt;= 0x0700)</font>
01461 <font class="preprocessor"></font>        m_psd.lpfnPagePaintHook = (LPPAGEPAINTHOOK)m_thunkPaint.GetWNDPROC();
01462 <font class="preprocessor">#else</font>
01463 <font class="preprocessor"></font>        m_psd.lpfnPagePaintHook = (LPPAGEPAINTHOOK)&amp;(m_thunkPaint.thunk);
01464 <font class="preprocessor">#endif</font>
01465 <font class="preprocessor"></font>    }
01466 
01467     DECLARE_EMPTY_MSG_MAP()
01468 
01469 <font class="comment">// Attributes</font>
<a name="l01470"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a1">01470</a>     LPDEVMODE GetDevMode() <font class="keyword">const</font>    <font class="comment">// return DEVMODE</font>
01471     {
01472         <font class="keywordflow">if</font>(m_psd.hDevMode == NULL)
01473             <font class="keywordflow">return</font> NULL;
01474 
01475         <font class="keywordflow">return</font> (LPDEVMODE)::GlobalLock(m_psd.hDevMode);
01476     }
<a name="l01477"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a2">01477</a>     LPCTSTR GetDriverName() <font class="keyword">const</font>   <font class="comment">// return driver name</font>
01478     {
01479         <font class="keywordflow">if</font>(m_psd.hDevNames == NULL)
01480             <font class="keywordflow">return</font> NULL;
01481 
01482         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_psd.hDevNames);
01483         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wDriverOffset;
01484     }
<a name="l01485"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a3">01485</a>     LPCTSTR GetDeviceName() <font class="keyword">const</font>   <font class="comment">// return device name</font>
01486     {
01487         <font class="keywordflow">if</font>(m_psd.hDevNames == NULL)
01488             <font class="keywordflow">return</font> NULL;
01489 
01490         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_psd.hDevNames);
01491         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wDeviceOffset;
01492     }
<a name="l01493"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a4">01493</a>     LPCTSTR GetPortName() <font class="keyword">const</font>     <font class="comment">// return output port name</font>
01494     {
01495         <font class="keywordflow">if</font>(m_psd.hDevNames == NULL)
01496             <font class="keywordflow">return</font> NULL;
01497 
01498         LPDEVNAMES lpDev = (LPDEVNAMES)::GlobalLock(m_psd.hDevNames);
01499         <font class="keywordflow">return</font> (LPCTSTR)lpDev + lpDev-&gt;wOutputOffset;
01500     }
<a name="l01501"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a5">01501</a>     HDC CreatePrinterDC()
01502     {
01503         <font class="keywordflow">return</font> <a class="code" href="namespaceWTL.html#a65">_AtlCreateDC</a>(m_psd.hDevNames, m_psd.hDevMode);
01504     }
<a name="l01505"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a6">01505</a>     SIZE GetPaperSize()<font class="keyword"> const</font>
01506 <font class="keyword">    </font>{
01507         SIZE size;
01508         size.cx = m_psd.ptPaperSize.x;
01509         size.cy = m_psd.ptPaperSize.y;
01510         <font class="keywordflow">return</font> size;
01511     }
<a name="l01512"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a7">01512</a>     <font class="keywordtype">void</font> GetMargins(LPRECT lpRectMargins, LPRECT lpRectMinMargins)<font class="keyword"> const</font>
01513 <font class="keyword">    </font>{
01514         <font class="keywordflow">if</font>(lpRectMargins != NULL)
01515             memcpy(lpRectMargins, &amp;m_psd.rtMargin, <font class="keyword">sizeof</font>(RECT));
01516         <font class="keywordflow">if</font>(lpRectMinMargins != NULL)
01517             memcpy(lpRectMinMargins, &amp;m_psd.rtMinMargin, <font class="keyword">sizeof</font>(RECT));
01518     }
01519 
01520 <font class="comment">// Operations</font>
<a name="l01521"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a8">01521</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
01522     {
01523         ATLASSERT(m_psd.Flags &amp; PSD_ENABLEPAGESETUPHOOK);
01524         ATLASSERT(m_psd.Flags &amp; PSD_ENABLEPAGEPAINTHOOK);
01525         ATLASSERT(m_psd.lpfnPageSetupHook != NULL); <font class="comment">// can still be a user hook</font>
01526         ATLASSERT(m_psd.lpfnPagePaintHook != NULL); <font class="comment">// can still be a user hook</font>
01527 
01528         <font class="keywordflow">if</font>(m_psd.hwndOwner == NULL)     <font class="comment">// set only if not specified before</font>
01529             m_psd.hwndOwner = hWndParent;
01530 
01531         ATLASSERT(m_hWnd == NULL);
01532         _Module.AddCreateWndData(&amp;m_thunk.cd, (CCommonDialogImplBase*)<font class="keyword">this</font>);
01533 
01534         BOOL bRet = ::PageSetupDlg(&amp;m_psd);
01535 
01536         m_hWnd = NULL;
01537 
01538         <font class="keywordflow">return</font> bRet ? IDOK : IDCANCEL;
01539     }
01540 
01541 <font class="comment">// Implementation</font>
<a name="l01542"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#d0">01542</a>     <font class="keyword">static</font> UINT CALLBACK PaintHookProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
01543     {
01544         <a class="code" href="classWTL_1_1CPageSetupDialogImpl.html">CPageSetupDialogImpl&lt; T &gt;</a>* pDlg = (<a class="code" href="classWTL_1_1CPageSetupDialogImpl.html">CPageSetupDialogImpl&lt; T &gt;</a>*)hWnd;
01545         ATLASSERT(pDlg-&gt;m_hWnd == ::GetParent(hWnd));
01546         UINT uRet = 0;
01547         <font class="keywordflow">switch</font>(uMsg)
01548         {
01549         <font class="keywordflow">case</font> WM_PSD_PAGESETUPDLG:
01550             uRet = pDlg-&gt;<a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a9">PreDrawPage</a>(LOWORD(wParam), HIWORD(wParam), (LPPAGESETUPDLG)lParam);
01551             <font class="keywordflow">break</font>;
01552         <font class="keywordflow">case</font> WM_PSD_FULLPAGERECT:
01553         <font class="keywordflow">case</font> WM_PSD_MINMARGINRECT:
01554         <font class="keywordflow">case</font> WM_PSD_MARGINRECT:
01555         <font class="keywordflow">case</font> WM_PSD_GREEKTEXTRECT:
01556         <font class="keywordflow">case</font> WM_PSD_ENVSTAMPRECT:
01557         <font class="keywordflow">case</font> WM_PSD_YAFULLPAGERECT:
01558             uRet = pDlg-&gt;<a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a10">OnDrawPage</a>(uMsg, (HDC)wParam, (LPRECT)lParam);
01559             <font class="keywordflow">break</font>;
01560         <font class="keywordflow">default</font>:
01561             ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, _T(<font class="stringliteral">"CPageSetupDialogImpl::PaintHookProc - unknown message received\n"</font>));
01562             <font class="keywordflow">break</font>;
01563         }
01564         <font class="keywordflow">return</font> uRet;
01565     }
01566 
01567 <font class="comment">// Overridables</font>
<a name="l01568"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a9">01568</a>     UINT PreDrawPage(WORD <font class="comment">/*wPaper*/</font>, WORD <font class="comment">/*wFlags*/</font>, LPPAGESETUPDLG <font class="comment">/*pPSD*/</font>)
01569     {
01570         <font class="comment">// return 1 to prevent any more drawing</font>
01571         <font class="keywordflow">return</font> 0;
01572     }
<a name="l01573"></a><a class="code" href="classWTL_1_1CPageSetupDialogImpl.html#a10">01573</a>     UINT OnDrawPage(UINT <font class="comment">/*uMsg*/</font>, HDC <font class="comment">/*hDC*/</font>, LPRECT <font class="comment">/*lpRect*/</font>)
01574     {
01575         <font class="keywordflow">return</font> 0; <font class="comment">// do the default</font>
01576     }
01577 };
01578 
<a name="l01579"></a><a class="code" href="classWTL_1_1CPageSetupDialog.html">01579</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPageSetupDialog.html">CPageSetupDialog</a> : <font class="keyword">public</font> CPageSetupDialogImpl&lt;CPageSetupDialog&gt;
01580 {
01581 <font class="keyword">public</font>:
<a name="l01582"></a><a class="code" href="classWTL_1_1CPageSetupDialog.html#a0">01582</a>     <a class="code" href="classWTL_1_1CPageSetupDialog.html#a0">CPageSetupDialog</a>(DWORD dwFlags = PSD_MARGINS | PSD_INWININIINTLMEASURE, HWND hWndParent = NULL)
01583         : CPageSetupDialogImpl&lt;<a class="code" href="classWTL_1_1CPageSetupDialog.html">CPageSetupDialog</a>&gt;(dwFlags, hWndParent)
01584     { }
01585 
01586     <font class="comment">// override PaintHookProc and references to handlers</font>
<a name="l01587"></a><a class="code" href="classWTL_1_1CPageSetupDialog.html#d0">01587</a>     <font class="keyword">static</font> UINT CALLBACK <a class="code" href="classWTL_1_1CPageSetupDialog.html#d0">PaintHookProc</a>(HWND, UINT, WPARAM, LPARAM)
01588     {
01589         <font class="keywordflow">return</font> 0;
01590     }
01591 };
01592 
01593 
01595 <font class="comment">// CFindReplaceDialogImpl - Find/FindReplace modeless dialogs</font>
01596 
01597 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt;
<a name="l01598"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html">01598</a> <font class="keyword">class </font>ATL_NO_VTABLE CFindReplaceDialogImpl : <font class="keyword">public</font> CCommonDialogImplBase
01599 {
01600 <font class="keyword">public</font>:
<a name="l01601"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#m0">01601</a>     FINDREPLACE m_fr;
<a name="l01602"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#m1">01602</a>     TCHAR m_szFindWhat[128];
<a name="l01603"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#m2">01603</a>     TCHAR m_szReplaceWith[128];
01604 
01605 <font class="comment">// Constructors</font>
<a name="l01606"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a0">01606</a>     CFindReplaceDialogImpl()
01607     {
01608         memset(&amp;m_fr, 0, <font class="keyword">sizeof</font>(m_fr));
01609         m_szFindWhat[0] = <font class="charliteral">'\0'</font>;
01610         m_szReplaceWith[0] = <font class="charliteral">'\0'</font>;
01611 
01612         m_fr.lStructSize = <font class="keyword">sizeof</font>(m_fr);
01613         m_fr.Flags = FR_ENABLEHOOK;
01614         m_fr.lpfnHook = (LPFRHOOKPROC)T::HookProc;
01615         m_fr.lpstrFindWhat = (LPTSTR)m_szFindWhat;
01616     }
01617 
01618     <font class="comment">// Note: You must allocate the object on the heap.</font>
01619     <font class="comment">//       If you do not, you must override OnFinalMessage()</font>
<a name="l01620"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a1">01620</a>     <font class="keyword">virtual</font> <font class="keywordtype">void</font> OnFinalMessage(HWND <font class="comment">/*hWnd*/</font>)
01621     {
01622         <font class="keyword">delete</font> <font class="keyword">this</font>;
01623     }
01624 
<a name="l01625"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a2">01625</a>     HWND Create(BOOL bFindDialogOnly, <font class="comment">// TRUE for Find, FALSE for FindReplace</font>
01626             LPCTSTR lpszFindWhat,
01627             LPCTSTR lpszReplaceWith = NULL,
01628             DWORD dwFlags = FR_DOWN,
01629             HWND hWndParent = NULL)
01630     {
01631         ATLASSERT(m_fr.Flags &amp; FR_ENABLEHOOK);
01632         ATLASSERT(m_fr.lpfnHook != NULL);
01633 
01634         m_fr.wFindWhatLen = <font class="keyword">sizeof</font>(m_szFindWhat)/<font class="keyword">sizeof</font>(TCHAR);
01635         m_fr.lpstrReplaceWith = (LPTSTR)m_szReplaceWith;
01636         m_fr.wReplaceWithLen = <font class="keyword">sizeof</font>(m_szReplaceWith)/<font class="keyword">sizeof</font>(TCHAR);
01637         m_fr.Flags |= dwFlags;
01638 
01639         <font class="keywordflow">if</font>(hWndParent == NULL)
01640             m_fr.hwndOwner = ::GetActiveWindow();
01641         <font class="keywordflow">else</font>
01642             m_fr.hwndOwner = hWndParent;
01643         ATLASSERT(m_fr.hwndOwner != NULL); <font class="comment">// must have an owner for modeless dialog</font>
01644 
01645         <font class="keywordflow">if</font>(lpszFindWhat != NULL)
01646             lstrcpyn(m_szFindWhat, lpszFindWhat, <font class="keyword">sizeof</font>(m_szFindWhat)/<font class="keyword">sizeof</font>(TCHAR));
01647 
01648         <font class="keywordflow">if</font>(lpszReplaceWith != NULL)
01649             lstrcpyn(m_szReplaceWith, lpszReplaceWith, <font class="keyword">sizeof</font>(m_szReplaceWith)/<font class="keyword">sizeof</font>(TCHAR));
01650 
01651         ATLASSERT(m_hWnd == NULL);
01652         _Module.AddCreateWndData(&amp;m_thunk.cd, (CCommonDialogImplBase*)<font class="keyword">this</font>);
01653         HWND hWnd;
01654 
01655         <font class="keywordflow">if</font>(bFindDialogOnly)
01656             hWnd = ::FindText(&amp;m_fr);
01657         <font class="keywordflow">else</font>
01658             hWnd = ::ReplaceText(&amp;m_fr);
01659 
01660         ATLASSERT(m_hWnd == hWnd);
01661         <font class="keywordflow">return</font> hWnd;
01662     }
01663 
<a name="l01664"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#d0">01664</a>     <font class="keyword">static</font> <font class="keyword">const</font> UINT GetFindReplaceMsg()
01665     {
01666         <font class="keyword">static</font> <font class="keyword">const</font> UINT nMsgFindReplace = ::RegisterWindowMessage(FINDMSGSTRING);
01667         <font class="keywordflow">return</font> nMsgFindReplace;
01668     }
01669     <font class="comment">// call while handling FINDMSGSTRING registered message</font>
01670     <font class="comment">// to retreive the object</font>
<a name="l01671"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#d1">01671</a>     <font class="keyword">static</font> T* PASCAL GetNotifier(LPARAM lParam)
01672     {
01673         ATLASSERT(lParam != NULL);
01674         T* pDlg = (T*)(lParam - offsetof(T, m_fr));
01675         <font class="keywordflow">return</font> pDlg;
01676     }
01677 
01678 <font class="comment">// Operations</font>
01679     <font class="comment">// Helpers for parsing information after successful return</font>
<a name="l01680"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a3">01680</a>     LPCTSTR GetFindString() <font class="keyword">const</font>    <font class="comment">// get find string</font>
01681     {
01682         <font class="keywordflow">return</font> (LPCTSTR)m_fr.lpstrFindWhat;
01683     }
<a name="l01684"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a4">01684</a>     LPCTSTR GetReplaceString() <font class="keyword">const</font> <font class="comment">// get replacement string</font>
01685     {
01686         <font class="keywordflow">return</font> (LPCTSTR)m_fr.lpstrReplaceWith;
01687     }
<a name="l01688"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a5">01688</a>     BOOL SearchDown() <font class="keyword">const</font>          <font class="comment">// TRUE if search down, FALSE is up</font>
01689     {
01690         <font class="keywordflow">return</font> (m_fr.Flags &amp; FR_DOWN) ? TRUE : FALSE;
01691     }
<a name="l01692"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a6">01692</a>     BOOL FindNext() <font class="keyword">const</font>            <font class="comment">// TRUE if command is find next</font>
01693     {
01694         <font class="keywordflow">return</font> (m_fr.Flags &amp; FR_FINDNEXT) ? TRUE : FALSE;
01695     }
<a name="l01696"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a7">01696</a>     BOOL MatchCase() <font class="keyword">const</font>           <font class="comment">// TRUE if matching case</font>
01697     {
01698         <font class="keywordflow">return</font> (m_fr.Flags &amp; FR_MATCHCASE) ? TRUE : FALSE;
01699     }
<a name="l01700"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a8">01700</a>     BOOL MatchWholeWord() <font class="keyword">const</font>      <font class="comment">// TRUE if matching whole words only</font>
01701     {
01702         <font class="keywordflow">return</font> (m_fr.Flags &amp; FR_WHOLEWORD) ? TRUE : FALSE;
01703     }
<a name="l01704"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a9">01704</a>     BOOL ReplaceCurrent() <font class="keyword">const</font>      <font class="comment">// TRUE if replacing current string</font>
01705     {
01706         <font class="keywordflow">return</font> (m_fr. Flags &amp; FR_REPLACE) ? TRUE : FALSE;
01707     }
<a name="l01708"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a10">01708</a>     BOOL ReplaceAll() <font class="keyword">const</font>          <font class="comment">// TRUE if replacing all occurrences</font>
01709     {
01710         <font class="keywordflow">return</font> (m_fr.Flags &amp; FR_REPLACEALL) ? TRUE : FALSE;
01711     }
<a name="l01712"></a><a class="code" href="classWTL_1_1CFindReplaceDialogImpl.html#a11">01712</a>     BOOL IsTerminating() <font class="keyword">const</font>       <font class="comment">// TRUE if terminating dialog</font>
01713     {
01714         <font class="keywordflow">return</font> (m_fr.Flags &amp; FR_DIALOGTERM) ? TRUE : FALSE ;
01715     }
01716 };
01717 
<a name="l01718"></a><a class="code" href="classWTL_1_1CFindReplaceDialog.html">01718</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CFindReplaceDialog.html">CFindReplaceDialog</a> : <font class="keyword">public</font> CFindReplaceDialogImpl&lt;CFindReplaceDialog&gt;
01719 {
01720 <font class="keyword">public</font>:
01721     DECLARE_EMPTY_MSG_MAP()
01722 };
01723 
01724 
01726 <font class="comment">// CPropertySheetWindow - client side for a property sheet</font>
01727 
<a name="l01728"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html">01728</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPropertySheetWindow.html">CPropertySheetWindow</a> : <font class="keyword">public</font> <a class="code" href="classCWindow.html">CWindow</a>
01729 {
01730 <font class="keyword">public</font>:
01731 <font class="comment">// Constructors</font>
<a name="l01732"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a0">01732</a>     <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a0">CPropertySheetWindow</a>(HWND hWnd = NULL) : <a class="code" href="classCWindow.html">CWindow</a>(hWnd) { }
01733 
<a name="l01734"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a1">01734</a>     <a class="code" href="classWTL_1_1CPropertySheetWindow.html">CPropertySheetWindow</a>&amp; <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a1">operator=</a>(HWND hWnd)
01735     {
01736         m_hWnd = hWnd;
01737         <font class="keywordflow">return</font> *<font class="keyword">this</font>;
01738     }
01739 
01740 <font class="comment">// Attributes</font>
<a name="l01741"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a2">01741</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a2">GetPageCount</a>()<font class="keyword"> const</font>
01742 <font class="keyword">    </font>{
01743         ATLASSERT(::IsWindow(m_hWnd));
01744         HWND hWndTabCtrl = <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a9">GetTabControl</a>();
01745         ATLASSERT(hWndTabCtrl != NULL);
01746         <font class="keywordflow">return</font> (int)::SendMessage(hWndTabCtrl, TCM_GETITEMCOUNT, 0, 0L);
01747     }
<a name="l01748"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a3">01748</a>     HWND <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a3">GetActivePage</a>()<font class="keyword"> const</font>
01749 <font class="keyword">    </font>{
01750         ATLASSERT(::IsWindow(m_hWnd));
01751         <font class="keywordflow">return</font> (HWND)::SendMessage(m_hWnd, PSM_GETCURRENTPAGEHWND, 0, 0L);
01752     }
<a name="l01753"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a4">01753</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a4">GetActiveIndex</a>()<font class="keyword"> const</font>
01754 <font class="keyword">    </font>{
01755         ATLASSERT(::IsWindow(m_hWnd));
01756         HWND hWndTabCtrl = <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a9">GetTabControl</a>();
01757         ATLASSERT(hWndTabCtrl != NULL);
01758         <font class="keywordflow">return</font> (int)::SendMessage(hWndTabCtrl, TCM_GETCURSEL, 0, 0L);
01759     }
<a name="l01760"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a5">01760</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a5">SetActivePage</a>(<font class="keywordtype">int</font> nPageIndex)
01761     {
01762         ATLASSERT(::IsWindow(m_hWnd));
01763         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_SETCURSEL, nPageIndex, 0L);
01764     }
<a name="l01765"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a6">01765</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a5">SetActivePage</a>(HPROPSHEETPAGE hPage)
01766     {
01767         ATLASSERT(::IsWindow(m_hWnd));
01768         ATLASSERT(hPage != NULL);
01769         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_SETCURSEL, 0, (LPARAM)hPage);
01770     }
<a name="l01771"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a7">01771</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a7">SetActivePageByID</a>(<font class="keywordtype">int</font> nPageID)
01772     {
01773         ATLASSERT(::IsWindow(m_hWnd));
01774         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_SETCURSELID, 0, nPageID);
01775     }
<a name="l01776"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a8">01776</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a8">SetTitle</a>(LPCTSTR lpszText, UINT nStyle = 0)
01777     {
01778         ATLASSERT(::IsWindow(m_hWnd));
01779         ATLASSERT((nStyle &amp; ~PSH_PROPTITLE) == 0); <font class="comment">// only PSH_PROPTITLE is valid</font>
01780         ATLASSERT(lpszText != NULL);
01781         ::SendMessage(m_hWnd, PSM_SETTITLE, nStyle, (LPARAM)lpszText);
01782     }
<a name="l01783"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a9">01783</a>     HWND <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a9">GetTabControl</a>()<font class="keyword"> const</font>
01784 <font class="keyword">    </font>{
01785         ATLASSERT(::IsWindow(m_hWnd));
01786         <font class="keywordflow">return</font> (HWND)::SendMessage(m_hWnd, PSM_GETTABCONTROL, 0, 0L);
01787     }
<a name="l01788"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a10">01788</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a10">SetFinishText</a>(LPCTSTR lpszText)
01789     {
01790         ATLASSERT(::IsWindow(m_hWnd));
01791         ::SendMessage(m_hWnd, PSM_SETFINISHTEXT, 0, (LPARAM)lpszText);
01792     }
<a name="l01793"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a11">01793</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a11">SetWizardButtons</a>(DWORD dwFlags)
01794     {
01795         ATLASSERT(::IsWindow(m_hWnd));
01796         ::PostMessage(m_hWnd, PSM_SETWIZBUTTONS, 0, dwFlags);
01797     }
01798 
01799 <font class="comment">// Operations</font>
<a name="l01800"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a12">01800</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a12">AddPage</a>(HPROPSHEETPAGE hPage)
01801     {
01802         ATLASSERT(::IsWindow(m_hWnd));
01803         ATLASSERT(hPage != NULL);
01804         ::SendMessage(m_hWnd, PSM_ADDPAGE, 0, (LPARAM)hPage);
01805     }
<a name="l01806"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a13">01806</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a12">AddPage</a>(LPCPROPSHEETPAGE pPage)
01807     {
01808         ATLASSERT(::IsWindow(m_hWnd));
01809         ATLASSERT(pPage != NULL);
01810         HPROPSHEETPAGE hPage = ::CreatePropertySheetPage(pPage);
01811         <font class="keywordflow">if</font>(hPage == NULL)
01812             <font class="keywordflow">return</font> FALSE;
01813         ::SendMessage(m_hWnd, PSM_ADDPAGE, 0, (LPARAM)hPage);
01814         <font class="keywordflow">return</font> TRUE;
01815     }
<a name="l01816"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a14">01816</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a14">RemovePage</a>(<font class="keywordtype">int</font> nPageIndex)
01817     {
01818         ATLASSERT(::IsWindow(m_hWnd));
01819         ::SendMessage(m_hWnd, PSM_REMOVEPAGE, nPageIndex, 0L);
01820     }
<a name="l01821"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a15">01821</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a14">RemovePage</a>(HPROPSHEETPAGE hPage)
01822     {
01823         ATLASSERT(::IsWindow(m_hWnd));
01824         ATLASSERT(hPage != NULL);
01825         ::SendMessage(m_hWnd, PSM_REMOVEPAGE, 0, (LPARAM)hPage);
01826     }
<a name="l01827"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a16">01827</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a16">PressButton</a>(<font class="keywordtype">int</font> nButton)
01828     {
01829         ATLASSERT(::IsWindow(m_hWnd));
01830         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_PRESSBUTTON, nButton, 0L);
01831     }
<a name="l01832"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a17">01832</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a17">Apply</a>()
01833     {
01834         ATLASSERT(::IsWindow(m_hWnd));
01835         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_APPLY, 0, 0L);
01836     }
<a name="l01837"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a18">01837</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a18">CancelToClose</a>()
01838     {
01839         ATLASSERT(::IsWindow(m_hWnd));
01840         ::SendMessage(m_hWnd, PSM_CANCELTOCLOSE, 0, 0L);
01841     }
<a name="l01842"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a19">01842</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a19">SetModified</a>(HWND hWndPage, BOOL bChanged = TRUE)
01843     {
01844         ATLASSERT(::IsWindow(m_hWnd));
01845         ATLASSERT(::IsWindow(hWndPage));
01846         UINT uMsg = bChanged ? PSM_CHANGED : PSM_UNCHANGED;
01847         ::SendMessage(m_hWnd, uMsg, (WPARAM)hWndPage, 0L);
01848     }
<a name="l01849"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a20">01849</a>     LRESULT <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a20">QuerySiblings</a>(WPARAM wParam, LPARAM lParam)
01850     {
01851         ATLASSERT(::IsWindow(m_hWnd));
01852         return ::SendMessage(m_hWnd, PSM_QUERYSIBLINGS, wParam, lParam);
01853     }
<a name="l01854"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a21">01854</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a21">RebootSystem</a>()
01855     {
01856         ATLASSERT(::IsWindow(m_hWnd));
01857         ::SendMessage(m_hWnd, PSM_REBOOTSYSTEM, 0, 0L);
01858     }
<a name="l01859"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a22">01859</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a22">RestartWindows</a>()
01860     {
01861         ATLASSERT(::IsWindow(m_hWnd));
01862         ::SendMessage(m_hWnd, PSM_RESTARTWINDOWS, 0, 0L);
01863     }
<a name="l01864"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a23">01864</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a23">IsDialogMessage</a>(LPMSG lpMsg)
01865     {
01866         ATLASSERT(::IsWindow(m_hWnd));
01867         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_ISDIALOGMESSAGE, 0, (LPARAM)lpMsg);
01868     }
01869 
01870 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
<a name="l01871"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a24">01871</a> <font class="preprocessor"></font>    <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a24">HwndToIndex</a>(HWND hWnd)<font class="keyword"> const</font>
01872 <font class="keyword">    </font>{
01873         ATLASSERT(::IsWindow(m_hWnd));
01874         <font class="keywordflow">return</font> (int)::SendMessage(m_hWnd, PSM_HWNDTOINDEX, (WPARAM)hWnd, 0L);
01875     }
<a name="l01876"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a25">01876</a>     HWND <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a25">IndexToHwnd</a>(<font class="keywordtype">int</font> nIndex)<font class="keyword"> const</font>
01877 <font class="keyword">    </font>{
01878         ATLASSERT(::IsWindow(m_hWnd));
01879         <font class="keywordflow">return</font> (HWND)::SendMessage(m_hWnd, PSM_INDEXTOHWND, nIndex, 0L);
01880     }
<a name="l01881"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a26">01881</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a26">PageToIndex</a>(HPROPSHEETPAGE hPage)<font class="keyword"> const</font>
01882 <font class="keyword">    </font>{
01883         ATLASSERT(::IsWindow(m_hWnd));
01884         <font class="keywordflow">return</font> (int)::SendMessage(m_hWnd, PSM_PAGETOINDEX, 0, (LPARAM)hPage);
01885     }
<a name="l01886"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a27">01886</a>     HPROPSHEETPAGE <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a27">IndexToPage</a>(<font class="keywordtype">int</font> nIndex)<font class="keyword"> const</font>
01887 <font class="keyword">    </font>{
01888         ATLASSERT(::IsWindow(m_hWnd));
01889         <font class="keywordflow">return</font> (HPROPSHEETPAGE)::SendMessage(m_hWnd, PSM_INDEXTOPAGE, nIndex, 0L);
01890     }
<a name="l01891"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a28">01891</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a28">IdToIndex</a>(<font class="keywordtype">int</font> nID)<font class="keyword"> const</font>
01892 <font class="keyword">    </font>{
01893         ATLASSERT(::IsWindow(m_hWnd));
01894         <font class="keywordflow">return</font> (int)::SendMessage(m_hWnd, PSM_IDTOINDEX, 0, nID);
01895     }
<a name="l01896"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a29">01896</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a29">IndexToId</a>(<font class="keywordtype">int</font> nIndex)<font class="keyword"> const</font>
01897 <font class="keyword">    </font>{
01898         ATLASSERT(::IsWindow(m_hWnd));
01899         <font class="keywordflow">return</font> (int)::SendMessage(m_hWnd, PSM_INDEXTOID, nIndex, 0L);
01900     }
<a name="l01901"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a30">01901</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a30">GetResult</a>()<font class="keyword"> const</font>
01902 <font class="keyword">    </font>{
01903         ATLASSERT(::IsWindow(m_hWnd));
01904         <font class="keywordflow">return</font> (int)::SendMessage(m_hWnd, PSM_GETRESULT, 0, 0L);
01905     }
<a name="l01906"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a31">01906</a>     BOOL <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a31">RecalcPageSizes</a>()
01907     {
01908         ATLASSERT(::IsWindow(m_hWnd));
01909         <font class="keywordflow">return</font> (BOOL)::SendMessage(m_hWnd, PSM_RECALCPAGESIZES, 0, 0L);
01910     }
01911 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
01912 <font class="preprocessor"></font>
01913 <font class="comment">// Implementation - override to prevent usage</font>
<a name="l01914"></a><a class="code" href="classWTL_1_1CPropertySheetWindow.html#a32">01914</a>     HWND <a class="code" href="classWTL_1_1CPropertySheetWindow.html#a32">Create</a>(LPCTSTR, HWND, <a class="code" href="classWTL_1_1__U__RECT.html">_U_RECT</a> = NULL, LPCTSTR = NULL, DWORD = 0, DWORD = 0, <a class="code" href="classWTL_1_1__U__MENUorID.html">_U_MENUorID</a> = 0U, LPVOID = NULL)
01915     {
01916         ATLASSERT(FALSE);
01917         <font class="keywordflow">return</font> NULL;
01918     }
01919 };
01920 
01922 <font class="comment">// CPropertySheetImpl - implements a property sheet</font>
01923 
01924 <font class="preprocessor">#if (_MSC_VER &gt;= 1200)</font>
01925 <font class="preprocessor"></font><font class="keyword">typedef</font> HPROPSHEETPAGE  <a class="code" href="namespaceWTL.html#a34">_HPROPSHEETPAGE_TYPE</a>;
01926 <font class="preprocessor">#else</font>
01927 <font class="preprocessor"></font><font class="comment">// we use void* here instead of HPROPSHEETPAGE becuase HPROPSHEETPAGE</font>
01928 <font class="comment">// is a _PSP*, but _PSP is not defined properly</font>
<a name="l01929"></a><a class="code" href="namespaceWTL.html#a34">01929</a> <font class="keyword">typedef</font> <font class="keywordtype">void</font>*   <a class="code" href="namespaceWTL.html#a34">_HPROPSHEETPAGE_TYPE</a>;
01930 <font class="preprocessor">#endif</font>
01931 <font class="preprocessor"></font>
01932 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keyword">class</font> TBase = CPropertySheetWindow&gt;
<a name="l01933"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html">01933</a> <font class="keyword">class </font>ATL_NO_VTABLE CPropertySheetImpl : <font class="keyword">public</font> <a class="code" href="classCWindowImplBaseT.html">CWindowImplBaseT</a>&lt; TBase &gt;
01934 {
01935 <font class="keyword">public</font>:
<a name="l01936"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#m0">01936</a>     PROPSHEETHEADER m_psh;
<a name="l01937"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#m1">01937</a>     <a class="code" href="classCSimpleArray.html">CSimpleArray&lt;_HPROPSHEETPAGE_TYPE&gt;</a> m_arrPages;
01938 
01939 <font class="comment">// Construction/Destruction</font>
<a name="l01940"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a0">01940</a>     CPropertySheetImpl(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title = (LPCTSTR)NULL, UINT uStartPage = 0, HWND hWndParent = NULL)
01941     {
01942         memset(&amp;m_psh, 0, <font class="keyword">sizeof</font>(PROPSHEETHEADER));
01943         m_psh.dwSize = <font class="keyword">sizeof</font>(PROPSHEETHEADER);
01944         m_psh.dwFlags = PSH_USECALLBACK;
01945         m_psh.hInstance = _Module.GetResourceInstance();
01946         m_psh.phpage = NULL;    <font class="comment">// will be set later</font>
01947         m_psh.nPages = 0;   <font class="comment">// will be set later</font>
01948         m_psh.pszCaption = title.m_lpstr;
01949         m_psh.nStartPage = uStartPage;
01950         m_psh.hwndParent = hWndParent;  <font class="comment">// if NULL, will be set in DoModal/Create</font>
01951         m_psh.pfnCallback = T::PropSheetCallback;
01952     }
01953 
<a name="l01954"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a1">01954</a>     ~CPropertySheetImpl()
01955     {
01956         <font class="keywordflow">if</font>(m_arrPages.GetSize() &gt; 0)    <font class="comment">// sheet never created, destroy all pages</font>
01957         {
01958             <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; m_arrPages.GetSize(); i++)
01959                 ::DestroyPropertySheetPage((HPROPSHEETPAGE)m_arrPages[i]);
01960         }
01961     }
01962 
<a name="l01963"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#d0">01963</a>     <font class="keyword">static</font> <font class="keywordtype">int</font> CALLBACK PropSheetCallback(HWND hWnd, UINT uMsg, LPARAM)
01964     {
01965         <font class="keywordflow">if</font>(uMsg == PSCB_INITIALIZED)
01966         {
01967             ATLASSERT(hWnd != NULL);
01968             T* pT = (T*)_Module.ExtractCreateWndData();
01969             <font class="comment">// subclass the sheet window</font>
01970             pT-&gt;SubclassWindow(hWnd);
01971             <font class="comment">// remove page handles array</font>
01972             pT-&gt;_CleanUpPages();
01973         }
01974 
01975         <font class="keywordflow">return</font> 0;
01976     }
01977 
<a name="l01978"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a2">01978</a>     HWND Create(HWND hWndParent = NULL)
01979     {
01980         ATLASSERT(m_hWnd == NULL);
01981 
01982         m_psh.dwFlags |= PSH_MODELESS;
01983         <font class="keywordflow">if</font>(m_psh.hwndParent == NULL)
01984             m_psh.hwndParent = hWndParent;
01985         m_psh.phpage = (HPROPSHEETPAGE*)m_arrPages.GetData();
01986         m_psh.nPages = m_arrPages.GetSize();
01987 
01988         T* pT = static_cast&lt;T*&gt;(this);
01989         _Module.AddCreateWndData(&amp;m_thunk.cd, pT);
01990 
01991         HWND hWnd = (HWND)::PropertySheet(&amp;m_psh);
01992         _CleanUpPages();    <font class="comment">// ensure clean-up, required if call failed</font>
01993 
01994         ATLASSERT(m_hWnd == hWnd);
01995 
01996         <font class="keywordflow">return</font> hWnd;
01997     }
01998 
<a name="l01999"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a3">01999</a>     INT_PTR DoModal(HWND hWndParent = ::GetActiveWindow())
02000     {
02001         ATLASSERT(m_hWnd == NULL);
02002 
02003         m_psh.dwFlags &amp;= ~PSH_MODELESS;
02004         <font class="keywordflow">if</font>(m_psh.hwndParent == NULL)
02005             m_psh.hwndParent = hWndParent;
02006         m_psh.phpage = (HPROPSHEETPAGE*)m_arrPages.GetData();
02007         m_psh.nPages = m_arrPages.GetSize();
02008 
02009         T* pT = static_cast&lt;T*&gt;(this);
02010         _Module.AddCreateWndData(&amp;m_thunk.cd, pT);
02011 
02012         INT_PTR nRet = ::PropertySheet(&amp;m_psh);
02013         _CleanUpPages();    <font class="comment">// ensure clean-up, required if call failed</font>
02014 
02015         <font class="keywordflow">return</font> nRet;
02016     }
02017 
02018     <font class="comment">// implementation helper - clean up pages array</font>
<a name="l02019"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a4">02019</a>     <font class="keywordtype">void</font> _CleanUpPages()
02020     {
02021         m_psh.nPages = 0;
02022         m_psh.phpage = NULL;
02023         m_arrPages.RemoveAll();
02024     }
02025 
02026 <font class="comment">// Attributes (extended overrides of client class methods)</font>
02027 <font class="comment">// These now can be called before the sheet is created</font>
02028 <font class="comment">// Note: Calling these after the sheet is created gives unpredictable results</font>
<a name="l02029"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a5">02029</a>     <font class="keywordtype">int</font> GetPageCount()<font class="keyword"> const</font>
02030 <font class="keyword">    </font>{
02031         <font class="keywordflow">if</font>(m_hWnd == NULL)  <font class="comment">// not created yet</font>
02032             <font class="keywordflow">return</font> m_arrPages.GetSize();
02033         <font class="keywordflow">return</font> TBase::GetPageCount();
02034     }
<a name="l02035"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a6">02035</a>     <font class="keywordtype">int</font> GetActiveIndex()<font class="keyword"> const</font>
02036 <font class="keyword">    </font>{
02037         <font class="keywordflow">if</font>(m_hWnd == NULL)  <font class="comment">// not created yet</font>
02038             <font class="keywordflow">return</font> m_psh.nStartPage;
02039         <font class="keywordflow">return</font> TBase::GetActiveIndex();
02040     }
<a name="l02041"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a7">02041</a>     HPROPSHEETPAGE GetPage(<font class="keywordtype">int</font> nPageIndex)<font class="keyword"> const</font>
02042 <font class="keyword">    </font>{
02043         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02044         <font class="keywordflow">return</font> (HPROPSHEETPAGE)m_arrPages[nPageIndex];
02045     }
<a name="l02046"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a8">02046</a>     <font class="keywordtype">int</font> GetPageIndex(HPROPSHEETPAGE hPage)<font class="keyword"> const</font>
02047 <font class="keyword">    </font>{
02048         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02049         <font class="keywordflow">return</font> m_arrPages.Find((<a class="code" href="namespaceWTL.html#a34">_HPROPSHEETPAGE_TYPE</a>&amp;)hPage);
02050     }
<a name="l02051"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a9">02051</a>     BOOL SetActivePage(<font class="keywordtype">int</font> nPageIndex)
02052     {
02053         <font class="keywordflow">if</font>(m_hWnd == NULL)  <font class="comment">// not created yet</font>
02054         {
02055             ATLASSERT(nPageIndex &gt;= 0 &amp;&amp; nPageIndex &lt; m_arrPages.GetSize());
02056             m_psh.nStartPage = nPageIndex;
02057             <font class="keywordflow">return</font> TRUE;
02058         }
02059         <font class="keywordflow">return</font> TBase::SetActivePage(nPageIndex);
02060     }
<a name="l02061"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a10">02061</a>     BOOL SetActivePage(HPROPSHEETPAGE hPage)
02062     {
02063         ATLASSERT(hPage != NULL);
02064         <font class="keywordflow">if</font> (m_hWnd == NULL) <font class="comment">// not created yet</font>
02065         {
02066             <font class="keywordtype">int</font> nPageIndex = GetPageIndex(hPage);
02067             <font class="keywordflow">if</font>(nPageIndex == -1)
02068                 <font class="keywordflow">return</font> FALSE;
02069 
02070             <font class="keywordflow">return</font> SetActivePage(nPageIndex);
02071         }
02072         <font class="keywordflow">return</font> TBase::SetActivePage(hPage);
02073 
02074     }
<a name="l02075"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a11">02075</a>     <font class="keywordtype">void</font> SetTitle(LPCTSTR lpszText, UINT nStyle = 0)
02076     {
02077         ATLASSERT((nStyle &amp; ~PSH_PROPTITLE) == 0); <font class="comment">// only PSH_PROPTITLE is valid</font>
02078         ATLASSERT(lpszText != NULL);
02079 
02080         <font class="keywordflow">if</font>(m_hWnd == NULL)
02081         {
02082             <font class="comment">// set internal state</font>
02083             m_psh.pszCaption = lpszText;    <font class="comment">// must exist until sheet is created</font>
02084             m_psh.dwFlags &amp;= ~PSH_PROPTITLE;
02085             m_psh.dwFlags |= nStyle;
02086         }
02087         <font class="keywordflow">else</font>
02088         {
02089             <font class="comment">// set external state</font>
02090             TBase::SetTitle(lpszText, nStyle);
02091         }
02092     }
<a name="l02093"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a12">02093</a>     <font class="keywordtype">void</font> SetWizardMode()
02094     {
02095         m_psh.dwFlags |= PSH_WIZARD;
02096     }
<a name="l02097"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a13">02097</a>     <font class="keywordtype">void</font> EnableHelp()
02098     {
02099         m_psh.dwFlags |= PSH_HASHELP;
02100     }
02101 
02102 <font class="comment">// Operations</font>
<a name="l02103"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a14">02103</a>     BOOL AddPage(HPROPSHEETPAGE hPage)
02104     {
02105         ATLASSERT(hPage != NULL);
02106         BOOL bRet = TRUE;
02107         <font class="keywordflow">if</font>(m_hWnd != NULL)
02108             TBase::AddPage(hPage);
02109         <font class="keywordflow">else</font>    <font class="comment">// sheet not created yet, use internal data</font>
02110             bRet = m_arrPages.Add((<a class="code" href="namespaceWTL.html#a34">_HPROPSHEETPAGE_TYPE</a>&amp;)hPage);
02111         <font class="keywordflow">return</font> bRet;
02112     }
<a name="l02113"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a15">02113</a>     BOOL AddPage(LPCPROPSHEETPAGE pPage)
02114     {
02115         ATLASSERT(pPage != NULL);
02116         HPROPSHEETPAGE hPage = ::CreatePropertySheetPage(pPage);
02117         <font class="keywordflow">if</font>(hPage == NULL)
02118             <font class="keywordflow">return</font> FALSE;
02119         BOOL bRet = AddPage(hPage);
02120         <font class="keywordflow">if</font>(!bRet)
02121             ::DestroyPropertySheetPage(hPage);
02122         <font class="keywordflow">return</font> bRet;
02123     }
<a name="l02124"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a16">02124</a>     BOOL RemovePage(HPROPSHEETPAGE hPage)
02125     {
02126         ATLASSERT(hPage != NULL);
02127         <font class="keywordflow">if</font> (m_hWnd == NULL)     <font class="comment">// not created yet</font>
02128         {
02129             <font class="keywordtype">int</font> nPage = GetPageIndex(hPage);
02130             <font class="keywordflow">if</font>(nPage == -1)
02131                 <font class="keywordflow">return</font> FALSE;
02132             <font class="keywordflow">return</font> RemovePage(nPage);
02133         }
02134         TBase::RemovePage(hPage);
02135         <font class="keywordflow">return</font> TRUE;
02136 
02137     }
<a name="l02138"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a17">02138</a>     BOOL RemovePage(<font class="keywordtype">int</font> nPageIndex)
02139     {
02140         BOOL bRet = TRUE;
02141         <font class="keywordflow">if</font>(m_hWnd != NULL)
02142             TBase::RemovePage(nPageIndex);
02143         <font class="keywordflow">else</font>    <font class="comment">// sheet not created yet, use internal data</font>
02144             bRet = m_arrPages.RemoveAt(nPageIndex);
02145         <font class="keywordflow">return</font> bRet;
02146     }
02147 
02148 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0400)</font>
<a name="l02149"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a18">02149</a> <font class="preprocessor"></font>    <font class="keywordtype">void</font> SetHeader(LPCTSTR szbmHeader)
02150     {
02151         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02152 
02153         m_psh.dwFlags &amp;= ~PSH_WIZARD;
02154         m_psh.dwFlags |= (PSH_HEADER | PSH_WIZARD97);
02155         m_psh.pszbmHeader = szbmHeader;
02156     }
02157 
<a name="l02158"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a19">02158</a>     <font class="keywordtype">void</font> SetHeader(HBITMAP hbmHeader)
02159     {
02160         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02161 
02162         m_psh.dwFlags &amp;= ~PSH_WIZARD;
02163         m_psh.dwFlags |= (PSH_HEADER | PSH_USEHBMHEADER | PSH_WIZARD97);
02164         m_psh.hbmHeader = hbmHeader;
02165     }
02166 
<a name="l02167"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a20">02167</a>     <font class="keywordtype">void</font> SetWatermark(LPCTSTR szbmWatermark, HPALETTE hplWatermark = NULL)
02168     {
02169         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02170 
02171         m_psh.dwFlags &amp;= ~PSH_WIZARD;
02172         m_psh.dwFlags |= PSH_WATERMARK | PSH_WIZARD97;
02173         m_psh.pszbmWatermark = szbmWatermark;
02174 
02175         <font class="keywordflow">if</font> (hplWatermark != NULL)
02176         {
02177             m_psh.dwFlags |= PSH_USEHPLWATERMARK;
02178             m_psh.hplWatermark = hplWatermark;
02179         }
02180     }
02181 
<a name="l02182"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a21">02182</a>     <font class="keywordtype">void</font> SetWatermark(HBITMAP hbmWatermark, HPALETTE hplWatermark = NULL)
02183     {
02184         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02185 
02186         m_psh.dwFlags &amp;= ~PSH_WIZARD;
02187         m_psh.dwFlags |= (PSH_WATERMARK | PSH_USEHBMWATERMARK | PSH_WIZARD97);
02188         m_psh.hbmWatermark = hbmWatermark;
02189 
02190         <font class="keywordflow">if</font> (hplWatermark != NULL)
02191         {
02192             m_psh.dwFlags |= PSH_USEHPLWATERMARK;
02193             m_psh.hplWatermark = hplWatermark;
02194         }
02195     }
02196 
<a name="l02197"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a22">02197</a>     <font class="keywordtype">void</font> StretchWatermark(<font class="keywordtype">bool</font> bStretchWatermark)
02198     {
02199         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02200         <font class="keywordflow">if</font> (bStretchWatermark)
02201             m_psh.dwFlags |= PSH_STRETCHWATERMARK;
02202         <font class="keywordflow">else</font>
02203             m_psh.dwFlags &amp;= ~PSH_STRETCHWATERMARK;
02204     }
02205 <font class="preprocessor">#endif</font>
02206 <font class="preprocessor"></font>
02207 <font class="comment">// Message map and handlers</font>
02208     BEGIN_MSG_MAP(CPropertySheetImpl)
02209         MESSAGE_HANDLER(WM_COMMAND, OnCommand)
02210         MESSAGE_HANDLER(WM_SYSCOMMAND, OnSysCommand)
02211     END_MSG_MAP()
02212 
<a name="l02213"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a23">02213</a>     LRESULT OnCommand(UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; <font class="comment">/*bHandled*/</font>)
02214     {
02215         LRESULT lRet = DefWindowProc(uMsg, wParam, lParam);
02216         <font class="keywordflow">if</font>(HIWORD(wParam) == BN_CLICKED &amp;&amp; (LOWORD(wParam) == IDOK || LOWORD(wParam) == IDCANCEL) &amp;&amp;
02217            ((m_psh.dwFlags &amp; PSH_MODELESS) != 0) &amp;&amp; (GetActivePage() == NULL))
02218             DestroyWindow();
02219         <font class="keywordflow">return</font> lRet;
02220     }
02221 
<a name="l02222"></a><a class="code" href="classWTL_1_1CPropertySheetImpl.html#a24">02222</a>     LRESULT OnSysCommand(UINT <font class="comment">/*uMsg*/</font>, WPARAM wParam, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; bHandled)
02223     {
02224         <font class="keywordflow">if</font>(((m_psh.dwFlags &amp; PSH_MODELESS) == PSH_MODELESS) &amp;&amp; ((wParam &amp; 0xFFF0) == SC_CLOSE))
02225             SendMessage(WM_CLOSE);
02226         <font class="keywordflow">else</font>
02227             bHandled = FALSE;
02228         <font class="keywordflow">return</font> 0;
02229     }
02230 };
02231 
02232 <font class="comment">// for non-customized sheets</font>
<a name="l02233"></a><a class="code" href="classWTL_1_1CPropertySheet.html">02233</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPropertySheet.html">CPropertySheet</a> : <font class="keyword">public</font> CPropertySheetImpl&lt;CPropertySheet&gt;
02234 {
02235 <font class="keyword">public</font>:
<a name="l02236"></a><a class="code" href="classWTL_1_1CPropertySheet.html#a0">02236</a>     <a class="code" href="classWTL_1_1CPropertySheet.html#a0">CPropertySheet</a>(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title = (LPCTSTR)NULL, UINT uStartPage = 0, HWND hWndParent = NULL)
02237         : CPropertySheetImpl&lt;<a class="code" href="classWTL_1_1CPropertySheet.html">CPropertySheet</a>&gt;(title, uStartPage, hWndParent)
02238     { }
02239 
02240     BEGIN_MSG_MAP(<a class="code" href="classWTL_1_1CPropertySheet.html#a0">CPropertySheet</a>)
02241         MESSAGE_HANDLER(WM_COMMAND, CPropertySheetImpl&lt;CPropertySheet&gt;::<a class="code" href="classWTL_1_1CPropertySheetImpl.html#a23">OnCommand</a>)
02242     END_MSG_MAP()
02243 };
02244 
02245 
02247 <font class="comment">// CPropertyPageWindow - client side for a property page</font>
02248 
<a name="l02249"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html">02249</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPropertyPageWindow.html">CPropertyPageWindow</a> : <font class="keyword">public</font> <a class="code" href="classCWindow.html">CWindow</a>
02250 {
02251 <font class="keyword">public</font>:
02252 <font class="comment">// Constructors</font>
<a name="l02253"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a0">02253</a>     <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a0">CPropertyPageWindow</a>(HWND hWnd = NULL) : <a class="code" href="classCWindow.html">CWindow</a>(hWnd) { }
02254 
<a name="l02255"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a1">02255</a>     <a class="code" href="classWTL_1_1CPropertyPageWindow.html">CPropertyPageWindow</a>&amp; <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a1">operator=</a>(HWND hWnd)
02256     {
02257         m_hWnd = hWnd;
02258         <font class="keywordflow">return</font> *<font class="keyword">this</font>;
02259     }
02260 
02261 <font class="comment">// Attributes</font>
<a name="l02262"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">02262</a>     <a class="code" href="classWTL_1_1CPropertySheetWindow.html">CPropertySheetWindow</a> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>()<font class="keyword"> const</font>
02263 <font class="keyword">    </font>{
02264         ATLASSERT(::IsWindow(m_hWnd));
02265         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPropertySheetWindow.html">CPropertySheetWindow</a>(GetParent());
02266     }
02267 
02268 <font class="comment">// Operations</font>
<a name="l02269"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a3">02269</a>     BOOL <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a3">Apply</a>()
02270     {
02271         ATLASSERT(::IsWindow(m_hWnd));
02272         ATLASSERT(GetParent() != NULL);
02273         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a17">Apply</a>();
02274     }
<a name="l02275"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a4">02275</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a4">CancelToClose</a>()
02276     {
02277         ATLASSERT(::IsWindow(m_hWnd));
02278         ATLASSERT(GetParent() != NULL);
02279         <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a18">CancelToClose</a>();
02280     }
<a name="l02281"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a5">02281</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a5">SetModified</a>(BOOL bChanged = TRUE)
02282     {
02283         ATLASSERT(::IsWindow(m_hWnd));
02284         ATLASSERT(GetParent() != NULL);
02285         <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a19">SetModified</a>(m_hWnd, bChanged);
02286     }
<a name="l02287"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a6">02287</a>     LRESULT <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a6">QuerySiblings</a>(WPARAM wParam, LPARAM lParam)
02288     {
02289         ATLASSERT(::IsWindow(m_hWnd));
02290         ATLASSERT(GetParent() != NULL);
02291         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a20">QuerySiblings</a>(wParam, lParam);
02292     }
<a name="l02293"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a7">02293</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a7">RebootSystem</a>()
02294     {
02295         ATLASSERT(::IsWindow(m_hWnd));
02296         ATLASSERT(GetParent() != NULL);
02297         <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a21">RebootSystem</a>();
02298     }
<a name="l02299"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a8">02299</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a8">RestartWindows</a>()
02300     {
02301         ATLASSERT(::IsWindow(m_hWnd));
02302         ATLASSERT(GetParent() != NULL);
02303         <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a22">RestartWindows</a>();
02304     }
<a name="l02305"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a9">02305</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a9">SetWizardButtons</a>(DWORD dwFlags)
02306     {
02307         ATLASSERT(::IsWindow(m_hWnd));
02308         ATLASSERT(GetParent() != NULL);
02309         <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a2">GetPropertySheet</a>().<a class="code" href="classWTL_1_1CPropertySheetWindow.html#a11">SetWizardButtons</a>(dwFlags);
02310     }
02311 
02312 <font class="comment">// Implementation - overrides to prevent usage</font>
<a name="l02313"></a><a class="code" href="classWTL_1_1CPropertyPageWindow.html#a10">02313</a>     HWND <a class="code" href="classWTL_1_1CPropertyPageWindow.html#a10">Create</a>(LPCTSTR, HWND, <a class="code" href="classWTL_1_1__U__RECT.html">_U_RECT</a> = NULL, LPCTSTR = NULL, DWORD = 0, DWORD = 0, <a class="code" href="classWTL_1_1__U__MENUorID.html">_U_MENUorID</a> = 0U, LPVOID = NULL)
02314     {
02315         ATLASSERT(FALSE);
02316         <font class="keywordflow">return</font> NULL;
02317     }
02318 };
02319 
02321 <font class="comment">// CPropertyPageImpl - implements a property page</font>
02322 
02323 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keyword">class</font> TBase = CPropertyPageWindow&gt;
<a name="l02324"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html">02324</a> <font class="keyword">class </font>ATL_NO_VTABLE CPropertyPageImpl : <font class="keyword">public</font> <a class="code" href="classCDialogImplBaseT.html">CDialogImplBaseT</a>&lt; TBase &gt;
02325 {
02326 <font class="keyword">public</font>:
<a name="l02327"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#m0">02327</a>     PROPSHEETPAGE m_psp;
02328 
<a name="l02329"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a0">02329</a>     operator PROPSHEETPAGE*() { <font class="keywordflow">return</font> &amp;m_psp; }
02330 
02331 <font class="comment">// Construction</font>
<a name="l02332"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a1">02332</a>     CPropertyPageImpl(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title = (LPCTSTR)NULL)
02333     {
02334         <font class="comment">// initialize PROPSHEETPAGE struct</font>
02335         memset(&amp;m_psp, 0, <font class="keyword">sizeof</font>(PROPSHEETPAGE));
02336         m_psp.dwSize = <font class="keyword">sizeof</font>(PROPSHEETPAGE);
02337         m_psp.dwFlags = PSP_USECALLBACK;
02338         m_psp.hInstance = _Module.GetResourceInstance();
02339         T* pT = static_cast&lt;T*&gt;(this);
02340         m_psp.pszTemplate = MAKEINTRESOURCE(pT-&gt;IDD);
02341         m_psp.pfnDlgProc = (DLGPROC)T::StartDialogProc;
02342         m_psp.pfnCallback = T::PropPageCallback;
02343         m_psp.lParam = (LPARAM)pT;
02344 
02345         <font class="keywordflow">if</font>(title.m_lpstr != NULL)
02346             SetTitle(title);
02347     }
02348 
<a name="l02349"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#d0">02349</a>     <font class="keyword">static</font> UINT CALLBACK PropPageCallback(HWND hWnd, UINT uMsg, LPPROPSHEETPAGE ppsp)
02350     {
02351         hWnd;   <font class="comment">// avoid level 4 warning</font>
02352         <font class="keywordflow">if</font>(uMsg == PSPCB_CREATE)
02353         {
02354             ATLASSERT(hWnd == NULL);
02355             <a class="code" href="classCDialogImplBaseT.html">CDialogImplBaseT&lt; TBase &gt;</a>* pPage = (<a class="code" href="classCDialogImplBaseT.html">CDialogImplBaseT&lt; TBase &gt;</a>*)(T*)ppsp-&gt;lParam;
02356             _Module.AddCreateWndData(&amp;pPage-&gt;m_thunk.cd, pPage);
02357         }
02358 
02359         <font class="keywordflow">return</font> 1;
02360     }
02361 
<a name="l02362"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a2">02362</a>     HPROPSHEETPAGE Create()
02363     {
02364         return ::CreatePropertySheetPage(&amp;m_psp);
02365     }
02366 
02367 <font class="comment">// Attributes</font>
<a name="l02368"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a3">02368</a>     <font class="keywordtype">void</font> SetTitle(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title)
02369     {
02370         m_psp.pszTitle = title.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>;
02371         m_psp.dwFlags |= PSP_USETITLE;
02372     }
02373 
02374 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
<a name="l02375"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a4">02375</a> <font class="preprocessor"></font>    <font class="keywordtype">void</font> SetHeaderTitle(LPCTSTR lpstrHeaderTitle)
02376     {
02377         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02378         m_psp.dwFlags |= PSP_USEHEADERTITLE;
02379         m_psp.pszHeaderTitle = lpstrHeaderTitle;
02380     }
<a name="l02381"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a5">02381</a>     <font class="keywordtype">void</font> SetHeaderSubTitle(LPCTSTR lpstrHeaderSubTitle)
02382     {
02383         ATLASSERT(m_hWnd == NULL);  <font class="comment">// can't do this after it's created</font>
02384         m_psp.dwFlags |= PSP_USEHEADERSUBTITLE;
02385         m_psp.pszHeaderSubTitle = lpstrHeaderSubTitle;
02386     }
02387 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02388 <font class="preprocessor"></font>
02389 <font class="comment">// Operations</font>
<a name="l02390"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a6">02390</a>     <font class="keywordtype">void</font> EnableHelp()
02391     {
02392         m_psp.dwFlags |= PSP_HASHELP;
02393     }
02394 
02395 <font class="comment">// Message map and handlers</font>
02396     BEGIN_MSG_MAP(CPropertyPageImpl)
02397         MESSAGE_HANDLER(WM_NOTIFY, OnNotify)
02398     END_MSG_MAP()
02399 
02400     <font class="comment">// NOTE: Define _WTL_NEW_PAGE_NOTIFY_HANDLERS to use new notification</font>
02401     <font class="comment">// handlers that return direct values without any restrictions</font>
<a name="l02402"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a7">02402</a>     LRESULT OnNotify(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM lParam, BOOL&amp; bHandled)
02403     {
02404         ATLASSERT(::IsWindow(m_hWnd));
02405         NMHDR* pNMHDR = (NMHDR*)lParam;
02406 
02407         <font class="comment">// don't handle messages not from the page/sheet itself</font>
02408         <font class="keywordflow">if</font>(pNMHDR-&gt;hwndFrom != m_hWnd &amp;&amp; pNMHDR-&gt;hwndFrom != ::GetParent(m_hWnd))
02409         {
02410             bHandled = FALSE;
02411             <font class="keywordflow">return</font> 1;
02412         }
02413 
02414         T* pT = static_cast&lt;T*&gt;(this);
02415         LRESULT lResult = 0;
02416         <font class="keywordflow">switch</font>(pNMHDR-&gt;code)
02417         {
02418 <font class="preprocessor">#ifdef _WTL_NEW_PAGE_NOTIFY_HANDLERS</font>
02419 <font class="preprocessor"></font>        <font class="keywordflow">case</font> PSN_SETACTIVE:
02420             lResult = pT-&gt;OnSetActive();
02421             <font class="keywordflow">break</font>;
02422         <font class="keywordflow">case</font> PSN_KILLACTIVE:
02423             lResult = pT-&gt;OnKillActive();
02424             <font class="keywordflow">break</font>;
02425         <font class="keywordflow">case</font> PSN_APPLY:
02426             lResult = pT-&gt;OnApply();
02427             <font class="keywordflow">break</font>;
02428         <font class="keywordflow">case</font> PSN_RESET:
02429             pT-&gt;OnReset();
02430             <font class="keywordflow">break</font>;
02431         <font class="keywordflow">case</font> PSN_QUERYCANCEL:
02432             lResult = pT-&gt;OnQueryCancel();
02433             <font class="keywordflow">break</font>;
02434         <font class="keywordflow">case</font> PSN_WIZNEXT:
02435             lResult = pT-&gt;OnWizardNext();
02436             <font class="keywordflow">break</font>;
02437         <font class="keywordflow">case</font> PSN_WIZBACK:
02438             lResult = pT-&gt;OnWizardBack();
02439             <font class="keywordflow">break</font>;
02440         <font class="keywordflow">case</font> PSN_WIZFINISH:
02441             lResult = pT-&gt;OnWizardFinish();
02442             <font class="keywordflow">break</font>;
02443         <font class="keywordflow">case</font> PSN_HELP:
02444             pT-&gt;OnHelp();
02445             <font class="keywordflow">break</font>;
02446 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0400)</font>
02447 <font class="preprocessor"></font>        <font class="keywordflow">case</font> PSN_GETOBJECT:
02448             <font class="keywordflow">if</font>(!pT-&gt;OnGetObject((LPNMOBJECTNOTIFY)lParam))
02449                 bHandled = FALSE;
02450             <font class="keywordflow">break</font>;
02451 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0400)</font>
02452 <font class="preprocessor"></font><font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02453 <font class="preprocessor"></font>        <font class="keywordflow">case</font> PSN_TRANSLATEACCELERATOR:
02454             {
02455                 LPPSHNOTIFY lpPSHNotify = (LPPSHNOTIFY)lParam;
02456                 lResult = pT-&gt;OnTranslateAccelerator((LPMSG)lpPSHNotify-&gt;lParam);
02457             }
02458             <font class="keywordflow">break</font>;
02459         <font class="keywordflow">case</font> PSN_QUERYINITIALFOCUS:
02460             {
02461                 LPPSHNOTIFY lpPSHNotify = (LPPSHNOTIFY)lParam;
02462                 lResult = (LRESULT)pT-&gt;OnQueryInitialFocus((HWND)lpPSHNotify-&gt;lParam);
02463             }
02464             <font class="keywordflow">break</font>;
02465 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02466 <font class="preprocessor"></font>
02467 <font class="preprocessor">#else </font>
02468 <font class="preprocessor">        case PSN_SETACTIVE:</font>
02469 <font class="preprocessor"></font>            lResult = pT-&gt;OnSetActive() ? 0 : -1;
02470             <font class="keywordflow">break</font>;
02471         <font class="keywordflow">case</font> PSN_KILLACTIVE:
02472             lResult = !pT-&gt;OnKillActive();
02473             <font class="keywordflow">break</font>;
02474         <font class="keywordflow">case</font> PSN_APPLY:
02475             lResult = pT-&gt;OnApply() ? PSNRET_NOERROR : PSNRET_INVALID_NOCHANGEPAGE;
02476             <font class="keywordflow">break</font>;
02477         <font class="keywordflow">case</font> PSN_RESET:
02478             pT-&gt;OnReset();
02479             <font class="keywordflow">break</font>;
02480         <font class="keywordflow">case</font> PSN_QUERYCANCEL:
02481             lResult = !pT-&gt;OnQueryCancel();
02482             <font class="keywordflow">break</font>;
02483         <font class="keywordflow">case</font> PSN_WIZNEXT:
02484             lResult = pT-&gt;OnWizardNext();
02485             <font class="keywordflow">break</font>;
02486         <font class="keywordflow">case</font> PSN_WIZBACK:
02487             lResult = pT-&gt;OnWizardBack();
02488             <font class="keywordflow">break</font>;
02489         <font class="keywordflow">case</font> PSN_WIZFINISH:
02490             lResult = !pT-&gt;OnWizardFinish();
02491             <font class="keywordflow">break</font>;
02492         <font class="keywordflow">case</font> PSN_HELP:
02493             pT-&gt;OnHelp();
02494             <font class="keywordflow">break</font>;
02495 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0400)</font>
02496 <font class="preprocessor"></font>        <font class="keywordflow">case</font> PSN_GETOBJECT:
02497             <font class="keywordflow">if</font>(!pT-&gt;OnGetObject((LPNMOBJECTNOTIFY)lParam))
02498                 bHandled = FALSE;
02499             <font class="keywordflow">break</font>;
02500 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0400)</font>
02501 <font class="preprocessor"></font><font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02502 <font class="preprocessor"></font>        <font class="keywordflow">case</font> PSN_TRANSLATEACCELERATOR:
02503             {
02504                 LPPSHNOTIFY lpPSHNotify = (LPPSHNOTIFY)lParam;
02505                 lResult = pT-&gt;OnTranslateAccelerator((LPMSG)lpPSHNotify-&gt;lParam) ? PSNRET_MESSAGEHANDLED : PSNRET_NOERROR;
02506             }
02507             <font class="keywordflow">break</font>;
02508         <font class="keywordflow">case</font> PSN_QUERYINITIALFOCUS:
02509             {
02510                 LPPSHNOTIFY lpPSHNotify = (LPPSHNOTIFY)lParam;
02511                 lResult = (LRESULT)pT-&gt;OnQueryInitialFocus((HWND)lpPSHNotify-&gt;lParam);
02512             }
02513             <font class="keywordflow">break</font>;
02514 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02515 <font class="preprocessor"></font>
02516 <font class="preprocessor">#endif </font>
02517 <font class="preprocessor">        default:</font>
02518 <font class="preprocessor"></font>            bHandled = FALSE;   <font class="comment">// not handled</font>
02519         }
02520 
02521         <font class="keywordflow">return</font> lResult;
02522     }
02523 
02524 <font class="comment">// Overridables</font>
02525     <font class="comment">// NOTE: Define _WTL_NEW_PAGE_NOTIFY_HANDLERS to use new notification</font>
02526     <font class="comment">// handlers that return direct values without any restrictions</font>
02527 <font class="preprocessor">#ifdef _WTL_NEW_PAGE_NOTIFY_HANDLERS</font>
02528 <font class="preprocessor"></font>    <font class="keywordtype">int</font> OnSetActive()
02529     {
02530         <font class="comment">// 0 = allow activate</font>
02531         <font class="comment">// -1 = go back that was active</font>
02532         <font class="comment">// page ID = jump to page</font>
02533         <font class="keywordflow">return</font> 0;
02534     }
02535     BOOL OnKillActive()
02536     {
02537         <font class="comment">// FALSE = allow deactivate</font>
02538         <font class="comment">// TRUE = prevent deactivation</font>
02539         <font class="keywordflow">return</font> FALSE;
02540     }
02541     <font class="keywordtype">int</font> OnApply()
02542     {
02543         <font class="comment">// PSNRET_NOERROR = apply OK</font>
02544         <font class="comment">// PSNRET_INVALID = apply not OK, return to this page</font>
02545         <font class="comment">// PSNRET_INVALID_NOCHANGEPAGE = apply not OK, don't change focus</font>
02546         <font class="keywordflow">return</font> PSNRET_NOERROR;
02547     }
02548     <font class="keywordtype">void</font> OnReset()
02549     {
02550     }
02551     BOOL OnQueryCancel()
02552     {
02553         <font class="comment">// FALSE = allow cancel</font>
02554         <font class="comment">// TRUE = prevent cancel</font>
02555         <font class="keywordflow">return</font> FALSE;
02556     }
02557     <font class="keywordtype">int</font> OnWizardBack()
02558     {
02559         <font class="comment">// 0  = goto previous page</font>
02560         <font class="comment">// -1 = prevent page change</font>
02561         <font class="comment">// &gt;0 = jump to page by dlg ID</font>
02562         <font class="keywordflow">return</font> 0;
02563     }
02564     <font class="keywordtype">int</font> OnWizardNext()
02565     {
02566         <font class="comment">// 0  = goto next page</font>
02567         <font class="comment">// -1 = prevent page change</font>
02568         <font class="comment">// &gt;0 = jump to page by dlg ID</font>
02569         <font class="keywordflow">return</font> 0;
02570     }
02571     INT_PTR OnWizardFinish()
02572     {
02573         <font class="comment">// FALSE = allow finish</font>
02574         <font class="comment">// TRUE = prevent finish</font>
02575         <font class="comment">// HWND = prevent finish and set focus to HWND (CommCtrl 5.80 only)</font>
02576         <font class="keywordflow">return</font> FALSE;
02577     }
02578     <font class="keywordtype">void</font> OnHelp()
02579     {
02580     }
02581 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0400)</font>
02582 <font class="preprocessor"></font>    BOOL OnGetObject(LPNMOBJECTNOTIFY <font class="comment">/*lpObjectNotify*/</font>)
02583     {
02584         <font class="keywordflow">return</font> FALSE;   <font class="comment">// not processed</font>
02585     }
02586 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0400)</font>
02587 <font class="preprocessor"></font><font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02588 <font class="preprocessor"></font>    <font class="keywordtype">int</font> OnTranslateAccelerator(LPMSG <font class="comment">/*lpMsg*/</font>)
02589     {
02590         <font class="comment">// PSNRET_NOERROR - message not handled</font>
02591         <font class="comment">// PSNRET_MESSAGEHANDLED - message handled</font>
02592         <font class="keywordflow">return</font> PSNRET_NOERROR;
02593     }
02594     HWND OnQueryInitialFocus(HWND <font class="comment">/*hWndFocus*/</font>)
02595     {
02596         <font class="comment">// NULL = set focus to default control</font>
02597         <font class="comment">// HWND = set focus to HWND</font>
02598         <font class="keywordflow">return</font> NULL;
02599     }
02600 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02601 <font class="preprocessor"></font>
02602 <font class="preprocessor">#else </font>
<a name="l02603"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a8">02603</a> <font class="preprocessor">    BOOL OnSetActive()</font>
02604 <font class="preprocessor"></font>    {
02605         <font class="keywordflow">return</font> TRUE;
02606     }
<a name="l02607"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a9">02607</a>     BOOL OnKillActive()
02608     {
02609         <font class="keywordflow">return</font> TRUE;
02610     }
<a name="l02611"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a10">02611</a>     BOOL OnApply()
02612     {
02613         <font class="keywordflow">return</font> TRUE;
02614     }
<a name="l02615"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a11">02615</a>     <font class="keywordtype">void</font> OnReset()
02616     {
02617     }
<a name="l02618"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a12">02618</a>     BOOL OnQueryCancel()
02619     {
02620         <font class="keywordflow">return</font> TRUE;    <font class="comment">// ok to cancel</font>
02621     }
<a name="l02622"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a13">02622</a>     <font class="keywordtype">int</font> OnWizardBack()
02623     {
02624         <font class="comment">// 0  = goto previous page</font>
02625         <font class="comment">// -1 = prevent page change</font>
02626         <font class="comment">// &gt;0 = jump to page by dlg ID</font>
02627         <font class="keywordflow">return</font> 0;
02628     }
<a name="l02629"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a14">02629</a>     <font class="keywordtype">int</font> OnWizardNext()
02630     {
02631         <font class="comment">// 0  = goto next page</font>
02632         <font class="comment">// -1 = prevent page change</font>
02633         <font class="comment">// &gt;0 = jump to page by dlg ID</font>
02634         <font class="keywordflow">return</font> 0;
02635     }
<a name="l02636"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a15">02636</a>     BOOL OnWizardFinish()
02637     {
02638         <font class="keywordflow">return</font> TRUE;
02639     }
<a name="l02640"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a16">02640</a>     <font class="keywordtype">void</font> OnHelp()
02641     {
02642     }
02643 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0400)</font>
<a name="l02644"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a17">02644</a> <font class="preprocessor"></font>    BOOL OnGetObject(LPNMOBJECTNOTIFY <font class="comment">/*lpObjectNotify*/</font>)
02645     {
02646         <font class="keywordflow">return</font> FALSE;   <font class="comment">// not processed</font>
02647     }
02648 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0400)</font>
02649 <font class="preprocessor"></font><font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
<a name="l02650"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a18">02650</a> <font class="preprocessor"></font>    BOOL OnTranslateAccelerator(LPMSG <font class="comment">/*lpMsg*/</font>)
02651     {
02652         <font class="keywordflow">return</font> FALSE;   <font class="comment">// not translated</font>
02653     }
<a name="l02654"></a><a class="code" href="classWTL_1_1CPropertyPageImpl.html#a19">02654</a>     HWND OnQueryInitialFocus(HWND <font class="comment">/*hWndFocus*/</font>)
02655     {
02656         <font class="keywordflow">return</font> NULL;    <font class="comment">// default</font>
02657     }
02658 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02659 <font class="preprocessor"></font>
02660 <font class="preprocessor">#endif </font>
02661 <font class="preprocessor">};</font>
02662 <font class="preprocessor"></font>
02663 <font class="comment">// for non-customized pages</font>
02664 <font class="keyword">template</font> &lt;WORD t_wDlgTemplateID&gt;
<a name="l02665"></a><a class="code" href="classWTL_1_1CPropertyPage.html">02665</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPropertyPage.html">CPropertyPage</a> : <font class="keyword">public</font> CPropertyPageImpl&lt;CPropertyPage&lt;t_wDlgTemplateID&gt; &gt;
02666 {
02667 <font class="keyword">public</font>:
02668     <font class="keyword">enum</font> { IDD = t_wDlgTemplateID };
02669 
<a name="l02670"></a><a class="code" href="classWTL_1_1CPropertyPage.html#a0">02670</a>     <a class="code" href="classWTL_1_1CPropertyPage.html">CPropertyPage</a>(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title = (LPCTSTR)NULL) : CPropertyPageImpl&lt;<a class="code" href="classWTL_1_1CPropertyPage.html">CPropertyPage</a>&gt;(title)
02671     { }
02672 
02673     DECLARE_EMPTY_MSG_MAP()
02674 };
02675 
02677 <font class="comment">// CAxPropertyPageImpl - property page that hosts ActiveX controls</font>
02678 
02679 <font class="preprocessor">#ifndef _ATL_NO_HOSTING</font>
02680 <font class="preprocessor"></font>
02681 <font class="comment">// Note: You must #include &lt;atlhost.h&gt; to use these classes</font>
02682 
02683 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keyword">class</font> TBase = CPropertyPageWindow&gt;
<a name="l02684"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html">02684</a> <font class="keyword">class </font>ATL_NO_VTABLE CAxPropertyPageImpl : <font class="keyword">public</font> CPropertyPageImpl&lt; T, TBase &gt;
02685 {
02686 <font class="keyword">public</font>:
02687 <font class="comment">// Data members</font>
<a name="l02688"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#m0">02688</a>     HGLOBAL m_hInitData;
<a name="l02689"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#m1">02689</a>     HGLOBAL m_hDlgRes;
<a name="l02690"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#m2">02690</a>     HGLOBAL m_hDlgResSplit;
02691 
02692 <font class="comment">// Constructor/destructor</font>
<a name="l02693"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#a0">02693</a>     CAxPropertyPageImpl(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title = (LPCTSTR)NULL) : 
02694             CPropertyPageImpl&lt; T, TBase &gt;(title),
02695             m_hInitData(NULL), m_hDlgRes(NULL), m_hDlgResSplit(NULL)
02696     {
02697         T* pT = static_cast&lt;T*&gt;(this);
02698         pT; <font class="comment">// avoid level 4 warning</font>
02699 
02700         <font class="comment">// initialize ActiveX hosting and modify dialog template</font>
02701         AtlAxWinInit();
02702 
02703         HINSTANCE hInstance = _Module.GetResourceInstance();
02704         LPCTSTR lpTemplateName = MAKEINTRESOURCE(pT-&gt;IDD);
02705         HRSRC hDlg = ::FindResource(hInstance, lpTemplateName, (LPTSTR)RT_DIALOG);
02706         <font class="keywordflow">if</font>(hDlg != NULL)
02707         {
02708             HRSRC hDlgInit = ::FindResource(hInstance, lpTemplateName, (LPTSTR)_ATL_RT_DLGINIT);
02709 
02710             BYTE* pInitData = NULL;
02711             <font class="keywordflow">if</font>(hDlgInit != NULL)
02712             {
02713                 m_hInitData = ::LoadResource(hInstance, hDlgInit);
02714                 pInitData = (BYTE*)::LockResource(m_hInitData);
02715             }
02716 
02717             m_hDlgRes = ::LoadResource(hInstance, hDlg);
02718             DLGTEMPLATE* pDlg = (DLGTEMPLATE*)::LockResource(m_hDlgRes);
02719             LPCDLGTEMPLATE lpDialogTemplate = _DialogSplitHelper::SplitDialogTemplate(pDlg, pInitData);
02720             <font class="keywordflow">if</font>(lpDialogTemplate != pDlg)
02721                 m_hDlgResSplit = ::GlobalHandle(lpDialogTemplate);
02722 
02723             <font class="comment">// set up property page to use in-memory dialog template</font>
02724             <font class="keywordflow">if</font>(lpDialogTemplate != NULL)
02725             {
02726                 m_psp.dwFlags |= PSP_DLGINDIRECT;
02727                 m_psp.pResource = lpDialogTemplate;
02728             }
02729             <font class="keywordflow">else</font>
02730             {
02731                 ATLASSERT(FALSE &amp;&amp; _T(<font class="stringliteral">"CAxPropertyPageImpl - ActiveX initializtion failed!"</font>));
02732             }
02733         }
02734         <font class="keywordflow">else</font>
02735         {
02736             ATLASSERT(FALSE &amp;&amp; _T(<font class="stringliteral">"CAxPropertyPageImpl - Cannot find dialog template!"</font>));
02737         }
02738     }
02739 
<a name="l02740"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#a1">02740</a>     ~CAxPropertyPageImpl()
02741     {
02742         <font class="keywordflow">if</font>(m_hInitData != NULL)
02743         {
02744             UnlockResource(m_hInitData);
02745             ::FreeResource(m_hInitData);
02746         }
02747         <font class="keywordflow">if</font>(m_hDlgRes != NULL)
02748         {
02749             UnlockResource(m_hDlgRes);
02750             ::FreeResource(m_hDlgRes);
02751         }
02752         <font class="keywordflow">if</font>(m_hDlgResSplit != NULL)
02753         {
02754             ::GlobalFree(m_hDlgResSplit);
02755         }
02756     }
02757 
02758 <font class="comment">// Methods</font>
02759     <font class="comment">// call this one to handle keyboard message for ActiveX controls</font>
<a name="l02760"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#a2">02760</a>     BOOL PreTranslateMessage(LPMSG pMsg)
02761     {
02762         <font class="keywordflow">if</font> ((pMsg-&gt;message &lt; WM_KEYFIRST || pMsg-&gt;message &gt; WM_KEYLAST) &amp;&amp;
02763            (pMsg-&gt;message &lt; WM_MOUSEFIRST || pMsg-&gt;message &gt; WM_MOUSELAST))
02764             <font class="keywordflow">return</font> FALSE;
02765         <font class="comment">// find a direct child of the dialog from the window that has focus</font>
02766         HWND hWndCtl = ::GetFocus();
02767         <font class="keywordflow">if</font> (IsChild(hWndCtl) &amp;&amp; ::GetParent(hWndCtl) != m_hWnd)
02768         {
02769             <font class="keywordflow">do</font>
02770             {
02771                 hWndCtl = ::GetParent(hWndCtl);
02772             }
02773             <font class="keywordflow">while</font> (::GetParent(hWndCtl) != m_hWnd);
02774         }
02775         <font class="comment">// give controls a chance to translate this message</font>
02776         <font class="keywordflow">return</font> (BOOL)::SendMessage(hWndCtl, WM_FORWARDMSG, 0, (LPARAM)pMsg);
02777     }
02778 
02779 <font class="comment">// Overridables</font>
02780 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02781 <font class="preprocessor"></font>    <font class="comment">// new default implementation for ActiveX hosting pages</font>
<a name="l02782"></a><a class="code" href="classWTL_1_1CAxPropertyPageImpl.html#a3">02782</a>     BOOL OnTranslateAccelerator(LPMSG lpMsg)
02783     {
02784         T* pT = static_cast&lt;T*&gt;(this);
02785         <font class="keywordflow">return</font> pT-&gt;PreTranslateMessage(lpMsg);
02786     }
02787 <font class="preprocessor">#endif //(_WIN32_IE &gt;= 0x0500)</font>
02788 <font class="preprocessor"></font>};
02789 
02790 <font class="comment">// for non-customized pages</font>
02791 <font class="keyword">template</font> &lt;WORD t_wDlgTemplateID&gt;
<a name="l02792"></a><a class="code" href="classWTL_1_1CAxPropertyPage.html">02792</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CAxPropertyPage.html">CAxPropertyPage</a> : <font class="keyword">public</font> CAxPropertyPageImpl&lt;CAxPropertyPage&lt;t_wDlgTemplateID&gt; &gt;
02793 {
02794 <font class="keyword">public</font>:
02795     <font class="keyword">enum</font> { IDD = t_wDlgTemplateID };
02796 
<a name="l02797"></a><a class="code" href="classWTL_1_1CAxPropertyPage.html#a0">02797</a>     <a class="code" href="classWTL_1_1CAxPropertyPage.html">CAxPropertyPage</a>(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> title = (LPCTSTR)NULL) : CAxPropertyPageImpl&lt;<a class="code" href="classWTL_1_1CAxPropertyPage.html">CAxPropertyPage</a>&gt;(title)
02798     { }
02799 
02800 <font class="preprocessor">#if (_WIN32_IE &gt;= 0x0500)</font>
02801 <font class="preprocessor"></font>    <font class="comment">// not empty so we handle accelerators</font>
02802     BEGIN_MSG_MAP(CAxPropertyPage)
02803         CHAIN_MSG_MAP(CAxPropertyPageImpl&lt;CAxPropertyPage&lt;t_wDlgTemplateID&gt; &gt;)
02804     END_MSG_MAP()
02805 <font class="preprocessor">#else </font>
02806 <font class="preprocessor">    DECLARE_EMPTY_MSG_MAP()</font>
02807 <font class="preprocessor"></font><font class="preprocessor">#endif </font>
02808 <font class="preprocessor">};</font>
02809 <font class="preprocessor"></font>
02810 <font class="preprocessor">#endif //_ATL_NO_HOSTING</font>
02811 <font class="preprocessor"></font>
02812 }; <font class="comment">//namespace WTL</font>
02813 
02814 <font class="preprocessor">#endif // __ATLDLGS_H__</font>
</pre></div><hr><address align="right"><small>Generated on Thu Apr 11 21:09:30 2002 for wtl-doc by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
