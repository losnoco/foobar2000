<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>atlapp.h Source File</title>
<link href="mystyles.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>atlapp.h</h1><a href="atlapp_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Windows Template Library - WTL version 7.0</font>
00002 <font class="comment">// Copyright (C) 1997-2002 Microsoft Corporation</font>
00003 <font class="comment">// All rights reserved.</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// This file is a part of the Windows Template Library.</font>
00006 <font class="comment">// The code and information is provided "as-is" without</font>
00007 <font class="comment">// warranty of any kind, either expressed or implied.</font>
00008 
00009 <font class="preprocessor">#ifndef __ATLAPP_H__</font>
00010 <font class="preprocessor"></font><font class="preprocessor">#define __ATLAPP_H__</font>
00011 <font class="preprocessor"></font>
00012 <font class="preprocessor">#pragma once</font>
00013 <font class="preprocessor"></font>
00014 <font class="preprocessor">#ifndef __cplusplus</font>
00015 <font class="preprocessor"></font><font class="preprocessor">    #error ATL requires C++ compilation (use a .cpp suffix)</font>
00016 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00017 <font class="preprocessor"></font>
00018 <font class="preprocessor">#ifndef __ATLBASE_H__</font>
00019 <font class="preprocessor"></font><font class="preprocessor">    #error atlapp.h requires atlbase.h to be included first</font>
00020 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00021 <font class="preprocessor"></font>
00022 <font class="preprocessor">#if (WINVER &lt; 0x0400)</font>
00023 <font class="preprocessor"></font><font class="preprocessor">    #error WTL requires Windows version 4.0 or higher</font>
00024 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00025 <font class="preprocessor"></font>
00026 <font class="preprocessor">#include &lt;limits.h&gt;</font>
00027 <font class="preprocessor">#if !defined(_ATL_MIN_CRT) &amp; defined(_MT)</font>
00028 <font class="preprocessor"></font><font class="preprocessor">#include &lt;process.h&gt;</font>    <font class="comment">// for _beginthreadex, _endthreadex</font>
00029 <font class="preprocessor">#endif</font>
00030 <font class="preprocessor"></font>
00031 <font class="preprocessor">#include &lt;commctrl.h&gt;</font>
00032 <font class="preprocessor">#pragma comment(lib, "comctl32.lib")</font>
00033 <font class="preprocessor"></font>
00034 <font class="preprocessor">#include &lt;<a class="code" href="atlres_8h.html">atlres.h</a>&gt;</font>
00035 
00036 <font class="preprocessor">#if (_WIN32_IE &lt; 0x0300)</font>
00037 <font class="preprocessor"></font><font class="preprocessor">    #error WTL requires IE version 3.0 or higher</font>
00038 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00039 <font class="preprocessor"></font>
00040 
00041 <font class="comment">// WTL version number</font>
<a name="l00042"></a><a class="code" href="atlapp_8h.html#a0">00042</a> <font class="preprocessor">#define _WTL_VER    0x0700</font>
00043 <font class="preprocessor"></font>
00044 
00046 <font class="comment">// Classes in this file</font>
00047 <font class="comment">//</font>
00048 <font class="comment">// CMessageFilter</font>
00049 <font class="comment">// CIdleHandler</font>
00050 <font class="comment">// CMessageLoop</font>
00051 <font class="comment">//</font>
00052 <font class="comment">// CAppModule</font>
00053 <font class="comment">// CServerAppModule</font>
00054 <font class="comment">//</font>
00055 <font class="comment">// _U_RECT</font>
00056 <font class="comment">// _U_MENUorID</font>
00057 <font class="comment">// _U_STRINGorID</font>
00058 
00059 
00060 <font class="comment">// This is to support using original VC++ 6.0 headers with WTL</font>
00061 <font class="preprocessor">#ifndef _ATL_NO_OLD_HEADERS_WIN64</font>
00062 <font class="preprocessor"></font><font class="preprocessor">#if !defined(_WIN64) &amp;&amp; (_ATL_VER &lt; 0x0700)</font>
00063 <font class="preprocessor"></font>
00064 <font class="preprocessor">  #ifndef GetWindowLongPtr</font>
<a name="l00065"></a><a class="code" href="atlapp_8h.html#a1">00065</a> <font class="preprocessor"></font><font class="preprocessor">    #define GetWindowLongPtrA   GetWindowLongA</font>
<a name="l00066"></a><a class="code" href="atlapp_8h.html#a2">00066</a> <font class="preprocessor"></font><font class="preprocessor">    #define GetWindowLongPtrW   GetWindowLongW</font>
00067 <font class="preprocessor"></font><font class="preprocessor">    #ifdef UNICODE</font>
00068 <font class="preprocessor"></font><font class="preprocessor">      #define GetWindowLongPtr  GetWindowLongPtrW</font>
00069 <font class="preprocessor"></font><font class="preprocessor">    #else</font>
<a name="l00070"></a><a class="code" href="atlapp_8h.html#a3">00070</a> <font class="preprocessor"></font><font class="preprocessor">      #define GetWindowLongPtr  GetWindowLongPtrA</font>
00071 <font class="preprocessor"></font><font class="preprocessor">    #endif // !UNICODE</font>
00072 <font class="preprocessor"></font><font class="preprocessor">  #endif // !GetWindowLongPtr</font>
00073 <font class="preprocessor"></font>
00074 <font class="preprocessor">  #ifndef SetWindowLongPtr</font>
<a name="l00075"></a><a class="code" href="atlapp_8h.html#a4">00075</a> <font class="preprocessor"></font><font class="preprocessor">    #define SetWindowLongPtrA   SetWindowLongA</font>
<a name="l00076"></a><a class="code" href="atlapp_8h.html#a5">00076</a> <font class="preprocessor"></font><font class="preprocessor">    #define SetWindowLongPtrW   SetWindowLongW</font>
00077 <font class="preprocessor"></font><font class="preprocessor">    #ifdef UNICODE</font>
00078 <font class="preprocessor"></font><font class="preprocessor">      #define SetWindowLongPtr  SetWindowLongPtrW</font>
00079 <font class="preprocessor"></font><font class="preprocessor">    #else</font>
<a name="l00080"></a><a class="code" href="atlapp_8h.html#a6">00080</a> <font class="preprocessor"></font><font class="preprocessor">      #define SetWindowLongPtr  SetWindowLongPtrA</font>
00081 <font class="preprocessor"></font><font class="preprocessor">    #endif // !UNICODE</font>
00082 <font class="preprocessor"></font><font class="preprocessor">  #endif // !SetWindowLongPtr</font>
00083 <font class="preprocessor"></font>
00084 <font class="preprocessor">  #ifndef GWLP_WNDPROC</font>
<a name="l00085"></a><a class="code" href="atlapp_8h.html#a7">00085</a> <font class="preprocessor"></font><font class="preprocessor">    #define GWLP_WNDPROC        (-4)</font>
00086 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00087 <font class="preprocessor"></font><font class="preprocessor">  #ifndef GWLP_HINSTANCE</font>
<a name="l00088"></a><a class="code" href="atlapp_8h.html#a8">00088</a> <font class="preprocessor"></font><font class="preprocessor">    #define GWLP_HINSTANCE      (-6)</font>
00089 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00090 <font class="preprocessor"></font><font class="preprocessor">  #ifndef GWLP_HWNDPARENT</font>
<a name="l00091"></a><a class="code" href="atlapp_8h.html#a9">00091</a> <font class="preprocessor"></font><font class="preprocessor">    #define GWLP_HWNDPARENT     (-8)</font>
00092 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00093 <font class="preprocessor"></font><font class="preprocessor">  #ifndef GWLP_USERDATA</font>
<a name="l00094"></a><a class="code" href="atlapp_8h.html#a10">00094</a> <font class="preprocessor"></font><font class="preprocessor">    #define GWLP_USERDATA       (-21)</font>
00095 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00096 <font class="preprocessor"></font><font class="preprocessor">  #ifndef GWLP_ID</font>
<a name="l00097"></a><a class="code" href="atlapp_8h.html#a11">00097</a> <font class="preprocessor"></font><font class="preprocessor">    #define GWLP_ID             (-12)</font>
00098 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00099 <font class="preprocessor"></font>
00100 <font class="preprocessor">  #ifndef DWLP_MSGRESULT</font>
<a name="l00101"></a><a class="code" href="atlapp_8h.html#a12">00101</a> <font class="preprocessor"></font><font class="preprocessor">    #define DWLP_MSGRESULT  0</font>
00102 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00103 <font class="preprocessor"></font>
<a name="l00104"></a><a class="code" href="atlapp_8h.html#a41">00104</a>   <font class="keyword">typedef</font> <font class="keywordtype">long</font> <a class="code" href="atlapp_8h.html#a41">LONG_PTR</a>;
<a name="l00105"></a><a class="code" href="atlapp_8h.html#a42">00105</a>   <font class="keyword">typedef</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> <a class="code" href="atlapp_8h.html#a42">ULONG_PTR</a>;
<a name="l00106"></a><a class="code" href="atlapp_8h.html#a43">00106</a>   <font class="keyword">typedef</font> <a class="code" href="atlapp_8h.html#a42">ULONG_PTR</a> <a class="code" href="atlapp_8h.html#a43">DWORD_PTR</a>;
00107 
00108 <font class="preprocessor">  #ifndef HandleToUlong</font>
<a name="l00109"></a><a class="code" href="atlapp_8h.html#a13">00109</a> <font class="preprocessor"></font><font class="preprocessor">    #define HandleToUlong( h ) ((ULONG)(ULONG_PTR)(h) )</font>
00110 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00111 <font class="preprocessor"></font><font class="preprocessor">  #ifndef HandleToLong</font>
<a name="l00112"></a><a class="code" href="atlapp_8h.html#a14">00112</a> <font class="preprocessor"></font><font class="preprocessor">    #define HandleToLong( h ) ((LONG)(LONG_PTR) (h) )</font>
00113 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00114 <font class="preprocessor"></font><font class="preprocessor">  #ifndef LongToHandle</font>
<a name="l00115"></a><a class="code" href="atlapp_8h.html#a15">00115</a> <font class="preprocessor"></font><font class="preprocessor">    #define LongToHandle( h) ((HANDLE)(LONG_PTR) (h))</font>
00116 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00117 <font class="preprocessor"></font><font class="preprocessor">  #ifndef PtrToUlong</font>
<a name="l00118"></a><a class="code" href="atlapp_8h.html#a16">00118</a> <font class="preprocessor"></font><font class="preprocessor">    #define PtrToUlong( p ) ((ULONG)(ULONG_PTR) (p) )</font>
00119 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00120 <font class="preprocessor"></font><font class="preprocessor">  #ifndef PtrToLong</font>
<a name="l00121"></a><a class="code" href="atlapp_8h.html#a17">00121</a> <font class="preprocessor"></font><font class="preprocessor">    #define PtrToLong( p ) ((LONG)(LONG_PTR) (p) )</font>
00122 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00123 <font class="preprocessor"></font><font class="preprocessor">  #ifndef PtrToUint</font>
<a name="l00124"></a><a class="code" href="atlapp_8h.html#a18">00124</a> <font class="preprocessor"></font><font class="preprocessor">    #define PtrToUint( p ) ((UINT)(UINT_PTR) (p) )</font>
00125 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00126 <font class="preprocessor"></font><font class="preprocessor">  #ifndef PtrToInt</font>
<a name="l00127"></a><a class="code" href="atlapp_8h.html#a19">00127</a> <font class="preprocessor"></font><font class="preprocessor">    #define PtrToInt( p ) ((INT)(INT_PTR) (p) )</font>
00128 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00129 <font class="preprocessor"></font><font class="preprocessor">  #ifndef PtrToUshort</font>
<a name="l00130"></a><a class="code" href="atlapp_8h.html#a20">00130</a> <font class="preprocessor"></font><font class="preprocessor">    #define PtrToUshort( p ) ((unsigned short)(ULONG_PTR)(p) )</font>
00131 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00132 <font class="preprocessor"></font><font class="preprocessor">  #ifndef PtrToShort</font>
<a name="l00133"></a><a class="code" href="atlapp_8h.html#a21">00133</a> <font class="preprocessor"></font><font class="preprocessor">    #define PtrToShort( p ) ((short)(LONG_PTR)(p) )</font>
00134 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00135 <font class="preprocessor"></font><font class="preprocessor">  #ifndef IntToPtr</font>
<a name="l00136"></a><a class="code" href="atlapp_8h.html#a22">00136</a> <font class="preprocessor"></font><font class="preprocessor">    #define IntToPtr( i )    ((VOID *)(INT_PTR)((int)i))</font>
00137 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00138 <font class="preprocessor"></font><font class="preprocessor">  #ifndef UIntToPtr</font>
<a name="l00139"></a><a class="code" href="atlapp_8h.html#a23">00139</a> <font class="preprocessor"></font><font class="preprocessor">    #define UIntToPtr( ui )  ((VOID *)(UINT_PTR)((unsigned int)ui))</font>
00140 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00141 <font class="preprocessor"></font><font class="preprocessor">  #ifndef LongToPtr</font>
<a name="l00142"></a><a class="code" href="atlapp_8h.html#a24">00142</a> <font class="preprocessor"></font><font class="preprocessor">    #define LongToPtr( l )   ((VOID *)(LONG_PTR)((long)l))</font>
00143 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00144 <font class="preprocessor"></font><font class="preprocessor">  #ifndef ULongToPtr</font>
<a name="l00145"></a><a class="code" href="atlapp_8h.html#a25">00145</a> <font class="preprocessor"></font><font class="preprocessor">    #define ULongToPtr( ul )  ((VOID *)(ULONG_PTR)((unsigned long)ul))</font>
00146 <font class="preprocessor"></font><font class="preprocessor">  #endif</font>
00147 <font class="preprocessor"></font>
00148 <font class="preprocessor">#endif </font>
00149 <font class="preprocessor">#endif </font>
00150 <font class="preprocessor"></font>
00151 <font class="preprocessor"></font><font class="preprocessor">#ifndef IS_INTRESOURCE</font>
<a name="l00152"></a><a class="code" href="atlapp_8h.html#a26">00152</a> <font class="preprocessor"></font><font class="preprocessor">#define IS_INTRESOURCE(_r) (((ULONG_PTR)(_r) &gt;&gt; 16) == 0)</font>
00153 <font class="preprocessor"></font><font class="preprocessor">#endif //IS_INTRESOURCE</font>
00154 <font class="preprocessor"></font>
00155 
<a name="l00156"></a><a class="code" href="namespaceWTL.html">00156</a> <font class="keyword">namespace </font>WTL
00157 {
00158 
00159 <font class="preprocessor">#if (_ATL_VER &gt;= 0x0700)</font>
00160 <font class="preprocessor"></font>  DECLARE_TRACE_CATEGORY(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>);
00161 <font class="preprocessor">  #ifdef _DEBUG</font>
00162 <font class="preprocessor"></font>    <a class="code" href="namespaceWTL.html#a64">__declspec</a>(selectany) CTraceCategory <a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>(_T(<font class="stringliteral">"atlTraceUI"</font>));
00163 <font class="preprocessor">  #endif // _DEBUG</font>
00164 <font class="preprocessor"></font><font class="preprocessor">#else </font>
<a name="l00165"></a><a class="code" href="namespaceWTL.html#a111">00165</a> <font class="preprocessor">  enum wtlTraceFlags</font>
00166 <font class="preprocessor"></font>  {
00167     <a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a> = 0x10000000
00168   };
00169 <font class="preprocessor">#endif </font>
00170 <font class="preprocessor"></font>
00171 <font class="preprocessor"></font><font class="comment">// Windows version helper</font>
<a name="l00172"></a><a class="code" href="namespaceWTL.html#a59">00172</a> <font class="keyword">inline</font> <font class="keywordtype">bool</font> <a class="code" href="namespaceWTL.html#a59">AtlIsOldWindows</a>()
00173 {
00174     OSVERSIONINFO ovi;
00175     ovi.dwOSVersionInfoSize = <font class="keyword">sizeof</font>(OSVERSIONINFO);
00176     BOOL bRet = ::GetVersionEx(&amp;ovi);
00177     <font class="keywordflow">return</font> (!bRet || !((ovi.dwMajorVersion &gt;= 5) || (ovi.dwMajorVersion == 4 &amp;&amp; ovi.dwMinorVersion &gt;= 90)));
00178 }
00179 
00180 <font class="comment">// default GUI font helper</font>
<a name="l00181"></a><a class="code" href="namespaceWTL.html#a60">00181</a> <font class="keyword">inline</font> HFONT <a class="code" href="namespaceWTL.html#a60">AtlGetDefaultGuiFont</a>()
00182 {
00183     <font class="keywordflow">return</font> (HFONT)::GetStockObject(DEFAULT_GUI_FONT);
00184 }
00185 
00186 <font class="comment">// Common Controls initialization helper</font>
<a name="l00187"></a><a class="code" href="namespaceWTL.html#a61">00187</a> <font class="keyword">inline</font> BOOL <a class="code" href="namespaceWTL.html#a61">AtlInitCommonControls</a>(DWORD dwFlags)
00188 {
00189     INITCOMMONCONTROLSEX iccx = { <font class="keyword">sizeof</font>(INITCOMMONCONTROLSEX), dwFlags };
00190     BOOL bRet = ::InitCommonControlsEx(&amp;iccx);
00191     ATLASSERT(bRet);
00192     <font class="keywordflow">return</font> bRet;
00193 }
00194 
00195 
00197 <font class="comment">// CMessageFilter - Interface for message filter support</font>
00198 
<a name="l00199"></a><a class="code" href="classWTL_1_1CMessageFilter.html">00199</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CMessageFilter.html">CMessageFilter</a>
00200 {
00201 <font class="keyword">public</font>:
00202     <font class="keyword">virtual</font> BOOL <a class="code" href="classWTL_1_1CMessageFilter.html#a0">PreTranslateMessage</a>(MSG* pMsg) = 0;
00203 };
00204 
00205 
00207 <font class="comment">// CIdleHandler - Interface for idle processing</font>
00208 
<a name="l00209"></a><a class="code" href="classWTL_1_1CIdleHandler.html">00209</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>
00210 {
00211 <font class="keyword">public</font>:
00212     <font class="keyword">virtual</font> BOOL <a class="code" href="classWTL_1_1CIdleHandler.html#a0">OnIdle</a>() = 0;
00213 };
00214 
00215 <font class="preprocessor">#ifndef _ATL_NO_OLD_NAMES</font>
00216 <font class="preprocessor"></font><font class="comment">// for compatilibility with old names only</font>
<a name="l00217"></a><a class="code" href="namespaceWTL.html#a0">00217</a> <font class="keyword">typedef</font> <a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>    <a class="code" href="namespaceWTL.html#a0">CUpdateUIObject</a>;
<a name="l00218"></a><a class="code" href="atlapp_8h.html#a27">00218</a> <font class="preprocessor">#define DoUpdate    OnIdle</font>
00219 <font class="preprocessor"></font><font class="preprocessor">#endif </font>
00220 <font class="preprocessor"></font>
00221 <font class="preprocessor"></font>
00223 <font class="comment">// CMessageLoop - message loop implementation</font>
00224 
<a name="l00225"></a><a class="code" href="classWTL_1_1CMessageLoop.html">00225</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CMessageLoop.html">CMessageLoop</a>
00226 {
00227 <font class="keyword">public</font>:
<a name="l00228"></a><a class="code" href="classWTL_1_1CMessageLoop.html#m0">00228</a>     <a class="code" href="classCSimpleArray.html">CSimpleArray&lt;CMessageFilter*&gt;</a> <a class="code" href="classWTL_1_1CMessageLoop.html#m0">m_aMsgFilter</a>;
<a name="l00229"></a><a class="code" href="classWTL_1_1CMessageLoop.html#m1">00229</a>     <a class="code" href="classCSimpleArray.html">CSimpleArray&lt;CIdleHandler*&gt;</a> <a class="code" href="classWTL_1_1CMessageLoop.html#m1">m_aIdleHandler</a>;
<a name="l00230"></a><a class="code" href="classWTL_1_1CMessageLoop.html#m2">00230</a>     MSG <a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>;
00231 
00232 <font class="comment">// Message filter operations</font>
<a name="l00233"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a0">00233</a>     BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a0">AddMessageFilter</a>(<a class="code" href="classWTL_1_1CMessageFilter.html">CMessageFilter</a>* pMessageFilter)
00234     {
00235         <font class="keywordflow">return</font> m_aMsgFilter.Add(pMessageFilter);
00236     }
<a name="l00237"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a1">00237</a>     BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a1">RemoveMessageFilter</a>(<a class="code" href="classWTL_1_1CMessageFilter.html">CMessageFilter</a>* pMessageFilter)
00238     {
00239         <font class="keywordflow">return</font> m_aMsgFilter.Remove(pMessageFilter);
00240     }
00241 <font class="comment">// Idle handler operations</font>
<a name="l00242"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a2">00242</a>     BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a2">AddIdleHandler</a>(<a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>* pIdleHandler)
00243     {
00244         <font class="keywordflow">return</font> m_aIdleHandler.Add(pIdleHandler);
00245     }
<a name="l00246"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a3">00246</a>     BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a3">RemoveIdleHandler</a>(<a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>* pIdleHandler)
00247     {
00248         <font class="keywordflow">return</font> m_aIdleHandler.Remove(pIdleHandler);
00249     }
00250 <font class="preprocessor">#ifndef _ATL_NO_OLD_NAMES</font>
00251 <font class="preprocessor"></font>    <font class="comment">// for compatilibility with old names only</font>
<a name="l00252"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a4">00252</a>     BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a4">AddUpdateUI</a>(<a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>* pIdleHandler)
00253     {
00254         ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CUpdateUIObject and AddUpdateUI are deprecated. Please change your code to use CIdleHandler and OnIdle\n"</font>);
00255         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CMessageLoop.html#a2">AddIdleHandler</a>(pIdleHandler);
00256     }
<a name="l00257"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a5">00257</a>     BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a5">RemoveUpdateUI</a>(<a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>* pIdleHandler)
00258     {
00259         ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, <font class="stringliteral">"CUpdateUIObject and RemoveUpdateUI are deprecated. Please change your code to use CIdleHandler and OnIdle\n"</font>);
00260         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CMessageLoop.html#a3">RemoveIdleHandler</a>(pIdleHandler);
00261     }
00262 <font class="preprocessor">#endif </font>
00263 <font class="preprocessor">// message loop</font>
<a name="l00264"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a6">00264</a> <font class="preprocessor"></font>    <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CMessageLoop.html#a6">Run</a>()
00265     {
00266         BOOL bDoIdle = TRUE;
00267         <font class="keywordtype">int</font> nIdleCount = 0;
00268         BOOL bRet;
00269 
00270         <font class="keywordflow">for</font>(;;)
00271         {
00272             <font class="keywordflow">while</font>(!::PeekMessage(&amp;<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>, NULL, 0, 0, PM_NOREMOVE) &amp;&amp; bDoIdle)
00273             {
00274                 <font class="keywordflow">if</font>(!<a class="code" href="classWTL_1_1CMessageLoop.html#a8">OnIdle</a>(nIdleCount++))
00275                     bDoIdle = FALSE;
00276             }
00277 
00278             bRet = ::GetMessage(&amp;<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>, NULL, 0, 0);
00279 
00280             <font class="keywordflow">if</font>(bRet == -1)
00281             {
00282                 ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, _T(<font class="stringliteral">"::GetMessage returned -1 (error)\n"</font>));
00283                 <font class="keywordflow">continue</font>;   <font class="comment">// error, don't process</font>
00284             }
00285             <font class="keywordflow">else</font> <font class="keywordflow">if</font>(!bRet)
00286             {
00287                 ATLTRACE2(<a class="code" href="namespaceWTL.html#a111a1">atlTraceUI</a>, 0, _T(<font class="stringliteral">"CMessageLoop::Run - exiting\n"</font>));
00288                 <font class="keywordflow">break</font>;      <font class="comment">// WM_QUIT, exit message loop</font>
00289             }
00290 
00291             <font class="keywordflow">if</font>(!<a class="code" href="classWTL_1_1CMessageLoop.html#a7">PreTranslateMessage</a>(&amp;<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>))
00292             {
00293                 ::TranslateMessage(&amp;<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>);
00294                 ::DispatchMessage(&amp;<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>);
00295             }
00296 
00297             <font class="keywordflow">if</font>(<a class="code" href="classWTL_1_1CMessageLoop.html#d0">IsIdleMessage</a>(&amp;<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>))
00298             {
00299                 bDoIdle = TRUE;
00300                 nIdleCount = 0;
00301             }
00302         }
00303 
00304         <font class="keywordflow">return</font> (int)<a class="code" href="classWTL_1_1CMessageLoop.html#m2">m_msg</a>.wParam;
00305     }
00306 
<a name="l00307"></a><a class="code" href="classWTL_1_1CMessageLoop.html#d0">00307</a>     <font class="keyword">static</font> BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#d0">IsIdleMessage</a>(MSG* pMsg)
00308     {
00309         <font class="comment">// These messages should NOT cause idle processing</font>
00310         <font class="keywordflow">switch</font>(pMsg-&gt;message)
00311         {
00312         <font class="keywordflow">case</font> WM_MOUSEMOVE:
00313         <font class="keywordflow">case</font> WM_NCMOUSEMOVE:
00314         <font class="keywordflow">case</font> WM_PAINT:
00315         <font class="keywordflow">case</font> 0x0118:    <font class="comment">// WM_SYSTIMER (caret blink)</font>
00316             <font class="keywordflow">return</font> FALSE;
00317         }
00318 
00319         <font class="keywordflow">return</font> TRUE;
00320     }
00321 
00322 <font class="comment">// Overrideables</font>
00323     <font class="comment">// Override to change message filtering</font>
<a name="l00324"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a7">00324</a>     <font class="keyword">virtual</font> BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a7">PreTranslateMessage</a>(MSG* pMsg)
00325     {
00326         <font class="comment">// loop backwards</font>
00327         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = m_aMsgFilter.GetSize() - 1; i &gt;= 0; i--)
00328         {
00329             <a class="code" href="classWTL_1_1CMessageFilter.html">CMessageFilter</a>* pMessageFilter = m_aMsgFilter[i];
00330             <font class="keywordflow">if</font>(pMessageFilter != NULL &amp;&amp; pMessageFilter-&gt;<a class="code" href="classWTL_1_1CMessageFilter.html#a0">PreTranslateMessage</a>(pMsg))
00331                 <font class="keywordflow">return</font> TRUE;
00332         }
00333         <font class="keywordflow">return</font> FALSE;   <font class="comment">// not translated</font>
00334     }
00335     <font class="comment">// override to change idle processing</font>
<a name="l00336"></a><a class="code" href="classWTL_1_1CMessageLoop.html#a8">00336</a>     <font class="keyword">virtual</font> BOOL <a class="code" href="classWTL_1_1CMessageLoop.html#a8">OnIdle</a>(<font class="keywordtype">int</font> <font class="comment">/*nIdleCount*/</font>)
00337     {
00338         <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; m_aIdleHandler.GetSize(); i++)
00339         {
00340             <a class="code" href="classWTL_1_1CIdleHandler.html">CIdleHandler</a>* pIdleHandler = m_aIdleHandler[i];
00341             <font class="keywordflow">if</font>(pIdleHandler != NULL)
00342                 pIdleHandler-&gt;<a class="code" href="classWTL_1_1CIdleHandler.html#a0">OnIdle</a>();
00343         }
00344         <font class="keywordflow">return</font> FALSE;   <font class="comment">// don't continue</font>
00345     }
00346 };
00347 
00348 
00350 <font class="comment">// CAppModule - module class for an application</font>
00351 
<a name="l00352"></a><a class="code" href="classWTL_1_1CAppModule.html">00352</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CAppModule.html">CAppModule</a> : <font class="keyword">public</font> CComModule
00353 {
00354 <font class="keyword">public</font>:
<a name="l00355"></a><a class="code" href="classWTL_1_1CAppModule.html#m0">00355</a>     DWORD <a class="code" href="classWTL_1_1CAppModule.html#m0">m_dwMainThreadID</a>;
<a name="l00356"></a><a class="code" href="classWTL_1_1CAppModule.html#m1">00356</a>     CSimpleMap&lt;DWORD, CMessageLoop*&gt;* <a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a>;
<a name="l00357"></a><a class="code" href="classWTL_1_1CAppModule.html#m2">00357</a>     <a class="code" href="classCSimpleArray.html">CSimpleArray&lt;HWND&gt;</a>* <a class="code" href="classWTL_1_1CAppModule.html#m2">m_pSettingChangeNotify</a>;
00358 
00359 <font class="comment">// Overrides of CComModule::Init and Term</font>
<a name="l00360"></a><a class="code" href="classWTL_1_1CAppModule.html#a0">00360</a>     HRESULT <a class="code" href="classWTL_1_1CAppModule.html#a0">Init</a>(_ATL_OBJMAP_ENTRY* pObjMap, HINSTANCE hInstance, <font class="keyword">const</font> GUID* pLibID = NULL)
00361     {
00362         HRESULT hRet = CComModule::Init(pObjMap, hInstance, pLibID);
00363         <font class="keywordflow">if</font>(FAILED(hRet))
00364             <font class="keywordflow">return</font> hRet;
00365 
00366         <a class="code" href="classWTL_1_1CAppModule.html#m0">m_dwMainThreadID</a> = ::GetCurrentThreadId();
00367         <font class="keyword">typedef</font> CSimpleMap&lt;DWORD, CMessageLoop*&gt;    mapClass;
00368         <a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a> = NULL;
00369         ATLTRY(<a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a> = <font class="keyword">new</font> mapClass);
00370         <font class="keywordflow">if</font>(<a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a> == NULL)
00371             <font class="keywordflow">return</font> E_OUTOFMEMORY;
00372         m_pSettingChangeNotify = NULL;
00373 
00374         <font class="keywordflow">return</font> hRet;
00375     }
<a name="l00376"></a><a class="code" href="classWTL_1_1CAppModule.html#a1">00376</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CAppModule.html#a1">Term</a>()
00377     {
00378         <font class="keywordflow">if</font>(m_pSettingChangeNotify != NULL &amp;&amp; m_pSettingChangeNotify-&gt;GetSize() &gt; 0)
00379         {
00380             ::DestroyWindow((*m_pSettingChangeNotify)[0]);
00381         }
00382         <font class="keyword">delete</font> m_pSettingChangeNotify;
00383         <font class="keyword">delete</font> <a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a>;
00384         CComModule::Term();
00385     }
00386 
00387 <font class="comment">// Message loop map methods</font>
<a name="l00388"></a><a class="code" href="classWTL_1_1CAppModule.html#a2">00388</a>     BOOL <a class="code" href="classWTL_1_1CAppModule.html#a2">AddMessageLoop</a>(<a class="code" href="classWTL_1_1CMessageLoop.html">CMessageLoop</a>* pMsgLoop)
00389     {
00390         ATLASSERT(pMsgLoop != NULL);
00391         ATLASSERT(<a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a>-&gt;Lookup(::GetCurrentThreadId()) == NULL);   <font class="comment">// not in map yet</font>
00392         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a>-&gt;Add(::GetCurrentThreadId(), pMsgLoop);
00393     }
<a name="l00394"></a><a class="code" href="classWTL_1_1CAppModule.html#a3">00394</a>     BOOL <a class="code" href="classWTL_1_1CAppModule.html#a3">RemoveMessageLoop</a>()
00395     {
00396         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a>-&gt;Remove(::GetCurrentThreadId());
00397     }
<a name="l00398"></a><a class="code" href="classWTL_1_1CAppModule.html#a4">00398</a>     <a class="code" href="classWTL_1_1CMessageLoop.html">CMessageLoop</a>* <a class="code" href="classWTL_1_1CAppModule.html#a4">GetMessageLoop</a>(DWORD dwThreadID = ::GetCurrentThreadId())<font class="keyword"> const</font>
00399 <font class="keyword">    </font>{
00400         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CAppModule.html#m1">m_pMsgLoopMap</a>-&gt;Lookup(dwThreadID);
00401     }
00402 
00403 <font class="comment">// Setting change notify methods</font>
<a name="l00404"></a><a class="code" href="classWTL_1_1CAppModule.html#a5">00404</a>     BOOL <a class="code" href="classWTL_1_1CAppModule.html#a5">AddSettingChangeNotify</a>(HWND hWnd)
00405     {
00406         ATLASSERT(::IsWindow(hWnd));
00407         <font class="keywordflow">if</font>(m_pSettingChangeNotify == NULL)
00408         {
00409             <font class="keyword">typedef</font> <a class="code" href="classCSimpleArray.html">CSimpleArray&lt;HWND&gt;</a>  notifyClass;
00410             ATLTRY(m_pSettingChangeNotify = <font class="keyword">new</font> notifyClass);
00411             ATLASSERT(m_pSettingChangeNotify != NULL);
00412             <font class="keywordflow">if</font>(m_pSettingChangeNotify == NULL)
00413                 <font class="keywordflow">return</font> FALSE;
00414         }
00415         <font class="keywordflow">if</font>(m_pSettingChangeNotify-&gt;GetSize() == 0)
00416         {
00417             <font class="comment">// init everything</font>
00418             <a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html">_ATL_EMPTY_DLGTEMPLATE</a> templ;
00419             HWND hNtfWnd = ::CreateDialogIndirect(GetModuleInstance(), &amp;templ, NULL, <a class="code" href="classWTL_1_1CAppModule.html#d0">_SettingChangeDlgProc</a>);
00420             ATLASSERT(::IsWindow(hNtfWnd));
00421             <font class="keywordflow">if</font>(::IsWindow(hNtfWnd))
00422             {
00423 <font class="comment">// need conditional code because types don't match in winuser.h</font>
00424 <font class="preprocessor">#ifdef _WIN64</font>
00425 <font class="preprocessor"></font>                ::SetWindowLongPtr(hNtfWnd, <a class="code" href="atlapp_8h.html#a10">GWLP_USERDATA</a>, (LONG_PTR)<font class="keyword">this</font>);
00426 <font class="preprocessor">#else</font>
00427 <font class="preprocessor"></font>                ::SetWindowLongPtr(hNtfWnd, <a class="code" href="atlapp_8h.html#a10">GWLP_USERDATA</a>, <a class="code" href="atlapp_8h.html#a17">PtrToLong</a>(<font class="keyword">this</font>));
00428 <font class="preprocessor">#endif</font>
00429 <font class="preprocessor"></font>                m_pSettingChangeNotify-&gt;Add(hNtfWnd);
00430             }
00431         }
00432         <font class="keywordflow">return</font> m_pSettingChangeNotify-&gt;Add(hWnd);
00433     }
00434 
<a name="l00435"></a><a class="code" href="classWTL_1_1CAppModule.html#a6">00435</a>     BOOL <a class="code" href="classWTL_1_1CAppModule.html#a6">RemoveSettingChangeNotify</a>(HWND hWnd)
00436     {
00437         <font class="keywordflow">if</font>(m_pSettingChangeNotify == NULL)
00438             <font class="keywordflow">return</font> FALSE;
00439         <font class="keywordflow">return</font> m_pSettingChangeNotify-&gt;Remove(hWnd);
00440     }
00441 
00442 <font class="comment">// Implementation - setting change notify dialog template and dialog procedure</font>
<a name="l00443"></a><a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html">00443</a>     <font class="keyword">struct </font><a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html">_ATL_EMPTY_DLGTEMPLATE</a> : DLGTEMPLATE
00444     {
<a name="l00445"></a><a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html#a0">00445</a>         <a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html#a0">_ATL_EMPTY_DLGTEMPLATE</a>()
00446         {
00447             memset(<font class="keyword">this</font>, 0, <font class="keyword">sizeof</font>(<a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html">_ATL_EMPTY_DLGTEMPLATE</a>));
00448             style = WS_POPUP;
00449         }
<a name="l00450"></a><a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html#m2">00450</a>         WORD <a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html#m0">wMenu</a>, <a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html#m1">wClass</a>, <a class="code" href="structWTL_1_1CAppModule_1_1__ATL__EMPTY__DLGTEMPLATE.html#m2">wTitle</a>;
00451     };
00452 
00453 <font class="preprocessor">#ifdef _WIN64</font>
00454 <font class="preprocessor"></font>    <font class="keyword">static</font> INT_PTR CALLBACK <a class="code" href="classWTL_1_1CAppModule.html#d0">_SettingChangeDlgProc</a>(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
00455 <font class="preprocessor">#else</font>
<a name="l00456"></a><a class="code" href="classWTL_1_1CAppModule.html#d0">00456</a> <font class="preprocessor"></font>    <font class="keyword">static</font> BOOL CALLBACK <a class="code" href="classWTL_1_1CAppModule.html#d0">_SettingChangeDlgProc</a>(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)
00457 <font class="preprocessor">#endif</font>
00458 <font class="preprocessor"></font>    {
00459         <font class="keywordflow">if</font>(uMsg == WM_SETTINGCHANGE)
00460         {
00461 <font class="comment">// need conditional code because types don't match in winuser.h</font>
00462 <font class="preprocessor">#ifdef _WIN64</font>
00463 <font class="preprocessor"></font>            <a class="code" href="classWTL_1_1CAppModule.html">CAppModule</a>* pModule = (<a class="code" href="classWTL_1_1CAppModule.html">CAppModule</a>*)::GetWindowLongPtr(hWnd, <a class="code" href="atlapp_8h.html#a10">GWLP_USERDATA</a>);
00464 <font class="preprocessor">#else</font>
00465 <font class="preprocessor"></font>            <a class="code" href="classWTL_1_1CAppModule.html">CAppModule</a>* pModule = (<a class="code" href="classWTL_1_1CAppModule.html">CAppModule</a>*)<a class="code" href="atlapp_8h.html#a24">LongToPtr</a>(::<a class="code" href="atlapp_8h.html#a3">GetWindowLongPtr</a>(hWnd, <a class="code" href="atlapp_8h.html#a10">GWLP_USERDATA</a>));
00466 <font class="preprocessor">#endif</font>
00467 <font class="preprocessor"></font>            ATLASSERT(pModule != NULL);
00468             ATLASSERT(pModule-&gt;<a class="code" href="classWTL_1_1CAppModule.html#m2">m_pSettingChangeNotify</a> != NULL);
00469             <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 1; i &lt; pModule-&gt;<a class="code" href="classWTL_1_1CAppModule.html#m2">m_pSettingChangeNotify</a>-&gt;GetSize(); i++)
00470                 ::SendMessageTimeout((*pModule-&gt;<a class="code" href="classWTL_1_1CAppModule.html#m2">m_pSettingChangeNotify</a>)[i], uMsg, wParam, lParam, SMTO_ABORTIFHUNG, 1500, NULL);
00471             <font class="keywordflow">return</font> TRUE;
00472         }
00473         <font class="keywordflow">return</font> FALSE;
00474     }
00475 };
00476 
00477 
00479 <font class="comment">// CServerAppModule - module class for a COM server application</font>
00480 
<a name="l00481"></a><a class="code" href="classWTL_1_1CServerAppModule.html">00481</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CServerAppModule.html">CServerAppModule</a> : <font class="keyword">public</font> <a class="code" href="classWTL_1_1CAppModule.html">CAppModule</a>
00482 {
00483 <font class="keyword">public</font>:
<a name="l00484"></a><a class="code" href="classWTL_1_1CServerAppModule.html#m0">00484</a>     HANDLE <a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a>;
<a name="l00485"></a><a class="code" href="classWTL_1_1CServerAppModule.html#m1">00485</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CServerAppModule.html#m1">m_bActivity</a>;
<a name="l00486"></a><a class="code" href="classWTL_1_1CServerAppModule.html#m2">00486</a>     DWORD <a class="code" href="classWTL_1_1CServerAppModule.html#m2">m_dwTimeOut</a>;
<a name="l00487"></a><a class="code" href="classWTL_1_1CServerAppModule.html#m3">00487</a>     DWORD <a class="code" href="classWTL_1_1CServerAppModule.html#m3">m_dwPause</a>;
00488 
00489 <font class="comment">// Override of CAppModule::Init</font>
<a name="l00490"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a0">00490</a>     HRESULT <a class="code" href="classWTL_1_1CServerAppModule.html#a0">Init</a>(_ATL_OBJMAP_ENTRY* pObjMap, HINSTANCE hInstance, <font class="keyword">const</font> GUID* pLibID = NULL)
00491     {
00492         <a class="code" href="classWTL_1_1CServerAppModule.html#m2">m_dwTimeOut</a> = 5000;
00493         <a class="code" href="classWTL_1_1CServerAppModule.html#m3">m_dwPause</a> = 1000;
00494         <font class="keywordflow">return</font> CAppModule::Init(pObjMap, hInstance, pLibID);
00495     }
<a name="l00496"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a1">00496</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CServerAppModule.html#a1">Term</a>()
00497     {
00498         <font class="keywordflow">if</font>(<a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a> != NULL &amp;&amp; ::CloseHandle(m_hEventShutdown))
00499             <a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a> = NULL;
00500         CAppModule::Term();
00501     }
00502 
00503 <font class="comment">// COM Server methods</font>
<a name="l00504"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a2">00504</a>     LONG <a class="code" href="classWTL_1_1CServerAppModule.html#a2">Unlock</a>()
00505     {
00506         LONG lRet = CComModule::Unlock();
00507         <font class="keywordflow">if</font>(lRet == 0)
00508         {
00509             <a class="code" href="classWTL_1_1CServerAppModule.html#m1">m_bActivity</a> = <font class="keyword">true</font>;
00510             ::SetEvent(m_hEventShutdown); <font class="comment">// tell monitor that we transitioned to zero</font>
00511         }
00512         <font class="keywordflow">return</font> lRet;
00513     }
00514 
<a name="l00515"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a3">00515</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CServerAppModule.html#a3">MonitorShutdown</a>()
00516     {
00517         <font class="keywordflow">while</font>(1)
00518         {
00519             ::WaitForSingleObject(<a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a>, INFINITE);
00520             DWORD dwWait = 0;
00521             <font class="keywordflow">do</font>
00522             {
00523                 <a class="code" href="classWTL_1_1CServerAppModule.html#m1">m_bActivity</a> = <font class="keyword">false</font>;
00524                 dwWait = ::WaitForSingleObject(<a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a>, <a class="code" href="classWTL_1_1CServerAppModule.html#m2">m_dwTimeOut</a>);
00525             }
00526             <font class="keywordflow">while</font>(dwWait == WAIT_OBJECT_0);
00527             <font class="comment">// timed out</font>
00528             <font class="keywordflow">if</font>(!<a class="code" href="classWTL_1_1CServerAppModule.html#m1">m_bActivity</a> &amp;&amp; m_nLockCnt == 0) <font class="comment">// if no activity let's really bail</font>
00529             {
00530 <font class="preprocessor">#if ((_WIN32_WINNT &gt;= 0x0400 ) || defined(_WIN32_DCOM)) &amp; defined(_ATL_FREE_THREADED)</font>
00531 <font class="preprocessor"></font>                ::CoSuspendClassObjects();
00532                 <font class="keywordflow">if</font>(!<a class="code" href="classWTL_1_1CServerAppModule.html#m1">m_bActivity</a> &amp;&amp; m_nLockCnt == 0)
00533 <font class="preprocessor">#endif</font>
00534 <font class="preprocessor"></font>                    <font class="keywordflow">break</font>;
00535             }
00536         }
00537         <font class="comment">// This handle should be valid now. If it isn't, </font>
00538         <font class="comment">// check if _Module.Term was called first (it shouldn't)</font>
00539         <font class="keywordflow">if</font>(::CloseHandle(m_hEventShutdown))
00540             <a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a> = NULL;
00541         ::PostThreadMessage(<a class="code" href="classWTL_1_1CAppModule.html#m0">m_dwMainThreadID</a>, WM_QUIT, 0, 0);
00542     }
00543 
<a name="l00544"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a4">00544</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CServerAppModule.html#a4">StartMonitor</a>()
00545     {
00546         <a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a> = ::CreateEvent(NULL, <font class="keyword">false</font>, <font class="keyword">false</font>, NULL);
00547         <font class="keywordflow">if</font>(<a class="code" href="classWTL_1_1CServerAppModule.html#m0">m_hEventShutdown</a> == NULL)
00548             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00549         DWORD dwThreadID;
00550 <font class="preprocessor">#if !defined(_ATL_MIN_CRT) &amp; defined(_MT)</font>
00551 <font class="preprocessor"></font>        HANDLE hThread = (HANDLE)_beginthreadex(NULL, 0, (UINT (WINAPI*)(<font class="keywordtype">void</font>*))<a class="code" href="classWTL_1_1CServerAppModule.html#d0">MonitorProc</a>, <font class="keyword">this</font>, 0, (UINT*)&amp;dwThreadID);
00552 <font class="preprocessor">#else</font>
00553 <font class="preprocessor"></font>        HANDLE hThread = ::CreateThread(NULL, 0, <a class="code" href="classWTL_1_1CServerAppModule.html#d0">MonitorProc</a>, <font class="keyword">this</font>, 0, &amp;dwThreadID);
00554 <font class="preprocessor">#endif</font>
00555 <font class="preprocessor"></font>        <font class="keywordtype">bool</font> bRet = (hThread != NULL);
00556         <font class="keywordflow">if</font>(bRet)
00557             ::CloseHandle(hThread);
00558         <font class="keywordflow">return</font> bRet;
00559     }
00560 
<a name="l00561"></a><a class="code" href="classWTL_1_1CServerAppModule.html#d0">00561</a>     <font class="keyword">static</font> DWORD WINAPI <a class="code" href="classWTL_1_1CServerAppModule.html#d0">MonitorProc</a>(<font class="keywordtype">void</font>* pv)
00562     {
00563         <a class="code" href="classWTL_1_1CServerAppModule.html">CServerAppModule</a>* p = (<a class="code" href="classWTL_1_1CServerAppModule.html">CServerAppModule</a>*)pv;
00564         p-&gt;<a class="code" href="classWTL_1_1CServerAppModule.html#a3">MonitorShutdown</a>();
00565 <font class="preprocessor">#if !defined(_ATL_MIN_CRT) &amp; defined(_MT)</font>
00566 <font class="preprocessor"></font>        _endthreadex(0);
00567 <font class="preprocessor">#endif</font>
00568 <font class="preprocessor"></font>        <font class="keywordflow">return</font> 0;
00569     }
00570 
00571     <font class="comment">// Scan command line and perform registration</font>
00572     <font class="comment">// Return value specifies if server should run</font>
00573 
00574     <font class="comment">// Parses the command line and registers/unregisters the rgs file if necessary</font>
<a name="l00575"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a5">00575</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CServerAppModule.html#a5">ParseCommandLine</a>(LPCTSTR lpCmdLine, UINT nResId, HRESULT* pnRetCode)
00576     {
00577         TCHAR szTokens[] = _T(<font class="stringliteral">"-/"</font>);
00578         *pnRetCode = S_OK;
00579 
00580         LPCTSTR lpszToken = <a class="code" href="classWTL_1_1CServerAppModule.html#d1">FindOneOf</a>(lpCmdLine, szTokens);
00581         <font class="keywordflow">while</font>(lpszToken != NULL)
00582         {
00583             <font class="keywordflow">if</font>(lstrcmpi(lpszToken, _T(<font class="stringliteral">"UnregServer"</font>))==0)
00584             {
00585                 *pnRetCode = UnregisterServer(TRUE);
00586                 ATLASSERT(SUCCEEDED(*pnRetCode));
00587                 <font class="keywordflow">if</font>(FAILED(*pnRetCode))
00588                     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00589                 *pnRetCode = UpdateRegistryFromResource(nResId, FALSE);
00590                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00591             }
00592 
00593             <font class="comment">// Register as Local Server</font>
00594             <font class="keywordflow">if</font>(lstrcmpi(lpszToken, _T(<font class="stringliteral">"RegServer"</font>))==0)
00595             {
00596                 *pnRetCode = UpdateRegistryFromResource(nResId, TRUE);
00597                 ATLASSERT(SUCCEEDED(*pnRetCode));
00598                 <font class="keywordflow">if</font>(FAILED(*pnRetCode))
00599                     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00600                 *pnRetCode = RegisterServer(TRUE);
00601                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00602             }
00603 
00604             lpszToken = <a class="code" href="classWTL_1_1CServerAppModule.html#d1">FindOneOf</a>(lpszToken, szTokens);
00605         }
00606         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00607     }
00608     
00609     <font class="comment">// Parses the command line and registers/unregisters the appid if necessary</font>
<a name="l00610"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a6">00610</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CServerAppModule.html#a5">ParseCommandLine</a>(LPCTSTR lpCmdLine, LPCTSTR pAppId, HRESULT* pnRetCode)
00611     {
00612         TCHAR szTokens[] = _T(<font class="stringliteral">"-/"</font>);
00613         *pnRetCode = S_OK;
00614 
00615         LPCTSTR lpszToken = <a class="code" href="classWTL_1_1CServerAppModule.html#d1">FindOneOf</a>(lpCmdLine, szTokens);
00616         <font class="keywordflow">while</font>(lpszToken != NULL)
00617         {
00618             <font class="keywordflow">if</font>(lstrcmpi(lpszToken, _T(<font class="stringliteral">"UnregServer"</font>))==0)
00619             {
00620                 *pnRetCode = <a class="code" href="classWTL_1_1CServerAppModule.html#a8">UnregisterAppId</a>(pAppId);
00621                 ATLASSERT(SUCCEEDED(*pnRetCode));
00622                 <font class="keywordflow">if</font>(FAILED(*pnRetCode))
00623                     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00624                 *pnRetCode = UnregisterServer(TRUE);
00625                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00626             }
00627 
00628             <font class="comment">// Register as Local Server</font>
00629             <font class="keywordflow">if</font>(lstrcmpi(lpszToken, _T(<font class="stringliteral">"RegServer"</font>))==0)
00630             {
00631                 *pnRetCode = <a class="code" href="classWTL_1_1CServerAppModule.html#a7">RegisterAppId</a>(pAppId);
00632                 ATLASSERT(SUCCEEDED(*pnRetCode));
00633                 <font class="keywordflow">if</font>(FAILED(*pnRetCode))
00634                     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00635                 *pnRetCode = RegisterServer(TRUE);
00636                 <font class="keywordflow">return</font> <font class="keyword">false</font>;
00637             }
00638 
00639             lpszToken = <a class="code" href="classWTL_1_1CServerAppModule.html#d1">FindOneOf</a>(lpszToken, szTokens);
00640         }
00641         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00642     }
00643 
00644 <font class="preprocessor">#if (_ATL_VER &lt; 0x0700)</font>
00645 <font class="preprocessor"></font>    <font class="comment">// search for an occurence of string p2 in string p1</font>
<a name="l00646"></a><a class="code" href="classWTL_1_1CServerAppModule.html#d1">00646</a>     <font class="keyword">static</font> LPCTSTR <a class="code" href="classWTL_1_1CServerAppModule.html#d1">FindOneOf</a>(LPCTSTR p1, LPCTSTR p2)
00647     {
00648         <font class="keywordflow">while</font>(p1 != NULL &amp;&amp; *p1 != NULL)
00649         {
00650             LPCTSTR p = p2;
00651             <font class="keywordflow">while</font>(p != NULL &amp;&amp; *p != NULL)
00652             {
00653                 <font class="keywordflow">if</font>(*p1 == *p)
00654                     return ::CharNext(p1);
00655                 p = ::CharNext(p);
00656             }
00657             p1 = ::CharNext(p1);
00658         }
00659         <font class="keywordflow">return</font> NULL;
00660     }
00661 
<a name="l00662"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a7">00662</a>     HRESULT <a class="code" href="classWTL_1_1CServerAppModule.html#a7">RegisterAppId</a>(LPCTSTR pAppId)
00663     {
00664         CRegKey keyAppID;
00665         <font class="keywordflow">if</font>(keyAppID.Open(HKEY_CLASSES_ROOT, _T(<font class="stringliteral">"AppID"</font>), KEY_READ) == ERROR_SUCCESS)
00666         {
00667             TCHAR szModule1[_MAX_PATH];
00668             TCHAR szModule2[_MAX_PATH];
00669             TCHAR* pszFileName;
00670             ::GetModuleFileName(GetModuleInstance(), szModule1, _MAX_PATH);
00671             ::GetFullPathName(szModule1, _MAX_PATH, szModule2, &amp;pszFileName);
00672             CRegKey keyAppIDEXE;
00673             <font class="keywordflow">if</font>(keyAppIDEXE.Create(keyAppID, pszFileName, REG_NONE, REG_OPTION_NON_VOLATILE, KEY_READ | KEY_WRITE) == ERROR_SUCCESS)
00674                 keyAppIDEXE.SetValue(pAppId, _T(<font class="stringliteral">"AppID"</font>));
00675             <font class="keywordflow">if</font>(keyAppIDEXE.Create(keyAppID, pAppId, REG_NONE, REG_OPTION_NON_VOLATILE, KEY_READ | KEY_WRITE) == ERROR_SUCCESS)
00676                 keyAppIDEXE.SetValue(pszFileName);
00677         }
00678         <font class="keywordflow">return</font> S_OK;
00679     }
00680 
<a name="l00681"></a><a class="code" href="classWTL_1_1CServerAppModule.html#a8">00681</a>     HRESULT <a class="code" href="classWTL_1_1CServerAppModule.html#a8">UnregisterAppId</a>(LPCTSTR pAppId)
00682     {
00683         CRegKey keyAppID;
00684         <font class="keywordflow">if</font>(keyAppID.Open(HKEY_CLASSES_ROOT, _T(<font class="stringliteral">"AppID"</font>), KEY_READ) == ERROR_SUCCESS)
00685         {
00686             TCHAR szModule1[_MAX_PATH];
00687             TCHAR szModule2[_MAX_PATH];
00688             TCHAR* pszFileName;
00689             ::GetModuleFileName(GetModuleInstance(), szModule1, _MAX_PATH);
00690             ::GetFullPathName(szModule1, _MAX_PATH, szModule2, &amp;pszFileName);
00691             keyAppID.RecurseDeleteKey(pszFileName);
00692             keyAppID.RecurseDeleteKey(pAppId);
00693         }
00694         <font class="keywordflow">return</font> S_OK;
00695     }
00696 <font class="preprocessor">#endif //(_ATL_VER &lt; 0x0700)</font>
00697 <font class="preprocessor"></font>};
00698 
00699 
00701 <font class="comment">// ATL 3.0 Add-ons</font>
00702 
00703 <font class="comment">// protect template members from windowsx.h macros</font>
00704 <font class="preprocessor">#ifdef _INC_WINDOWSX</font>
00705 <font class="preprocessor"></font><font class="preprocessor">#undef SubclassWindow</font>
00706 <font class="preprocessor"></font><font class="preprocessor">#endif //_INC_WINDOWSX</font>
00707 <font class="preprocessor"></font>
00708 <font class="comment">// define useful macros from windowsx.h</font>
00709 <font class="preprocessor">#ifndef GET_X_LPARAM</font>
<a name="l00710"></a><a class="code" href="atlapp_8h.html#a28">00710</a> <font class="preprocessor"></font><font class="preprocessor">#define GET_X_LPARAM(lParam)    ((int)(short)LOWORD(lParam))</font>
00711 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00712 <font class="preprocessor"></font><font class="preprocessor">#ifndef GET_Y_LPARAM</font>
<a name="l00713"></a><a class="code" href="atlapp_8h.html#a29">00713</a> <font class="preprocessor"></font><font class="preprocessor">#define GET_Y_LPARAM(lParam)    ((int)(short)HIWORD(lParam))</font>
00714 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00715 <font class="preprocessor"></font>
00716 
00718 <font class="comment">// Dual argument helper classes</font>
00719 
00720 <font class="preprocessor">#ifndef _WTL_NO_UNION_CLASSES</font>
00721 <font class="preprocessor"></font>
<a name="l00722"></a><a class="code" href="classWTL_1_1__U__RECT.html">00722</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1__U__RECT.html">_U_RECT</a>
00723 {
00724 <font class="keyword">public</font>:
<a name="l00725"></a><a class="code" href="classWTL_1_1__U__RECT.html#a0">00725</a>     <a class="code" href="classWTL_1_1__U__RECT.html#a0">_U_RECT</a>(LPRECT lpRect) : <a class="code" href="classWTL_1_1__U__RECT.html#m0">m_lpRect</a>(lpRect)
00726     { }
<a name="l00727"></a><a class="code" href="classWTL_1_1__U__RECT.html#a1">00727</a>     <a class="code" href="classWTL_1_1__U__RECT.html#a0">_U_RECT</a>(RECT&amp; rc) : <a class="code" href="classWTL_1_1__U__RECT.html#m0">m_lpRect</a>(&amp;rc)
00728     { }
<a name="l00729"></a><a class="code" href="classWTL_1_1__U__RECT.html#m0">00729</a>     LPRECT <a class="code" href="classWTL_1_1__U__RECT.html#m0">m_lpRect</a>;
00730 };
00731 
<a name="l00732"></a><a class="code" href="classWTL_1_1__U__MENUorID.html">00732</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1__U__MENUorID.html">_U_MENUorID</a>
00733 {
00734 <font class="keyword">public</font>:
<a name="l00735"></a><a class="code" href="classWTL_1_1__U__MENUorID.html#a0">00735</a>     <a class="code" href="classWTL_1_1__U__MENUorID.html#a0">_U_MENUorID</a>(HMENU hMenu) : <a class="code" href="classWTL_1_1__U__MENUorID.html#m0">m_hMenu</a>(hMenu)
00736     { }
<a name="l00737"></a><a class="code" href="classWTL_1_1__U__MENUorID.html#a1">00737</a>     <a class="code" href="classWTL_1_1__U__MENUorID.html#a0">_U_MENUorID</a>(UINT nID) : <a class="code" href="classWTL_1_1__U__MENUorID.html#m0">m_hMenu</a>((HMENU)<a class="code" href="atlapp_8h.html#a15">LongToHandle</a>(nID))
00738     { }
<a name="l00739"></a><a class="code" href="classWTL_1_1__U__MENUorID.html#m0">00739</a>     HMENU <a class="code" href="classWTL_1_1__U__MENUorID.html#m0">m_hMenu</a>;
00740 };
00741 
<a name="l00742"></a><a class="code" href="classWTL_1_1__U__STRINGorID.html">00742</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a>
00743 {
00744 <font class="keyword">public</font>:
<a name="l00745"></a><a class="code" href="classWTL_1_1__U__STRINGorID.html#a0">00745</a>     <a class="code" href="classWTL_1_1__U__STRINGorID.html#a0">_U_STRINGorID</a>(LPCTSTR lpString) : <a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>(lpString)
00746     { }
<a name="l00747"></a><a class="code" href="classWTL_1_1__U__STRINGorID.html#a1">00747</a>     <a class="code" href="classWTL_1_1__U__STRINGorID.html#a0">_U_STRINGorID</a>(UINT nID) : <a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>(MAKEINTRESOURCE(nID))
00748     { }
<a name="l00749"></a><a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">00749</a>     LPCTSTR <a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>;
00750 };
00751 
00752 <font class="preprocessor">#endif </font>
00753 <font class="preprocessor"></font>
00754 <font class="preprocessor"></font>
00756 <font class="comment">// Forward notifications support for message maps</font>
00757 
00758 <font class="preprocessor">#if (_ATL_VER &lt; 0x0700)</font>
00759 <font class="preprocessor"></font>
00760 <font class="comment">// forward notifications support</font>
<a name="l00761"></a><a class="code" href="atlapp_8h.html#a30">00761</a> <font class="preprocessor">#define FORWARD_NOTIFICATIONS() \</font>
00762 <font class="preprocessor">    { \</font>
00763 <font class="preprocessor">        bHandled = TRUE; \</font>
00764 <font class="preprocessor">        lResult = Atl3ForwardNotifications(m_hWnd, uMsg, wParam, lParam, bHandled); \</font>
00765 <font class="preprocessor">        if(bHandled) \</font>
00766 <font class="preprocessor">            return TRUE; \</font>
00767 <font class="preprocessor">    }</font>
00768 <font class="preprocessor"></font>
<a name="l00769"></a><a class="code" href="namespaceWTL.html#a62">00769</a> <font class="keyword">static</font> LRESULT <a class="code" href="namespaceWTL.html#a62">Atl3ForwardNotifications</a>(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam, BOOL&amp; bHandled)
00770 {
00771     LRESULT lResult = 0;
00772     <font class="keywordflow">switch</font>(uMsg)
00773     {
00774     <font class="keywordflow">case</font> WM_COMMAND:
00775     <font class="keywordflow">case</font> WM_NOTIFY:
00776     <font class="keywordflow">case</font> WM_PARENTNOTIFY:
00777     <font class="keywordflow">case</font> WM_DRAWITEM:
00778     <font class="keywordflow">case</font> WM_MEASUREITEM:
00779     <font class="keywordflow">case</font> WM_COMPAREITEM:
00780     <font class="keywordflow">case</font> WM_DELETEITEM:
00781     <font class="keywordflow">case</font> WM_VKEYTOITEM:
00782     <font class="keywordflow">case</font> WM_CHARTOITEM:
00783     <font class="keywordflow">case</font> WM_HSCROLL:
00784     <font class="keywordflow">case</font> WM_VSCROLL:
00785     <font class="keywordflow">case</font> WM_CTLCOLORBTN:
00786     <font class="keywordflow">case</font> WM_CTLCOLORDLG:
00787     <font class="keywordflow">case</font> WM_CTLCOLOREDIT:
00788     <font class="keywordflow">case</font> WM_CTLCOLORLISTBOX:
00789     <font class="keywordflow">case</font> WM_CTLCOLORMSGBOX:
00790     <font class="keywordflow">case</font> WM_CTLCOLORSCROLLBAR:
00791     <font class="keywordflow">case</font> WM_CTLCOLORSTATIC:
00792         lResult = ::SendMessage(::GetParent(hWnd), uMsg, wParam, lParam);
00793         <font class="keywordflow">break</font>;
00794     <font class="keywordflow">default</font>:
00795         bHandled = FALSE;
00796         <font class="keywordflow">break</font>;
00797     }
00798     <font class="keywordflow">return</font> lResult;
00799 }
00800 
00801 
00803 <font class="comment">// Reflected message handler macros for message maps</font>
00804 
<a name="l00805"></a><a class="code" href="atlapp_8h.html#a31">00805</a> <font class="preprocessor">#define REFLECTED_COMMAND_HANDLER(id, code, func) \</font>
00806 <font class="preprocessor">    if(uMsg == OCM_COMMAND &amp;&amp; id == LOWORD(wParam) &amp;&amp; code == HIWORD(wParam)) \</font>
00807 <font class="preprocessor">    { \</font>
00808 <font class="preprocessor">        bHandled = TRUE; \</font>
00809 <font class="preprocessor">        lResult = func(HIWORD(wParam), LOWORD(wParam), (HWND)lParam, bHandled); \</font>
00810 <font class="preprocessor">        if(bHandled) \</font>
00811 <font class="preprocessor">            return TRUE; \</font>
00812 <font class="preprocessor">    }</font>
00813 <font class="preprocessor"></font>
<a name="l00814"></a><a class="code" href="atlapp_8h.html#a32">00814</a> <font class="preprocessor">#define REFLECTED_COMMAND_ID_HANDLER(id, func) \</font>
00815 <font class="preprocessor">    if(uMsg == OCM_COMMAND &amp;&amp; id == LOWORD(wParam)) \</font>
00816 <font class="preprocessor">    { \</font>
00817 <font class="preprocessor">        bHandled = TRUE; \</font>
00818 <font class="preprocessor">        lResult = func(HIWORD(wParam), LOWORD(wParam), (HWND)lParam, bHandled); \</font>
00819 <font class="preprocessor">        if(bHandled) \</font>
00820 <font class="preprocessor">            return TRUE; \</font>
00821 <font class="preprocessor">    }</font>
00822 <font class="preprocessor"></font>
<a name="l00823"></a><a class="code" href="atlapp_8h.html#a33">00823</a> <font class="preprocessor">#define REFLECTED_COMMAND_CODE_HANDLER(code, func) \</font>
00824 <font class="preprocessor">    if(uMsg == OCM_COMMAND &amp;&amp; code == HIWORD(wParam)) \</font>
00825 <font class="preprocessor">    { \</font>
00826 <font class="preprocessor">        bHandled = TRUE; \</font>
00827 <font class="preprocessor">        lResult = func(HIWORD(wParam), LOWORD(wParam), (HWND)lParam, bHandled); \</font>
00828 <font class="preprocessor">        if(bHandled) \</font>
00829 <font class="preprocessor">            return TRUE; \</font>
00830 <font class="preprocessor">    }</font>
00831 <font class="preprocessor"></font>
<a name="l00832"></a><a class="code" href="atlapp_8h.html#a34">00832</a> <font class="preprocessor">#define REFLECTED_COMMAND_RANGE_HANDLER(idFirst, idLast, func) \</font>
00833 <font class="preprocessor">    if(uMsg == OCM_COMMAND &amp;&amp; LOWORD(wParam) &gt;= idFirst  &amp;&amp; LOWORD(wParam) &lt;= idLast) \</font>
00834 <font class="preprocessor">    { \</font>
00835 <font class="preprocessor">        bHandled = TRUE; \</font>
00836 <font class="preprocessor">        lResult = func(HIWORD(wParam), LOWORD(wParam), (HWND)lParam, bHandled); \</font>
00837 <font class="preprocessor">        if(bHandled) \</font>
00838 <font class="preprocessor">            return TRUE; \</font>
00839 <font class="preprocessor">    }</font>
00840 <font class="preprocessor"></font>
<a name="l00841"></a><a class="code" href="atlapp_8h.html#a35">00841</a> <font class="preprocessor">#define REFLECTED_COMMAND_RANGE_CODE_HANDLER(idFirst, idLast, code, func) \</font>
00842 <font class="preprocessor">    if(uMsg == OCM_COMMAND &amp;&amp; code == HIWORD(wParam) &amp;&amp; LOWORD(wParam) &gt;= idFirst  &amp;&amp; LOWORD(wParam) &lt;= idLast) \</font>
00843 <font class="preprocessor">    { \</font>
00844 <font class="preprocessor">        bHandled = TRUE; \</font>
00845 <font class="preprocessor">        lResult = func(HIWORD(wParam), LOWORD(wParam), (HWND)lParam, bHandled); \</font>
00846 <font class="preprocessor">        if(bHandled) \</font>
00847 <font class="preprocessor">            return TRUE; \</font>
00848 <font class="preprocessor">    }</font>
00849 <font class="preprocessor"></font>
<a name="l00850"></a><a class="code" href="atlapp_8h.html#a36">00850</a> <font class="preprocessor">#define REFLECTED_NOTIFY_HANDLER(id, cd, func) \</font>
00851 <font class="preprocessor">    if(uMsg == OCM_NOTIFY &amp;&amp; id == ((LPNMHDR)lParam)-&gt;idFrom &amp;&amp; cd == ((LPNMHDR)lParam)-&gt;code) \</font>
00852 <font class="preprocessor">    { \</font>
00853 <font class="preprocessor">        bHandled = TRUE; \</font>
00854 <font class="preprocessor">        lResult = func((int)wParam, (LPNMHDR)lParam, bHandled); \</font>
00855 <font class="preprocessor">        if(bHandled) \</font>
00856 <font class="preprocessor">            return TRUE; \</font>
00857 <font class="preprocessor">    }</font>
00858 <font class="preprocessor"></font>
<a name="l00859"></a><a class="code" href="atlapp_8h.html#a37">00859</a> <font class="preprocessor">#define REFLECTED_NOTIFY_ID_HANDLER(id, func) \</font>
00860 <font class="preprocessor">    if(uMsg == OCM_NOTIFY &amp;&amp; id == ((LPNMHDR)lParam)-&gt;idFrom) \</font>
00861 <font class="preprocessor">    { \</font>
00862 <font class="preprocessor">        bHandled = TRUE; \</font>
00863 <font class="preprocessor">        lResult = func((int)wParam, (LPNMHDR)lParam, bHandled); \</font>
00864 <font class="preprocessor">        if(bHandled) \</font>
00865 <font class="preprocessor">            return TRUE; \</font>
00866 <font class="preprocessor">    }</font>
00867 <font class="preprocessor"></font>
<a name="l00868"></a><a class="code" href="atlapp_8h.html#a38">00868</a> <font class="preprocessor">#define REFLECTED_NOTIFY_CODE_HANDLER(cd, func) \</font>
00869 <font class="preprocessor">    if(uMsg == OCM_NOTIFY &amp;&amp; cd == ((LPNMHDR)lParam)-&gt;code) \</font>
00870 <font class="preprocessor">    { \</font>
00871 <font class="preprocessor">        bHandled = TRUE; \</font>
00872 <font class="preprocessor">        lResult = func((int)wParam, (LPNMHDR)lParam, bHandled); \</font>
00873 <font class="preprocessor">        if(bHandled) \</font>
00874 <font class="preprocessor">            return TRUE; \</font>
00875 <font class="preprocessor">    }</font>
00876 <font class="preprocessor"></font>
<a name="l00877"></a><a class="code" href="atlapp_8h.html#a39">00877</a> <font class="preprocessor">#define REFLECTED_NOTIFY_RANGE_HANDLER(idFirst, idLast, func) \</font>
00878 <font class="preprocessor">    if(uMsg == OCM_NOTIFY &amp;&amp; ((LPNMHDR)lParam)-&gt;idFrom &gt;= idFirst &amp;&amp; ((LPNMHDR)lParam)-&gt;idFrom &lt;= idLast) \</font>
00879 <font class="preprocessor">    { \</font>
00880 <font class="preprocessor">        bHandled = TRUE; \</font>
00881 <font class="preprocessor">        lResult = func((int)wParam, (LPNMHDR)lParam, bHandled); \</font>
00882 <font class="preprocessor">        if(bHandled) \</font>
00883 <font class="preprocessor">            return TRUE; \</font>
00884 <font class="preprocessor">    }</font>
00885 <font class="preprocessor"></font>
<a name="l00886"></a><a class="code" href="atlapp_8h.html#a40">00886</a> <font class="preprocessor">#define REFLECTED_NOTIFY_RANGE_CODE_HANDLER(idFirst, idLast, cd, func) \</font>
00887 <font class="preprocessor">    if(uMsg == OCM_NOTIFY &amp;&amp; cd == ((LPNMHDR)lParam)-&gt;code &amp;&amp; ((LPNMHDR)lParam)-&gt;idFrom &gt;= idFirst &amp;&amp; ((LPNMHDR)lParam)-&gt;idFrom &lt;= idLast) \</font>
00888 <font class="preprocessor">    { \</font>
00889 <font class="preprocessor">        bHandled = TRUE; \</font>
00890 <font class="preprocessor">        lResult = func((int)wParam, (LPNMHDR)lParam, bHandled); \</font>
00891 <font class="preprocessor">        if(bHandled) \</font>
00892 <font class="preprocessor">            return TRUE; \</font>
00893 <font class="preprocessor">    }</font>
00894 <font class="preprocessor"></font>
00895 <font class="preprocessor">#endif //(_ATL_VER &lt; 0x0700)</font>
00896 <font class="preprocessor"></font>
00898 <font class="comment">// General DLL version helpers (excluded from atlbase.h if _ATL_DLL is defined)</font>
00899 
00900 <font class="preprocessor">#if (_ATL_VER &lt; 0x0700) &amp;&amp; defined(_ATL_DLL)</font>
00901 <font class="preprocessor"></font>
00902 <font class="keyword">inline</font> HRESULT AtlGetDllVersion(HINSTANCE hInstDLL, DLLVERSIONINFO* pDllVersionInfo)
00903 {
00904     ATLASSERT(pDllVersionInfo != NULL);
00905     <font class="keywordflow">if</font>(pDllVersionInfo == NULL)
00906         <font class="keywordflow">return</font> E_INVALIDARG;
00907 
00908     <font class="comment">// We must get this function explicitly because some DLLs don't implement it.</font>
00909     DLLGETVERSIONPROC pfnDllGetVersion = (DLLGETVERSIONPROC)::GetProcAddress(hInstDLL, <font class="stringliteral">"DllGetVersion"</font>);
00910     <font class="keywordflow">if</font>(pfnDllGetVersion == NULL)
00911         <font class="keywordflow">return</font> E_NOTIMPL;
00912 
00913     <font class="keywordflow">return</font> (*pfnDllGetVersion)(pDllVersionInfo);
00914 }
00915 
00916 <font class="keyword">inline</font> HRESULT AtlGetDllVersion(LPCTSTR lpstrDllName, DLLVERSIONINFO* pDllVersionInfo)
00917 {
00918     HINSTANCE hInstDLL = ::LoadLibrary(lpstrDllName);
00919     <font class="keywordflow">if</font>(hInstDLL == NULL)
00920         <font class="keywordflow">return</font> E_FAIL;
00921     HRESULT hRet = AtlGetDllVersion(hInstDLL, pDllVersionInfo);
00922     ::FreeLibrary(hInstDLL);
00923     <font class="keywordflow">return</font> hRet;
00924 }
00925 
00926 <font class="comment">// Common Control Versions:</font>
00927 <font class="comment">//   Win95/WinNT 4.0    maj=4 min=00</font>
00928 <font class="comment">//   IE 3.x     maj=4 min=70</font>
00929 <font class="comment">//   IE 4.0     maj=4 min=71</font>
00930 <font class="keyword">inline</font> HRESULT AtlGetCommCtrlVersion(LPDWORD pdwMajor, LPDWORD pdwMinor)
00931 {
00932     ATLASSERT(pdwMajor != NULL &amp;&amp; pdwMinor != NULL);
00933     <font class="keywordflow">if</font>(pdwMajor == NULL || pdwMinor == NULL)
00934         <font class="keywordflow">return</font> E_INVALIDARG;
00935 
00936     DLLVERSIONINFO dvi;
00937     ::ZeroMemory(&amp;dvi, <font class="keyword">sizeof</font>(dvi));
00938     dvi.cbSize = <font class="keyword">sizeof</font>(dvi);
00939     HRESULT hRet = AtlGetDllVersion(_T(<font class="stringliteral">"comctl32.dll"</font>), &amp;dvi);
00940 
00941     <font class="keywordflow">if</font>(SUCCEEDED(hRet))
00942     {
00943         *pdwMajor = dvi.dwMajorVersion;
00944         *pdwMinor = dvi.dwMinorVersion;
00945     }
00946     <font class="keywordflow">else</font> <font class="keywordflow">if</font>(hRet == E_NOTIMPL)
00947     {
00948         <font class="comment">// If DllGetVersion is not there, then the DLL is a version</font>
00949         <font class="comment">// previous to the one shipped with IE 3.x</font>
00950         *pdwMajor = 4;
00951         *pdwMinor = 0;
00952         hRet = S_OK;
00953     }
00954 
00955     <font class="keywordflow">return</font> hRet;
00956 }
00957 
00958 <font class="comment">// Shell Versions:</font>
00959 <font class="comment">//   Win95/WinNT 4.0                    maj=4 min=00</font>
00960 <font class="comment">//   IE 3.x, IE 4.0 without Web Integrated Desktop  maj=4 min=00</font>
00961 <font class="comment">//   IE 4.0 with Web Integrated Desktop         maj=4 min=71</font>
00962 <font class="comment">//   IE 4.01 with Web Integrated Desktop        maj=4 min=72</font>
00963 <font class="keyword">inline</font> HRESULT AtlGetShellVersion(LPDWORD pdwMajor, LPDWORD pdwMinor)
00964 {
00965     ATLASSERT(pdwMajor != NULL &amp;&amp; pdwMinor != NULL);
00966     <font class="keywordflow">if</font>(pdwMajor == NULL || pdwMinor == NULL)
00967         <font class="keywordflow">return</font> E_INVALIDARG;
00968 
00969     DLLVERSIONINFO dvi;
00970     ::ZeroMemory(&amp;dvi, <font class="keyword">sizeof</font>(dvi));
00971     dvi.cbSize = <font class="keyword">sizeof</font>(dvi);
00972     HRESULT hRet = AtlGetDllVersion(_T(<font class="stringliteral">"shell32.dll"</font>), &amp;dvi);
00973 
00974     <font class="keywordflow">if</font>(SUCCEEDED(hRet))
00975     {
00976         *pdwMajor = dvi.dwMajorVersion;
00977         *pdwMinor = dvi.dwMinorVersion;
00978     }
00979     <font class="keywordflow">else</font> <font class="keywordflow">if</font>(hRet == E_NOTIMPL)
00980     {
00981         <font class="comment">// If DllGetVersion is not there, then the DLL is a version</font>
00982         <font class="comment">// previous to the one shipped with IE 4.x</font>
00983         *pdwMajor = 4;
00984         *pdwMinor = 0;
00985         hRet = S_OK;
00986     }
00987 
00988     <font class="keywordflow">return</font> hRet;
00989 }
00990 
00991 <font class="preprocessor">#endif //(_ATL_VER &lt; 0x0700) &amp;&amp; defined(_ATL_DLL)</font>
00992 <font class="preprocessor"></font>
00994 <font class="comment">// 32-bit (alpha channel) bitmap resource helper</font>
00995 
00996 <font class="comment">// Note: 32-bit (alpha channel) images work only on Windows XP with Common Controls version 6.</font>
00997 <font class="comment">// If you want your app to work on older version of Windows, load non-alpha images if Common</font>
00998 <font class="comment">// Controls version is less than 6.</font>
00999 
<a name="l01000"></a><a class="code" href="namespaceWTL.html#a63">01000</a> <font class="keyword">inline</font> <font class="keywordtype">bool</font> <a class="code" href="namespaceWTL.html#a63">AtlIsAlphaBitmapResource</a>(<a class="code" href="classWTL_1_1__U__STRINGorID.html">_U_STRINGorID</a> image)
01001 {
01002     HRSRC hResource = ::FindResource(_pModule-&gt;GetResourceInstance(), image.<a class="code" href="classWTL_1_1__U__STRINGorID.html#m0">m_lpstr</a>, RT_BITMAP);
01003     ATLASSERT(hResource != NULL);
01004     HGLOBAL hGlobal = ::LoadResource(_pModule-&gt;GetResourceInstance(), hResource);
01005     ATLASSERT(hGlobal != NULL);
01006     LPBITMAPINFOHEADER pBitmapInfoHeader = (LPBITMAPINFOHEADER)::LockResource(hGlobal);
01007     ATLASSERT(pBitmapInfoHeader != NULL);
01008     <font class="keywordflow">return</font> (pBitmapInfoHeader-&gt;biBitCount == 32);
01009 }
01010 
01012 <font class="comment">// CString forward reference (enables CString use in atluser.h and atlgdi.h)</font>
01013 
01014 <font class="preprocessor">#if defined(_WTL_FORWARD_DECLARE_CSTRING) &amp;&amp; !defined(_WTL_USE_CSTRING)</font>
01015 <font class="preprocessor"></font><font class="preprocessor">#define _WTL_USE_CSTRING</font>
01016 <font class="preprocessor"></font><font class="preprocessor">#endif //defined(_WTL_FORWARD_DECLARE_CSTRING) &amp;&amp; !defined(_WTL_USE_CSTRING)</font>
01017 <font class="preprocessor"></font>
01018 <font class="preprocessor">#ifdef _WTL_USE_CSTRING</font>
01019 <font class="preprocessor"></font><font class="keyword">class </font>CString;  <font class="comment">// forward declaration (include atlmisc.h for the whole class)</font>
01020 <font class="preprocessor">#endif //_WTL_USE_CSTRING</font>
01021 <font class="preprocessor"></font>
01022 }; <font class="comment">//namespace WTL</font>
01023 
01024 <font class="comment">// These are always included</font>
01025 <font class="preprocessor">#include &lt;<a class="code" href="atluser_8h.html">atluser.h</a>&gt;</font>
01026 <font class="preprocessor">#include &lt;<a class="code" href="atlgdi_8h.html">atlgdi.h</a>&gt;</font>
01027 
01028 <font class="preprocessor">#ifndef _WTL_NO_AUTOMATIC_NAMESPACE</font>
01029 <font class="preprocessor"></font><font class="keyword">using</font> <font class="keyword">namespace </font>WTL;
01030 <font class="preprocessor">#endif </font>
01031 <font class="preprocessor"></font>
01032 <font class="preprocessor"></font><font class="preprocessor">#endif // __ATLAPP_H__</font>
</pre></div><hr><address align="right"><small>Generated on Thu Apr 11 21:09:28 2002 for wtl-doc by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
