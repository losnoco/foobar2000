<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>atlprint.h Source File</title>
<link href="mystyles.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>atlprint.h</h1><a href="atlprint_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Windows Template Library - WTL version 7.0</font>
00002 <font class="comment">// Copyright (C) 1997-2002 Microsoft Corporation</font>
00003 <font class="comment">// All rights reserved.</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// This file is a part of the Windows Template Library.</font>
00006 <font class="comment">// The code and information is provided "as-is" without</font>
00007 <font class="comment">// warranty of any kind, either expressed or implied.</font>
00008 
00009 <font class="preprocessor">#ifndef __ATLPRINT_H__</font>
00010 <font class="preprocessor"></font><font class="preprocessor">#define __ATLPRINT_H__</font>
00011 <font class="preprocessor"></font>
00012 <font class="preprocessor">#pragma once</font>
00013 <font class="preprocessor"></font>
00014 <font class="preprocessor">#ifndef __cplusplus</font>
00015 <font class="preprocessor"></font><font class="preprocessor">    #error ATL requires C++ compilation (use a .cpp suffix)</font>
00016 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00017 <font class="preprocessor"></font>
00018 <font class="preprocessor">#ifndef __ATLAPP_H__</font>
00019 <font class="preprocessor"></font><font class="preprocessor">    #error atlprint.h requires atlapp.h to be included first</font>
00020 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00021 <font class="preprocessor"></font>
00022 <font class="preprocessor">#ifndef __ATLWIN_H__</font>
00023 <font class="preprocessor"></font><font class="preprocessor">    #error atlprint.h requires atlwin.h to be included first</font>
00024 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00025 <font class="preprocessor"></font>
00026 
00028 <font class="comment">// Classes in this file</font>
00029 <font class="comment">//</font>
00030 <font class="comment">// CPrinterInfo&lt;t_nInfo&gt;</font>
00031 <font class="comment">// CPrinterT&lt;t_bManaged&gt;</font>
00032 <font class="comment">// CDevModeT&lt;t_bManaged&gt;</font>
00033 <font class="comment">// CPrinterDC</font>
00034 <font class="comment">// CPrintJobInfo</font>
00035 <font class="comment">// CPrintJob</font>
00036 <font class="comment">// CPrintPreview</font>
00037 <font class="comment">// CPrintPreviewWindowImpl&lt;T, TBase, TWinTraits&gt;</font>
00038 <font class="comment">// CPrintPreviewWindow</font>
00039 
00040 
00041 <font class="keyword">namespace </font>WTL
00042 {
00043 
00045 
00046 <font class="keyword">template</font> &lt;<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> t_nInfo&gt;
<a name="l00047"></a><a class="code" href="classWTL_1_1__printer__info.html">00047</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>
00048 {
00049 <font class="keyword">public</font>:
<a name="l00050"></a><a class="code" href="classWTL_1_1__printer__info.html#s0">00050</a>     <font class="keyword">typedef</font> <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>;
00051 };
00052 
<a name="l00053"></a><a class="code" href="classWTL_1_1__printer__info_3_011_01_4.html#s0">00053</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;1&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_1 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
<a name="l00054"></a><a class="code" href="classWTL_1_1__printer__info_3_012_01_4.html#s0">00054</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;2&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_2 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
<a name="l00055"></a><a class="code" href="classWTL_1_1__printer__info_3_013_01_4.html#s0">00055</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;3&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_3 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
<a name="l00056"></a><a class="code" href="classWTL_1_1__printer__info_3_014_01_4.html#s0">00056</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;4&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_4 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
<a name="l00057"></a><a class="code" href="classWTL_1_1__printer__info_3_015_01_4.html#s0">00057</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;5&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_5 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
<a name="l00058"></a><a class="code" href="classWTL_1_1__printer__info_3_016_01_4.html#s0">00058</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;6&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_6 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
<a name="l00059"></a><a class="code" href="classWTL_1_1__printer__info_3_017_01_4.html#s0">00059</a> <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font><a class="code" href="classWTL_1_1__printer__info.html">_printer_info</a>&lt;7&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_7 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
00060 <font class="comment">// these are not in the old (vc6.0) headers</font>
00061 <font class="preprocessor">#ifdef _ATL_USE_NEW_PRINTER_INFO</font>
00062 <font class="preprocessor"></font><font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font>_printer_info&lt;8&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_8 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
00063 <font class="keyword">template</font> &lt;&gt; <font class="keyword">class </font>_printer_info&lt;9&gt; { <font class="keyword">public</font>: <font class="keyword">typedef</font> PRINTER_INFO_9 <a class="code" href="classWTL_1_1__printer__info.html#s0">infotype</a>; };
00064 <font class="preprocessor">#endif //_ATL_USE_NEW_PRINTER_INFO</font>
00065 <font class="preprocessor"></font>
00066 <font class="comment">//This class wraps all of the PRINTER_INFO_* structures</font>
00067 <font class="comment">//and provided by ::GetPrinter.</font>
00068 <font class="keyword">template</font> &lt;<font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> t_nInfo&gt;
<a name="l00069"></a><a class="code" href="classWTL_1_1CPrinterInfo.html">00069</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo</a>
00070 {
00071 <font class="keyword">public</font>:
00072 <font class="comment">// Data members</font>
<a name="l00073"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#m0">00073</a>     <a class="code" href="classWTL_1_1__printer__info.html">_printer_info&lt;t_nInfo&gt;</a>::infotype* <a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>;
00074 
00075 <font class="comment">// Constructor/destructor</font>
<a name="l00076"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#a0">00076</a>     <a class="code" href="classWTL_1_1CPrinterInfo.html#a0">CPrinterInfo</a>() : m_pi(NULL)
00077     { }
<a name="l00078"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#a1">00078</a>     <a class="code" href="classWTL_1_1CPrinterInfo.html#a0">CPrinterInfo</a>(HANDLE hPrinter) : m_pi(NULL)
00079     {
00080         <a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(hPrinter);
00081     }
<a name="l00082"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#a2">00082</a>     <a class="code" href="classWTL_1_1CPrinterInfo.html#a2">~CPrinterInfo</a>()
00083     {
00084         <a class="code" href="classWTL_1_1CPrinterInfo.html#a4">Cleanup</a>();
00085     }
00086 
00087 <font class="comment">// Operations</font>
<a name="l00088"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#a3">00088</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(HANDLE hPrinter)
00089     {
00090         <a class="code" href="classWTL_1_1CPrinterInfo.html#a4">Cleanup</a>();
00091         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPrinterInfo.html#d0">GetPrinterInfoHelper</a>(hPrinter, (BYTE**)&amp;m_pi, t_nInfo);
00092     }
00093 
00094 <font class="comment">// Implementation</font>
<a name="l00095"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#a4">00095</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrinterInfo.html#a4">Cleanup</a>()
00096     {
00097         <font class="keyword">delete</font> [] (BYTE*)m_pi;
00098         m_pi = NULL;
00099     }
<a name="l00100"></a><a class="code" href="classWTL_1_1CPrinterInfo.html#d0">00100</a>     <font class="keyword">static</font> <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterInfo.html#d0">GetPrinterInfoHelper</a>(HANDLE hPrinter, BYTE** pi, <font class="keywordtype">int</font> nIndex)
00101     {
00102         ATLASSERT(pi != NULL);
00103         DWORD dw = 0;
00104         BYTE* pb = NULL;
00105         ::GetPrinter(hPrinter, nIndex, NULL, 0, &amp;dw);
00106         <font class="keywordflow">if</font> (dw &gt; 0)
00107         {
00108             ATLTRY(pb = <font class="keyword">new</font> BYTE[dw]);
00109             <font class="keywordflow">if</font> (pb != NULL)
00110             {
00111                 memset(pb, 0, dw);
00112                 DWORD dwNew;
00113                 <font class="keywordflow">if</font> (!::GetPrinter(hPrinter, nIndex, pb, dw, &amp;dwNew))
00114                 {
00115                     <font class="keyword">delete</font> [] pb;
00116                     pb = NULL;
00117                 }
00118             }
00119         }
00120         *pi = pb;
00121         <font class="keywordflow">return</font> (pb != NULL);
00122     }
00123 };
00124 
00125 <font class="comment">//Provides a wrapper class for a HANDLE to a printer.</font>
00126 <font class="keyword">template</font> &lt;<font class="keywordtype">bool</font> t_bManaged&gt;
<a name="l00127"></a><a class="code" href="classWTL_1_1CPrinterT.html">00127</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrinterT.html">CPrinterT</a>
00128 {
00129 <font class="keyword">public</font>:
00130 <font class="comment">// Data members</font>
<a name="l00131"></a><a class="code" href="classWTL_1_1CPrinterT.html#m0">00131</a>     HANDLE <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>;
00132 
00133 <font class="comment">// Constructor/destructor</font>
<a name="l00134"></a><a class="code" href="classWTL_1_1CPrinterT.html#a0">00134</a>     <a class="code" href="classWTL_1_1CPrinterT.html#a0">CPrinterT</a>(HANDLE hPrinter = NULL) : <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>(hPrinter)
00135     { }
00136 
<a name="l00137"></a><a class="code" href="classWTL_1_1CPrinterT.html#a1">00137</a>     <a class="code" href="classWTL_1_1CPrinterT.html#a1">~CPrinterT</a>()
00138     {
00139         <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>();
00140     }
00141 
00142 <font class="comment">// Operations</font>
<a name="l00143"></a><a class="code" href="classWTL_1_1CPrinterT.html#a2">00143</a>     <a class="code" href="classWTL_1_1CPrinterT.html">CPrinterT</a>&amp; <a class="code" href="classWTL_1_1CPrinterT.html#a2">operator=</a>(HANDLE hPrinter)
00144     {
00145         <font class="keywordflow">if</font> (hPrinter != <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>)
00146         {
00147             <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>();
00148             <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> = hPrinter;
00149         }
00150         <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00151     }
00152 
<a name="l00153"></a><a class="code" href="classWTL_1_1CPrinterT.html#a3">00153</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterT.html#a3">IsNull</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> (<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> == NULL); }
00154 
<a name="l00155"></a><a class="code" href="classWTL_1_1CPrinterT.html#a4">00155</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterT.html#a4">OpenPrinter</a>(HANDLE hDevNames, <font class="keyword">const</font> DEVMODE* pDevMode = NULL)
00156     {
00157         <font class="keywordtype">bool</font> b = <font class="keyword">false</font>;
00158         DEVNAMES* pdn = (DEVNAMES*)::GlobalLock(hDevNames);
00159         <font class="keywordflow">if</font> (pdn != NULL)
00160         {
00161             LPTSTR lpszPrinterName = (LPTSTR)pdn + pdn-&gt;wDeviceOffset;
00162             b = <a class="code" href="classWTL_1_1CPrinterT.html#a4">OpenPrinter</a>(lpszPrinterName, pDevMode);
00163             ::GlobalUnlock(hDevNames);
00164         }
00165         <font class="keywordflow">return</font> b;
00166     }
<a name="l00167"></a><a class="code" href="classWTL_1_1CPrinterT.html#a5">00167</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterT.html#a4">OpenPrinter</a>(LPCTSTR lpszPrinterName, <font class="keyword">const</font> DEVMODE* pDevMode = NULL)
00168     {
00169         <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>();
00170         PRINTER_DEFAULTS pdefs = { NULL, (DEVMODE*)pDevMode, PRINTER_ACCESS_USE };
00171         ::OpenPrinter((LPTSTR) lpszPrinterName, &amp;<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>, (pDevMode == NULL) ? NULL : &amp;pdefs);
00172 
00173         <font class="keywordflow">return</font> (<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> != NULL);
00174     }
<a name="l00175"></a><a class="code" href="classWTL_1_1CPrinterT.html#a6">00175</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterT.html#a4">OpenPrinter</a>(LPCTSTR lpszPrinterName, PRINTER_DEFAULTS* pprintdefs)
00176     {
00177         <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>();
00178         ::OpenPrinter((LPTSTR) lpszPrinterName, &amp;<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>, pprintdefs);
00179         <font class="keywordflow">return</font> (<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> != NULL);
00180     }
<a name="l00181"></a><a class="code" href="classWTL_1_1CPrinterT.html#a7">00181</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterT.html#a7">OpenDefaultPrinter</a>(<font class="keyword">const</font> DEVMODE* pDevMode = NULL)
00182     {
00183         <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>();
00184         TCHAR buffer[512];
00185         buffer[0] = 0;
00186         ::GetProfileString(_T(<font class="stringliteral">"windows"</font>), _T(<font class="stringliteral">"device"</font>), _T(<font class="stringliteral">",,,"</font>), buffer, <font class="keyword">sizeof</font>(buffer));
00187         <font class="keywordtype">int</font> nLen = lstrlen(buffer);
00188         <font class="keywordflow">if</font> (nLen != 0)
00189         {
00190             LPTSTR lpsz = buffer;
00191             <font class="keywordflow">while</font> (*lpsz)
00192             {
00193                 <font class="keywordflow">if</font> (*lpsz == <font class="charliteral">','</font>)
00194                 {
00195                     *lpsz = 0;
00196                     <font class="keywordflow">break</font>;
00197                 }
00198                 lpsz = CharNext(lpsz);
00199             }
00200             PRINTER_DEFAULTS pdefs = { NULL, (DEVMODE*)pDevMode, PRINTER_ACCESS_USE };
00201             ::OpenPrinter(buffer, &amp;<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>, (pDevMode == NULL) ? NULL : &amp;pdefs);
00202         }
00203         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> != NULL;
00204     }
<a name="l00205"></a><a class="code" href="classWTL_1_1CPrinterT.html#a8">00205</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>()
00206     {
00207         <font class="keywordflow">if</font> (<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> != NULL)
00208         {
00209             <font class="keywordflow">if</font> (t_bManaged)
00210                 ::ClosePrinter(m_hPrinter);
00211             <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> = NULL;
00212         }
00213     }
00214 
<a name="l00215"></a><a class="code" href="classWTL_1_1CPrinterT.html#a9">00215</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrinterT.html#a9">PrinterProperties</a>(HWND hWnd = NULL)
00216     {
00217         <font class="keywordflow">if</font> (hWnd == NULL)
00218             hWnd = ::GetActiveWindow();
00219         <font class="keywordflow">return</font> !!::PrinterProperties(hWnd, <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>);
00220     }
<a name="l00221"></a><a class="code" href="classWTL_1_1CPrinterT.html#a10">00221</a>     HANDLE <a class="code" href="classWTL_1_1CPrinterT.html#a10">CopyToHDEVNAMES</a>()<font class="keyword"> const</font>
00222 <font class="keyword">    </font>{
00223         HANDLE h = NULL;
00224         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;5&gt;</a> pinfon5;
00225         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;2&gt;</a> pinfon2;
00226         LPTSTR lpszPrinterName = NULL;
00227         <font class="comment">//Some printers fail for PRINTER_INFO_5 in some situations</font>
00228         <font class="keywordflow">if</font> (pinfon5.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>))
00229             lpszPrinterName = pinfon5.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pPrinterName;
00230         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (pinfon2.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>))
00231             lpszPrinterName = pinfon2.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pPrinterName;
00232         <font class="keywordflow">if</font> (lpszPrinterName != NULL)
00233         {
00234             <font class="keywordtype">int</font> nLen = <font class="keyword">sizeof</font>(DEVNAMES) + (lstrlen(lpszPrinterName) + 1) * <font class="keyword">sizeof</font>(TCHAR);
00235             h = ::GlobalAlloc(GMEM_MOVEABLE, nLen);
00236             BYTE* pv = (BYTE*)::GlobalLock(h);
00237             DEVNAMES* pdev = (DEVNAMES*)pv;
00238             <font class="keywordflow">if</font> (pv != NULL)
00239             {
00240                 memset(pv, 0, nLen);
00241                 pdev-&gt;wDeviceOffset = <font class="keyword">sizeof</font>(DEVNAMES)/<font class="keyword">sizeof</font>(TCHAR);
00242                 pv = pv + <font class="keyword">sizeof</font>(DEVNAMES); <font class="comment">//now points to end</font>
00243                 lstrcpy((LPTSTR)pv, lpszPrinterName);
00244                 ::GlobalUnlock(h);
00245             }
00246         }
00247         <font class="keywordflow">return</font> h;
00248     }
<a name="l00249"></a><a class="code" href="classWTL_1_1CPrinterT.html#a11">00249</a>     HDC <a class="code" href="classWTL_1_1CPrinterT.html#a11">CreatePrinterDC</a>(<font class="keyword">const</font> DEVMODE* pdm = NULL)
00250     {
00251         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;5&gt;</a> pinfo5;
00252         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;2&gt;</a> pinfo2;
00253         HDC hDC = NULL;
00254         LPTSTR lpszPrinterName = NULL;
00255         <font class="comment">//Some printers fail for PRINTER_INFO_5 in some situations</font>
00256         <font class="keywordflow">if</font> (pinfo5.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>))
00257             lpszPrinterName = pinfo5.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pPrinterName;
00258         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (pinfo2.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>))
00259             lpszPrinterName = pinfo2.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pPrinterName;
00260         <font class="keywordflow">if</font> (lpszPrinterName != NULL)
00261             hDC = ::CreateDC(NULL, lpszPrinterName, NULL, pdm);
00262         <font class="keywordflow">return</font> hDC;
00263     }
<a name="l00264"></a><a class="code" href="classWTL_1_1CPrinterT.html#a12">00264</a>     HDC <a class="code" href="classWTL_1_1CPrinterT.html#a12">CreatePrinterIC</a>(<font class="keyword">const</font> DEVMODE* pdm = NULL)
00265     {
00266         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;5&gt;</a> pinfo5;
00267         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;2&gt;</a> pinfo2;
00268         HDC hDC = NULL;
00269         LPTSTR lpszPrinterName = NULL;
00270         <font class="comment">//Some printers fail for PRINTER_INFO_5 in some situations</font>
00271         <font class="keywordflow">if</font> (pinfo5.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>))
00272             lpszPrinterName = pinfo5.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pPrinterName;
00273         <font class="keywordflow">else</font> <font class="keywordflow">if</font> (pinfo2.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(<a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>))
00274             lpszPrinterName = pinfo2.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pPrinterName;
00275         <font class="keywordflow">if</font> (lpszPrinterName != NULL)
00276             hDC = ::CreateIC(NULL, lpszPrinterName, NULL, pdm);
00277         <font class="keywordflow">return</font> hDC;
00278     }
00279 
<a name="l00280"></a><a class="code" href="classWTL_1_1CPrinterT.html#a13">00280</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrinterT.html#a13">Attach</a>(HANDLE hPrinter)
00281     {
00282         <a class="code" href="classWTL_1_1CPrinterT.html#a8">ClosePrinter</a>();
00283         <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> = hPrinter;
00284     }
00285 
<a name="l00286"></a><a class="code" href="classWTL_1_1CPrinterT.html#a14">00286</a>     HANDLE <a class="code" href="classWTL_1_1CPrinterT.html#a14">Detach</a>()
00287     {
00288         HANDLE hPrinter = <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>;
00289         <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a> = NULL;
00290         <font class="keywordflow">return</font> hPrinter;
00291     }
<a name="l00292"></a><a class="code" href="classWTL_1_1CPrinterT.html#a15">00292</a>     <a class="code" href="classWTL_1_1CPrinterT.html#a15">operator HANDLE</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPrinterT.html#m0">m_hPrinter</a>; }
00293 };
00294 
<a name="l00295"></a><a class="code" href="namespaceWTL.html#a51">00295</a> <font class="keyword">typedef</font> <a class="code" href="classWTL_1_1CPrinterT.html">CPrinterT&lt;false&gt;</a>    <a class="code" href="namespaceWTL.html#a51">CPrinterHandle</a>;
<a name="l00296"></a><a class="code" href="namespaceWTL.html#a52">00296</a> <font class="keyword">typedef</font> <a class="code" href="classWTL_1_1CPrinterT.html">CPrinterT&lt;true&gt;</a>     <a class="code" href="namespaceWTL.html#a52">CPrinter</a>;
00297 
00298 
00299 <font class="keyword">template</font> &lt;<font class="keywordtype">bool</font> t_bManaged&gt;
<a name="l00300"></a><a class="code" href="classWTL_1_1CDevModeT.html">00300</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CDevModeT.html">CDevModeT</a>
00301 {
00302 <font class="keyword">public</font>:
00303 <font class="comment">// Data members</font>
<a name="l00304"></a><a class="code" href="classWTL_1_1CDevModeT.html#m0">00304</a>     HANDLE <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a>;
<a name="l00305"></a><a class="code" href="classWTL_1_1CDevModeT.html#m1">00305</a>     DEVMODE* <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>;
00306 
00307 <font class="comment">// Constructor/destructor</font>
<a name="l00308"></a><a class="code" href="classWTL_1_1CDevModeT.html#a0">00308</a>     <a class="code" href="classWTL_1_1CDevModeT.html#a0">CDevModeT</a>(HANDLE hDevMode = NULL) : <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a>(hDevMode)
00309     {
00310         <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a> = (<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> != NULL) ? (DEVMODE*)::GlobalLock(m_hDevMode) : NULL;
00311     }
<a name="l00312"></a><a class="code" href="classWTL_1_1CDevModeT.html#a1">00312</a>     <a class="code" href="classWTL_1_1CDevModeT.html#a1">~CDevModeT</a>()
00313     {
00314         <a class="code" href="classWTL_1_1CDevModeT.html#a14">Cleanup</a>();
00315     }
00316 
00317 <font class="comment">// Operations</font>
<a name="l00318"></a><a class="code" href="classWTL_1_1CDevModeT.html#a2">00318</a>     <a class="code" href="classWTL_1_1CDevModeT.html">CDevModeT&lt;t_bManaged&gt;</a>&amp; <a class="code" href="classWTL_1_1CDevModeT.html#a2">operator=</a>(HANDLE hDevMode)
00319     {
00320         <a class="code" href="classWTL_1_1CDevModeT.html#a3">Attach</a>(hDevMode);
00321         <font class="keywordflow">return</font> *<font class="keyword">this</font>;
00322     }
00323 
<a name="l00324"></a><a class="code" href="classWTL_1_1CDevModeT.html#a3">00324</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CDevModeT.html#a3">Attach</a>(HANDLE hDevModeNew)
00325     {
00326         <a class="code" href="classWTL_1_1CDevModeT.html#a14">Cleanup</a>();
00327         <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> = hDevModeNew;
00328         <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a> = (<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> != NULL) ? (DEVMODE*)::GlobalLock(m_hDevMode) : NULL;
00329     }
00330 
<a name="l00331"></a><a class="code" href="classWTL_1_1CDevModeT.html#a4">00331</a>     HANDLE <a class="code" href="classWTL_1_1CDevModeT.html#a4">Detach</a>()
00332     {
00333         <font class="keywordflow">if</font> (<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> != NULL)
00334             ::GlobalUnlock(m_hDevMode);
00335         HANDLE hDevMode = <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a>;
00336         <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> = NULL;
00337         <font class="keywordflow">return</font> hDevMode;
00338     }
00339 
<a name="l00340"></a><a class="code" href="classWTL_1_1CDevModeT.html#a5">00340</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CDevModeT.html#a5">IsNull</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> (<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> == NULL); }
00341 
<a name="l00342"></a><a class="code" href="classWTL_1_1CDevModeT.html#a6">00342</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CDevModeT.html#a6">CopyFromPrinter</a>(HANDLE hPrinter)
00343     {
00344         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;2&gt;</a> pinfo;
00345         <font class="keywordtype">bool</font> b = pinfo.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(hPrinter);
00346         <font class="keywordflow">if</font> (b)
00347          b = <a class="code" href="classWTL_1_1CDevModeT.html#a7">CopyFromDEVMODE</a>(pinfo.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pDevMode);
00348         <font class="keywordflow">return</font> b;
00349     }
<a name="l00350"></a><a class="code" href="classWTL_1_1CDevModeT.html#a7">00350</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CDevModeT.html#a7">CopyFromDEVMODE</a>(<font class="keyword">const</font> DEVMODE* pdm)
00351     {
00352         <font class="keywordflow">if</font> (pdm == NULL)
00353             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00354         <font class="keywordtype">int</font> nSize = pdm-&gt;dmSize + pdm-&gt;dmDriverExtra;
00355         HANDLE h = ::GlobalAlloc(GMEM_MOVEABLE, nSize);
00356         <font class="keywordflow">if</font> (h != NULL)
00357         {
00358             <font class="keywordtype">void</font>* p = ::GlobalLock(h);
00359             memcpy(p, pdm, nSize);
00360             ::GlobalUnlock(h);
00361         }
00362         <a class="code" href="classWTL_1_1CDevModeT.html#a3">Attach</a>(h);
00363         <font class="keywordflow">return</font> (h != NULL);
00364     }
<a name="l00365"></a><a class="code" href="classWTL_1_1CDevModeT.html#a8">00365</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CDevModeT.html#a8">CopyFromHDEVMODE</a>(HANDLE hdm)
00366     {
00367         <font class="keywordtype">bool</font> b = <font class="keyword">false</font>;
00368         <font class="keywordflow">if</font> (hdm != NULL)
00369         {
00370             DEVMODE* pdm = (DEVMODE*)GlobalLock(hdm);
00371             b = <a class="code" href="classWTL_1_1CDevModeT.html#a7">CopyFromDEVMODE</a>(pdm);
00372             GlobalUnlock(hdm);
00373         }
00374         <font class="keywordflow">return</font> b;
00375     }
<a name="l00376"></a><a class="code" href="classWTL_1_1CDevModeT.html#a9">00376</a>     HANDLE <a class="code" href="classWTL_1_1CDevModeT.html#a9">CopyToHDEVMODE</a>()
00377     {
00378         <font class="keywordflow">if</font> ((<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> == NULL) || (<a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a> == NULL))
00379             <font class="keywordflow">return</font> NULL;
00380         <font class="keywordtype">int</font> nSize = <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>-&gt;dmSize + <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>-&gt;dmDriverExtra;
00381         HANDLE h = GlobalAlloc(GMEM_MOVEABLE, nSize);
00382         <font class="keywordflow">if</font> (h != NULL)
00383         {
00384             <font class="keywordtype">void</font>* p = GlobalLock(h);
00385             memcpy(p, <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>, nSize);
00386         }
00387         <font class="keywordflow">return</font> h;
00388     }
00389     <font class="comment">// If this devmode was for another printer, this will create a new devmode</font>
00390     <font class="comment">// based on the existing devmode, but retargeted at the new printer</font>
<a name="l00391"></a><a class="code" href="classWTL_1_1CDevModeT.html#a10">00391</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CDevModeT.html#a10">UpdateForNewPrinter</a>(HANDLE hPrinter)
00392     {
00393         LONG nLen = ::DocumentProperties(NULL, hPrinter, NULL, NULL, NULL, 0);
00394         DEVMODE* pdm = (DEVMODE*)_alloca(nLen);
00395         memset(pdm, 0, nLen);
00396         LONG l = ::DocumentProperties(NULL, hPrinter, NULL, pdm, <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>, DM_IN_BUFFER | DM_OUT_BUFFER);
00397         <font class="keywordtype">bool</font> b = <font class="keyword">false</font>;
00398         <font class="keywordflow">if</font> (l == IDOK)
00399             b = <a class="code" href="classWTL_1_1CDevModeT.html#a7">CopyFromDEVMODE</a>(pdm);
00400         <font class="keywordflow">return</font> b;
00401     }
<a name="l00402"></a><a class="code" href="classWTL_1_1CDevModeT.html#a11">00402</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CDevModeT.html#a11">DocumentProperties</a>(HANDLE hPrinter, HWND hWnd = NULL)
00403     {
00404         <a class="code" href="classWTL_1_1CPrinterInfo.html">CPrinterInfo&lt;1&gt;</a> pi;
00405         pi.<a class="code" href="classWTL_1_1CPrinterInfo.html#a3">GetPrinterInfo</a>(hPrinter);
00406         <font class="keywordflow">if</font> (hWnd == NULL)
00407             hWnd = ::GetActiveWindow();
00408 
00409         LONG nLen = ::DocumentProperties(hWnd, hPrinter, pi.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pName, NULL, NULL, 0);
00410         DEVMODE* pdm = (DEVMODE*)_alloca(nLen);
00411         memset(pdm, 0, nLen);
00412         LONG l = ::DocumentProperties(hWnd, hPrinter, pi.<a class="code" href="classWTL_1_1CPrinterInfo.html#m0">m_pi</a>-&gt;pName, pdm, <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>, DM_IN_BUFFER | DM_OUT_BUFFER | DM_PROMPT);
00413         <font class="keywordtype">bool</font> b = <font class="keyword">false</font>;
00414         <font class="keywordflow">if</font> (l == IDOK)
00415             b = <a class="code" href="classWTL_1_1CDevModeT.html#a7">CopyFromDEVMODE</a>(pdm);
00416         <font class="keywordflow">return</font> b;
00417     }
<a name="l00418"></a><a class="code" href="classWTL_1_1CDevModeT.html#a12">00418</a>     <a class="code" href="classWTL_1_1CDevModeT.html#a12">operator HANDLE</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a>; }
<a name="l00419"></a><a class="code" href="classWTL_1_1CDevModeT.html#a13">00419</a>     <a class="code" href="classWTL_1_1CDevModeT.html#a13">operator DEVMODE*</a>()<font class="keyword"> const </font>{ <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CDevModeT.html#m1">m_pDevMode</a>; }
00420 
00421 <font class="comment">// Implementation</font>
<a name="l00422"></a><a class="code" href="classWTL_1_1CDevModeT.html#a14">00422</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CDevModeT.html#a14">Cleanup</a>()
00423     {
00424         <font class="keywordflow">if</font> (<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> != NULL)
00425         {
00426             GlobalUnlock(<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a>);
00427             <font class="keywordflow">if</font>(t_bManaged)
00428                 GlobalFree(<a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a>);
00429             <a class="code" href="classWTL_1_1CDevModeT.html#m0">m_hDevMode</a> = NULL;
00430         }
00431     }
00432 };
00433 
<a name="l00434"></a><a class="code" href="namespaceWTL.html#a53">00434</a> <font class="keyword">typedef</font> <a class="code" href="classWTL_1_1CDevModeT.html">CDevModeT&lt;false&gt;</a>    <a class="code" href="namespaceWTL.html#a53">CDevModeHandle</a>;
<a name="l00435"></a><a class="code" href="namespaceWTL.html#a54">00435</a> <font class="keyword">typedef</font> <a class="code" href="classWTL_1_1CDevModeT.html">CDevModeT&lt;true&gt;</a>     <a class="code" href="namespaceWTL.html#a54">CDevMode</a>;
00436 
00437 
<a name="l00438"></a><a class="code" href="classWTL_1_1CPrinterDC.html">00438</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrinterDC.html">CPrinterDC</a> : <font class="keyword">public</font> <a class="code" href="namespaceWTL.html#a48">CDC</a>
00439 {
00440 <font class="keyword">public</font>:
00441 <font class="comment">// Constructors/destructor</font>
<a name="l00442"></a><a class="code" href="classWTL_1_1CPrinterDC.html#a0">00442</a>     <a class="code" href="classWTL_1_1CPrinterDC.html#a0">CPrinterDC</a>()
00443     {
00444         CPrinter printer;
00445         printer.<a class="code" href="classWTL_1_1CPrinterT.html#a7">OpenDefaultPrinter</a>();
00446         <a class="code" href="classWTL_1_1CDCT.html#a3">Attach</a>(printer.CreatePrinterDC());
00447         ATLASSERT(<a class="code" href="classWTL_1_1CDCT.html#m0">m_hDC</a> != NULL);
00448     }
<a name="l00449"></a><a class="code" href="classWTL_1_1CPrinterDC.html#a1">00449</a>     <a class="code" href="classWTL_1_1CPrinterDC.html#a0">CPrinterDC</a>(HANDLE hPrinter, <font class="keyword">const</font> DEVMODE* pdm = NULL)
00450     {
00451         CPrinterHandle p;
00452         p.<a class="code" href="classWTL_1_1CPrinterT.html#a13">Attach</a>(hPrinter);
00453         <a class="code" href="classWTL_1_1CDCT.html#a3">Attach</a>(p.CreatePrinterDC(pdm));
00454         ATLASSERT(<a class="code" href="classWTL_1_1CDCT.html#m0">m_hDC</a> != NULL);
00455     }
<a name="l00456"></a><a class="code" href="classWTL_1_1CPrinterDC.html#a2">00456</a>     <a class="code" href="classWTL_1_1CPrinterDC.html#a2">~CPrinterDC</a>()
00457     {
00458         <a class="code" href="classWTL_1_1CDCT.html#a15">DeleteDC</a>();
00459     }
00460 };
00461 
00462 
00463 <font class="comment">//Defines callbacks used by CPrintJob (not a COM interface)</font>
<a name="l00464"></a><a class="code" href="classWTL_1_1IPrintJobInfo.html">00464</a> <font class="keyword">class </font>ATL_NO_VTABLE <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>
00465 {
00466 <font class="keyword">public</font>:
00467     <font class="keyword">virtual</font> <font class="keywordtype">void</font> BeginPrintJob(HDC hDC) = 0;        <font class="comment">// allocate handles needed, etc.</font>
00468     <font class="keyword">virtual</font> <font class="keywordtype">void</font> EndPrintJob(HDC hDC, <font class="keywordtype">bool</font> bAborted) = 0;   <font class="comment">// free handles, etc.</font>
00469     <font class="keyword">virtual</font> <font class="keywordtype">void</font> PrePrintPage(UINT nPage, HDC hDC) = 0;
00470     <font class="keyword">virtual</font> <font class="keywordtype">bool</font> PrintPage(UINT nPage, HDC hDC) = 0;
00471     <font class="keyword">virtual</font> <font class="keywordtype">void</font> PostPrintPage(UINT nPage, HDC hDC) = 0;
00472     <font class="comment">// If you want per page devmodes, return the DEVMODE* to use for nPage.</font>
00473     <font class="comment">// You can optimize by only returning a new DEVMODE* when it is different</font>
00474     <font class="comment">// from the one for nLastPage, otherwise return NULL.</font>
00475     <font class="comment">// When nLastPage==0, the current DEVMODE* will be the default passed to</font>
00476     <font class="comment">// StartPrintJob.</font>
00477     <font class="comment">// Note: During print preview, nLastPage will always be "0".</font>
00478     <font class="keyword">virtual</font> DEVMODE* GetNewDevModeForPage(UINT nLastPage, UINT nPage) = 0;
00479     <font class="keyword">virtual</font> <font class="keywordtype">bool</font> IsValidPage(UINT nPage) = 0;
00480 };
00481 
00482 
00483 <font class="comment">// Provides a default implementatin for IPrintJobInfo</font>
00484 <font class="comment">// Typically, MI'd into a document or view class</font>
<a name="l00485"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html">00485</a> <font class="keyword">class </font>ATL_NO_VTABLE CPrintJobInfo : <font class="keyword">public</font> <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>
00486 {
00487 <font class="keyword">public</font>:
<a name="l00488"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#a0">00488</a>     <font class="keyword">virtual</font> <font class="keywordtype">void</font> BeginPrintJob(HDC <font class="comment">/*hDC*/</font>) <font class="comment">//allocate handles needed, etc</font>
00489     {
00490     }
<a name="l00491"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#a1">00491</a>     <font class="keyword">virtual</font> <font class="keywordtype">void</font> EndPrintJob(HDC <font class="comment">/*hDC*/</font>, <font class="keywordtype">bool</font> <font class="comment">/*bAborted*/</font>)    <font class="comment">// free handles, etc</font>
00492     {
00493     }
<a name="l00494"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#a2">00494</a>     <font class="keyword">virtual</font> <font class="keywordtype">void</font> PrePrintPage(UINT <font class="comment">/*nPage*/</font>, HDC hDC)
00495     {
00496         m_nPJState = ::SaveDC(hDC);
00497     }
00498     <font class="keyword">virtual</font> <font class="keywordtype">bool</font> PrintPage(UINT <font class="comment">/*nPage*/</font>, HDC <font class="comment">/*hDC*/</font>) = 0;
<a name="l00499"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#a4">00499</a>     <font class="keyword">virtual</font> <font class="keywordtype">void</font> PostPrintPage(UINT <font class="comment">/*nPage*/</font>, HDC hDC)
00500     {
00501         RestoreDC(hDC, m_nPJState);
00502     }
<a name="l00503"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#a5">00503</a>     <font class="keyword">virtual</font> DEVMODE* GetNewDevModeForPage(UINT <font class="comment">/*nLastPage*/</font>, UINT <font class="comment">/*nPage*/</font>)
00504     {
00505         <font class="keywordflow">return</font> NULL;
00506     }
<a name="l00507"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#a6">00507</a>     <font class="keyword">virtual</font> <font class="keywordtype">bool</font> IsValidPage(UINT <font class="comment">/*nPage*/</font>)
00508     {
00509         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00510     }
00511 
00512 <font class="comment">// Implementation - data</font>
<a name="l00513"></a><a class="code" href="classWTL_1_1CPrintJobInfo.html#m0">00513</a>     <font class="keywordtype">int</font> m_nPJState;
00514 };
00515 
00516 
00517 <font class="comment">// Wraps a set of tasks for a specific printer (StartDoc/EndDoc)</font>
00518 <font class="comment">// Handles aborting, background printing</font>
<a name="l00519"></a><a class="code" href="classWTL_1_1CPrintJob.html">00519</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrintJob.html">CPrintJob</a>
00520 {
00521 <font class="keyword">public</font>:
00522 <font class="comment">// Data members</font>
<a name="l00523"></a><a class="code" href="classWTL_1_1CPrintJob.html#m0">00523</a>     CPrinterHandle <a class="code" href="classWTL_1_1CPrintJob.html#m0">m_printer</a>;
<a name="l00524"></a><a class="code" href="classWTL_1_1CPrintJob.html#m1">00524</a>     <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>* <a class="code" href="classWTL_1_1CPrintJob.html#m1">m_pInfo</a>;
<a name="l00525"></a><a class="code" href="classWTL_1_1CPrintJob.html#m2">00525</a>     DEVMODE* <a class="code" href="classWTL_1_1CPrintJob.html#m2">m_pDefDevMode</a>;
<a name="l00526"></a><a class="code" href="classWTL_1_1CPrintJob.html#m3">00526</a>     DOCINFO <a class="code" href="classWTL_1_1CPrintJob.html#m3">m_docinfo</a>;
<a name="l00527"></a><a class="code" href="classWTL_1_1CPrintJob.html#m4">00527</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPrintJob.html#m4">m_nJobID</a>;
<a name="l00528"></a><a class="code" href="classWTL_1_1CPrintJob.html#m5">00528</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrintJob.html#m5">m_bCancel</a>;
<a name="l00529"></a><a class="code" href="classWTL_1_1CPrintJob.html#m6">00529</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a>;
<a name="l00530"></a><a class="code" href="classWTL_1_1CPrintJob.html#m7">00530</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> <a class="code" href="classWTL_1_1CPrintJob.html#m7">m_nStartPage</a>;
<a name="l00531"></a><a class="code" href="classWTL_1_1CPrintJob.html#m8">00531</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> <a class="code" href="classWTL_1_1CPrintJob.html#m8">m_nEndPage</a>;
00532 
00533 <font class="comment">// Constructor/destructor</font>
<a name="l00534"></a><a class="code" href="classWTL_1_1CPrintJob.html#a0">00534</a>     <a class="code" href="classWTL_1_1CPrintJob.html#a0">CPrintJob</a>() : <a class="code" href="classWTL_1_1CPrintJob.html#m4">m_nJobID</a>(0), <a class="code" href="classWTL_1_1CPrintJob.html#m5">m_bCancel</a>(false), <a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a>(true)
00535     { }
00536 
<a name="l00537"></a><a class="code" href="classWTL_1_1CPrintJob.html#a1">00537</a>     <a class="code" href="classWTL_1_1CPrintJob.html#a1">~CPrintJob</a>()
00538     {
00539         ATLASSERT(<a class="code" href="classWTL_1_1CPrintJob.html#a2">IsJobComplete</a>()); <font class="comment">//premature destruction?</font>
00540     }
00541 
00542 <font class="comment">// Operations</font>
<a name="l00543"></a><a class="code" href="classWTL_1_1CPrintJob.html#a2">00543</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrintJob.html#a2">IsJobComplete</a>()<font class="keyword"> const</font>
00544 <font class="keyword">    </font>{
00545         <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a>;
00546     }
00547 
<a name="l00548"></a><a class="code" href="classWTL_1_1CPrintJob.html#a3">00548</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrintJob.html#a3">StartPrintJob</a>(<font class="keywordtype">bool</font> bBackground, HANDLE hPrinter, DEVMODE* pDefaultDevMode,
00549             <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>* pInfo, LPCTSTR lpszDocName, 
00550             <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> nStartPage, <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> nEndPage)
00551     {
00552         ATLASSERT(<a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a>); <font class="comment">//previous job not done yet?</font>
00553         <font class="keywordflow">if</font> (pInfo == NULL)
00554             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00555         memset(&amp;<a class="code" href="classWTL_1_1CPrintJob.html#m3">m_docinfo</a>, 0, <font class="keyword">sizeof</font>(<a class="code" href="classWTL_1_1CPrintJob.html#m3">m_docinfo</a>));
00556         <a class="code" href="classWTL_1_1CPrintJob.html#m3">m_docinfo</a>.cbSize = <font class="keyword">sizeof</font>(m_docinfo);
00557         <a class="code" href="classWTL_1_1CPrintJob.html#m3">m_docinfo</a>.lpszDocName = lpszDocName;
00558         m_pInfo = pInfo;
00559         <a class="code" href="classWTL_1_1CPrintJob.html#m7">m_nStartPage</a> = nStartPage;
00560         <a class="code" href="classWTL_1_1CPrintJob.html#m8">m_nEndPage</a> = nEndPage;
00561         <a class="code" href="classWTL_1_1CPrintJob.html#m0">m_printer</a>.Attach(hPrinter);
00562         <a class="code" href="classWTL_1_1CPrintJob.html#m2">m_pDefDevMode</a> = pDefaultDevMode;
00563         <a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a> = <font class="keyword">false</font>;
00564         <font class="keywordflow">if</font> (!bBackground)
00565         {
00566             <a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a> = <font class="keyword">true</font>;
00567             <font class="keywordflow">return</font> <a class="code" href="classWTL_1_1CPrintJob.html#a4">StartHelper</a>();
00568         }
00569 
00570         <font class="comment">//Create a thread and return</font>
00571         DWORD dwThreadID = 0;
00572         HANDLE hThread = ::CreateThread(NULL, 0, <a class="code" href="classWTL_1_1CPrintJob.html#d0">StartProc</a>, (<font class="keywordtype">void</font>*)<font class="keyword">this</font>, 0, &amp;dwThreadID);
00573         ::CloseHandle(hThread);
00574 
00575         <font class="keywordflow">return</font> (hThread != NULL);
00576     }
00577 
00578 <font class="comment">// Implementation</font>
<a name="l00579"></a><a class="code" href="classWTL_1_1CPrintJob.html#d0">00579</a>     <font class="keyword">static</font> DWORD WINAPI <a class="code" href="classWTL_1_1CPrintJob.html#d0">StartProc</a>(<font class="keywordtype">void</font>* p)
00580     {
00581         <a class="code" href="classWTL_1_1CPrintJob.html">CPrintJob</a>* pThis = (<a class="code" href="classWTL_1_1CPrintJob.html">CPrintJob</a>*)p;
00582         pThis-&gt;<a class="code" href="classWTL_1_1CPrintJob.html#a4">StartHelper</a>();
00583         pThis-&gt;<a class="code" href="classWTL_1_1CPrintJob.html#m6">m_bComplete</a> = <font class="keyword">true</font>;
00584         <font class="keywordflow">return</font> 0;
00585     }
<a name="l00586"></a><a class="code" href="classWTL_1_1CPrintJob.html#a4">00586</a>     <font class="keywordtype">bool</font> <a class="code" href="classWTL_1_1CPrintJob.html#a4">StartHelper</a>()
00587     {
00588         <a class="code" href="namespaceWTL.html#a48">CDC</a> dcPrinter;
00589         dcPrinter.<a class="code" href="classWTL_1_1CDCT.html#a3">Attach</a>(<a class="code" href="classWTL_1_1CPrintJob.html#m0">m_printer</a>.CreatePrinterDC(<a class="code" href="classWTL_1_1CPrintJob.html#m2">m_pDefDevMode</a>));
00590         <font class="keywordflow">if</font> (dcPrinter.IsNull())
00591             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00592             
00593         <a class="code" href="classWTL_1_1CPrintJob.html#m4">m_nJobID</a> = ::StartDoc(dcPrinter, &amp;<a class="code" href="classWTL_1_1CPrintJob.html#m3">m_docinfo</a>);
00594         <font class="keywordflow">if</font> (<a class="code" href="classWTL_1_1CPrintJob.html#m4">m_nJobID</a> &lt;= 0)
00595             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00596 
00597         m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a0">BeginPrintJob</a>(dcPrinter);
00598 
00599         <font class="comment">//print all the pages now</font>
00600         <font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> nLastPage = 0;
00601         <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> <font class="keywordtype">long</font> nPage = <a class="code" href="classWTL_1_1CPrintJob.html#m7">m_nStartPage</a>; nPage &lt;= <a class="code" href="classWTL_1_1CPrintJob.html#m8">m_nEndPage</a>; nPage++)
00602         {
00603             <font class="keywordflow">if</font> (!m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a6">IsValidPage</a>(nPage))
00604                 <font class="keywordflow">break</font>;
00605             DEVMODE* pdm = m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a5">GetNewDevModeForPage</a>(nLastPage, nPage);
00606             <font class="keywordflow">if</font> (pdm != NULL)
00607                 dcPrinter.ResetDC(pdm);
00608             dcPrinter.StartPage();
00609             m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a2">PrePrintPage</a>(nPage, dcPrinter);
00610             <font class="keywordflow">if</font> (!m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a3">PrintPage</a>(nPage, dcPrinter))
00611                 <a class="code" href="classWTL_1_1CPrintJob.html#m5">m_bCancel</a> = <font class="keyword">true</font>;
00612             m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a4">PostPrintPage</a>(nPage, dcPrinter);
00613             dcPrinter.EndPage();
00614             <font class="keywordflow">if</font> (m_bCancel)
00615                 <font class="keywordflow">break</font>;
00616             nLastPage = nPage;
00617         }
00618 
00619         m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a1">EndPrintJob</a>(dcPrinter, <a class="code" href="classWTL_1_1CPrintJob.html#m5">m_bCancel</a>);
00620         <font class="keywordflow">if</font> (m_bCancel)
00621             ::AbortDoc(dcPrinter);
00622         else
00623             ::EndDoc(dcPrinter);
00624         <a class="code" href="classWTL_1_1CPrintJob.html#m4">m_nJobID</a> = 0;
00625         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00626     }
00627     <font class="comment">// Cancels a print job. Can be called asynchronously.</font>
<a name="l00628"></a><a class="code" href="classWTL_1_1CPrintJob.html#a5">00628</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrintJob.html#a5">CancelPrintJob</a>()
00629     {
00630         <a class="code" href="classWTL_1_1CPrintJob.html#m5">m_bCancel</a> = <font class="keyword">true</font>;
00631     }
00632 };
00633 
00634 
00635 <font class="comment">// Adds print preview support to an existing window</font>
<a name="l00636"></a><a class="code" href="classWTL_1_1CPrintPreview.html">00636</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrintPreview.html">CPrintPreview</a>
00637 {
00638 <font class="keyword">public</font>:
00639 <font class="comment">// Data members</font>
<a name="l00640"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m0">00640</a>     <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>* <a class="code" href="classWTL_1_1CPrintPreview.html#m0">m_pInfo</a>;
<a name="l00641"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m1">00641</a>     CPrinterHandle <a class="code" href="classWTL_1_1CPrintPreview.html#m1">m_printer</a>;
<a name="l00642"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m2">00642</a>     <a class="code" href="namespaceWTL.html#a50">CEnhMetaFile</a> <a class="code" href="classWTL_1_1CPrintPreview.html#m2">m_meta</a>;
<a name="l00643"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m3">00643</a>     DEVMODE* <a class="code" href="classWTL_1_1CPrintPreview.html#m3">m_pDefDevMode</a>;
<a name="l00644"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m4">00644</a>     DEVMODE* <a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a>;
<a name="l00645"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m5">00645</a>     SIZE <a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>;
00646 
00647 <font class="comment">// Constructor</font>
<a name="l00648"></a><a class="code" href="classWTL_1_1CPrintPreview.html#a0">00648</a>     <a class="code" href="classWTL_1_1CPrintPreview.html#a0">CPrintPreview</a>() : m_pInfo(NULL), <a class="code" href="classWTL_1_1CPrintPreview.html#m3">m_pDefDevMode</a>(NULL), <a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a>(NULL)
00649     {
00650         <a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>.cx = 0;
00651         <a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>.cy = 0;
00652     }
00653 
00654 <font class="comment">// Operations</font>
<a name="l00655"></a><a class="code" href="classWTL_1_1CPrintPreview.html#a1">00655</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrintPreview.html#a1">SetPrintPreviewInfo</a>(HANDLE hPrinter, DEVMODE* pDefaultDevMode, <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>* pji)
00656     {
00657         <a class="code" href="classWTL_1_1CPrintPreview.html#m1">m_printer</a>.Attach(hPrinter);
00658         <a class="code" href="classWTL_1_1CPrintPreview.html#m3">m_pDefDevMode</a> = pDefaultDevMode;
00659         m_pInfo = pji;
00660         <a class="code" href="classWTL_1_1CPrintPreview.html#m6">m_nCurPage</a> = 0;
00661         <a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a> = NULL;
00662     }
<a name="l00663"></a><a class="code" href="classWTL_1_1CPrintPreview.html#a2">00663</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrintPreview.html#a2">SetEnhMetaFile</a>(HENHMETAFILE hEMF)
00664     {
00665         <a class="code" href="classWTL_1_1CPrintPreview.html#m2">m_meta</a> = hEMF;
00666     }
<a name="l00667"></a><a class="code" href="classWTL_1_1CPrintPreview.html#a3">00667</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrintPreview.html#a3">SetPage</a>(<font class="keywordtype">int</font> nPage)
00668     {
00669         <font class="keywordflow">if</font> (!m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a6">IsValidPage</a>(nPage))
00670             <font class="keywordflow">return</font>;
00671         <a class="code" href="classWTL_1_1CPrintPreview.html#m6">m_nCurPage</a> = nPage;
00672         <a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a> = m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a5">GetNewDevModeForPage</a>(0, nPage);
00673         <font class="keywordflow">if</font> (<a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a> == NULL)
00674             <a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a> = <a class="code" href="classWTL_1_1CPrintPreview.html#m3">m_pDefDevMode</a>;
00675         <a class="code" href="namespaceWTL.html#a48">CDC</a> dcPrinter = <a class="code" href="classWTL_1_1CPrintPreview.html#m1">m_printer</a>.CreatePrinterDC(<a class="code" href="classWTL_1_1CPrintPreview.html#m4">m_pCurDevMode</a>);
00676 
00677         <font class="keywordtype">int</font> iWidth = dcPrinter.GetDeviceCaps(PHYSICALWIDTH); 
00678         <font class="keywordtype">int</font> iHeight = dcPrinter.GetDeviceCaps(PHYSICALHEIGHT); 
00679         <font class="keywordtype">int</font> nLogx = dcPrinter.GetDeviceCaps(LOGPIXELSX);
00680         <font class="keywordtype">int</font> nLogy = dcPrinter.GetDeviceCaps(LOGPIXELSY);
00681 
00682         RECT rcMM = { 0, 0, ::MulDiv(iWidth, 2540, nLogx), ::MulDiv(iHeight, 2540, nLogy) };
00683 
00684         <a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>.cx = dcPrinter.GetDeviceCaps(PHYSICALOFFSETX);
00685         <a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>.cy = dcPrinter.GetDeviceCaps(PHYSICALOFFSETY);
00686         
00687         <a class="code" href="classWTL_1_1CEnhMetaFileDC.html">CEnhMetaFileDC</a> dcMeta(dcPrinter, &amp;rcMM);
00688         m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a2">PrePrintPage</a>(nPage, dcMeta);
00689         m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a3">PrintPage</a>(nPage, dcMeta);
00690         m_pInfo-&gt;<a class="code" href="classWTL_1_1IPrintJobInfo.html#a4">PostPrintPage</a>(nPage, dcMeta);
00691         <a class="code" href="classWTL_1_1CPrintPreview.html#m2">m_meta</a>.Attach(dcMeta.<a class="code" href="classWTL_1_1CEnhMetaFileDC.html#a5">Close</a>());
00692     }
<a name="l00693"></a><a class="code" href="classWTL_1_1CPrintPreview.html#a4">00693</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrintPreview.html#a4">GetPageRect</a>(RECT&amp; rc, LPRECT prc)
00694     {
00695         <font class="keywordtype">int</font> x1 = rc.right-rc.left;
00696         <font class="keywordtype">int</font> y1 = rc.bottom - rc.top;
00697         <font class="keywordflow">if</font> ((x1 &lt; 0) || (y1 &lt; 0))
00698             <font class="keywordflow">return</font>;
00699 
00700         <a class="code" href="classWTL_1_1CEnhMetaFileInfo.html">CEnhMetaFileInfo</a> emfinfo(<a class="code" href="classWTL_1_1CPrintPreview.html#m2">m_meta</a>);
00701         ENHMETAHEADER* pmh = emfinfo.<a class="code" href="classWTL_1_1CEnhMetaFileInfo.html#a4">GetEnhMetaFileHeader</a>();
00702 
00703         <font class="comment">//Compute whether we are OK vertically or horizontally</font>
00704         <font class="keywordtype">int</font> x2 = pmh-&gt;szlDevice.cx;
00705         <font class="keywordtype">int</font> y2 = pmh-&gt;szlDevice.cy;
00706         <font class="keywordtype">int</font> y1p = MulDiv(x1, y2, x2);
00707         <font class="keywordtype">int</font> x1p = MulDiv(y1, x2, y2);
00708         ATLASSERT( (x1p &lt;= x1) || (y1p &lt;= y1));
00709         <font class="keywordflow">if</font> (x1p &lt;= x1)
00710         {
00711             prc-&gt;left = rc.left + (x1 - x1p)/2;
00712             prc-&gt;right = prc-&gt;left + x1p;
00713             prc-&gt;top = rc.top;
00714             prc-&gt;bottom = rc.bottom;
00715         }
00716         <font class="keywordflow">else</font>
00717         {
00718             prc-&gt;left = rc.left;
00719             prc-&gt;right = rc.right;
00720             prc-&gt;top = rc.top + (y1 - y1p)/2;
00721             prc-&gt;bottom = prc-&gt;top + y1p;
00722         }
00723     }
00724 
00725 <font class="comment">// Painting helper</font>
<a name="l00726"></a><a class="code" href="classWTL_1_1CPrintPreview.html#a5">00726</a>     <font class="keywordtype">void</font> <a class="code" href="classWTL_1_1CPrintPreview.html#a5">DoPaint</a>(<a class="code" href="namespaceWTL.html#a47">CDCHandle</a> dc, RECT&amp; rc)
00727     {
00728         <a class="code" href="classWTL_1_1CEnhMetaFileInfo.html">CEnhMetaFileInfo</a> emfinfo(<a class="code" href="classWTL_1_1CPrintPreview.html#m2">m_meta</a>);
00729         ENHMETAHEADER* pmh = emfinfo.<a class="code" href="classWTL_1_1CEnhMetaFileInfo.html#a4">GetEnhMetaFileHeader</a>();
00730         <font class="keywordtype">int</font> nOffsetX = MulDiv(<a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>.cx, rc.right-rc.left, pmh-&gt;szlDevice.cx);
00731         <font class="keywordtype">int</font> nOffsetY = MulDiv(<a class="code" href="classWTL_1_1CPrintPreview.html#m5">m_sizeCurPhysOffset</a>.cy, rc.bottom-rc.top, pmh-&gt;szlDevice.cy);
00732 
00733         dc.OffsetWindowOrg(-nOffsetX, -nOffsetY);
00734         dc.PlayMetaFile(<a class="code" href="classWTL_1_1CPrintPreview.html#m2">m_meta</a>, &amp;rc);
00735     }
00736 
00737 <font class="comment">// Implementation - data</font>
<a name="l00738"></a><a class="code" href="classWTL_1_1CPrintPreview.html#m6">00738</a>     <font class="keywordtype">int</font> <a class="code" href="classWTL_1_1CPrintPreview.html#m6">m_nCurPage</a>;
00739 };
00740 
00741 <font class="keyword">template</font> &lt;<font class="keyword">class</font> T, <font class="keyword">class</font> TBase = CWindow, <font class="keyword">class</font> TWinTraits = CControlWinTraits&gt;
<a name="l00742"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html">00742</a> <font class="keyword">class </font>ATL_NO_VTABLE CPrintPreviewWindowImpl : <font class="keyword">public</font> <a class="code" href="classCWindowImpl.html">CWindowImpl</a>&lt;T, TBase, TWinTraits&gt;, <font class="keyword">public</font> <a class="code" href="classWTL_1_1CPrintPreview.html">CPrintPreview</a>
00743 {
00744 <font class="keyword">public</font>:
00745     DECLARE_WND_CLASS_EX(NULL, CS_VREDRAW | CS_HREDRAW, -1)
00746 
00747     <font class="keyword">enum</font> { m_cxOffset = 10, m_cyOffset = 10 };
00748 
00749 <font class="comment">// Constructor</font>
<a name="l00750"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#a0">00750</a>     CPrintPreviewWindowImpl() : m_nMaxPage(0), m_nMinPage(0)
00751     { }
00752 
00753 <font class="comment">// Operations</font>
<a name="l00754"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#a1">00754</a>     <font class="keywordtype">void</font> SetPrintPreviewInfo(HANDLE hPrinter, DEVMODE* pDefaultDevMode, 
00755         <a class="code" href="classWTL_1_1IPrintJobInfo.html">IPrintJobInfo</a>* pji, <font class="keywordtype">int</font> nMinPage, <font class="keywordtype">int</font> nMaxPage)
00756     {
00757         CPrintPreview::SetPrintPreviewInfo(hPrinter, pDefaultDevMode, pji);
00758         m_nMinPage = nMinPage;
00759         m_nMaxPage = nMaxPage;
00760     }
<a name="l00761"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#a2">00761</a>     <font class="keywordtype">bool</font> NextPage()
00762     {
00763         <font class="keywordflow">if</font> (m_nCurPage == m_nMaxPage)
00764             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00765         SetPage(m_nCurPage + 1);
00766         Invalidate();
00767         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00768     }
<a name="l00769"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#a3">00769</a>     <font class="keywordtype">bool</font> PrevPage()
00770     {
00771         <font class="keywordflow">if</font> (m_nCurPage == m_nMinPage)
00772             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00773         <font class="keywordflow">if</font> (m_nCurPage == 0)
00774             <font class="keywordflow">return</font> <font class="keyword">false</font>;
00775         SetPage(m_nCurPage - 1);
00776         Invalidate();
00777         <font class="keywordflow">return</font> <font class="keyword">true</font>;
00778     }
00779 
00780 <font class="comment">// Message map and handlers</font>
00781     BEGIN_MSG_MAP(CPrintPreviewWindowImpl)
00782         MESSAGE_HANDLER(WM_ERASEBKGND, OnEraseBkgnd)
00783         MESSAGE_HANDLER(WM_PAINT, OnPaint)
00784     END_MSG_MAP()
00785 
<a name="l00786"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#a4">00786</a>     LRESULT OnEraseBkgnd(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00787     {
00788         <font class="keywordflow">return</font> 1;   <font class="comment">// no need for the background</font>
00789     }
00790 
<a name="l00791"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#a5">00791</a>     LRESULT OnPaint(UINT <font class="comment">/*uMsg*/</font>, WPARAM <font class="comment">/*wParam*/</font>, LPARAM <font class="comment">/*lParam*/</font>, BOOL&amp; <font class="comment">/*bHandled*/</font>)
00792     {
00793         T* pT = static_cast&lt;T*&gt;(this);
00794         <a class="code" href="classWTL_1_1CPaintDC.html">CPaintDC</a> dc(m_hWnd);
00795         RECT rcClient;
00796         GetClientRect(&amp;rcClient);
00797         RECT rcArea = rcClient;
00798         ::InflateRect(&amp;rcArea, -pT-&gt;m_cxOffset, -pT-&gt;m_cyOffset);
00799         <font class="keywordflow">if</font> (rcArea.left &gt; rcArea.right)
00800             rcArea.right = rcArea.left;
00801         <font class="keywordflow">if</font> (rcArea.top &gt; rcArea.bottom)
00802             rcArea.bottom = rcArea.top;
00803         RECT rc;
00804         GetPageRect(rcArea, &amp;rc);
00805         <a class="code" href="namespaceWTL.html#a46">CRgn</a> rgn1, rgn2;
00806         rgn1.CreateRectRgnIndirect(&amp;rc);
00807         rgn2.CreateRectRgnIndirect(&amp;rcClient);
00808         rgn2.CombineRgn(rgn1, RGN_DIFF);
00809         dc.<a class="code" href="classWTL_1_1CDCT.html#a89">SelectClipRgn</a>(rgn2);
00810         dc.<a class="code" href="classWTL_1_1CDCT.html#a116">FillRect</a>(&amp;rcClient, COLOR_BTNSHADOW);
00811         dc.<a class="code" href="classWTL_1_1CDCT.html#a89">SelectClipRgn</a>(NULL);
00812         dc.<a class="code" href="classWTL_1_1CDCT.html#a116">FillRect</a>(&amp;rc, (HBRUSH)::GetStockObject(WHITE_BRUSH));
00813         pT-&gt;DoPaint(dc.<a class="code" href="classWTL_1_1CDCT.html#m0">m_hDC</a>, rc);
00814         <font class="keywordflow">return</font> 0;
00815     }
00816 
00817 <font class="comment">// Implementation - data</font>
<a name="l00818"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#m0">00818</a>     <font class="keywordtype">int</font> m_nMinPage;
<a name="l00819"></a><a class="code" href="classWTL_1_1CPrintPreviewWindowImpl.html#m1">00819</a>     <font class="keywordtype">int</font> m_nMaxPage;
00820 };
00821 
00822 
<a name="l00823"></a><a class="code" href="classWTL_1_1CPrintPreviewWindow.html">00823</a> <font class="keyword">class </font><a class="code" href="classWTL_1_1CPrintPreviewWindow.html">CPrintPreviewWindow</a> : <font class="keyword">public</font> CPrintPreviewWindowImpl&lt;CPrintPreviewWindow&gt;
00824 {
00825 <font class="keyword">public</font>:
00826     DECLARE_WND_CLASS_EX(_T(<font class="stringliteral">"WTL_PrintPreview"</font>), CS_VREDRAW | CS_HREDRAW, -1)
00827 };
00828 
00829 }; <font class="comment">//namespace WTL</font>
00830 
00831 <font class="preprocessor">#endif // __ATLPRINT_H__</font>
</pre></div><hr><address align="right"><small>Generated on Thu Apr 11 21:09:32 2002 for wtl-doc by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
